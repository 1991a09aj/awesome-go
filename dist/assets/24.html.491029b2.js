import{_ as c,r as o,o as l,c as i,a as n,b as a,w as e,e as s,d as u}from"./app.bdc458db.js";const r={},k={href:"https://github.com/3293172751",target:"_blank",rel:"noopener noreferrer"},d=s("author"),v=n("h1",{id:"\u7B2C24\u8282-socks5-\u4EE3\u7406-\u8C03\u7528\u7B2C\u4E09\u65B9api\u6848\u4F8B",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u7B2C24\u8282-socks5-\u4EE3\u7406-\u8C03\u7528\u7B2C\u4E09\u65B9api\u6848\u4F8B","aria-hidden":"true"},"#"),s(" \u7B2C24\u8282 SOCKS5 \u4EE3\u7406\uFF08\u8C03\u7528\u7B2C\u4E09\u65B9API\u6848\u4F8B\uFF09")],-1),m=s("\u56DE\u5230\u76EE\u5F55"),b=s("\u4E0A\u4E00\u8282"),f=s("\u2764\uFE0F\u{1F495}\u{1F495}Go\u8BED\u8A00\u9AD8\u7EA7\u7BC7\u7AE0,\u5728\u6B64\u4E4B\u524D\u5EFA\u8BAE\u60A8\u5148\u4E86\u89E3\u57FA\u7840\u548C\u8FDB\u9636\u7BC7\u3002Myblog:"),y={href:"http://nsddd.top/",target:"_blank",rel:"noopener noreferrer"},w=s("http://nsddd.top"),h={id:"go\u8BED\u8A00\u57FA\u7840\u7BC7",tabindex:"-1"},g=n("a",{class:"header-anchor",href:"#go\u8BED\u8A00\u57FA\u7840\u7BC7","aria-hidden":"true"},"#",-1),q=s(),_={href:"https://github.com/3293172751/Block_Chain/blob/master/TOC.md",target:"_blank",rel:"noopener noreferrer"},R=s("Go\u8BED\u8A00\u57FA\u7840\u7BC7"),E={id:"go\u8BED\u8A00100\u7BC7\u8FDB\u9636",tabindex:"-1"},S=n("a",{class:"header-anchor",href:"#go\u8BED\u8A00100\u7BC7\u8FDB\u9636","aria-hidden":"true"},"#",-1),D=s(),T={href:"https://github.com/3293172751/Block_Chain/blob/master/Gomd_super/README.md",target:"_blank",rel:"noopener noreferrer"},x=s("Go\u8BED\u8A00100\u7BC7\u8FDB\u9636"),P=n("hr",null,null,-1),O=n("p",null,"[TOC]",-1),V=n("h2",{id:"clash\u4ECB\u7ECD",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#clash\u4ECB\u7ECD","aria-hidden":"true"},"#"),s(" Clash\u4ECB\u7ECD")],-1),N={href:"https://github.com/Dreamacro/clash",target:"_blank",rel:"noopener noreferrer"},A=s("clash \u9879\u76EE\u5730\u5740"),C=n("p",null,[n("strong",null,"\u7279\u70B9\uFF1A")],-1),H=n("li",null,"\u652F\u6301\u8EAB\u4EFD\u9A8C\u8BC1\u7684\u672C\u5730HTTP/HTTPS/SOCKS\u670D\u52A1\u5668",-1),M=n("li",null,"Shadowsocks\uFF08R\uFF09\u3001VMess\u3001\u7279\u6D1B\u4F0A\u6728\u9A6C\u3001Snell\u3001SOCKS5\u3001HTTP\uFF08S\uFF09\u51FA\u7AD9\u652F\u6301",-1),I=s("\u5185\u7F6E "),B={href:"https://www.rfc-editor.org/rfc/rfc3089",target:"_blank",rel:"noopener noreferrer"},z=s("\u4F2Aip"),F=s("DNS\u670D\u52A1\u5668\uFF0C\u65E8\u5728\u6700\u5927\u9650\u5EA6\u5730\u51CF\u5C11DNS\u6C61\u67D3\u653B\u51FB\u7684\u5F71\u54CD\u3002\u652F\u6301DoH/DoT\u4E0A\u6E38\u3002"),U=n("li",null,"\u57FA\u4E8E\u57DF\u3001GEOIP\u3001IP-CIDR\u6216\u8FDB\u7A0B\u540D\u79F0\u7684\u89C4\u5219\u5C06\u6570\u636E\u5305\u8DEF\u7531\u5230\u4E0D\u540C\u7684\u76EE\u7684\u5730",-1),X=n("li",null,"\u4EE3\u7406\u7EC4\u5141\u8BB8\u7528\u6237\u5B9E\u65BD\u5F3A\u5927\u7684\u89C4\u5219\u3002\u652F\u6301\u81EA\u52A8\u56DE\u9000\u3001\u8D1F\u8F7D\u5E73\u8861\u6216\u57FA\u4E8E\u5EF6\u8FDF\u81EA\u52A8\u9009\u62E9\u4EE3\u7406",-1),W=n("li",null,"\u8FDC\u7A0B\u63D0\u4F9B\u7A0B\u5E8F\uFF0C\u5141\u8BB8\u7528\u6237\u8FDC\u7A0B\u83B7\u53D6\u4EE3\u7406\u5217\u8868\uFF0C\u800C\u4E0D\u662F\u5728\u914D\u7F6E\u4E2D\u786C\u7F16\u7801",-1),L=n("li",null,"\u900F\u660E\u4EE3\u7406\uFF1A\u4F7F\u7528\u81EA\u52A8\u8DEF\u7531\u8868/\u89C4\u5219\u7BA1\u7406\u91CD\u5B9A\u5411TCP\u548CTProxy TCP/UDP",-1),Y=n("li",null,"\u901A\u8FC7\u5168\u9762\u7684HTTP RESTful API\u63A7\u5236\u5668\u8FDB\u884C\u70ED\u91CD\u65B0\u52A0\u8F7D",-1),K=u(`<h2 id="\u539F\u7406\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#\u539F\u7406\u4ECB\u7ECD" aria-hidden="true">#</a> \u539F\u7406\u4ECB\u7ECD</h2><p>SOCKS5\u662F\u7528\u4E8E\u901A\u8FC7\u4EE3\u7406\u670D\u52A1\u5668\u5B89\u5168\u5730\u8DEF\u7531\u7F51\u7EDC\u6D41\u91CF\u7684\u534F\u8BAE\u3002\u5B83\u901A\u5E38\u7528\u4E8E\u7ED5\u8FC7\u7F51\u7EDC\u9650\u5236\u548C\u8BBF\u95EE\u88AB\u963B\u6B62\u7684\u7F51\u7AD9\u3002SOCKS5\u4E3ASOCKS\u534F\u8BAE\u6DFB\u52A0\u4E86\u989D\u5916\u7684\u529F\u80FD\uFF0C\u4F8B\u5982\u9A8C\u8BC1\u7528\u6237\u8EAB\u4EFD\u7684\u80FD\u529B\u4EE5\u53CA\u5BF9TCP\u548CUDP\u6D41\u91CF\u7684\u652F\u6301\u3002SOCKS5\u4EE3\u7406\u670D\u52A1\u5668\u5145\u5F53\u5BA2\u6237\u7AEF\u548C\u76EE\u6807\u670D\u52A1\u5668\u4E4B\u95F4\u7684\u4E2D\u95F4\u4EBA\uFF0C\u5728\u5B83\u4EEC\u4E4B\u95F4\u8F6C\u53D1\u6D41\u91CF\uFF0C\u540C\u65F6\u9690\u85CF\u5BA2\u6237\u7AEF\u7684IP\u5730\u5740\u3002\u8FD9\u5141\u8BB8\u5BA2\u6237\u7AEF\u8BBF\u95EE\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u7684\u8D44\u6E90\uFF0C\u5C31\u597D\u50CF\u5B83\u4EEC\u4F4D\u4E8E\u540C\u4E00\u7F51\u7EDC\u4E0A\u4E00\u6837\u3002</p><p><img src="http://sm.nsddd.top/sm202301141645441.png" alt="image-20230114164536220"></p><h2 id="\u7B2C\u4E00\u6B65-\u4E00\u4E2A\u7B80\u5355\u7684\u94FE\u63A5" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E00\u6B65-\u4E00\u4E2A\u7B80\u5355\u7684\u94FE\u63A5" aria-hidden="true">#</a> \u7B2C\u4E00\u6B65\uFF0C\u4E00\u4E2A\u7B80\u5355\u7684\u94FE\u63A5</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	server<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1:1080&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		client<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Accept failed %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		b<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>b<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6D4B\u8BD5\uFF1A</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>go run main.go
nc 127.0.0.1 1080
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u8BA4\u8BC1\u9636\u6BB5" tabindex="-1"><a class="header-anchor" href="#\u8BA4\u8BC1\u9636\u6BB5" aria-hidden="true">#</a> \u8BA4\u8BC1\u9636\u6BB5</h2><p>\u4EE3\u7801\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> socks5Ver <span class="token operator">=</span> <span class="token number">0x05</span>
<span class="token keyword">const</span> cmdBind <span class="token operator">=</span> <span class="token number">0x01</span>
<span class="token keyword">const</span> atypIPV4 <span class="token operator">=</span> <span class="token number">0x01</span>
<span class="token keyword">const</span> atypeHOST <span class="token operator">=</span> <span class="token number">0x03</span>
<span class="token keyword">const</span> atypeIPV6 <span class="token operator">=</span> <span class="token number">0x04</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	server<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1:1080&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		client<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Accept failed %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> <span class="token function">auth</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;client %v auth failed:%v&quot;</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;auth success&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">auth</span><span class="token punctuation">(</span>reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// +----+----------+----------+</span>
	<span class="token comment">// |VER | NMETHODS | METHODS  |</span>
	<span class="token comment">// +----+----------+----------+</span>
	<span class="token comment">// | 1  |    1     | 1 to 255 |</span>
	<span class="token comment">// +----+----------+----------+</span>
	<span class="token comment">// VER: \u534F\u8BAE\u7248\u672C\uFF0Csocks5\u4E3A0x05</span>
	<span class="token comment">// NMETHODS: \u652F\u6301\u8BA4\u8BC1\u7684\u65B9\u6CD5\u6570\u91CF</span>
	<span class="token comment">// METHODS: \u5BF9\u5E94NMETHODS\uFF0CNMETHODS\u7684\u503C\u4E3A\u591A\u5C11\uFF0CMETHODS\u5C31\u6709\u591A\u5C11\u4E2A\u5B57\u8282\u3002RFC\u9884\u5B9A\u4E49\u4E86\u4E00\u4E9B\u503C\u7684\u542B\u4E49\uFF0C\u5185\u5BB9\u5982\u4E0B:</span>
	<span class="token comment">// X\u201900\u2019 NO AUTHENTICATION REQUIRED</span>
	<span class="token comment">// X\u201902\u2019 USERNAME/PASSWORD</span>

	ver<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read ver failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> ver <span class="token operator">!=</span> socks5Ver <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not supported ver:%v&quot;</span><span class="token punctuation">,</span> ver<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	methodSize<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read methodSize failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	method <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> methodSize<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> method<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read method failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;ver&quot;</span><span class="token punctuation">,</span> ver<span class="token punctuation">,</span> <span class="token string">&quot;method&quot;</span><span class="token punctuation">,</span> method<span class="token punctuation">)</span>
	<span class="token comment">// +----+--------+</span>
	<span class="token comment">// |VER | METHOD |</span>
	<span class="token comment">// +----+--------+</span>
	<span class="token comment">// | 1  |   1    |</span>
	<span class="token comment">// +----+--------+</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>socks5Ver<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;write failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u8BF7\u6C42\u9636\u6BB5" tabindex="-1"><a class="header-anchor" href="#\u8BF7\u6C42\u9636\u6BB5" aria-hidden="true">#</a> \u8BF7\u6C42\u9636\u6BB5</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;encoding/binary&quot;</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> socks5Ver <span class="token operator">=</span> <span class="token number">0x05</span>
<span class="token keyword">const</span> cmdBind <span class="token operator">=</span> <span class="token number">0x01</span>
<span class="token keyword">const</span> atypIPV4 <span class="token operator">=</span> <span class="token number">0x01</span>
<span class="token keyword">const</span> atypeHOST <span class="token operator">=</span> <span class="token number">0x03</span>
<span class="token keyword">const</span> atypeIPV6 <span class="token operator">=</span> <span class="token number">0x04</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	server<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1:1080&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		client<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Accept failed %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> <span class="token function">auth</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;client %v auth failed:%v&quot;</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;client %v auth failed:%v&quot;</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">auth</span><span class="token punctuation">(</span>reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// +----+----------+----------+</span>
	<span class="token comment">// |VER | NMETHODS | METHODS  |</span>
	<span class="token comment">// +----+----------+----------+</span>
	<span class="token comment">// | 1  |    1     | 1 to 255 |</span>
	<span class="token comment">// +----+----------+----------+</span>
	<span class="token comment">// VER: \u534F\u8BAE\u7248\u672C\uFF0Csocks5\u4E3A0x05</span>
	<span class="token comment">// NMETHODS: \u652F\u6301\u8BA4\u8BC1\u7684\u65B9\u6CD5\u6570\u91CF</span>
	<span class="token comment">// METHODS: \u5BF9\u5E94NMETHODS\uFF0CNMETHODS\u7684\u503C\u4E3A\u591A\u5C11\uFF0CMETHODS\u5C31\u6709\u591A\u5C11\u4E2A\u5B57\u8282\u3002RFC\u9884\u5B9A\u4E49\u4E86\u4E00\u4E9B\u503C\u7684\u542B\u4E49\uFF0C\u5185\u5BB9\u5982\u4E0B:</span>
	<span class="token comment">// X\u201900\u2019 NO AUTHENTICATION REQUIRED</span>
	<span class="token comment">// X\u201902\u2019 USERNAME/PASSWORD</span>

	ver<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read ver failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> ver <span class="token operator">!=</span> socks5Ver <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not supported ver:%v&quot;</span><span class="token punctuation">,</span> ver<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	methodSize<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read methodSize failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	method <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> methodSize<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> method<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read method failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// +----+--------+</span>
	<span class="token comment">// |VER | METHOD |</span>
	<span class="token comment">// +----+--------+</span>
	<span class="token comment">// | 1  |   1    |</span>
	<span class="token comment">// +----+--------+</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>socks5Ver<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;write failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">connect</span><span class="token punctuation">(</span>reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// |VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// | 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// VER \u7248\u672C\u53F7\uFF0Csocks5\u7684\u503C\u4E3A0x05</span>
	<span class="token comment">// CMD 0x01\u8868\u793ACONNECT\u8BF7\u6C42</span>
	<span class="token comment">// RSV \u4FDD\u7559\u5B57\u6BB5\uFF0C\u503C\u4E3A0x00</span>
	<span class="token comment">// ATYP \u76EE\u6807\u5730\u5740\u7C7B\u578B\uFF0CDST.ADDR\u7684\u6570\u636E\u5BF9\u5E94\u8FD9\u4E2A\u5B57\u6BB5\u7684\u7C7B\u578B\u3002</span>
	<span class="token comment">//   0x01\u8868\u793AIPv4\u5730\u5740\uFF0CDST.ADDR\u4E3A4\u4E2A\u5B57\u8282</span>
	<span class="token comment">//   0x03\u8868\u793A\u57DF\u540D\uFF0CDST.ADDR\u662F\u4E00\u4E2A\u53EF\u53D8\u957F\u5EA6\u7684\u57DF\u540D</span>
	<span class="token comment">// DST.ADDR \u4E00\u4E2A\u53EF\u53D8\u957F\u5EA6\u7684\u503C</span>
	<span class="token comment">// DST.PORT \u76EE\u6807\u7AEF\u53E3\uFF0C\u56FA\u5B9A2\u4E2A\u5B57\u8282</span>

	buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read header failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ver<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> atyp <span class="token operator">:=</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> ver <span class="token operator">!=</span> socks5Ver <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not supported ver:%v&quot;</span><span class="token punctuation">,</span> ver<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> cmd <span class="token operator">!=</span> cmdBind <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not supported cmd:%v&quot;</span><span class="token punctuation">,</span> ver<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>
	<span class="token keyword">switch</span> atyp <span class="token punctuation">{</span>
	<span class="token keyword">case</span> atypIPV4<span class="token punctuation">:</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read atyp failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		addr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d.%d.%d.%d&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> atypeHOST<span class="token punctuation">:</span>
		hostSize<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read hostSize failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		host <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> hostSize<span class="token punctuation">)</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> host<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read host failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		addr <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span>
	<span class="token keyword">case</span> atypeIPV6<span class="token punctuation">:</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;IPv6: no supported yet&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;invalid atyp&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read port failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	port <span class="token operator">:=</span> binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">.</span><span class="token function">Uint16</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;dial&quot;</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// |VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// | 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// VER socks\u7248\u672C\uFF0C\u8FD9\u91CC\u4E3A0x05</span>
	<span class="token comment">// REP Relay field,\u5185\u5BB9\u53D6\u503C\u5982\u4E0B X\u201900\u2019 succeeded</span>
	<span class="token comment">// RSV \u4FDD\u7559\u5B57\u6BB5</span>
	<span class="token comment">// ATYPE \u5730\u5740\u7C7B\u578B</span>
	<span class="token comment">// BND.ADDR \u670D\u52A1\u7ED1\u5B9A\u7684\u5730\u5740</span>
	<span class="token comment">// BND.PORT \u670D\u52A1\u7ED1\u5B9A\u7684\u7AEF\u53E3DST.PORT</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;write failed: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="relay-\u9636\u6BB5" tabindex="-1"><a class="header-anchor" href="#relay-\u9636\u6BB5" aria-hidden="true">#</a> relay \u9636\u6BB5</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;encoding/binary&quot;</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> socks5Ver <span class="token operator">=</span> <span class="token number">0x05</span>
<span class="token keyword">const</span> cmdBind <span class="token operator">=</span> <span class="token number">0x01</span>
<span class="token keyword">const</span> atypIPV4 <span class="token operator">=</span> <span class="token number">0x01</span>
<span class="token keyword">const</span> atypeHOST <span class="token operator">=</span> <span class="token number">0x03</span>
<span class="token keyword">const</span> atypeIPV6 <span class="token operator">=</span> <span class="token number">0x04</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	server<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1:1080&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		client<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Accept failed %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> <span class="token function">auth</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;client %v auth failed:%v&quot;</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;client %v auth failed:%v&quot;</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">auth</span><span class="token punctuation">(</span>reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// +----+----------+----------+</span>
	<span class="token comment">// |VER | NMETHODS | METHODS  |</span>
	<span class="token comment">// +----+----------+----------+</span>
	<span class="token comment">// | 1  |    1     | 1 to 255 |</span>
	<span class="token comment">// +----+----------+----------+</span>
	<span class="token comment">// VER: \u534F\u8BAE\u7248\u672C\uFF0Csocks5\u4E3A0x05</span>
	<span class="token comment">// NMETHODS: \u652F\u6301\u8BA4\u8BC1\u7684\u65B9\u6CD5\u6570\u91CF</span>
	<span class="token comment">// METHODS: \u5BF9\u5E94NMETHODS\uFF0CNMETHODS\u7684\u503C\u4E3A\u591A\u5C11\uFF0CMETHODS\u5C31\u6709\u591A\u5C11\u4E2A\u5B57\u8282\u3002RFC\u9884\u5B9A\u4E49\u4E86\u4E00\u4E9B\u503C\u7684\u542B\u4E49\uFF0C\u5185\u5BB9\u5982\u4E0B:</span>
	<span class="token comment">// X\u201900\u2019 NO AUTHENTICATION REQUIRED</span>
	<span class="token comment">// X\u201902\u2019 USERNAME/PASSWORD</span>

	ver<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read ver failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> ver <span class="token operator">!=</span> socks5Ver <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not supported ver:%v&quot;</span><span class="token punctuation">,</span> ver<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	methodSize<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read methodSize failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	method <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> methodSize<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> method<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read method failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// +----+--------+</span>
	<span class="token comment">// |VER | METHOD |</span>
	<span class="token comment">// +----+--------+</span>
	<span class="token comment">// | 1  |   1    |</span>
	<span class="token comment">// +----+--------+</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>socks5Ver<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;write failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">connect</span><span class="token punctuation">(</span>reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// |VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// | 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// VER \u7248\u672C\u53F7\uFF0Csocks5\u7684\u503C\u4E3A0x05</span>
	<span class="token comment">// CMD 0x01\u8868\u793ACONNECT\u8BF7\u6C42</span>
	<span class="token comment">// RSV \u4FDD\u7559\u5B57\u6BB5\uFF0C\u503C\u4E3A0x00</span>
	<span class="token comment">// ATYP \u76EE\u6807\u5730\u5740\u7C7B\u578B\uFF0CDST.ADDR\u7684\u6570\u636E\u5BF9\u5E94\u8FD9\u4E2A\u5B57\u6BB5\u7684\u7C7B\u578B\u3002</span>
	<span class="token comment">//   0x01\u8868\u793AIPv4\u5730\u5740\uFF0CDST.ADDR\u4E3A4\u4E2A\u5B57\u8282</span>
	<span class="token comment">//   0x03\u8868\u793A\u57DF\u540D\uFF0CDST.ADDR\u662F\u4E00\u4E2A\u53EF\u53D8\u957F\u5EA6\u7684\u57DF\u540D</span>
	<span class="token comment">// DST.ADDR \u4E00\u4E2A\u53EF\u53D8\u957F\u5EA6\u7684\u503C</span>
	<span class="token comment">// DST.PORT \u76EE\u6807\u7AEF\u53E3\uFF0C\u56FA\u5B9A2\u4E2A\u5B57\u8282</span>

	buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read header failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ver<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> atyp <span class="token operator">:=</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> ver <span class="token operator">!=</span> socks5Ver <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not supported ver:%v&quot;</span><span class="token punctuation">,</span> ver<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> cmd <span class="token operator">!=</span> cmdBind <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not supported cmd:%v&quot;</span><span class="token punctuation">,</span> ver<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>
	<span class="token keyword">switch</span> atyp <span class="token punctuation">{</span>
	<span class="token keyword">case</span> atypIPV4<span class="token punctuation">:</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read atyp failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		addr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d.%d.%d.%d&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> atypeHOST<span class="token punctuation">:</span>
		hostSize<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read hostSize failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		host <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> hostSize<span class="token punctuation">)</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> host<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read host failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		addr <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span>
	<span class="token keyword">case</span> atypeIPV6<span class="token punctuation">:</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;IPv6: no supported yet&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;invalid atyp&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;read port failed:%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	port <span class="token operator">:=</span> binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">.</span><span class="token function">Uint16</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;dial&quot;</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// |VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// | 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |</span>
	<span class="token comment">// +----+-----+-------+------+----------+----------+</span>
	<span class="token comment">// VER socks\u7248\u672C\uFF0C\u8FD9\u91CC\u4E3A0x05</span>
	<span class="token comment">// REP Relay field,\u5185\u5BB9\u53D6\u503C\u5982\u4E0B X\u201900\u2019 succeeded</span>
	<span class="token comment">// RSV \u4FDD\u7559\u5B57\u6BB5</span>
	<span class="token comment">// ATYPE \u5730\u5740\u7C7B\u578B</span>
	<span class="token comment">// BND.ADDR \u670D\u52A1\u7ED1\u5B9A\u7684\u5730\u5740</span>
	<span class="token comment">// BND.PORT \u670D\u52A1\u7ED1\u5B9A\u7684\u7AEF\u53E3DST.PORT</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;write failed: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="end-\u94FE\u63A5" tabindex="-1"><a class="header-anchor" href="#end-\u94FE\u63A5" aria-hidden="true">#</a> END \u94FE\u63A5</h2>`,15),G=s("\u56DE\u5230\u76EE\u5F55"),Q=s("\u4E0A\u4E00\u8282"),j=s("\u4E0B\u4E00\u8282"),J=n("hr",null,null,-1),Z={href:"https://github.com/3293172751/Block_Chain/blob/master/Git/git-contributor.md",target:"_blank",rel:"noopener noreferrer"},$=s("\u53C2\u4E0E\u8D21\u732E\u2764\uFE0F\u{1F495}\u{1F495}");function nn(sn,an){const t=o("ExternalLinkIcon"),p=o("RouterLink");return l(),i("div",null,[n("ul",null,[n("li",null,[n("a",k,[d,a(t)])])]),v,n("ul",null,[n("li",null,[a(p,{to:"/go-advancend/"},{default:e(()=>[m]),_:1})]),n("li",null,[a(p,{to:"/go-advancend/markdown/23.html"},{default:e(()=>[b]),_:1})])]),n("blockquote",null,[n("p",null,[f,n("a",y,[w,a(t)])])]),n("h3",h,[g,q,n("strong",null,[n("a",_,[R,a(t)])])]),n("h3",E,[S,D,n("strong",null,[n("a",T,[x,a(t)])])]),P,O,V,n("ul",null,[n("li",null,[n("a",N,[A,a(t)])])]),C,n("ul",null,[H,M,n("li",null,[I,n("a",B,[z,a(t)]),F]),U,X,W,L,Y]),K,n("ul",null,[n("li",null,[a(p,{to:"/go-advancend/"},{default:e(()=>[G]),_:1})]),n("li",null,[a(p,{to:"/go-advancend/markdown/23.html"},{default:e(()=>[Q]),_:1})]),n("li",null,[a(p,{to:"/go-advancend/markdown/25.html"},{default:e(()=>[j]),_:1})])]),J,n("ul",null,[n("li",null,[n("a",Z,[$,a(t)])])])])}const pn=c(r,[["render",nn],["__file","24.html.vue"]]);export{pn as default};
