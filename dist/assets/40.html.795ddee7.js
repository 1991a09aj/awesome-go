import{_ as r,r as d,o as c,c as t,a as e,b as a,w as l,e as n,d as u}from"./app.798d5e9d.js";const v={},m={href:"https://github.com/3293172751",target:"_blank",rel:"noopener noreferrer"},o=n("author"),p=e("h1",{id:"\u7B2C40\u8282-\u4E00\u7AD9\u5F0Fgolang\u5185\u5B58\u6D17\u9AD3\u7ECF-\u8282\u9009",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#\u7B2C40\u8282-\u4E00\u7AD9\u5F0Fgolang\u5185\u5B58\u6D17\u9AD3\u7ECF-\u8282\u9009","aria-hidden":"true"},"#"),n(" \u7B2C40\u8282 \u4E00\u7AD9\u5F0FGolang\u5185\u5B58\u6D17\u9AD3\u7ECF(\u8282\u9009)")],-1),b=n("\u56DE\u5230\u76EE\u5F55"),h=n("\u4E0A\u4E00\u8282"),f=n("\u2764\uFE0F\u{1F495}\u{1F495}Go\u8BED\u8A00\u9AD8\u7EA7\u7BC7\u7AE0,\u5728\u6B64\u4E4B\u524D\u5EFA\u8BAE\u60A8\u5148\u4E86\u89E3\u57FA\u7840\u548C\u8FDB\u9636\u7BC7\u3002Myblog:"),g={href:"http://nsddd.top/",target:"_blank",rel:"noopener noreferrer"},C=n("http://nsddd.top"),B={id:"go\u8BED\u8A00\u57FA\u7840\u7BC7",tabindex:"-1"},S=e("a",{class:"header-anchor",href:"#go\u8BED\u8A00\u57FA\u7840\u7BC7","aria-hidden":"true"},"#",-1),x=n(),P={href:"https://github.com/cubxxw/awesome-cs-cloudnative-blockchain/blob/master/TOC.md",target:"_blank",rel:"noopener noreferrer"},M=n("Go\u8BED\u8A00\u57FA\u7840\u7BC7"),_={id:"go\u8BED\u8A00100\u7BC7\u8FDB\u9636",tabindex:"-1"},y=e("a",{class:"header-anchor",href:"#go\u8BED\u8A00100\u7BC7\u8FDB\u9636","aria-hidden":"true"},"#",-1),T=n(),z={href:"https://github.com/cubxxw/awesome-cs-cloudnative-blockchain/blob/master/Gomd_super/README.md",target:"_blank",rel:"noopener noreferrer"},G=n("Go\u8BED\u8A00100\u7BC7\u8FDB\u9636"),k=e("hr",null,null,-1),L=e("p",null,"[TOC]",-1),w=e("h2",{id:"\u524D\u8A00",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#\u524D\u8A00","aria-hidden":"true"},"#"),n(" \u524D\u8A00")],-1),q=n("\u672C\u7BC7\u6587\u7AE0\u5DF2\u6536\u5F55\u4E8E\u300AGolang \u4FEE\u517B\u4E4B\u8DEF\u300B"),H={href:"https://www.yuque.com/aceld/golang/ithv8f",target:"_blank",rel:"noopener noreferrer"},j=n("www.yuque.com/aceld/golang/ithv8f"),A=n(" \u7B2C\u4E00\u7AE0\u7B2C 9 \u7BC7"),N=u(`<p>Golang \u7684\u5185\u5B58\u7BA1\u7406\u53CA\u8BBE\u8BA1\u4E5F\u662F\u5F00\u53D1\u8005\u9700\u8981\u4E86\u89E3\u7684\u9886\u57DF\u4E4B\u4E00\uFF0C\u8981\u7406\u89E3 Go \u8BED\u8A00\u7684\u5185\u5B58\u7BA1\u7406\uFF0C\u5C31\u5FC5\u987B\u5148\u7406\u89E3\u64CD\u4F5C\u7CFB\u7EDF\u4EE5\u53CA\u673A\u5668\u786C\u4EF6\u662F\u5982\u4F55\u7BA1\u7406\u5185\u5B58\u7684\u3002\u56E0\u4E3A Go \u8BED\u8A00\u7684\u5185\u90E8\u673A\u5236\u662F\u5EFA\u7ACB\u5728\u8FD9\u4E2A\u57FA\u7840\u4E4B\u4E0A\u7684\uFF0C\u5B83\u7684\u8BBE\u8BA1\uFF0C\u672C\u8D28\u4E0A\u5C31\u662F\u5C3D\u53EF\u80FD\u7684\u4F1A\u53D1\u6325\u64CD\u4F5C\u7CFB\u7EDF\u5C42\u9762\u7684\u4F18\u52BF\uFF0C\u800C\u907F\u5F00\u5BFC\u81F4\u4F4E\u6548\u60C5\u51B5\u3002</p><p>\u672C\u7AE0\u8282\u4F1A\u56F4\u7ED5\u4EE5\u4E0B\u516D\u4E2A\u8BDD\u9898\u9010\u6B65\u5C55\u5F00\u3002</p><p>\uFF081\uFF09\u4F55\u4E3A\u5185\u5B58\u3002</p><p>\uFF082\uFF09\u5185\u5B58\u4E3A\u4EC0\u4E48\u9700\u8981\u7BA1\u7406\u3002</p><p>\uFF083\uFF09\u64CD\u4F5C\u7CFB\u7EDF\u662F\u5982\u4F55\u7BA1\u7406\u5185\u5B58\u7684\u3002</p><p>\uFF084\uFF09\u5982\u4F55\u7528 Golang \u81EA\u5DF1\u5B9E\u73B0\u4E00\u4E2A\u5185\u5B58\u7BA1\u7406\u6A21\u578B\u3002</p><p>\uFF085\uFF09Golang \u5185\u5B58\u7BA1\u7406\u4E4B\u9B42\uFF1ATCMalloc\u3002</p><p>\uFF086\uFF09Golang \u4E2D\u662F\u5982\u4F55\u7BA1\u7406\u5185\u5B58\u7684\u3002</p><h2 id="_1-\u4F55\u4E3A\u5185\u5B58" tabindex="-1"><a class="header-anchor" href="#_1-\u4F55\u4E3A\u5185\u5B58" aria-hidden="true">#</a> 1 \u4F55\u4E3A\u5185\u5B58</h2><p>\u8BF4\u5230\u5185\u5B58\uFF0C\u53CA\u65F6\u6CA1\u6709\u4EFB\u4F55\u7684\u8F6F\u4EF6\u57FA\u7840\u77E5\u8BC6\uFF0C\u90A3\u4E48\u7B2C\u4E00\u5370\u8C61\u5E94\u8BE5\u60F3\u5230\u7684\u662F\u5982\u4E0B\u5B9E\u7269\uFF0C\u5982\u56FE 1 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/zlvD7RteFS.png!large" alt="awsef"></p><h3 id="\u56FE-1-\u7269\u7406\u5185\u5B58\u6761" tabindex="-1"><a class="header-anchor" href="#\u56FE-1-\u7269\u7406\u5185\u5B58\u6761" aria-hidden="true">#</a> \u56FE 1 \u7269\u7406\u5185\u5B58\u6761</h3><p>\u56FE 1 \u4E2D\u5E38\u88AB\u79F0\u4E4B\u4E3A\u5185\u5B58\u6761\uFF0C\u662F\u8BA1\u7B97\u673A\u786C\u4EF6\u7EC4\u6210\u7684\u4E00\u4E2A\u90E8\u5206\uFF0C\u4E5F\u662F\u771F\u6B63\u7ED9\u8F6F\u4EF6\u63D0\u4F9B\u5185\u5B58\u7684\u7269\u7406\u7A7A\u95F4\u3002\u5982\u679C\u8BA1\u7B97\u673A\u6CA1\u6709\u5185\u5B58\u6761\uFF0C\u90A3\u4E48\u6839\u672C\u8C08\u4E0D\u4E0A\u6709\u5185\u5B58\u4E4B\u8BF4\u3002</p><p>\u90A3\u4E48\u5185\u5B58\u7684\u4F5C\u7528\u5728\u4E8E\u4EC0\u4E48\u5462\uFF1F\u5982\u679C\u5C06\u8BA1\u7B97\u673A\u7684\u5B58\u50A8\u5A92\u4ECB\u4E2D\u7684\u5904\u7406\u6027\u80FD\u4E0E\u5BB9\u91CF\u505A\u4E00\u4E2A\u5BF9\u6BD4\uFF0C\u4F1A\u51FA\u73B0\u5982\u4E0B\u7684\u91D1\u5B57\u5854\u6A21\u578B\uFF0C\u5982\u56FE 2 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/1dphL5SMT9.png!large" alt="awsef"></p><h3 id="\u56FE-2-\u8BA1\u7B97\u673A\u5B58\u50A8\u5A92\u4ECB\u91D1\u5B57\u5854\u6A21\u578B" tabindex="-1"><a class="header-anchor" href="#\u56FE-2-\u8BA1\u7B97\u673A\u5B58\u50A8\u5A92\u4ECB\u91D1\u5B57\u5854\u6A21\u578B" aria-hidden="true">#</a> \u56FE 2 \u8BA1\u7B97\u673A\u5B58\u50A8\u5A92\u4ECB\u91D1\u5B57\u5854\u6A21\u578B</h3><p>\u4ECE\u56FE\u4E2D\u53EF\u4EE5\u5F97\u51FA\u5904\u7406\u901F\u5EA6\u4E0E\u5B58\u50A8\u5BB9\u91CF\u662F\u6210\u53CD\u6BD4\u7684\u3002\u4E5F\u5C31\u662F\u8BF4\uFF0C\u6027\u80FD\u8D8A\u5927\u7684\u8BA1\u7B97\u673A\u786C\u4EF6\u8D44\u6E90\uFF0C\u8D8A\u662F\u7A00\u7F3A\uFF0C\u6240\u4EE5\u5408\u7406\u7684\u5229\u7528\u548C\u5206\u914D\u5C31\u8D8A\u91CD\u8981\u3002</p><p>\u6BD4\u5982\u5185\u5B58\u4E0E\u786C\u76D8\u7684\u5BF9\u6BD4\uFF0C\u56E0\u4E3A\u786C\u76D8\u7684\u5BB9\u91CF\u662F\u975E\u5E38\u5EC9\u4EF7\u7684\uFF0C\u867D\u7136\u5185\u5B58\u76EE\u524D\u4E5F\u53EF\u4EE5\u7528\u5230 10G \u7EA7\u522B\u7684\u4F7F\u7528\uFF0C\u4F46\u662F\u4ECE\u5904\u7406\u901F\u5EA6\u6765\u770B\u7684\u8BDD\uFF0C\u4E24\u8005\u7684\u5DEE\u8DDD\u8FD8\u662F\u76F8\u5DEE\u751A\u5927\u7684\uFF0C\u5177\u4F53\u5982\u8868 1 \u6240\u793A\u3002</p><h3 id="\u8868-1-\u786C\u76D8\u4E0E\u5185\u5B58\u5BF9\u6BD4\u8868" tabindex="-1"><a class="header-anchor" href="#\u8868-1-\u786C\u76D8\u4E0E\u5185\u5B58\u5BF9\u6BD4\u8868" aria-hidden="true">#</a> \u8868 1 \u786C\u76D8\u4E0E\u5185\u5B58\u5BF9\u6BD4\u8868</h3><p><img src="http://sm.nsddd.top/sm202303031006244.png" alt="image-20230303100620097"></p><p>\u6240\u4EE5\u5C06\u5927\u90E8\u5206\u7A0B\u5E8F\u903B\u8F91\u4E34\u65F6\u7528\u7684\u6570\u636E\uFF0C\u5168\u90E8\u90FD\u5B58\u5728\u5185\u5B58\u4E4B\u4E2D\uFF0C\u6BD4\u5982\uFF0C\u53D8\u91CF\u3001\u5168\u5C40\u53D8\u91CF\u3001\u51FD\u6570\u8DF3\u8F6C\u5730\u5740\u3001\u9759\u6001\u5E93\u3001\u6267\u884C\u4EE3\u7801\u3001\u4E34\u65F6\u5F00\u8F9F\u7684\u5185\u5B58\u7ED3\u6784\u4F53\uFF08\u5BF9\u8C61\uFF09\u7B49\u3002</p><h2 id="_2-\u5185\u5B58\u4E3A\u4EC0\u4E48\u9700\u8981\u7BA1\u7406" tabindex="-1"><a class="header-anchor" href="#_2-\u5185\u5B58\u4E3A\u4EC0\u4E48\u9700\u8981\u7BA1\u7406" aria-hidden="true">#</a> 2 \u5185\u5B58\u4E3A\u4EC0\u4E48\u9700\u8981\u7BA1\u7406</h2><p>\u5F53\u5B58\u50A8\u7684\u4E1C\u897F\u8D8A\u6765\u8D8A\u591A\uFF0C\u4E5F\u5C31\u53D1\u73B0\u7269\u7406\u5185\u5B58\u7684\u5BB9\u91CF\u4F9D\u7136\u662F\u4E0D\u591F\u7528\uFF0C\u90A3\u4E48\u5BF9\u7269\u7406\u5185\u5B58\u7684\u5229\u7528\u7387\u548C\u5408\u7406\u7684\u5206\u914D\uFF0C\u7BA1\u7406\u5C31\u53D8\u5F97\u975E\u5E38\u7684\u91CD\u8981\u3002</p><p>\uFF081\uFF09\u64CD\u4F5C\u7CFB\u7EDF\u5C31\u4F1A\u5BF9\u5185\u5B58\u8FDB\u884C\u975E\u5E38\u8BE6\u7EC6\u7684\u7BA1\u7406\u3002</p><p>\uFF082\uFF09\u57FA\u4E8E\u64CD\u4F5C\u7CFB\u7EDF\u7684\u57FA\u7840\u4E0A\uFF0C\u4E0D\u540C\u8BED\u8A00\u7684\u5185\u5B58\u7BA1\u7406\u673A\u5236\u4E5F\u5E94\u5141\u800C\u751F\uFF0C\u6709\u7684\u4E00\u4E9B\u8BED\u8A00\u5E76\u6CA1\u6709\u63D0\u4F9B\u81EA\u52A8\u7684\u5185\u5B58\u7BA1\u7406\u6A21\u5F0F\uFF0C\u6709\u7684\u8BED\u8A00\u5C31\u5DF2\u7ECF\u63D0\u4F9B\u4E86\u81EA\u8EAB\u7A0B\u5E8F\u7684\u5185\u5B58\u7BA1\u7406\u6A21\u5F0F\uFF0C\u5982\u8868 2 \u6240\u793A\u3002</p><h3 id="\u8868-2-\u81EA\u52A8\u4E0E\u975E\u81EA\u52A8\u5185\u5B58\u7BA1\u7406\u7684\u8BED\u8A00" tabindex="-1"><a class="header-anchor" href="#\u8868-2-\u81EA\u52A8\u4E0E\u975E\u81EA\u52A8\u5185\u5B58\u7BA1\u7406\u7684\u8BED\u8A00" aria-hidden="true">#</a> \u8868 2 \u81EA\u52A8\u4E0E\u975E\u81EA\u52A8\u5185\u5B58\u7BA1\u7406\u7684\u8BED\u8A00</h3><table><thead><tr><th><strong>\u5185\u5B58\u81EA\u52A8\u7BA1\u7406\u7684\u8BED\u8A00\uFF08\u90E8\u5206\uFF09</strong></th><th><strong>\u5185\u5B58\u975E\u81EA\u52A8\u7BA1\u7406\u7684\u8BED\u8A00\uFF08\u90E8\u5206\uFF09</strong></th></tr></thead><tbody><tr><td>Golang</td><td>C</td></tr><tr><td>Java</td><td>C++</td></tr><tr><td>Python</td><td>Rust</td></tr></tbody></table><p>\u6240\u4EE5\u4E3A\u4E86\u964D\u4F4E\u5185\u5B58\u7BA1\u7406\u7684\u96BE\u5EA6\uFF0C\u50CF C\u3001C++ \u8FD9\u6837\u7684\u7F16\u7A0B\u8BED\u8A00\u4F1A\u5B8C\u5168\u5C06\u5206\u914D\u548C\u56DE\u6536\u5185\u5B58\u7684\u6743\u9650\u4EA4\u7ED9\u5F00\u53D1\u8005\uFF0C\u800C Rust \u5219\u662F\u901A\u8FC7\u751F\u547D\u5468\u671F\u9650\u5B9A\u5F00\u53D1\u8005\u5BF9\u975E\u6CD5\u6743\u9650\u5185\u5B58\u7684\u8BBF\u95EE\u6765\u81EA\u52A8\u56DE\u6536\uFF0C\u56E0\u800C\u5E76\u6CA1\u6709\u63D0\u4F9B\u81EA\u52A8\u7BA1\u7406\u7684\u4E00\u5957\u673A\u5236\u3002\u4F46\u662F\u50CF Golang\u3001Java\u3001Python \u8FD9\u7C7B\u4E3A\u4E86\u5B8C\u5168\u8BA9\u5F00\u53D1\u5219\u5173\u6CE8\u4EE3\u7801\u903B\u8F91\u672C\u8EAB\uFF0C\u8BED\u8A00\u5C42\u63D0\u4F9B\u4E86\u4E00\u5957\u7BA1\u7406\u6A21\u5F0F\u3002\u56E0\u4E3A Golang \u7F16\u7A0B\u8BED\u8A00\u7ED9\u5F00\u53D1\u8005\u63D0\u4F9B\u4E86\u4E00\u5957\u5185\u5B58\u7BA1\u7406\u6A21\u5F0F\uFF0C\u6240\u4EE5\u5F00\u53D1\u8005\u6709\u5FC5\u8981\u4E86\u89E3\u4E00\u4E0B Golang \u505A\u4E86\u54EA\u4E9B\u52A9\u529B\u7684\u529F\u80FD\u3002</p><p>\u5728\u7406\u89E3 Golang \u8BED\u8A00\u5C42\u5185\u5B58\u7BA1\u7406\u4E4B\u524D\uFF0C\u5E94\u5148\u4E86\u89E3\u64CD\u4F5C\u7CFB\u7EDF\u9488\u5BF9\u7269\u7406\u5185\u5B58\u505A\u4E86\u54EA\u4E9B\u7BA1\u7406\u7684\u65B9\u5F0F\u3002\u5F53\u63D2\u4E0A\u5185\u5B58\u6761\u4E4B\u540E\uFF0C\u901A\u8FC7\u64CD\u4F5C\u7CFB\u7EDF\u662F\u5982\u4F55\u5C06\u8F6F\u4EF6\u5B58\u653E\u5728\u8FD9\u4E2A\u7EFF\u8272\u7684\u7269\u7406\u5185\u5B58\u6761\u4E2D\u53BB\u7684\u3002</p><h2 id="_3-\u64CD\u4F5C\u7CFB\u7EDF\u662F\u5982\u4F55\u7BA1\u7406\u5185\u5B58\u7684" tabindex="-1"><a class="header-anchor" href="#_3-\u64CD\u4F5C\u7CFB\u7EDF\u662F\u5982\u4F55\u7BA1\u7406\u5185\u5B58\u7684" aria-hidden="true">#</a> 3 \u64CD\u4F5C\u7CFB\u7EDF\u662F\u5982\u4F55\u7BA1\u7406\u5185\u5B58\u7684</h2><p>\u8BA1\u7B97\u673A\u5BF9\u4E8E\u5185\u5B58\u771F\u6B63\u7684\u8F7D\u4F53\u662F\u7269\u7406\u5185\u5B58\u6761\uFF0C\u8FD9\u4E2A\u662F\u5B9E\u6253\u5B9E\u7684\u7269\u7406\u786C\u4EF6\u5BB9\u91CF\uFF0C\u6240\u4EE5\u5728\u64CD\u4F5C\u7CFB\u7EDF\u4E2D\u5B9A\u4E49\u8FD9\u90E8\u95E8\u7684\u5BB9\u91CF\u53EB\u7269\u7406\u5185\u5B58\u3002</p><p>\u5B9E\u5219\u7269\u7406\u5185\u5B58\u7684\u5E03\u5C40\u5B9E\u9645\u4E0A\u5C31\u662F\u4E00\u4E2A\u5185\u5B58\u5927\u6570\u7EC4\uFF0C\u5982\u56FE 3 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/G72Sqei8Um.png!large" alt="awsef"></p><h3 id="\u56FE-3-\u7269\u7406\u5185\u5B58\u5E03\u5C40" tabindex="-1"><a class="header-anchor" href="#\u56FE-3-\u7269\u7406\u5185\u5B58\u5E03\u5C40" aria-hidden="true">#</a> \u56FE 3 \u7269\u7406\u5185\u5B58\u5E03\u5C40</h3><p>\u6BCF\u4E00\u4E2A\u5143\u7D20\u90FD\u4F1A\u5BF9\u5E94\u4E00\u4E2A\u5730\u5740\uFF0C\u79F0\u4E4B\u4E3A\u7269\u7406\u5185\u5B58\u5730\u5740\u3002\u90A3\u4E48 CPU \u5728\u8FD0\u7B97\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u5982\u679C\u9700\u8981\u4ECE\u5185\u5B58\u4E2D\u53D6 1 \u4E2A\u5B57\u8282\u7684\u6570\u636E\uFF0C\u5C31\u9700\u8981\u57FA\u4E8E\u8FD9\u4E2A\u6570\u636E\u7684\u7269\u7406\u5185\u5B58\u5730\u5740\u53BB\u8FD0\u7B97\u5373\u53EF\uFF0C\u800C\u4E14\u7269\u7406\u5185\u5B58\u5730\u5740\u662F\u8FDE\u7EED\u7684\uFF0C\u53EF\u4EE5\u6839\u636E\u4E00\u4E2A\u57FA\u51C6\u5730\u5740\u8FDB\u884C\u504F\u79FB\u6765\u53D6\u5F97\u76F8\u5E94\u7684\u4E00\u5757\u8FDE\u7EED\u5185\u5B58\u6570\u636E\u3002</p><p>\u4E00\u4E2A\u64CD\u4F5C\u7CFB\u7EDF\u662F\u4E0D\u53EF\u80FD\u53EA\u8FD0\u884C\u4E00\u4E2A\u7A0B\u5E8F\u7684\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u5927\u6570\u7EC4\u7269\u7406\u5185\u5B58\u52BF\u5FC5\u8981\u88AB N \u4E2A\u7A0B\u5E8F\u5206\u6210 N \u5206\uFF0C\u4F9B\u6BCF\u4E2A\u7A0B\u5E8F\u4F7F\u7528\u3002\u4F46\u662F\u7A0B\u5E8F\u662F\u6D3B\u7684\uFF0C\u4E00\u4E2A\u7A0B\u5E8F\u53EF\u80FD\u4E00\u4F1A\u9700\u8981 1MB \u7684\u5185\u5B58\uFF0C\u4E00\u4F1A\u53C8\u9700\u8981 1GB \u7684\u5185\u5B58\u3002\u64CD\u4F5C\u7CFB\u7EDF\u53EA\u80FD\u53D6\u8FD9\u4E2A\u7A0B\u5E8F\u5141\u8BB8\u7684\u6700\u5927\u5185\u5B58\u6781\u9650\u6765\u5206\u914D\u5185\u5B58\u7ED9\u8FD9\u4E2A\u8FDB\u7A0B\uFF0C\u4F46\u8FD9\u6837\u4F1A\u5BFC\u81F4\u6BCF\u4E2A\u8FDB\u7A0B\u90FD\u4F1A\u591A\u8981\u53BB\u4E00\u5927\u90E8\u5206\u5185\u5B58\uFF0C\u800C\u8FD9\u4E9B\u591A\u8981\u7684\u5185\u5B58\u5374\u5927\u6982\u7387\u4E0D\u4F1A\u88AB\u4F7F\u7528\uFF0C\u5982\u56FE 4 \u6240\u793A\u3002<img src="https://cdn.learnku.com/uploads/images/202205/23/58489/IQZQ8Vfysj.png!large" alt="awsef"></p><h3 id="\u56FE-4-\u7269\u7406\u5185\u5B58\u5206\u914D\u7684\u56F0\u5C40" tabindex="-1"><a class="header-anchor" href="#\u56FE-4-\u7269\u7406\u5185\u5B58\u5206\u914D\u7684\u56F0\u5C40" aria-hidden="true">#</a> \u56FE 4 \u7269\u7406\u5185\u5B58\u5206\u914D\u7684\u56F0\u5C40</h3><p>\u5F53 N \u4E2A\u7A0B\u5E8F\u540C\u65F6\u4F7F\u7528\u540C\u4E00\u5757\u5185\u5B58\u65F6\uFF0C\u90A3\u4E48\u4EA7\u751F\u8BFB\u5199\u7684\u51B2\u7A81\u4E5F\u5728\u6240\u96BE\u514D\u3002\u8FD9\u6837\u5C31\u4F1A\u5BFC\u81F4\u8FD9\u4E9B\u6602\u8D35\u7684\u7269\u7406\u5185\u5B58\u6761\uFF0C\u51E0\u4E4E\u8DD1\u4E0D\u4E86\u51E0\u4E2A\u7A0B\u5E8F\uFF0C\u5185\u5B58\u7684\u5229\u7528\u7387\u4E5F\u5C31\u63D0\u9AD8\u4E0D\u4E0A\u6765\u3002</p><p>\u6240\u4EE5\u5C31\u5F15\u51FA\u4E86\u64CD\u4F5C\u7CFB\u7EDF\u7684\u5185\u5B58\u7BA1\u7406\u65B9\u5F0F\uFF0C\u64CD\u4F5C\u7CFB\u7EDF\u63D0\u4F9B\u4E86\u865A\u62DF\u5185\u5B58\u6765\u89E3\u51B3\u8FD9\u4EF6\u4E8B\u3002</p><h3 id="_3-1-\u865A\u62DF\u5185\u5B58" tabindex="-1"><a class="header-anchor" href="#_3-1-\u865A\u62DF\u5185\u5B58" aria-hidden="true">#</a> 3.1 \u865A\u62DF\u5185\u5B58</h3><p>\u6240\u8C13\u865A\u62DF\uFF0C\u7C7B\u4F3C\u662F\u5047\u3001\u51ED\u7A7A\u800C\u9020\u7684\u5927\u81F4\u610F\u601D\u3002\u5BF9\u6BD4\u4E0A\u56FE 3.3 \u6240\u793A\u7684\u7269\u7406\u5185\u5B58\u5E03\u5C40\uFF0C\u865A\u62DF\u5185\u5B58\u7684\u5927\u81F4\u8868\u73B0\u65B9\u5F0F\u5982\u56FE 5 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/wPo2lh1X0C.png!large" alt="awsef"></p><h3 id="\u56FE-5-\u865A\u62DF\u5185\u5B58\u5E03\u5C40" tabindex="-1"><a class="header-anchor" href="#\u56FE-5-\u865A\u62DF\u5185\u5B58\u5E03\u5C40" aria-hidden="true">#</a> \u56FE 5 \u865A\u62DF\u5185\u5B58\u5E03\u5C40<a href="#2947cb">#</a></h3><p>\u865A\u62DF\u5185\u5B58\u5730\u5740\u662F\u57FA\u4E8E\u7269\u7406\u5185\u5B58\u5730\u5740\u4E4B\u4E0A\u51ED\u7A7A\u800C\u9020\u7684\u4E00\u4E2A\u65B0\u7684\u903B\u8F91\u5730\u5740\uFF0C\u800C\u64CD\u4F5C\u7CFB\u7EDF\u66B4\u9732\u7ED9\u7528\u6237\u8FDB\u7A0B\u7684\u53EA\u662F\u865A\u62DF\u5185\u5B58\u5730\u5740\uFF0C\u64CD\u4F5C\u7CFB\u7EDF\u5185\u90E8\u4F1A\u5BF9\u865A\u62DF\u5185\u5B58\u5730\u5740\u548C\u771F\u5B9E\u7684\u7269\u7406\u5185\u5B58\u5730\u5740\u505A\u6620\u5C04\u5173\u7CFB\uFF0C\u6765\u7BA1\u7406\u5730\u5740\u7684\u5206\u914D\uFF0C\u4ECE\u800C\u4F7F\u7269\u7406\u5185\u5B58\u7684\u5229\u7528\u7387\u63D0\u9AD8\u3002</p><p>\u8FD9\u6837\u7528\u6237\u7A0B\u5E8F\uFF08\u8FDB\u7A0B\uFF09\u53EA\u80FD\u4F7F\u7528\u865A\u62DF\u7684\u5185\u5B58\u5730\u5740\u6765\u83B7\u53D6\u6570\u636E\uFF0C\u7CFB\u7EDF\u4F1A\u5C06\u8FD9\u4E2A\u865A\u62DF\u5730\u5740\u7FFB\u8BD1\u6210\u5B9E\u9645\u7684\u7269\u7406\u5730\u5740\u3002\u8FD9\u91CC\u9762\u6BCF\u4E00\u4E2A\u7A0B\u5E8F\u7EDF\u4E00\u4F7F\u7528\u4E00\u5957\u8FDE\u7EED\u865A\u62DF\u5730\u5740\uFF0C\u6BD4\u5982 0x 0000 0000 ~ 0x ffff ffff\u3002\u4ECE\u7A0B\u5E8F\u7684\u89D2\u5EA6\u6765\u770B\uFF0C\u5B83\u89C9\u5F97\u81EA\u5DF1\u72EC\u4EAB\u4E86\u4E00\u6574\u5757\u5185\u5B58\uFF0C\u4E14\u4E0D\u7528\u8003\u8651\u8BBF\u95EE\u51B2\u7A81\u7684\u95EE\u9898\u3002\u7CFB\u7EDF\u4F1A\u5C06\u865A\u62DF\u5730\u5740\u7FFB\u8BD1\u6210\u7269\u7406\u5730\u5740\uFF0C\u4ECE\u5185\u5B58\u4E0A\u52A0\u8F7D\u6570\u636E\u3002</p><p>\u4F46\u5982\u679C\u4EC5\u4EC5\u628A\u865A\u62DF\u5185\u5B58\u76F4\u63A5\u7406\u89E3\u4E3A\u5730\u5740\u7684\u6620\u5C04\u5173\u7CFB\uFF0C\u90A3\u5C31\u662F\u8FC7\u4E8E\u4F4E\u4F30\u865A\u62DF\u5185\u5B58\u7684\u4F5C\u7528\u4E86\u3002</p><p>\u865A\u62DF\u5185\u5B58\u7684\u76EE\u7684\u662F\u4E3A\u4E86\u89E3\u51B3\u4EE5\u4E0B\u51E0\u4EF6\u4E8B\uFF1A</p><p>\uFF081\uFF09\u7269\u7406\u5185\u5B58\u65E0\u6CD5\u88AB\u6700\u5927\u5316\u5229\u7528\u3002</p><p>\uFF082\uFF09\u7A0B\u5E8F\u903B\u8F91\u5185\u5B58\u7A7A\u95F4\u4F7F\u7528\u72EC\u7ACB\u3002</p><p>\uFF083\uFF09\u5185\u5B58\u4E0D\u591F\uFF0C\u7EE7\u7EED\u865A\u62DF\u78C1\u76D8\u7A7A\u95F4\u3002</p><p>\u5BF9\u4E8E\uFF081\uFF09\uFF0C\uFF082\uFF09\u4E24\u70B9\uFF0C\u4E0A\u8FF0\u5E94\u8BE5\u5DF2\u7ECF\u6709\u4E00\u5B9A\u7684\u63CF\u8FF0\u4E86\uFF0C\u5176\u4E2D\u9488\u5BF9\uFF081\uFF09\u7684\u6700\u5927\u5316\uFF0C\u865A\u62DF\u5185\u5B58\u8FD8\u5B9E\u73B0\u4E86 \u201C\u8BFB\u65F6\u5171\u4EAB\uFF0C\u5199\u65F6\u590D\u5236\u201D \u7684\u673A\u5236\uFF0C\u53EF\u4EE5\u5728\u7269\u7406\u5C42\u540C\u4E00\u4E2A\u5B57\u8282\u7684\u5185\u5B58\u5730\u5740\u88AB\u591A\u4E2A\u865A\u62DF\u5185\u5B58\u7A7A\u95F4\u6620\u5C04\uFF0C\u8868\u73B0\u65B9\u5F0F\u5982\u56FE 6 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/sF5qe0wzlq.png!large" alt="awsef"></p><h3 id="\u56FE-6-\u8BFB\u65F6\u5171\u4EAB-\u5199\u65F6\u590D\u5236" tabindex="-1"><a class="header-anchor" href="#\u56FE-6-\u8BFB\u65F6\u5171\u4EAB-\u5199\u65F6\u590D\u5236" aria-hidden="true">#</a> \u56FE 6 \u8BFB\u65F6\u5171\u4EAB\uFF0C\u5199\u65F6\u590D\u5236<a href="#7ecb3a">#</a></h3><p>\u4E0A\u56FE\u6240\u793A\u5982\u679C\u4E00\u4E2A\u8FDB\u7A0B\u9700\u8981\u8FDB\u884C\u5199\u64CD\u4F5C\uFF0C\u5219\u8FD9\u4E2A\u5185\u5B58\u5C06\u4F1A\u88AB\u590D\u5236\u4E00\u4EFD\uFF0C\u6210\u4E3A\u5F53\u524D\u8FDB\u7A0B\u7684\u72EC\u4EAB\u5185\u5B58\u3002\u5982\u679C\u662F\u8BFB\u64CD\u4F5C\uFF0C\u53EF\u80FD\u4F1A\u591A\u4E2A\u8FDB\u7A0B\u8BBF\u95EE\u7684\u7269\u7406\u7A7A\u95F4\u662F\u76F8\u540C\u7684\u7A7A\u95F4\u3002</p><p>\u5982\u679C\u4E00\u4E2A\u5185\u5B58\u51E0\u4E4E\u5927\u91CF\u90FD\u662F\u88AB\u8BFB\u53D6\u7684\uFF0C\u5219\u53EF\u80FD\u4F1A\u591A\u4E2A\u8FDB\u7A0B\u5171\u4EAB\u540C\u4E00\u5757\u7269\u7406\u5185\u5B58\uFF0C\u4F46\u662F\u4ED6\u4EEC\u7684\u5404\u81EA\u865A\u62DF\u5185\u5B58\u662F\u4E0D\u540C\u7684\u3002\u5F53\u7136\u8FD9\u4E2A\u5171\u4EAB\u5E76\u4E0D\u662F\u6C38\u4E45\u7684\uFF0C\u5F53\u5176\u4E2D\u6709\u4E00\u4E2A\u8FDB\u7A0B\u5BF9\u8FD9\u4E2A\u5185\u5B58\u53D1\u751F\u5199\uFF0C\u5C31\u4F1A\u590D\u5236\u4E00\u4EFD\uFF0C\u6267\u884C\u5199\u64CD\u4F5C\u7684\u8FDB\u7A0B\u5C31\u4F1A\u5C06\u865A\u62DF\u5185\u5B58\u5730\u5740\u6620\u5C04\u5230\u65B0\u7684\u7269\u7406\u5185\u5B58\u5730\u5740\u4E0A\u3002</p><p>\u5BF9\u4E8E\u7B2C\uFF083\uFF09\u70B9\uFF0C\u662F\u865A\u62DF\u5185\u5B58\u4E3A\u4E86\u6700\u5927\u5316\u5229\u7528\u7269\u7406\u5185\u5B58\uFF0C\u5982\u679C\u8FDB\u7A0B\u4F7F\u7528\u7684\u5185\u5B58\u8DB3\u591F\u5927\uFF0C\u5219\u5BFC\u81F4\u7269\u7406\u5185\u5B58\u77ED\u6682\u7684\u4F9B\u4E0D\u5E94\u6C42\uFF0C\u90A3\u4E48\u865A\u62DF\u5185\u5B58\u4E5F\u4F1A \u201C\u5F00\u7586\u62D3\u571F\u201D \u4ECE\u78C1\u76D8\uFF08\u786C\u76D8\uFF09\u4E0A\u865A\u62DF\u51FA\u4E00\u5B9A\u91CF\u7684\u7A7A\u95F4\uFF0C\u6302\u5728\u865A\u62DF\u5730\u5740\u4E0A\uFF0C\u800C\u4E14\u8FD9\u4E2A\u52A8\u4F5C\u8FDB\u7A0B\u672C\u8EAB\u662F\u4E0D\u77E5\u9053\u7684\uFF0C\u56E0\u4E3A\u8FDB\u7A0B\u53EA\u80FD\u591F\u770B\u89C1\u81EA\u5DF1\u7684\u865A\u62DF\u5185\u5B58\u7A7A\u95F4\uFF0C\u5982\u56FE 7 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/bEPjaY1g3V.png!large" alt="awsef"></p><h3 id="\u56FE-7-\u865A\u62DF\u5185\u5B58\u4ECE\u78C1\u76D8\u6620\u5C04\u7A7A\u95F4" tabindex="-1"><a class="header-anchor" href="#\u56FE-7-\u865A\u62DF\u5185\u5B58\u4ECE\u78C1\u76D8\u6620\u5C04\u7A7A\u95F4" aria-hidden="true">#</a> \u56FE 7 \u865A\u62DF\u5185\u5B58\u4ECE\u78C1\u76D8\u6620\u5C04\u7A7A\u95F4<a href="#81a62c">#</a></h3><p>\u7EFC\u4E0A\u53EF\u89C1\u865A\u62DF\u5185\u5B58\u7684\u91CD\u8981\u6027\uFF0C\u4E0D\u4EC5\u63D0\u9AD8\u4E86\u5229\u7528\u7387\u800C\u4E14\u6574\u6761\u5185\u5B58\u8C03\u5EA6\u7684\u94FE\u8DEF\u5B8C\u5168\u662F\u5BF9\u7528\u6237\u6001\u7269\u7406\u5185\u5B58\u900F\u660E\uFF0C\u7528\u6237\u53EF\u4EE5\u5B89\u5FC3\u7684\u4F7F\u7528\u81EA\u8EAB\u8FDB\u7A0B\u72EC\u7ACB\u7684\u865A\u62DF\u5185\u5B58\u7A7A\u95F4\u8FDB\u884C\u5F00\u53D1\u3002</p><h3 id="_3-2-mmu-\u5185\u5B58\u7BA1\u7406\u5355\u5143" tabindex="-1"><a class="header-anchor" href="#_3-2-mmu-\u5185\u5B58\u7BA1\u7406\u5355\u5143" aria-hidden="true">#</a> 3.2 MMU \u5185\u5B58\u7BA1\u7406\u5355\u5143<a href="#929b49">#</a></h3><p>\u90A3\u4E48\u5BF9\u4E8E\u865A\u62DF\u5185\u5B58\u5730\u5740\u662F\u5982\u4F55\u6620\u5C04\u5230\u7269\u7406\u5185\u5B58\u5730\u5740\u4E0A\u7684\u5462\uFF1F\u4F1A\u4E0D\u4F1A\u662F\u4E00\u4E2A\u56FA\u5B9A\u5339\u914D\u5730\u5740\u903B\u8F91\u5904\u7406\u7684\uFF1F\u5047\u8BBE\u4F7F\u7528\u56FA\u5B9A\u5339\u914D\u5730\u5740\u903B\u8F91\u505A\u6620\u5C04\uFF0C\u53EF\u80FD\u4F1A\u51FA\u73B0\u5F88\u591A\u865A\u62DF\u5185\u5B58\u6253\u5230\u540C\u4E00\u4E2A\u7269\u7406\u5185\u5B58\u4E0A\uFF0C\u5982\u679C\u53D1\u73B0\u88AB\u5360\u7528\uFF0C\u5219\u4F1A\u518D\u91CD\u65B0\u6253\u3002\u8FD9\u6837\u5BF9\u6620\u5C04\u5730\u5740\u5BFB\u5740\u7684\u4EE3\u4EF7\u6781\u5927\uFF0C\u6240\u4EE5\u64CD\u4F5C\u7CFB\u7EDF\u53C8\u52A0\u4E86\u4E00\u5C42\u4E13\u95E8\u7528\u6765\u7BA1\u7406\u865A\u62DF\u5185\u5B58\u548C\u7269\u7406\u5185\u5B58\u6620\u5C04\u5173\u7CFB\u7684\u4E1C\u897F\uFF0C\u5C31\u662F MMU\uFF08Memory Management Unit\uFF09\uFF0C\u5982\u56FE 8 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/F11MJBbpMd.png!large" alt="awsef"></p><h3 id="\u56FE-8-mmu-\u5185\u5B58\u7BA1\u7406\u5355\u5143" tabindex="-1"><a class="header-anchor" href="#\u56FE-8-mmu-\u5185\u5B58\u7BA1\u7406\u5355\u5143" aria-hidden="true">#</a> \u56FE 8 MMU \u5185\u5B58\u7BA1\u7406\u5355\u5143<a href="#bd98d3">#</a></h3><p>MMU \u662F\u5728 CPU \u91CC\u7684\uFF0C\u6216\u8005\u8BF4\u662F CPU \u5177\u6709\u4E00\u4E2A\u5185\u5B58\u7BA1\u7406\u5355\u5143 MMU\uFF0C\u4E0B\u9762\u6765\u4ECB\u7ECD\u4E00\u4E0B MMU \u5177\u4F53\u7684\u7BA1\u7406\u903B\u8F91\u3002</p><h3 id="_3-3-\u865A\u62DF\u5185\u5B58\u672C\u8EAB\u600E\u4E48\u5B58\u653E" tabindex="-1"><a class="header-anchor" href="#_3-3-\u865A\u62DF\u5185\u5B58\u672C\u8EAB\u600E\u4E48\u5B58\u653E" aria-hidden="true">#</a> 3.3 \u865A\u62DF\u5185\u5B58\u672C\u8EAB\u600E\u4E48\u5B58\u653E<a href="#bfc8c8">#</a></h3><p>\u865A\u62DF\u5185\u5B58\u672C\u8EAB\u662F\u901A\u8FC7\u4E00\u4E2A\u53EB\u9875\u8868\uFF08Page Table\uFF09\u7684\u4E1C\u897F\u6765\u5B9E\u73B0\u7684\uFF0C\u63A5\u4E0B\u6765\u4ECB\u7ECD\u9875\u548C\u9875\u8868\u8FD9\u4E24\u4E2A\u6982\u5FF5\u3002</p><h4 id="_1-\u9875" tabindex="-1"><a class="header-anchor" href="#_1-\u9875" aria-hidden="true">#</a> <strong>1. \u9875</strong><a href="#760b0d">#</a></h4><p>\u9875\u662F\u64CD\u4F5C\u7CFB\u7EDF\u4E2D\u7528\u6765\u63CF\u8FF0\u5185\u5B58\u5927\u5C0F\u7684\u4E00\u4E2A\u5355\u4F4D\u540D\u79F0\u3002\u4E00\u4E2A\u9875\u7684\u542B\u4E49\u662F\u5927\u5C0F\u4E3A 4K\uFF081024*4=4096 \u5B57\u8282\uFF09\u7684\u5185\u5B58\u7A7A\u95F4\u3002\u64CD\u4F5C\u7CFB\u7EDF\u5BF9\u865A\u62DF\u5185\u5B58\u7A7A\u95F4\u662F\u6309\u7167\u8FD9\u4E2A\u5355\u4F4D\u6765\u7BA1\u7406\u7684\u3002</p><h4 id="_2-\u9875\u8868" tabindex="-1"><a class="header-anchor" href="#_2-\u9875\u8868" aria-hidden="true">#</a> <strong>2. \u9875\u8868</strong><a href="#d29eef">#</a></h4><p>\u9875\u8868\u5B9E\u9645\u4E0A\u5C31\u662F\u9875\u7684\u96C6\u5408\uFF0C\u5C31\u662F\u57FA\u4E8E\u9875\u7684\u4E00\u4E2A\u6570\u7EC4\u3002\u9875\u53EA\u662F\u8868\u793A\u5185\u5B58\u7684\u5927\u5C0F\uFF0C\u800C<strong>\u9875\u8868\u6761\u76EE\uFF08<strong>PTE</strong><a href="#_ftn1">[1]</a></strong>\uFF09, \u624D\u662F\u9875\u8868\u6570\u7EC4\u4E2D\u7684\u4E00\u4E2A\u5143\u7D20\u3002</p><p>\u4E3A\u4E86\u65B9\u4FBF\u8BFB\u8005\u7406\u89E3\uFF0C\u4E0B\u9762\u7528\u4E00\u4E2A\u62BD\u8C61\u7684\u56FE\u6765\u8868\u793A\u9875\u3001\u9875\u8868\u3001\u548C\u9875\u8868\u5143\u7D20 PTE \u7684\u6982\u5FF5\u548C\u5173\u7CFB\uFF0C\u5982\u56FE 9 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/Pi18r4mFiz.png!large" alt="awsef"></p><h3 id="\u56FE-9-\u9875\u3001\u9875\u8868\u3001pte-\u4E4B\u95F4\u7684\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#\u56FE-9-\u9875\u3001\u9875\u8868\u3001pte-\u4E4B\u95F4\u7684\u5173\u7CFB" aria-hidden="true">#</a> \u56FE 9 \u9875\u3001\u9875\u8868\u3001PTE \u4E4B\u95F4\u7684\u5173\u7CFB<a href="#7bba6e">#</a></h3><p>\u865A\u62DF\u5185\u5B58\u7684\u5B9E\u73B0\u65B9\u5F0F\uFF0C\u5927\u591A\u6570\u90FD\u662F\u901A\u8FC7<strong>\u9875\u8868</strong>\u6765\u5B9E\u73B0\u7684\u3002\u64CD\u4F5C\u7CFB\u7EDF\u865A\u62DF\u5185\u5B58\u7A7A\u95F4\u5206\u6210\u4E00\u9875\u4E00\u9875\u7684\u6765\u7BA1\u7406\uFF0C\u6BCF\u9875\u7684\u5927\u5C0F\u4E3A 4K\uFF08\u5F53\u7136\u8FD9\u662F\u53EF\u4EE5\u914D\u7F6E\u7684\uFF0C\u4E0D\u540C\u64CD\u4F5C\u7CFB\u7EDF\u4E0D\u4E00\u6837\uFF09\u3002\u78C1\u76D8\u548C\u4E3B\u5185\u5B58\u4E4B\u95F4\u7684\u7F6E\u6362\u4E5F\u662F\u4EE5<strong>\u9875</strong>\u4E3A\u5355\u4F4D\u6765\u64CD\u4F5C\u7684\u30024K \u7B97\u662F\u901A\u8FC7\u5B9E\u8DF5\u6298\u4E2D\u51FA\u6765\u7684\u901A\u7528\u503C\uFF0C\u592A\u5C0F\u4E86\u4F1A\u51FA\u73B0\u9891\u7E41\u7684\u7F6E\u6362\uFF0C\u592A\u5927\u4E86\u53C8\u6D6A\u8D39\u5185\u5B58\u3002</p><p>\u865A\u62DF\u5185\u5B58\u5230\u7269\u7406\u5185\u5B58\u7684\u6620\u5C04\u5173\u7CFB\u7684\u5B58\u50A8\u7ED3\u6784\u5C31\u662F\u7531\u7C7B\u4F3C\u4E0A\u8FF0\u56FE 3.9 \u4E2D\u7684\u9875\u8868\u8BB0\u5F55\uFF0C<strong>\u5B9E\u5219\u662F\u4E00\u4E2A\u6570\u7EC4\u3002\u8FD9\u91CC\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u9875\u662F\u4E00\u6B21\u8BFB\u53D6\u7684\u5185\u5B58\u5355\u5143\uFF0C\u4F46\u662F\u771F\u6B63\u8D77\u5230\u865A\u62DF\u5185\u5B58\u5BFB\u5740\u7684\u662F PTE\uFF0C\u4E5F\u5C31\u662F\u9875\u8868\u4E2D\u7684\u4E00\u4E2A\u5143\u7D20\u3002PTE \u7684\u5927\u81F4\u5185\u90E8\u7ED3\u6784\u5982\u56FE 10 \u6240\u793A\u3002</strong></p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/xznDie9ouV.png!large" alt="awsef"></p><h3 id="\u56FE-10-pte-\u5185\u90E8\u6784\u9020" tabindex="-1"><a class="header-anchor" href="#\u56FE-10-pte-\u5185\u90E8\u6784\u9020" aria-hidden="true">#</a> \u56FE 10 PTE \u5185\u90E8\u6784\u9020<a href="#8399f1">#</a></h3><p>\u53EF\u4EE5\u770B\u51FA\u6BCF\u4E2A PTE \u662F\u7531\u4E00\u4E2A\u6709\u6548\u4F4D\u548C\u4E00\u4E2A\u5305\u542B\u7269\u7406\u9875\u53F7\u6216\u8005\u78C1\u76D8\u5730\u5740\u7EC4\u6210\uFF0C\u6709\u6548\u4F4D\u8868\u793A\u5F53\u524D\u865A\u62DF\u9875\u662F\u5426\u5DF2\u7ECF\u88AB\u7F13\u5B58\u5728\u4E3B\u5185\u5B58\u4E2D\uFF08\u6216\u8005 CPU \u7684\u9AD8\u901F\u7F13\u5B58 Cache \u4E2D\uFF09\u3002</p><p>\u865A\u62DF\u9875\u4E3A\u4F55\u6709\u4F1A\u662F\u5426\u5DF2\u7ECF\u88AB\u7F13\u5B58\u5728\u4E3B\u5185\u5B58\u4E2D\u4E00\u8BF4\uFF1F\u865A\u62DF\u9875\u8868\uFF08\u7B80\u79F0\u9875\u8868\uFF09\u867D\u7136\u4F5C\u4E3A\u865A\u62DF\u5185\u5B58\u4E0E\u7269\u7406\u5185\u5B58\u7684\u6620\u5C04\u5173\u7CFB\uFF0C\u4F46\u662F\u672C\u8EAB\u4E5F\u662F\u9700\u8981\u5B58\u653E\u5728\u67D0\u4E2A\u4F4D\u7F6E\u4E0A\uFF0C\u6240\u4EE5\u81EA\u8EAB\u672C\u8EAB\u4E5F\u662F\u5360\u7528\u4E00\u5B9A\u5185\u5B58\u7684\u3002\u6240\u4EE5\u9875\u8868\u672C\u8EAB\u4E5F\u662F\u88AB\u64CD\u4F5C\u7CFB\u7EDF\u653E\u5728\u7269\u7406\u5185\u5B58\u7684\u6307\u5B9A\u4F4D\u7F6E\u3002CPU \u628A\u865A\u62DF\u5730\u5740\u7ED9 MMU\uFF0CMMU \u53BB\u7269\u7406\u5185\u5B58\u4E2D\u67E5\u8BE2\u9875\u8868\uFF0C\u5F97\u5230\u5B9E\u9645\u7684\u7269\u7406\u5730\u5740\u3002\u5F53\u7136 MMU \u4E0D\u4F1A\u6BCF\u6B21\u90FD\u53BB\u67E5\u7684\uFF0C\u5B83\u81EA\u5DF1\u4E5F\u6709\u4E00\u4EFD\u7F13\u5B58\u53EB Translation Lookaside Buffer (TLB)<a href="#_ftn2">[2]</a>\uFF0C\u662F\u4E3A\u4E86\u52A0\u901F\u5730\u5740\u7FFB\u8BD1\u3002CPU\u3001MMU \u4E0E TLB \u7684\u76F8\u4E92\u5173\u7CFB\u5982\u56FE 11 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/DwgpY8A3UC.png!large" alt="awsef"></p><h3 id="\u56FE-11-cpu\u3001mmu-\u4E0E-tlb-\u7684\u4EA4\u4E92\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#\u56FE-11-cpu\u3001mmu-\u4E0E-tlb-\u7684\u4EA4\u4E92\u5173\u7CFB" aria-hidden="true">#</a> \u56FE 11 CPU\u3001MMU \u4E0E TLB \u7684\u4EA4\u4E92\u5173\u7CFB<a href="#9faa5c">#</a></h3><p>\u4ECE\u4E0A\u56FE\u53EF\u4EE5\u770B\u51FA\uFF0CTLB \u662F\u865A\u62DF\u5185\u5B58\u9875\uFF0C\u5373\u865A\u62DF\u5730\u5740\u548C\u7269\u7406\u5730\u5740\u6620\u5C04\u5173\u7CFB\u7684\u7F13\u5B58\u5C42\u3002MMU \u5F53\u6536\u5230\u5730\u5740\u67E5\u8BE2\u6307\u4EE4\uFF0C\u7B2C\u4E00\u65F6\u95F4\u662F\u8BF7\u6C42 TLB \u7684\uFF0C\u5982\u679C\u6CA1\u6709\u624D\u4F1A\u8FDB\u884C\u4ECE\u5185\u5B58\u4E2D\u7684\u865A\u62DF\u9875\u8FDB\u884C\u67E5\u627E\uFF0C\u8FD9\u6837\u53EF\u80FD\u4F1A\u89E6\u53D1\u591A\u6B21\u5185\u5B58\u8BFB\u53D6\uFF0C\u800C\u8BFB\u53D6 TLB \u5219\u4E0D\u9700\u8981\u5185\u5B58\u8BFB\u53D6\uFF0C\u6240\u8FDB\u7A0B\u8BFB\u53D6\u7684\u6B65\u9AA4\u987A\u5E8F\u4E3A\uFF1A</p><p>\uFF081\uFF09CPU \u8FDB\u884C\u865A\u62DF\u5730\u5740\u8BF7\u6C42 MMU\u3002</p><p>\uFF082\uFF09MMU \u4F18\u5148\u4ECE TLB \u4E2D\u5F97\u5230\u865A\u62DF\u9875\u3002</p><p>\uFF083\uFF09\u5982\u679C\u5F97\u5230\u5219\u8FD4\u56DE\u7ED9\u4E0A\u5C42\u3002</p><p>\uFF084\uFF09\u5982\u679C\u6CA1\u6709\u5219\u4ECE\u4E3B\u5B58\u7684\u865A\u62DF\u9875\u8868\u4E2D\u67E5\u8BE2\u5173\u7CFB\u3002</p><p>\u4E0B\u9762\u7EE7\u7EED\u5206\u6790 PTE \u7684\u5185\u90E8\u6784\u9020\uFF0C\u6839\u636E\u6709\u6548\u4F4D\u7684\u7279\u5F81\u53EF\u4EE5\u5F97\u5230\u4E0D\u540C\u7684\u542B\u4E49\u5982\u4E0B\uFF1A</p><p>\uFF081\uFF09\u6709\u6548\u4F4D\u4E3A 1\uFF0C\u8868\u793A\u865A\u62DF\u9875\u5DF2\u7ECF\u88AB\u7F13\u5B58\u5728\u5185\u5B58\uFF08\u6216\u8005 CPU \u9AD8\u901F\u7F13\u5B58 TLB-Cache\uFF09\u4E2D\u3002</p><p>\uFF082\uFF09\u6709\u6548\u4F4D\u4E3A 0\uFF0C\u8868\u793A\u865A\u62DF\u9875\u672A\u88AB\u521B\u5EFA\u4E14\u6CA1\u6709\u5360\u7528\u5185\u5B58\uFF08\u6216\u8005 CPU \u9AD8\u901F\u7F13\u5B58 TLB-Cache\uFF09\uFF0C\u6216\u8005\u8868\u793A\u5DF2\u7ECF\u521B\u5EFA\u865A\u62DF\u9875\u4F46\u662F\u5E76\u6CA1\u6709\u5B58\u50A8\u5230\u5185\u5B58\uFF08\u6216\u8005 CPU \u9AD8\u901F\u7F13\u5B58 TLB-Cache\uFF09\u4E2D\u3002</p><p>\u901A\u8FC7\u4E0A\u8FF0\u7684\u6807\u8BC6\u4F4D\uFF0C\u53EF\u4EE5\u5C06\u865A\u62DF\u9875\u96C6\u5408\u5206\u6210\u4E09\u4E2A\u5B50\u96C6\uFF0C\u5982\u8868 3 \u6240\u793A\u3002</p><h3 id="\u8868-3-\u865A\u62DF\u9875\u88AB\u5206\u6210\u7684\u4E09\u79CD\u5B50\u96C6" tabindex="-1"><a class="header-anchor" href="#\u8868-3-\u865A\u62DF\u9875\u88AB\u5206\u6210\u7684\u4E09\u79CD\u5B50\u96C6" aria-hidden="true">#</a> \u8868 3 \u865A\u62DF\u9875\u88AB\u5206\u6210\u7684\u4E09\u79CD\u5B50\u96C6<a href="#9768f6">#</a></h3><table><thead><tr><th><strong>\u6709\u6548\u4F4D</strong></th><th><strong>\u96C6\u5408\u7279\u5F81</strong></th></tr></thead><tbody><tr><td>1</td><td>\u865A\u62DF\u5185\u5B58\u5DF2\u521B\u5EFA\u548C\u5206\u914D\u9875\uFF0C\u5DF2\u7F13\u5B58\u5728\u7269\u7406\u5185\u5B58\uFF08\u6216 TLB-Cache\uFF09\u4E2D\u3002</td></tr><tr><td>0</td><td>\u865A\u62DF\u5185\u5B58\u8FD8\u672A\u5206\u914D\u6216\u521B\u5EFA\u3002</td></tr><tr><td>0</td><td>\u865A\u62DF\u5185\u5B58\u5DF2\u521B\u5EFA\u548C\u5206\u914D\u9875\uFF0C\u4F46\u672A\u7F13\u5B58\u5728\u7269\u7406\u5185\u5B58\uFF08\u6216 TLB-Cache\uFF09\u4E2D\u3002</td></tr></tbody></table><p>\u5BF9\u4E8E Golang \u5F00\u53D1\u8005\uFF0C\u5BF9\u865A\u62DF\u5185\u5B58\u7684\u5B58\u50A8\u7ED3\u6784\u4E86\u89E3\u5230\u6B64\u6B65\u5373\u53EF\uFF0C\u5982\u679C\u60F3\u66F4\u6DF1\u5165\u7684\u4E86\u89E3 MMU \u5B58\u50A8\u7ED3\u679C\u53EF\u4EE5\u7FFB\u9605\u5176\u4ED6\u64CD\u4F5C\u7CFB\u7EDF\u6216\u786C\u4EF6\u76F8\u5173\u4E66\u7C4D\u6216\u8D44\u6599\u3002\u4E0B\u9762\u6765\u5206\u6790\u4E00\u4E0B\u5728\u8BBF\u95EE\u4E00\u6B21\u5185\u5B58\u7684\u6574\u4F53\u6D41\u7A0B\u3002</p><h3 id="_3-4-cpu-\u5185\u5B58\u8BBF\u95EE\u8FC7\u7A0B" tabindex="-1"><a class="header-anchor" href="#_3-4-cpu-\u5185\u5B58\u8BBF\u95EE\u8FC7\u7A0B" aria-hidden="true">#</a> 3.4 CPU \u5185\u5B58\u8BBF\u95EE\u8FC7\u7A0B<a href="#53d9ad">#</a></h3><p>\u4E00\u6B21 CPU \u5185\u5B58\u8BBF\u95EE\u7684\u6D41\u7A0B\u5982\u56FE 12 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/JnCscKIxBw.png!large" alt="awsef"></p><h3 id="\u56FE-12-cpu-\u5185\u5B58\u8BBF\u95EE\u7684\u8BE6\u7EC6\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u56FE-12-cpu-\u5185\u5B58\u8BBF\u95EE\u7684\u8BE6\u7EC6\u6D41\u7A0B" aria-hidden="true">#</a> \u56FE 12 CPU \u5185\u5B58\u8BBF\u95EE\u7684\u8BE6\u7EC6\u6D41\u7A0B<a href="#08bc59">#</a></h3><p>\u5F53\u67D0\u4E2A\u8FDB\u7A0B\u8FDB\u884C\u4E00\u6B21\u5185\u5B58\u8BBF\u95EE\u6307\u4EE4\u8BF7\u6C42\uFF0C\u5C06\u89E6\u53D1\u5982\u56FE 3.12 \u7684\u5185\u5B58\u8BBF\u95EE\u5177\u4F53\u7684\u8BBF\u95EE\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><p>\uFF081\uFF09\u8FDB\u7A0B\u5C06\u5185\u5B58\u76F8\u5173\u7684\u5BC4\u5B58\u5668\u6307\u4EE4\u8BF7\u6C42\u8FD0\u7B97\u53D1\u9001\u7ED9 CPU\uFF0CCPU \u5F97\u5230\u5177\u4F53\u7684\u6307\u4EE4\u8BF7\u6C42\u3002</p><p>\uFF082\uFF09\u8BA1\u7B97\u6307\u4EE4\u88AB CPU \u52A0\u8F7D\u5230\u5BC4\u5B58\u5668\u5F53\u4E2D\uFF0C\u51C6\u5907\u6267\u884C\u76F8\u5173\u6307\u4EE4\u903B\u8F91\u3002</p><p>\uFF083\uFF09CPU \u5BF9\u76F8\u5173\u53EF\u80FD\u8BF7\u6C42\u7684\u5185\u5B58\u751F\u6210\u865A\u62DF\u5185\u5B58\u5730\u5740\u3002\u4E00\u4E2A\u865A\u62DF\u5185\u5B58\u5730\u5740\u5305\u62EC\u865A\u62DF\u9875\u53F7 VPN\uFF08Virtual Page Number\uFF09\u548C\u865A\u62DF\u9875\u504F\u79FB\u91CF VPO\uFF08Virtual Page Offset\uFF09<a href="#_ftn3">[3]</a>\u3002</p><p>\uFF084\uFF09\u4ECE\u865A\u62DF\u5730\u5740\u4E2D\u5F97\u5230\u865A\u62DF\u9875\u53F7 VPN\u3002</p><p>\uFF085\uFF09\u901A\u8FC7\u865A\u62DF\u9875\u53F7 VPN \u8BF7\u6C42 MMU \u5185\u5B58\u7BA1\u7406\u5355\u5143\u3002</p><p>\uFF086\uFF09MMU \u901A\u8FC7\u865A\u62DF\u9875\u53F7\u67E5\u627E\u5BF9\u5E94\u7684 PTE \u6761\u76EE\uFF08\u4F18\u5148\u5C42 TLB \u7F13\u5B58\u67E5\u8BE2\uFF09\u3002</p><p>\uFF087\uFF09\u901A\u8FC7\u5F97\u5230\u5BF9\u5E94\u7684 PTE \u4E0A\u7684\u6709\u6548\u4F4D\u6765\u5224\u65AD\u5F53\u524D\u865A\u62DF\u9875\u662F\u5426\u5728\u4E3B\u5B58\u4E2D\u3002</p><p>\uFF088\uFF09\u5982\u679C\u7D22\u5F15\u5230\u7684 PTE \u6761\u76EE\u7684\u6709\u6548\u4F4D\u4E3A 1\uFF0C\u5219\u8868\u793A\u547D\u4E2D\uFF0C\u5C06\u5BF9\u5E94 PTE \u4E0A\u7684\u7269\u7406\u9875\u53F7 PPN\uFF08Physical Page Number\uFF09\u548C\u865A\u62DF\u5730\u5740\u4E2D\u7684\u865A\u62DF\u9875\u504F\u79FB\u91CF VPO \u8FDB\u884C\u4E32\u8054\u4ECE\u800C\u6784\u9020\u51FA\u4E3B\u5B58\u4E2D\u7684\u7269\u7406\u5730\u5740 PA\uFF08Physical Address\uFF09<a href="#_ftn4">[4]</a>\uFF0C\u8FDB\u5165\u6B65\u9AA4\uFF089\uFF09\u3002</p><p>\uFF089\uFF09\u901A\u8FC7\u7269\u7406\u5185\u5B58\u5730\u5740\u8BBF\u95EE\u7269\u7406\u5185\u5B58\uFF0C\u5F53\u524D\u7684\u5BFB\u5740\u6D41\u7A0B\u7ED3\u675F\u3002</p><p>\uFF0810\uFF09\u5982\u679C\u6709\u6548\u4F4D\u4E3A 0\uFF0C\u5219\u8868\u793A\u672A\u547D\u4E2D\uFF0C\u4E00\u822C\u79F0\u8FD9\u79CD\u60C5\u51B5\u4E3A\u7F3A\u9875\u3002\u6B64\u65F6 MMU \u5C06\u4EA7\u751F\u4E00\u4E2A\u7F3A\u9875\u5F02\u5E38\uFF0C\u629B\u7ED9\u64CD\u4F5C\u7CFB\u7EDF\u3002</p><p>\uFF0811\uFF09\u64CD\u4F5C\u7CFB\u7EDF\u6355\u83B7\u5230\u7F3A\u9875\u5F02\u5E38\uFF0C\u5F00\u59CB\u6267\u884C\u5F02\u5E38\u5904\u7406\u7A0B\u5E8F\u3002</p><p>\uFF0812\uFF09\u6B64\u65F6\u5C06\u9009\u62E9\u4E00\u4E2A\u727A\u7272\u9875\u5E76\u5C06\u5BF9\u5E94\u7684\u6240\u7F3A\u865A\u62DF\u9875\u8C03\u5165\u5E76\u66F4\u6B63\u65B0\u9875\u8868\u4E0A\u7684 PTE\uFF0C\u5982\u679C\u5F53\u524D\u727A\u7272\u9875\u6709\u6570\u636E\uFF0C\u5219\u5199\u5165\u78C1\u76D8\uFF0C\u5F97\u5230\u7269\u7406\u5185\u5B58\u9875\u53F7 PPN\uFF08Physical Page Number\uFF09\u3002</p><p>\uFF0813\uFF09\u7F3A\u9875\u5904\u7406\u7A0B\u5E8F\u66F4\u65B0\u4E4B\u524D\u7D22\u5F15\u5230\u7684 PTE\uFF0C\u5E76\u4E14\u5199\u5165\u7269\u7406\u5185\u5B58\u6012\u9875\u53F7 PPN\uFF0C\u6709\u6548\u4F4D\u8BBE\u7F6E\u4E3A 1\u3002</p><p>\uFF0814\uFF09\u7F3A\u9875\u5904\u7406\u7A0B\u5E8F\u518D\u6B21\u8FD4\u56DE\u5230\u539F\u6765\u7684\u8FDB\u7A0B\uFF0C\u4E14\u518D\u6B21\u6267\u884C\u7F3A\u9875\u6307\u4EE4\uFF0CCPU \u91CD\u65B0\u5C06\u865A\u62DF\u5730\u5740\u53D1\u7ED9 MMU\uFF0C\u6B64\u65F6\u865A\u62DF\u9875\u5DF2\u7ECF\u5B58\u5728\u7269\u7406\u5185\u5B58\u4E2D\uFF0C\u672C\u6B21\u4E00\u5B9A\u4F1A\u547D\u4E2D\uFF0C\u901A\u8FC7\uFF081\uFF09~\uFF089\uFF09\u6D41\u7A0B\uFF0C\u6700\u7EC8\u5C06\u8BF7\u6C42\u7684\u7269\u7406\u5185\u5B58\u8FD4\u56DE\u7ED9\u5904\u7406\u5668\u3002</p><p>\u4EE5\u4E0A\u5C31\u662F\u4E00\u6B21 CPU \u8BBF\u95EE\u5185\u5B58\u7684\u8BE6\u7EC6\u6D41\u7A0B\u3002\u53EF\u4EE5\u770B\u51FA\u6765\u4E0A\u8FF0\u6D41\u7A0B\u4E2D\uFF0C\u4ECE\u7B2C\uFF0810\uFF09\u6B65\u4E4B\u540E\u7684\u6D41\u7A0B\u5C31\u7A0D\u5FAE\u6709\u4E00\u4E9B\u7E41\u7410\u3002\u7C7B\u4F3C\u4EA7\u751F\u5F02\u5E38\u4FE1\u53F7\u3001\u6355\u83B7\u5F02\u5E38\uFF0C\u518D\u5904\u7406\u7F3A\u9875\u6D41\u7A0B\uFF0C\u5982\u9009\u62E9\u727A\u7272\u9875\uFF0C\u8FD8\u8981\u5C06\u727A\u7272\u9875\u7684\u6570\u636E\u5B58\u50A8\u5230\u78C1\u76D8\u4E0A\u7B49\u7B49\u3002\u6240\u4EE5\u5982\u679C\u9891\u7E41\u7684\u6267\u884C\uFF0810\uFF09~\uFF0814\uFF09\u6B65\u9AA4\u4F1A\u5BF9\u6027\u80FD\u5F71\u54CD\u5F88\u5927\u3002\u56E0\u4E3A\u727A\u7272\u9875\u6709\u53EF\u80FD\u4F1A\u6D89\u53CA\u5230\u78C1\u76D8\u7684\u8BBF\u95EE\uFF0C\u800C\u78C1\u76D8\u7684\u8BBF\u95EE\u901F\u5EA6\u975E\u5E38\u7684\u6162\uFF0C\u8FD9\u6837\u5C31\u4F1A\u5F15\u53D1\u7A0B\u5E8F\u6027\u80FD\u7684\u6025\u5267\u4E0B\u964D\u3002</p><p>\u4E00\u822C\u4ECE\uFF081\uFF09~\uFF089\uFF09\u6B65\u6D41\u7A0B\u7ED3\u675F\u5219\u8868\u793A\u9875\u547D\u4E2D\uFF0C\u53CD\u4E4B\u4E3A\u672A\u547D\u4E2D\uFF0C\u6240\u4EE5\u5C31\u4F1A\u51FA\u73B0\u4E00\u4E2A\u65B0\u7684\u6027\u80FD\u7EA7\u6307\u6807\uFF0C\u5373\u547D\u4E2D\u7387\u3002\u547D\u4E2D\u7387\u662F\u8BBF\u95EE\u6B21\u6570\u4E0E\u9875\u547D\u4E2D\u6B21\u6570\u4E4B\u6BD4\u3002\u4E00\u822C\u547D\u4E2D\u7387\u4F4E\u8BF4\u660E\u7269\u7406\u5185\u5B58\u4E0D\u8DB3\uFF0C\u6570\u636E\u5728\u5185\u5B58\u548C\u78C1\u76D8\u4E4B\u95F4\u4EA4\u6362\u9891\u7E41\uFF0C\u4F46\u5982\u679C\u7269\u7406\u5185\u5B58\u5145\u5206\uFF0C\u5219\u4E0D\u4F1A\u51FA\u73B0\u9891\u7E41\u7684\u5185\u5B58\u98A0\u7C38\u73B0\u8C61\u3002</p><h3 id="_3-4-\u5185\u5B58\u7684\u5C40\u90E8\u6027" tabindex="-1"><a class="header-anchor" href="#_3-4-\u5185\u5B58\u7684\u5C40\u90E8\u6027" aria-hidden="true">#</a> 3.4 \u5185\u5B58\u7684\u5C40\u90E8\u6027<a href="#b91659">#</a></h3><p>\u4E0A\u8FF0\u4E86\u89E3\u5230\u5185\u5B58\u7684\u547D\u4E2D\u7387\u5B9E\u9645\u4E0A\u662F\u4E00\u8861\u91CF\u6BCF\u6B21\u5185\u5B58\u8BBF\u95EE\u5747\u80FD\u88AB\u9875\u76F4\u63A5\u5BFB\u5740\u5230\u800C\u4E0D\u662F\u4EA7\u751F\u7F3A\u9875\u7684\u6307\u6807\u3002\u6240\u4EE5\u5982\u679C\u7ECF\u5E38\u5728\u4E00\u5B9A\u8303\u56F4\u5185\u7684\u5185\u5B58\u5219\u51FA\u73B0\u7F3A\u9875\u7684\u60C5\u51B5\u5C31\u4F1A\u964D\u4F4E\u3002\u8FD9\u5C31\u662F\u7A0B\u5E8F\u7684\u4E00\u79CD\u5C40\u90E8\u6027\u7279\u6027\u7684\u4F53\u73B0\u3002</p><p>\u5C40\u90E8\u6027\u5C31\u662F\u5728\u591A\u6B21\u5185\u5B58\u5F15\u7528\u7684\u65F6\u5019\uFF0C\u4F1A\u51FA\u73B0\u6709\u7684\u5185\u5B58\u88AB\u7ECF\u5E38\u5F15\u7528\u591A\u6B21\uFF0C\u800C\u4E14\u5728\u8BE5\u4F4D\u7F6E\u9644\u8FD1\u7684\u5176\u4ED6\u4F4D\u7F6E\uFF0C\u4E5F\u6709\u53EF\u80FD\u63A5\u4E0B\u6765\u88AB\u5F15\u7528\u5230\u3002\u4E00\u822C\u5927\u591A\u6570\u7A0B\u5E8F\u90FD\u4F1A\u5177\u5907\u5C40\u90E8\u6027\u7684\u7279\u70B9\u3002</p><p>\u5B9E\u9645\u4E0A\u64CD\u4F5C\u7CFB\u7EDF\u5728\u8BBE\u8BA1\u8FC7\u7A0B\u4E2D\u7ECF\u5E38\u4F1A\u7528\u5230\u7F13\u5B58\u6765\u63D0\u5347\u6027\u80FD\uFF0C\u6216\u8005\u5728\u8BBE\u8BA1\u89E3\u51B3\u65B9\u6848\u7B49\u67B6\u6784\u7684\u65F6\u5019\u4E5F\u4F1A\u8003\u8651\u5230\u7F13\u5B58\u6216\u8005\u7F13\u51B2\u5C42\u7684\u6982\u5FF5\uFF0C\u5B9E\u5219\u5C31\u662F\u5229\u7528\u7A0B\u5E8F\u6216\u4E1A\u52A1\u5929\u7136\u7684\u5C40\u90E8\u6027\u7279\u5F81\u3002\u56E0\u4E3A\u5982\u679C\u6CA1\u6709\u5C40\u90E8\u6027\u7684\u7279\u6027\uFF0C\u5219\u7F13\u5B58\u7EA7\u522B\u5C06\u8D77\u4E0D\u5230\u592A\u5927\u7684\u4F5C\u7528\uFF0C\u6240\u4EE5\u5728\u8BBE\u8BA1\u7A0B\u5E8F\u6216\u8005\u4E1A\u52A1\u7684\u65F6\u5019\u5E94\u8BE5\u591A\u8003\u8651\u589E\u5F3A\u7A0B\u5E8F\u5C40\u90E8\u6027\u7684\u7279\u5F81\uFF0C\u8FD9\u6837\u7684\u7A0B\u5E8F\u4F1A\u66F4\u5FEB\u3002</p><p>\u4E0B\u9762\u662F\u4E00\u4E2A\u975E\u5E38\u5178\u578B\u7684\u6848\u4F8B\u6765\u9A8C\u8BC1\u7A0B\u5E8F\u5C40\u90E8\u6027\u7684\u7A0B\u5E8F\u793A\u4F8B\uFF0C\u5177\u4F53\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>package MyGolang

func Loop(nums [awsef]int, step int) {
   l := len(nums)
   for i := 0; i &lt; step; i++ {
      for j := i; j &lt; l; j += step {
         nums[j] = 4 //\u8BBF\u95EE\u5185\u5B58\uFF0C\u5E76\u5199\u5165\u503C
      }
   }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Loop () \u51FD\u6570\u7684\u529F\u80FD\u662F\u904D\u5386\u6570\u7EC4 nums\uFF0C\u5E76\u4E14\u5C06 nums \u4E2D\u7684\u6BCF\u4E2A\u5143\u7D20\u5747\u8BBE\u7F6E\u4E3A 4\u3002\u4F46\u662F\u8FD9\u91CC\u7528\u4E86\u4E00\u4E2A step \u6765\u89C4\u5B9A\u6BCF\u6B21\u904D\u5386\u7684\u8DE8\u5EA6\u3002\u53EF\u4EE5\u8DDF\u8BFB\u4E0A\u8FF0\u4EE3\u7801\uFF0C\u5982\u679C step \u7B49\u4E8E 1\uFF0C\u5219\u5916\u5C42 for \u5FAA\u73AF\u53EA\u4F1A\u6267\u884C 1 \u6B21\u3002\u5185\u5C42 for \u5FAA\u73AF\u5219\u6B63\u5E38\u904D\u5386 nums\u3002\u5B9E\u5219\u76F8\u5F53\u4E8E\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func Loop(nums [awsef]int, step int) {
   l := len(nums)
   for j := 0; j &lt; l; j += 1 {
       nums[j] = 4 //\u8BBF\u95EE\u5185\u5B58\uFF0C\u5E76\u5199\u5165\u503C
   }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u679C Step \u7B49\u4E8E 3\uFF0C\u5219\u8868\u793A\u5916\u5C42 for \u5FAA\u73AF\u8981\u4E00\u5171\u5B8C\u6210 3 \u6B21\uFF0C\u5185\u5C42 for \u5FAA\u73AF\u6BCF\u6B21\u904D\u5386\u7684\u6570\u7EC4\u4E0B\u6807\u503C\u90FD\u76F8\u5DEE 3\u3002\u7B2C\u4E00\u6B21\u904D\u5386\u4F1A\u88AB\u904D\u5386\u7684 nums \u4E0B\u6807\u4E3A 0\u30013\u30016\u30019\u300112\u2026\u2026\uFF0C\u7B2C\u4E8C\u6B21\u904D\u5386\u4F1A\u904D\u5386\u7684 nums \u4E0B\u6807\u4E3A 1\u30014\u30017\u300110\u300113\u2026\u2026\uFF0C\u7B2C\u4E09\u6B21\u904D\u5386\u4F1A\u904D\u5386\u7684 nums \u4E0B\u6807\u4E3A 2\u30015\u30018\u300111\u300114\u2026\u2026\u3002\u90A3\u4E48\u4E09\u6B21\u5916\u5FAA\u73AF\u5C31\u4F1A\u5C06\u5168\u90E8\u904D\u5386\u5B8C\u6574\u4E2A nums \u6570\u7EC4\u3002</p><p>\u4E0A\u8FF0\u7684\u7A0B\u5E8F\u8868\u793A\u4E86\u8BBF\u95EE\u6570\u7EC4\u7684\u5C40\u90E8\u6027\uFF0Cstep \u8DE8\u5EA6\u8D8A\u5C0F\uFF0C\u5219\u8868\u793A\u8BBF\u95EE nums \u76F8\u90BB\u5185\u5B58\u7684\u5C40\u90E8\u6027\u7EA6\u597D\uFF0Cstep \u8D8A\u5927\u5219\u76F8\u53CD\u3002</p><p>\u63A5\u4E0B\u6765\u7528 Golang \u7684 Benchmark \u6027\u80FD\u6D4B\u8BD5\u6765\u5206\u522B\u5BF9 step \u53D6\u4E0D\u540C\u7684\u503C\u8FDB\u884C\u538B\u6D4B\uFF0C\u6765\u770B\u770B\u901A\u8FC7 Benchmark \u6267\u884C Loop () \u51FD\u6570\u800C\u7EDF\u8BA1\u51FA\u6765\u7684\u51E0\u79CD\u60C5\u51B5\uFF0C\u6700\u7EC8\u6D88\u8017\u7684\u65F6\u95F4\u5DEE\u8DDD\u4E3A\u591A\u5C11\u3002\u9996\u5148\u521B\u5EFA loop_test.go \u6587\u4EF6\uFF0C\u5B9E\u73B0\u4E00\u4E2A\u5236\u4F5C\u6570\u7EC4\u5E76\u4E14\u8D4B\u503C\u521D\u59CB\u5316\u5185\u5B58\u503C\u7684\u51FD\u6570 CreateSource ()\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>package MyGolang

import &quot;testing&quot;

func CreateSource(len int) [awsef]int {
   nums := make([awsef]int, 0, len)

   for i := 0 ; i &lt; len; i++ {
      nums = append(nums, i)
   }

   return nums
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u6B21\u5B9E\u73B0\u4E00\u4E2A Benchmark\uFF0C\u5236\u4F5C\u4E00\u4E2A\u957F\u5EA6\u4E3A 10000 \u7684\u6570\u7EC4\uFF0C\u8FD9\u91CC\u8981\u6CE8\u610F\u7684\u662F\u521B\u5EFA\u5B8C\u6570\u7EC4\u540E\u8981\u6267\u884C b.ResetTimer () \u91CD\u7F6E\u8BA1\u65F6\uFF0C\u53BB\u6389 CreateSource () \u6D88\u8017\u7684\u65F6\u95F4\uFF0Cstep \u8DE8\u5EA6\u4E3A 1 \u7684\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//\u7B2C\u4E00\u7BC7/chapter3/MyGolang/loop_test.go

func BenchmarkLoopStep1(b *testing.B) {
   //\u5236\u4F5C\u6E90\u6570\u636E\uFF0C\u957F\u5EA6\u4E3A10000
   src := CreateSource(10000)

   b.ResetTimer()
   for i:=0; i &lt; b.N; i++ {
      Loop(src, 1)
   }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Golang \u4E2D\u7684 b.N \u8868\u793A Golang \u4E00\u6B21\u538B\u6D4B\u6700\u7EC8\u5FAA\u73AF\u7684\u6B21\u6570\u3002BenchmarkLoopStep1 () \u4F1A\u5C06 N \u6B21\u7684\u603B\u8017\u65F6\u65F6\u95F4\u9664\u4EE5 N \u5F97\u5230\u5E73\u5747\u4E00\u6B21\u6267\u884C Loop () \u51FD\u6570\u7684\u8017\u65F6\u3002\u56E0\u4E3A\u8981\u5BF9\u6BD4\u591A\u4E2A step \u7684\u8017\u65F6\u5DEE\u8DDD\uFF0C\u6309\u7167\u4E0A\u8FF0\u4EE3\u7801\u518D\u4F9D\u6B21\u5B9E\u73B0 step \u4E3A 2\u30013\u30014\u30015\u30016\u300112\u300116 \u7B49 Benchmark \u6027\u80FD\u6D4B\u8BD5\u4EE3\u7801\uFF0C\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func BenchmarkLoopStep2(b *testing.B) {
   //\u5236\u4F5C\u6E90\u6570\u636E\uFF0C\u957F\u5EA6\u4E3A10000
   src := CreateSource(10000)

   b.ResetTimer()
   for i:=0; i &lt; b.N; i++ {
      Loop(src, 2)
   }
}

func BenchmarkLoopStep3(b *testing.B) {
   //\u5236\u4F5C\u6E90\u6570\u636E\uFF0C\u957F\u5EA6\u4E3A10000
   src := CreateSource(10000)

   b.ResetTimer()
   for i:=0; i &lt; b.N; i++ {
      Loop(src, 3)
   }
}

func BenchmarkLoopStep4(b *testing.B) {
   //\u5236\u4F5C\u6E90\u6570\u636E\uFF0C\u957F\u5EA6\u4E3A10000
   src := CreateSource(10000)

   b.ResetTimer()
   for i:=0; i &lt; b.N; i++ {
      Loop(src, 4)
   }
}

func BenchmarkLoopStep5(b *testing.B) {
   //\u5236\u4F5C\u6E90\u6570\u636E\uFF0C\u957F\u5EA6\u4E3A10000
   src := CreateSource(10000)

   b.ResetTimer()
   for i:=0; i &lt; b.N; i++ {
      Loop(src, 5)
   }
}

func BenchmarkLoopStep6(b *testing.B) {
   //\u5236\u4F5C\u6E90\u6570\u636E\uFF0C\u957F\u5EA6\u4E3A10000
   src := CreateSource(10000)

   b.ResetTimer()
   for i:=0; i &lt; b.N; i++ {
      Loop(src, 6)
   }
}

func BenchmarkLoopStep12(b *testing.B) {
   //\u5236\u4F5C\u6E90\u6570\u636E\uFF0C\u957F\u5EA6\u4E3A10000
   src := CreateSource(10000)

   b.ResetTimer()
   for i:=0; i &lt; b.N; i++ {
      Loop(src, 12)
   }
}

func BenchmarkLoopStep16(b *testing.B) {
   //\u5236\u4F5C\u6E90\u6570\u636E\uFF0C\u957F\u5EA6\u4E3A10000
   src := CreateSource(10000)

   b.ResetTimer()
   for i:=0; i &lt; b.N; i++ {
      Loop(src, 16)
   }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u6BCF\u4E2A Benchmark \u90FD\u662F\u76F8\u4F3C\u7684\u4EE3\u7801\uFF0C\u53EA\u6709 step \u4F20\u53C2\u4E0D\u540C\uFF0C\u63A5\u4E0B\u6765\u901A\u8FC7\u6267\u884C\u4E0B\u8FF0\u6307\u4EE4\u6765\u8FDB\u884C\u538B\u6D4B\uFF0C\u6307\u4EE4\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ go test -bench=.  -count=3

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D \u201Ccount=3\u201D \u8868\u793A\u6BCF\u4E2A Benchmark \u8981\u6267\u884C 3 \u6B21\uFF0C\u8FD9\u6837\u662F\u66F4\u597D\u9A8C\u8BC1\u4E0A\u8FF0\u7684\u7ED3\u679C\u3002\u5177\u4F53\u7684\u8FD0\u884C\u7ED3\u679C\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>goos: darwin
goarch: amd64
pkg: MyGolang
BenchmarkLoopStep1-12            366787      2792 ns/op
BenchmarkLoopStep1-12            432235      2787 ns/op
BenchmarkLoopStep1-12            428527      2849 ns/op
BenchmarkLoopStep2-12            374282      3282 ns/op
BenchmarkLoopStep2-12            363969      3263 ns/op
BenchmarkLoopStep2-12            361790      3315 ns/op
BenchmarkLoopStep3-12            308587      3760 ns/op
BenchmarkLoopStep3-12            311551      4369 ns/op
BenchmarkLoopStep3-12            289584      4622 ns/op
BenchmarkLoopStep4-12            275166      4921 ns/op
BenchmarkLoopStep4-12            264282      4504 ns/op
BenchmarkLoopStep4-12            286933      4869 ns/op
BenchmarkLoopStep5-12            223366      5609 ns/op
BenchmarkLoopStep5-12            202597      5655 ns/op
BenchmarkLoopStep5-12            214666      5623 ns/op
BenchmarkLoopStep6-12            187147      6344 ns/op
BenchmarkLoopStep6-12            177363      6397 ns/op
BenchmarkLoopStep6-12            185377      6333 ns/op
BenchmarkLoopStep12-12           126860      9660 ns/op
BenchmarkLoopStep12-12           127557      9741 ns/op
BenchmarkLoopStep12-12           126658      9492 ns/op
BenchmarkLoopStep16-12            95116     12754 ns/op
BenchmarkLoopStep16-12            95175     12591 ns/op
BenchmarkLoopStep16-12            92106     12533 ns/op
PASS
ok  MyGolang31.712s

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5BF9\u4E0A\u8FF0\u7ED3\u679C\u4EE5\u7B2C\u4E00\u884C\u4E3A\u4F8B\u8FDB\u884C\u7B80\u5355\u7684\u89E3\u8BFB\uFF1A</p><p>\uFF081\uFF09\u201CBenchmarkLoopStep1-12\u201D \u5176\u4E2D\u7684 \u201C-12\u201D \u8868\u793A GOMAXPROCS\uFF08\u7EBF\u7A0B\u6570\uFF09\u4E3A 12\uFF0C\u8FD9\u4E2A\u5728\u6B64\u5904\u4E0D\u9700\u8981\u8FC7\u5EA6\u7684\u5173\u5FC3\u3002</p><p>\uFF082\uFF09\u201C366787\u201D \u8868\u793A\u4E00\u5171\u6267\u884C\u4E86 366787 \u6B21\uFF0C\u5373\u4EE3\u7801\u4E2D b.N \u7684\u503C\uFF0C\u8FD9\u4E2A\u503C\u4E0D\u662F\u56FA\u5B9A\u4E0D\u53D8\u7684\u3002\u5B9E\u9645\u4E0A\u662F\u901A\u8FC7\u5FAA\u73AF\u8C03\u7528 366787 \u6B21 Loop () \u51FD\u6570\u5F97\u5230\u7684\u6700\u540E\u6027\u80FD\u7ED3\u679C\u3002</p><p>\uFF083\uFF09\u201C2792 ns/op\u201D \u8868\u793A\u5E73\u5747\u6BCF\u6B21 Loop () \u51FD\u6570\u6240\u6D88\u8017\u7684\u65F6\u95F4\u662F 2792 \u7EB3\u79D2\u3002</p><p>\u901A\u8FC7\u4E0A\u8FF0\u7ED3\u679C\u53EF\u4EE5\u770B\u51FA\uFF0C\u968F\u7740 Step \u53C2\u6570\u7684\u589E\u52A0\uFF0C\u5185\u5B58\u8BBF\u95EE\u7684\u5C40\u90E8\u6027\u5C31\u8D8A\u5DEE\uFF0C\u90A3\u4E48\u6267\u884C Loop () \u7684\u6027\u80FD\u4E5F\u5C31\u8D8A\u5DEE\uFF0C\u5728 Step \u4E3A 16 \u548C Step \u4E3A 1 \u7684\u7ED3\u679C\u6765\u770B\uFF0C\u6027\u80FD\u76F8\u5DEE\u8FD1 4~5 \u500D\u4E4B\u95F4\u3002</p><p>\u901A\u8FC7\u7ED3\u679C\u53EF\u4EE5\u5F97\u51FA\u5982\u679C\u8981\u8BBE\u8BA1\u51FA\u4E00\u4E2A\u66F4\u52A0\u9AD8\u6548\u7684\u7A0B\u5E8F\uFF0C\u63D0\u9AD8\u4EE3\u7801\u7684\u5C40\u90E8\u6027\u8BBF\u95EE\u662F\u975E\u5E38\u6709\u5FC5\u8981\u7684\u7A0B\u5E8F\u6027\u80FD\u4F18\u5316\u624B\u6BB5\u4E4B\u4E00\u3002</p><p>\u601D\u8003 \u5728 Golang \u7684 GPM \u8C03\u5EA6\u5668\u6A21\u578B\u4E2D\uFF0C\u4E3A\u4EC0\u4E48\u4E00\u4E2A G \u5F00\u8F9F\u7684\u5B50 G \u4F18\u5148\u653E\u5728\u5F53\u524D\u7684\u672C\u5730 G \u961F\u5217\u4E2D\uFF0C\u800C\u4E0D\u662F\u653E\u5728\u5176\u4ED6 M \u4E0A\u7684\u672C\u5730 P \u961F\u5217\u4E2D\uFF1FGPM \u4E3A\u4F55\u8981\u6EE1\u8DB3\u5C40\u90E8\u6027\u7684\u8C03\u5EA6\u8BBE\u8BA1\uFF1F</p><h2 id="_4-\u5982\u4F55\u7528-golang-\u8BED\u8A00\u5B9E\u73B0\u5185\u5B58\u7BA1\u7406\u548C\u5185\u5B58\u6C60\u8BBE\u8BA1" tabindex="-1"><a class="header-anchor" href="#_4-\u5982\u4F55\u7528-golang-\u8BED\u8A00\u5B9E\u73B0\u5185\u5B58\u7BA1\u7406\u548C\u5185\u5B58\u6C60\u8BBE\u8BA1" aria-hidden="true">#</a> 4 \u5982\u4F55\u7528 Golang \u8BED\u8A00\u5B9E\u73B0\u5185\u5B58\u7BA1\u7406\u548C\u5185\u5B58\u6C60\u8BBE\u8BA1<a href="#de9875">#</a></h2><p>\u672C\u8282\u4ECB\u7ECD\u81EA\u4E3B\u5B9E\u73B0\u4E00\u4E2A\u5185\u5B58\u7BA1\u7406\u6A21\u5757\u90FD\u5927\u81F4\u9700\u8981\u54EA\u4E9B\u57FA\u7840\u7684\u5F00\u53D1\u548C\u7EC4\u4EF6\u5EFA\u8BBE\u3002\u63A5\u4E0B\u6765\u7684\u4E00\u4E9B\u4EE3\u7801\u4E0D\u9700\u8981\u8BFB\u8005\u53BB\u638C\u63E1\uFF0C\u56E0\u4E3A Golang \u5DF2\u7ECF\u7ED9\u5F00\u53D1\u8005\u63D0\u4F9B\u7684\u5185\u5B58\u7BA1\u7406\u6A21\u5F0F\uFF0C\u5F00\u53D1\u8005\u4E0D\u9700\u8981\u5173\u5FC3 Golang \u7684\u5185\u5B58\u5206\u914D\u60C5\u51B5\u3002\u4F46\u662F\u4E3A\u4E86\u66F4\u597D\u7684\u7406\u89E3 Golang \u7684\u5185\u5B58\u7BA1\u7406\u6A21\u578B\uFF0C\u9700\u8981\u4E86\u89E3\u5982\u679C\u81EA\u5DF1\u5B9E\u73B0\u4E00\u5957\u7B80\u5355\u7684\u5185\u5B58\u7BA1\u7406\u6A21\u5757\u5E94\u8BE5\u9700\u8981\u5173\u6CE8\u54EA\u4E9B\u70B9\u548C\u9700\u8981\u5B9E\u73B0\u54EA\u4E9B\u5FC5\u8981\u7684\u6A21\u5757\u548C\u673A\u5236\u3002</p><p>\u672C\u8282\u63A5\u4E0B\u6765\u7684\u5185\u5BB9\u5373\u662F\u901A\u8FC7 Golang \u81EA\u6211\u5B9E\u73B0\u4E00\u4E2A\u5185\u5B58\u7BA1\u7406\u6A21\u5757\u548C\u5185\u5B58\u6C60\u7684\u5EFA\u8BBE\uFF0C\u8BE5\u6A21\u5757\u975E\u4F01\u4E1A\u7EA7\u5F00\u53D1\u800C\u662F\u4FC3\u8FDB\u7406\u89E3\u5185\u5B58\u7BA1\u7406\u6A21\u578B\u7684\u6559\u7A0B\u578B\u4EE3\u7801\u3002</p><h3 id="_4-1-\u57FA\u4E8E-cgo-\u7684\u5185\u5B58-c-\u63A5\u53E3\u5C01\u88C5" tabindex="-1"><a class="header-anchor" href="#_4-1-\u57FA\u4E8E-cgo-\u7684\u5185\u5B58-c-\u63A5\u53E3\u5C01\u88C5" aria-hidden="true">#</a> 4.1 \u57FA\u4E8E Cgo \u7684\u5185\u5B58 C \u63A5\u53E3\u5C01\u88C5<a href="#64a2ce">#</a></h3><p>\u56E0\u4E3A Golang \u8BED\u8A00\u5DF2\u7ECF\u5185\u7F6E\u7684\u5185\u5B58\u7BA1\u7406\u673A\u5236\uFF0C\u6240\u4EE5\u5982\u679C\u7528 Golang \u539F\u751F\u7684\u8BED\u6CD5\u7ED3\u6784\u5982 Slice\u3001String\u3001Map \u7B49\u90FD\u4F1A\u81EA\u52A8\u89E6\u53D1 Golang \u7684\u5185\u5B58\u7BA1\u7406\u673A\u5236\u3002\u672C\u6848\u4F8B\u4E3A\u4E86\u4ECB\u7ECD\u5982\u4F55\u5B9E\u73B0\u4E00\u4E2A\u81EA\u6211\u7BA1\u7406\u7684\u5185\u5B58\u6A21\u578B\uFF0C\u6240\u4EE5\u76F4\u63A5\u4F7F\u7528\u7684 C \u8BED\u8A00\u7684 malloc ()\u3001free () \u7CFB\u7EDF\u8C03\u7528\u6765\u5F00\u8F9F\u548C\u91CA\u653E\u5185\u5B58\u7A7A\u95F4\uFF0C\u4F7F\u7528 C \u8BED\u8A00\u7684 memcpy ()\u3001memmove () \u7B49\u8FDB\u884C\u5185\u5B58\u7684\u62F7\u8D1D\u548C\u79FB\u52A8\u3002\u81F3\u4E8E\u5982\u4F55\u5C01\u88C5 Golang \u8BED\u6CD5\u7684 Malloc ()\u3001Free ()\u3001Memcpy ()\u3001Memmove () \u7B49\u51FD\u6570\uFF0C\u5373\u662F\u5229\u7528\u7684 Golang \u4E2D\u7684 Cgo \u673A\u5236\u3002</p><p>\u6CE8\u610F Cgo \u63D0\u4F9B\u4E86 Golang \u548C C \u8BED\u8A00\u76F8\u4E92\u8C03\u7528\u7684\u673A\u5236\u3002\u53EF\u4EE5\u901A\u8FC7 Cgo \u7528 Golang \u8C03\u7528 C \u7684\u63A5\u53E3\uFF0C\u5BF9\u4E8E C++ \u7684\u63A5\u53E3\u53EF\u4EE5\u7528 C \u5305\u88C5\u4E00\u4E0B\u63D0\u4F9B\u7ED9 Golang \u8C03\u7528\u3002\u88AB\u8C03\u7528\u7684 C \u4EE3\u7801\u53EF\u4EE5\u76F4\u63A5\u4EE5\u6E90\u4EE3\u7801\u5F62\u5F0F\u63D0\u4F9B\u6216\u8005\u6253\u5305\u9759\u6001\u5E93\u6216\u52A8\u6001\u5E93\u5728\u7F16\u8BD1\u65F6\u94FE\u63A5\u3002<br> Cgo \u7684\u5177\u4F53\u4F7F\u7528\u6559\u7A0B\u672C\u7AE0\u5C06\u4E0D\u7EE7\u7EED\u8BE6\u7EC6\u4ECB\u7ECD\uFF0C\u672C\u7AE0\u4E3B\u8981\u4ECB\u7ECD\u4E0B\u5728\u5185\u5B58\u7BA1\u7406\u8BBE\u8BA1\u6240\u6D89\u53CA\u5230\u90E8\u5206 Cgo \u8BED\u6CD5\u90E8\u5206\u3002</p><p>\u5F00\u59CB\u521B\u5EFA\u4E00\u4E2A zmem / \u76EE\u5F55\uFF0C\u4F5C\u4E3A\u5F53\u524D\u5185\u5B58\u5B9E\u73B0\u6848\u4F8B\u7684\u9879\u76EE\u540D\u79F0\u3002\u5728 zmem / \u76EE\u5F55\u4E0B\u518D\u521B\u5EFA c / \u6587\u4EF6\u5939\uFF0C\u8FD9\u91CC\u7528\u6765\u5B9E\u73B0\u901A\u8FC7 Cgo \u6765\u5C01\u88C5\u7684 C \u8BED\u8A00\u5185\u5B58\u7BA1\u7406\u63A5\u53E3\u3002</p><p>\u5728 c / \u76EE\u5F55\u4E0B\u521B\u5EFA memory.go \u6587\u4EF6\uFF0C\u5206\u522B\u5C01\u88C5\u7684 C \u8BED\u8A00\u5185\u5B58\u63A5\u53E3\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/c/memory.go

package c

/*
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
 */
import &quot;C&quot;
import &quot;unsafe&quot;

func Malloc(size int) unsafe.Pointer {
   return C.malloc(C.size_t(size))
}

func Free(data unsafe.Pointer) {
   C.free(data)
}

func Memmove(dest, src unsafe.Pointer, length int) {
   C.memmove(dest, src, C.size_t(length))
}

func Memcpy(dest unsafe.Pointer, src [awsef]byte, length int) {
   srcData := C.CBytes(src)
   C.memcpy(dest, srcData, C.size_t(length))
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\u5206\u522B\u4ECB\u7ECD\u4E0A\u8FF0\u4EE3\u7801\u51E0\u4E2A\u9700\u8981\u6CE8\u610F\u7684\u5730\u65B9\u3002</p><h4 id="_1-import-c" tabindex="-1"><a class="header-anchor" href="#_1-import-c" aria-hidden="true">#</a> 1.import\u201CC\u201D<a href="#1e808a">#</a></h4><p>\u4EE3\u8868 Cgo \u6A21\u5757\u7684\u542F\u52A8\uFF0C\u5176\u4E2D import \u201CC\u201D \u4E0A\u9762\u7684\u5168\u90E8\u6CE8\u91CA\u4EE3\u7801\uFF08\u4E2D\u95F4\u4E0D\u5141\u8BB8\u6709\u7A7A\u767D\u884C\uFF09\u5747\u4E3A C \u8BED\u8A00\u539F\u751F\u4EE3\u7801\u3002\u56E0\u4E3A\u5728\u4E0B\u8FF0\u63A5\u53E3\u5C01\u88C5\u4E2D\u4F7F\u7528\u5230\u4E86 C \u8BED\u8A00\u7684 malloc ()\u3001free ()\u3001memmove ()\u3001memcpy () \u7B49\u51FD\u6570\uFF0C\u8FD9\u4E9B\u51FD\u6570\u7684\u58F0\u660E\u9700\u8981\u5305\u542B\u5934\u6587\u4EF6 string.h \u548C stdlib.h\uFF0C\u6240\u4EE5\u5728\u6CE8\u91CA\u90E8\u5206\u6DFB\u52A0\u4E86\u5BFC\u5165\u8FD9\u4E24\u4E2A\u5934\u6587\u4EF6\u7684\u4EE3\u7801\uFF0C\u5E76\u4E14\u901A\u8FC7 import \u201CC\u201D \u5BFC\u5165\u8FDB\u6765\u3002</p><h4 id="_2-unsafe-pointer" tabindex="-1"><a class="header-anchor" href="#_2-unsafe-pointer" aria-hidden="true">#</a> 2.unsafe.Pointer<a href="#a86c02">#</a></h4><p>\u8FD9\u91CC\u4EE5 malloc () \u7CFB\u7EDF\u8C03\u7528\u4E3A\u4F8B\uFF0C\u901A\u8FC7 man<a href="#_ftn5">[5]</a> \u624B\u518C\u67E5\u770B malloc () \u51FD\u6570\u7684\u539F\u578B\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>#include &lt;stdlib.h&gt;

void *malloc(size_t size);

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u51FD\u6570 malloc () \u5F62\u53C2\u662F C \u8BED\u8A00\u4E2D\u7684 size_t \u6570\u636E\u7C7B\u578B\u7C7B\u578B\uFF0C\u90A3\u4E48\u5728 Golang \u4E2D\u4F7F\u7528\u5BF9\u5E94\u7684 C \u7C7B\u578B\u662F C.size_t\uFF0C\u662F\u7684\uFF0C\u4E00\u822C\u7684 C \u57FA\u672C\u7C7B\u578B\u53EA\u9700\u8981\u901A\u8FC7 C \u5305\u76F4\u63A5\u8BBF\u95EE\u5373\u53EF\u3002\u4F46\u662F\u5BF9\u4E8E malloc () \u7684\u8FD4\u56DE\u503C void <em>\u6765\u8BF4\uFF0C\u8FD9\u662F\u4E00\u4E2A\u4E07\u80FD\u6307\u9488\uFF0C\u671F\u529F\u80FD\u7528\u6CD5\u7C7B\u4F3C Golang \u4E2D\u7684 interface {}\uFF0C\u4F46\u662F\u5728\u8BED\u6CD5\u4E0A\u5E76\u4E0D\u80FD\u5C06\u4E8C\u8005\u76F4\u63A5\u5212\u7B49\u53F7\u3002\u800C Golang \u7ED9\u5F00\u53D1\u8FD9\u63D0\u4F9B\u4E86\u4E00\u4E2A\u53EF\u4EE5\u76F4\u63A5\u5BF9\u7B49 C \u4E2D void</em> \u7684\u6570\u636E\u7C7B\u578B\uFF0C\u5C31\u662F unsafe.Pointer\u3002unsafe.Pointer \u662F Golang \u5C01\u88C5\u597D\u7684\u53EF\u4EE5\u6BD4\u8F83\u81EA\u7531\u8BBF\u95EE\u7684\u6307\u9488\u7C7B\u578B\uFF0C\u5176\u542B\u4E49\u548C void <em>\u4E07\u80FD\u6307\u9488\u76F8\u4F3C\u3002\u5728\u8BED\u6CD5\u4E0A\uFF0C\u4E5F\u53EF\u4EE5\u76F4\u63A5\u5C06 void</em> \u7C7B\u578B\u6570\u636E\u8D4B\u503C\u7ED9 unsafe.Pointer \u7C7B\u578B\u6570\u636E\u3002</p><h4 id="_3-golang-\u4E0E-c-\u7684\u5B57\u7B26\u4E32\u7B49\u7C7B\u578B\u8F6C\u6362" tabindex="-1"><a class="header-anchor" href="#_3-golang-\u4E0E-c-\u7684\u5B57\u7B26\u4E32\u7B49\u7C7B\u578B\u8F6C\u6362" aria-hidden="true">#</a> 3.Golang \u4E0E C \u7684\u5B57\u7B26\u4E32\u7B49\u7C7B\u578B\u8F6C\u6362<a href="#b37edf">#</a></h4><p>\u5728 Cgo \u4E2D Go \u7684\u5B57\u7B26\u4E32\u4E0E Byte \u6570\u7EC4\u90FD\u4F1A\u8F6C\u6362\u4E3A C \u7684 char \u6570\u7EC4\uFF0C\u5176\u4E2D Golang \u7684 Cgo \u6A21\u5757\u63D0\u4F9B\u4E86\u51E0\u4E2A\u65B9\u6CD5\u4F9B\u5F00\u53D1\u8005\u4F7F\u7528\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// Go\u5B57\u7B26\u4E32\u8F6C\u6362\u4E3AC\u5B57\u7B26\u4E32\u3002C\u5B57\u7B26\u4E32\u4F7F\u7528malloc\u5206\u914D\uFF0C\u56E0\u6B64\u9700\u8981\u4F7F\u7528C.free\u4EE5\u907F\u514D\u5185\u5B58\u6CC4\u9732
func C.CString(string) *C.char

// Go byte\u6570\u7EC4\u8F6C\u6362\u4E3AC\u7684\u6570\u7EC4\u3002\u4F7F\u7528malloc\u5206\u914D\u7684\u7A7A\u95F4\uFF0C\u56E0\u6B64\u9700\u8981\u4F7F\u7528C.free\u907F\u514D\u5185\u5B58\u6CC4\u6F0F
func C.CBytes([awsef]byte) unsafe.Pointer

// C\u5B57\u7B26\u4E32\u8F6C\u6362\u4E3AGo\u5B57\u7B26\u4E32
func C.GoString(*C.char) string

// C\u5B57\u7B26\u4E32\u8F6C\u6362\u4E3AGo\u5B57\u7B26\u4E32\uFF0C\u6307\u5B9A\u8F6C\u6362\u957F\u5EA6
func C.GoStringN(*C.char, C.int) string

// C\u6570\u636E\u8F6C\u6362\u4E3Abyte\u6570\u7EC4\uFF0C\u6307\u5B9A\u8F6C\u6362\u7684\u957F\u5EA6
func C.GoBytes(unsafe.Pointer, C.int) [awsef]byte

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D C.CBytes () \u65B9\u6CD5\u53EF\u4EE5\u5C06 Golang \u7684 [awsef] byte \u5207\u7247\u8F6C\u6362\u6210 unsafe.Pointer \u7C7B\u578B\u3002\u5229\u7528\u8FD9\u4E2A\u8F6C\u6362\u529F\u80FD\uFF0C\u6765\u5206\u6790\u4E00\u4E0B\u662F\u5982\u4F55\u5C01\u88C5 memcpy () \u51FD\u6570\u7684\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func Memcpy(dest unsafe.Pointer, src [awsef]byte, length int) {
   srcData := C.CBytes(src)
   C.memcpy(dest, srcData, C.size_t(length))
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u65B0\u5C01\u88C5\u7684 Memcpy () \u7684\u7B2C\u4E00\u4E2A\u5F62\u53C2\u662F\u4EFB\u610F\u6307\u9488\u7C7B\u578B\uFF0C\u8868\u793A\u62F7\u8D1D\u7684\u76EE\u6807\u5730\u5740\uFF0C\u7B2C\u4E8C\u4E2A\u5F62\u53C2\u662F [awsef] byte \u7C7B\u578B\uFF0C\u8868\u793A\u88AB\u62F7\u8D1D\u7684\u6E90\u6570\u636E\uFF0C\u7B2C\u4E09\u4E2A\u53C2\u6570\u8868\u793A\u672C\u6B21\u62F7\u8D1D\u6570\u636E\u7684\u957F\u5EA6\u3002\u56E0\u4E3A C \u8BED\u8A00\u4E2D\u7684 memcpy () \u51FD\u6570\u539F\u578B\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>#include &lt;string.h&gt;

void *memcpy(void *dst, const void *src, size_t n);

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5BF9\u4E8E src \u6570\u636E\u6E90\u5F62\u53C2\u9700\u8981 [awsef] byte \u8F6C\u6362\u4E3A unsafe.Pointer\uFF0C\u56E0\u6B64\u5728\u8C03\u7528 C \u7684\u63A5\u53E3\u662F\u901A\u8FC7 C.CBytes () \u8F6C\u6362\u4E86\u4E00\u4E0B\u3002</p><p>Free () \u548C Memmove () \u65B9\u6CD5\u7684\u5C01\u88C5\u548C\u4E0A\u8FF0\u4E00\u6837\u3002Free () \u4E0E Malloc () \u5BF9\u5E94\uFF0CMemmove () \u4E3A\u79FB\u52A8\u4E00\u5757\u8FDE\u7EED\u5185\u5B58\u3002</p><p>\u63A5\u4E0B\u6765\u5C06\u4E0A\u8FF0\u5C01\u88C5\u505A\u4E00\u4E2A\u7B80\u5355\u7684\u5355\u5143\u6D4B\u8BD5\uFF0C\u5728 c / \u76EE\u5F55\u4E0B\u521B\u5EFA memory_test.go\uFF0C\u5B9E\u73B0\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>package c_test

import (
   &quot;zmem/c&quot;
   &quot;bytes&quot;
   &quot;encoding/binary&quot;
   &quot;fmt&quot;
   &quot;testing&quot;
   &quot;unsafe&quot;
)

func IsLittleEndian() bool {
   var n int32 = 0x01020304

   //\u4E0B\u9762\u662F\u4E3A\u4E86\u5C06int32\u7C7B\u578B\u7684\u6307\u9488\u8F6C\u6362\u6210byte\u7C7B\u578B\u7684\u6307\u9488
   u := unsafe.Pointer(&amp;n)
   pb := (*byte)(u)

   //\u53D6\u5F97pb\u4F4D\u7F6E\u5BF9\u5E94\u7684\u503C
   b := *pb

   //\u7531\u4E8Eb\u662Fbyte\u7C7B\u578B\uFF0C\u6700\u591A\u4FDD\u5B588\u4F4D\uFF0C\u90A3\u4E48\u53EA\u80FD\u53D6\u5F97\u5F00\u59CB\u76848\u4F4D
   // \u5C0F\u7AEF: 04 (03 02 01)
   // \u5927\u7AEF: 01 (02 03 04)
   return (b == 0x04)
}

func IntToBytes(n uint32) [awsef]byte {
   x := int32(n)
   bytesBuffer := bytes.NewBuffer([awsef]byte{})

   var order binary.ByteOrder
   if IsLittleEndian() {
      order = binary.LittleEndian
   } else {
      order = binary.BigEndian
   }
   binary.Write(bytesBuffer, order, x)

   return bytesBuffer.Bytes()
}

func TestMemoryC(t *testing.T) {
   data := c.Malloc(4)
   fmt.Printf(&quot; data %+v, %T\\n&quot;, data, data)
   myData := (*uint32)(data)
   *myData = 5
   fmt.Printf(&quot; data %+v, %T\\n&quot;, *myData, *myData)

   var a uint32 = 100
   c.Memcpy(data, IntToBytes(a), 4)
   fmt.Printf(&quot; data %+v, %T\\n&quot;, *myData, *myData)

   c.Free(data)
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5355\u5143\u6D4B\u8BD5\u63A5\u53E3\u662F TestMemoryC ()\uFF0C\u9996\u5148\u901A\u8FC7 Malloc () \u5F00\u8F9F 4 \u4E2A\u5B57\u8282\u5185\u5B58\uFF0C\u7136\u540E\u5C06\u8FD9 4 \u4E2A\u5B57\u8282\u8D4B\u503C\u4E3A 5\uFF0C\u6253\u5370\u7ED3\u679C\u770B data \u7684\u503C\u662F\u5426\u662F 5\u3002\u6700\u540E\u662F\u5C06 100 \u901A\u8FC7 Memcpy () \u62F7\u8D1D\u7ED9\u8FD9 4 \u4E2A\u5B57\u8282\uFF0C\u770B\u6700\u540E\u7684\u7ED3\u679C\u662F\u5426\u662F 100\uFF0C\u8FD0\u884C\u7ED3\u679C\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>=== RUN   TestMemoryC
data 0x9d040a0, unsafe.Pointer
data 5, uint32
data 100, uint32
--- PASS: TestMemoryC (0.00s)
PASS

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u901A\u8FC7\u5355\u5143\u6D4B\u8BD5\u7ED3\u679C\u6765\u770B\uFF0C\u76EE\u524D\u7684\u5185\u5B58\u5F00\u8F9F\u548C\u62F7\u8D1D\u7684\u76F8\u5173\u63A5\u53E3\u53EF\u4EE5\u6B63\u5E38\u4F7F\u7528\uFF0C\u63A5\u4E0B\u6765\u5C31\u662F\u57FA\u4E8E\u8FD9\u4E9B\u63A5\u53E3\u6765\u5B9E\u73B0\u5185\u5B58\u7BA1\u7406\u7684\u6A21\u5757\u5B9E\u73B0\u3002</p><h3 id="_4-2-\u57FA\u7840\u5185\u5B58\u7F13\u51B2-buf-\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_4-2-\u57FA\u7840\u5185\u5B58\u7F13\u51B2-buf-\u5B9E\u73B0" aria-hidden="true">#</a> 4.2 \u57FA\u7840\u5185\u5B58\u7F13\u51B2 Buf \u5B9E\u73B0<a href="#a071ec">#</a></h3><p>\u5728 zmem \u76EE\u5F55\u4E0B\u518D\u521B\u5EFA mem \u6587\u4EF6\u5939\uFF0C\u5305 mem \u6A21\u5757\u4F5C\u4E3A\u5185\u5B58\u7BA1\u7406\u76F8\u5173\u4EE3\u7801\u7684\u5305\u540D\uFF0C\u7136\u540E\u518D mem \u76EE\u4E0B\u9762\u521B\u5EFA buf.go\uFF0C\u4F5C\u4E3A Buf \u7684\u4EE3\u7801\u5B9E\u73B0\u3002\u6587\u4EF6\u8DEF\u5F84\u7ED3\u6784\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>zmem/
\u251C\u2500\u2500 README.md
\u251C\u2500\u2500 c/
\u2502   \u251C\u2500\u2500 memory.go
\u2502   \u2514\u2500\u2500 memory_test.go
\u251C\u2500\u2500 go.mod
\u2514\u2500\u2500 mem/
\u2514\u2500\u2500 buf.go

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\u5B9A\u4E49\u4E00\u4E2A Buf \u6570\u636E\u7ED3\u6784\uFF0C\u5177\u4F53\u7684\u5B9A\u4E49\u5B9E\u73B0\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf.go

package mem

import &quot;unsafe&quot;

type Buf struct {
   //\u5982\u679C\u5B58\u5728\u591A\u4E2Abuffer\uFF0C\u662F\u91C7\u7528\u94FE\u8868\u7684\u5F62\u5F0F\u94FE\u63A5\u8D77\u6765
   Next *Buf
   //\u5F53\u524Dbuffer\u7684\u7F13\u5B58\u5BB9\u91CF\u5927\u5C0F
   Capacity int
   //\u5F53\u524Dbuffer\u6709\u6548\u6570\u636E\u957F\u5EA6
   length int
   //\u672A\u5904\u7406\u6570\u636E\u7684\u5934\u90E8\u4F4D\u7F6E\u7D22\u5F15
   head int
   //\u5F53\u524Dbuf\u6240\u4FDD\u5B58\u7684\u6570\u636E\u5730\u5740
   data unsafe.Pointer
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E00\u4E2A Buf \u5185\u5B58\u7F13\u51B2\u5305\u542B\u5982\u4E0B\u6210\u5458\u5C5E\u6027\uFF1A</p><p>\uFF081\uFF09Capacity\uFF0C\u8868\u793A\u5F53\u524D\u7F13\u51B2\u7684\u5BB9\u91CF\u5927\u5C0F\uFF0C\u5B9E\u5219\u662F\u5E95\u5C42\u5185\u5B58\u5206\u914D\u7684\u6700\u5927\u5185\u5B58\u7A7A\u95F4\u4E0A\u9650\u3002</p><p>\uFF082\uFF09length\uFF0C\u5F53\u524D\u7F13\u51B2\u533A\u7684\u6709\u6548\u6570\u636E\u957F\u5EA6\uFF0C\u6709\u6548\u6570\u636E\u957F\u5EA6\u4E3A\u7528\u6237\u5B58\u5165\u4F46\u53C8\u672A\u8BBF\u95EE\u7684\u5269\u4F59\u6570\u636E\u957F\u5EA6\u3002</p><p>\uFF083\uFF09head\uFF0C\u7F13\u51B2\u4E2D\u672A\u5904\u7406\u7684\u5934\u90E8\u4F4D\u7F6E\u7D22\u5F15\u3002</p><p>\uFF084\uFF09data\uFF0C\u662F\u5F53\u524D buf \u6240\u4FDD\u5B58\u5185\u5B58\u7684\u9996\u5730\u5740\u6307\u9488\uFF0C\u8FD9\u91CC\u7528\u7684\u4E8B unsafe.Pointer \u7C7B\u578B\uFF0C\u8868\u793A data \u6240\u5B58\u653E\u7684\u4E3A\u57FA\u7840\u7684\u865A\u62DF\u5185\u5B58\u5730\u5740\u3002</p><p>\uFF085\uFF09Next\uFF0C\u662F Buf \u7C7B\u578B\u7684\u6307\u9488\uFF0C\u6307\u5411\u4E0B\u4E00\u4E2A Buf \u5730\u5740\u3002Buf \u4E0E Buf \u4E4B\u95F4\u7684\u5173\u7CFB\u662F\u4E00\u4E2A\u94FE\u8868\u7ED3\u6784\u3002</p><p>\u4E00\u4E2A Buf \u7684\u6570\u636E\u5185\u5B58\u7ED3\u6784\u5E03\u5C40\u5982\u56FE 13 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/4FVN22kCa6.png!large" alt="awsef"></p><h3 id="\u56FE-13-buf-\u7684\u6570\u636E\u7ED3\u6784\u5E03\u5C40" tabindex="-1"><a class="header-anchor" href="#\u56FE-13-buf-\u7684\u6570\u636E\u7ED3\u6784\u5E03\u5C40" aria-hidden="true">#</a> \u56FE 13 Buf \u7684\u6570\u636E\u7ED3\u6784\u5E03\u5C40<a href="#95a6de">#</a></h3><p>Buf \u662F\u91C7\u7528\u94FE\u8868\u7684\u96C6\u5408\u65B9\u5F0F\uFF0C\u6BCF\u4E2A Buf \u901A\u8FC7 Next \u8FDB\u884C\u5173\u8054\uFF0C\u5176\u4E2D Data \u4E3A\u6307\u5411\u5E95\u5C42\u5F00\u8F9F\u51FA\u6765\u4F9B\u7528\u6237\u4F7F\u7528\u7684\u5185\u5B58\u3002\u4E00\u4E2A\u5185\u5B58\u4E2D\u6709\u51E0\u4E2A\u523B\u5EA6\u7D22\u5F15\uFF0C\u5185\u5B58\u9996\u5730\u5740\u7D22\u5F15\u4F4D\u7F6E\u5B9A\u4E49\u4E3A 0\uFF0CHead \u4E3A\u5F53\u524D\u7528\u6237\u5E94\u7528\u6709\u6548\u6570\u636E\u7684\u9996\u5730\u5740\u7D22\u5F15\uFF0CLength \u4E3A\u6709\u6548\u6570\u636E\u5C3E\u5730\u5740\u7D22\u5F15\uFF0C\u6709\u6548\u6570\u636E\u7684\u957F\u5EA6\u4E3A \u201CLength-Head\u201D\u3002Capacity \u662F\u5F00\u8F9F\u5185\u5B58\u7684\u5C3E\u5730\u5740\u7D22\u5F15\uFF0C\u4E5F\u8868\u793A\u5F53\u524D Buf \u7684\u53EF\u4F7F\u7528\u5185\u5B58\u5BB9\u91CF\u3002</p><p>\u63A5\u4E0B\u6765\u6765\u63D0\u4F9B\u4E00\u4E2A Buf \u7684\u6784\u9020\u65B9\u6CD5\uFF0C\u5177\u4F53\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf.go

//\u6784\u9020\uFF0C\u521B\u5EFA\u4E00\u4E2ABuf\u5BF9\u8C61
func NewBuf(size int) *Buf {
   return &amp;Buf{
      Capacity: size,
      length: 0,
      head: 0,
      Next: nil,
      data : c.Malloc(size),
   }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>NewBuf () \u63A5\u6536\u4E00\u4E2A size \u5F62\u53C2\uFF0C\u7528\u6765\u8868\u793A\u5F00\u8F9F\u7684\u5185\u5B58\u7A7A\u95F4\u957F\u5EA6\u3002\u8FD9\u91CC\u8C03\u7528\u5C01\u88C5\u7684 c.Malloc () \u65B9\u6CD5\u6765\u7533\u8BF7 size \u957F\u5EA6\u7684\u5185\u5B58\u7A7A\u95F4\uFF0C\u5E76\u4E14\u8D4B\u503C\u7ED9 data\u3002</p><p>Buf \u88AB\u521D\u59CB\u5316\u4E4B\u540E\uFF0C\u9700\u8981\u7ED9 Buf \u8D4B\u4E88\u8BA9\u8C03\u7528\u65B9\u4F20\u5165\u6570\u636E\u7684\u63A5\u53E3\uFF0C\u8FD9\u91CC\u5141\u8BB8\u4E00\u4E2A Buf \u7684\u5185\u5B58\u53EF\u4EE5\u8D4B\u4E88 [awsef] byte \u7C7B\u578B\u7684\u6E90\u6570\u636E\uFF0C\u65B9\u6CD5\u540D\u79F0\u662F SetBytes ()\uFF0C\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf.go
//\u7ED9\u4E00\u4E2ABuf\u586B\u5145[awsef]byte\u6570\u636E
func (b *Buf) SetBytes(src [awsef]byte) {
   c.Memcpy(unsafe.Pointer(uintptr(b.data)+uintptr(b.head)), src, len(src))
   b.length += len(src)
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u64CD\u4F5C\u4E00\u5171\u6709\u4E24\u4E2A\u8FC7\u7A0B\u7EC4\u6210\uFF1A</p><p>\uFF081\uFF09\u5C06 [awsef] byte \u6E90\u6570\u636E src \u901A\u8FC7 C \u63A5\u53E3\u7684\u5185\u5B58\u62F7\u8D1D\uFF0C\u7ED9 Buf \u7684 data \u8D4B\u503C\u3002\u8FD9\u91CC\u8981\u6CE8\u610F\u7684\u662F\u88AB\u62F7\u8D1D\u7684 data \u7684\u8D77\u59CB\u5730\u5740\u662F b.head\u3002</p><p>\uFF082\uFF09\u62F7\u8D1D\u4E4B\u540E Buf \u7684\u6709\u6548\u6570\u636E\u957F\u5EA6\u8981\u76F8\u5E94\u7684\u7D2F\u52A0\u504F\u79FB\uFF0C\u5177\u4F53\u7684\u8FC7\u7A0B\u5982\u56FE 14 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/7Sm6uBF3yK.png!large" alt="awsef"></p><h3 id="\u56FE-14-setbytes-\u5185\u5B58\u64CD\u4F5C" tabindex="-1"><a class="header-anchor" href="#\u56FE-14-setbytes-\u5185\u5B58\u64CD\u4F5C" aria-hidden="true">#</a> \u56FE 14 SetBytes \u5185\u5B58\u64CD\u4F5C<a href="#42ad87">#</a></h3><p>\u8FD9\u91CC\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u62F7\u8D1D\u7684\u8D77\u59CB\u5730\u5740\u4F1A\u57FA\u4E8E data \u7684\u57FA\u5730\u5740\u5411\u53F3\u504F\u79FB head \u7684\u957F\u5EA6\uFF0C\u56E0\u4E3A\u5B9A\u4E49\u662F\u4ECE Head \u5230 Length \u662F\u6709\u6548\u5408\u6CD5\u6570\u636E\u3002\u5BF9\u4E8E unsafe.Pointer \u7684\u5730\u5740\u504F\u79FB\u9700\u8981\u8F6C\u6362\u4E3A uintptr \u7C7B\u578B\u8FDB\u884C\u5730\u5740\u8BA1\u7B97\u3002</p><p>\u4E0E SetBytes () \u5BF9\u5E94\u7684\u662F GetBytes ()\uFF0C\u662F\u4ECE Buf \u7684 data \u4E2D\u83B7\u53D6\u6570\u636E\uFF0C\u5177\u4F53\u5B9E\u73B0\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf.go

//\u83B7\u53D6\u4E00\u4E2ABuf\u7684\u6570\u636E\uFF0C\u4EE5[awsef]byte\u5F62\u5F0F\u5C55\u73B0
func (b *Buf) GetBytes() [awsef]byte {
   data := C.GoBytes(unsafe.Pointer(uintptr(b.data)+uintptr(b.head)), C.int(b.length))
   return data
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D C.GoBytes () \u662F Cgo \u6A21\u5757\u63D0\u4F9B\u7684\u5C06 C \u6570\u636E\u8F6C\u6362\u4E3A byte \u6570\u7EC4\uFF0C\u5E76\u4E14\u6307\u5B9A\u8F6C\u6362\u7684\u957F\u5EA6\u3002</p><p>\u53D6\u6570\u636E\u7684\u8D77\u59CB\u5730\u5740\u4F9D\u7136\u662F\u57FA\u4E8E data \u8FDB\u884C head \u957F\u5EA6\u7684\u504F\u79FB\u3002</p><p>Buf \u8FD8\u9700\u8981\u63D0\u4F9B\u4E00\u4E2A Copy () \u65B9\u6CD5\uFF0C\u7528\u6765\u5C06\u5176\u4ED6 Buf \u7F13\u51B2\u5BF9\u8C61\u76F4\u63A5\u590D\u5236\u62F7\u8D1D\u5230\u81EA\u8EAB\u5F53\u4E2D\uFF0C\u4E14 head\u3001length \u7B49\u4E8E\u5BF9\u65B9\u5B8C\u5168\u4E00\u6837\uFF0C\u5177\u4F53\u5B9E\u73B0\u7684\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf.go

//\u5C06\u5176\u4ED6Buf\u5BF9\u8C61\u6570\u636E\u8003\u672C\u5230\u81EA\u5DF1\u4E2D
func (b *Buf) Copy(other *Buf) {
   c.Memcpy(b.data, other.GetBytes(), other.length)
   b.head = 0
   b.length = other.length
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\u9700\u8981\u63D0\u4F9B\u53EF\u4EE5\u79FB\u52A8 head \u7684\u65B9\u6CD5\uFF0C\u5176\u4F5C\u7528\u662F\u7F29\u5C0F\u6709\u6548\u6570\u636E\u957F\u5EA6\uFF0C\u5F53\u8C03\u7528\u65B9\u5DF2\u7ECF\u4F7F\u7528\u4E86\u4E00\u90E8\u5206\u6570\u636E\u4E4B\u540E\uFF0C\u8FD9\u90E8\u5206\u6570\u636E\u53EF\u80FD\u4F1A\u53D8\u6210\u975E\u6CD5\u7684\u975E\u6709\u6548\u6570\u636E\uFF0C\u90A3\u4E48\u5C31\u9700\u8981\u5C06 head \u5411\u540E\u504F\u79FB\u7F29\u5C0F\u6709\u6548\u6570\u636E\u7684\u957F\u5EA6\uFF0CBuf \u5C06\u63D0\u4F9B\u4E00\u4E2A\u540D\u5B57\u53EB Pop () \u7684\u65B9\u6CD5\uFF0C\u5177\u4F53\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf.go

//\u5904\u7406\u957F\u5EA6\u4E3Alen\u7684\u6570\u636E\uFF0C\u79FB\u52A8head\u548C\u4FEE\u6B63length
func (b *Buf) Pop(len int) {
   if b.data == nil {
      fmt.Printf(&quot;pop data is nil&quot;)
      return
   }
   if len &gt; b.length {
      fmt.Printf(&quot;pop len &gt; length&quot;)
      return
   }
   b.length -= len
   b.head += len
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E00\u6B21 Pop () \u64CD\u4F5C\uFF0C\u9996\u5148\u4F1A\u5224\u65AD\u5F39\u51FA\u5408\u6CD5\u6709\u6548\u6570\u636E\u7684\u957F\u5EA6\u662F\u5426\u8D8A\u754C\u3002\u7136\u540E\u5BF9\u5E94\u7684 head \u5411\u53F3\u504F\u79FB\uFF0Clength \u7684\u6709\u6548\u957F\u5EA6\u5BF9\u5E94\u505A\u7F29\u51CF\uFF0C\u5177\u4F53\u7684\u6D41\u7A0B\u5982\u56FE 15 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/uKA54pZVZ6.png!large" alt="awsef"></p><h3 id="\u56FE-15-pop-\u5185\u5B58\u64CD\u4F5C\u7684-head-\u4E0E-length-\u504F\u79FB" tabindex="-1"><a class="header-anchor" href="#\u56FE-15-pop-\u5185\u5B58\u64CD\u4F5C\u7684-head-\u4E0E-length-\u504F\u79FB" aria-hidden="true">#</a> \u56FE 15 Pop \u5185\u5B58\u64CD\u4F5C\u7684 head \u4E0E length \u504F\u79FB<a href="#8ac913">#</a></h3><p>\u56E0\u4E3A\u8C03\u7528\u65B9\u7ECF\u5E38\u7684\u83B7\u53D6\u6570\u636E\uFF0C\u7136\u540E\u8C03\u7528 Pop () \u7F29\u51CF\u6709\u6548\u957F\u5EA6\uFF0C\u90A3\u4E48\u4E0D\u51FA\u51E0\u6B21\uFF0C\u53EF\u80FD\u5C31\u4F1A\u5BFC\u81F4 head \u8D8A\u6765\u8D8A\u63A5\u8FD1 Capacity\uFF0C\u4E5F\u4F1A\u5BFC\u81F4\u6709\u6548\u6570\u636E\u4E4B\u524D\u7684\u5DF2\u7ECF\u8FC7\u671F\u7684\u975E\u6CD5\u6570\u636E\u8D8A\u6765\u8D8A\u591A\u3002\u6240\u4EE5 Buf \u9700\u8981\u63D0\u4F9B\u4E00\u4E2A Adjust () \u65B9\u6CD5\uFF0C\u6765\u5C06\u6709\u6548\u6570\u636E\u7684\u5185\u5B58\u8FC1\u79FB\u81F3 data \u57FA\u5730\u5740\u4F4D\u7F6E\uFF0C\u8986\u76D6\u4E4B\u524D\u7684\u5DF2\u4F7F\u7528\u8FC7\u7684\u8FC7\u671F\u6570\u636E\uFF0C\u5C06\u540E\u7EED\u7684\u7A7A\u767D\u53EF\u4F7F\u7528\u7A7A\u95F4\u6269\u5927\u3002Adjust () \u7684\u5B9E\u73B0\u65B9\u6CD5\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf.go

//\u5C06\u5DF2\u7ECF\u5904\u7406\u8FC7\u7684\u6570\u636E\uFF0C\u6E05\u7A7A,\u5C06\u672A\u5904\u7406\u7684\u6570\u636E\u63D0\u524D\u81F3\u6570\u636E\u9996\u5730\u5740
func (b *Buf) Adjust() {
   if b.head != 0 {
      if (b.length != 0) {
         c.Memmove(b.data, unsafe.Pointer(uintptr(b.data) + uintptr(b.head)), b.length)
      }
      b.head = 0
   }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Adjust () \u8C03\u7528\u4E4B\u524D\u5C01\u88C5\u597D\u7684 c.Memmove () \u65B9\u6CD5\uFF0C\u5C06\u6709\u6548\u6570\u636E\u5185\u5B58\u5E73\u79FB\u81F3 Buf \u7684 data \u57FA\u5730\u5730\u5740\uFF0C\u540C\u65F6\u5C06 head \u91CD\u7F6E\u5230 0 \u4F4D\u7F6E\uFF0C\u5177\u4F53\u7684\u6D41\u7A0B\u5982\u56FE 16 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/2ZKbGrxHAn.png!large" alt="awsef"></p><h3 id="\u56FE-16-adjust-\u64CD\u4F5C\u7684\u5185\u5B58\u5E73\u79FB" tabindex="-1"><a class="header-anchor" href="#\u56FE-16-adjust-\u64CD\u4F5C\u7684\u5185\u5B58\u5E73\u79FB" aria-hidden="true">#</a> \u56FE 16 Adjust \u64CD\u4F5C\u7684\u5185\u5B58\u5E73\u79FB<a href="#c19a7c">#</a></h3><p>Buf \u4E5F\u8981\u63D0\u4F9B\u4E00\u4E2A\u6E05\u7A7A\u7F13\u51B2\u5185\u5B58\u7684\u65B9\u6CD5 Clear ()\uFF0CClear () \u5B9E\u73B0\u5F88\u7B80\u5355\uFF0C\u53EA\u9700\u8981\u5C06\u51E0\u4E2A\u7D22\u5F15\u503C\u6E05\u96F6\u5373\u53EF\uFF0CClear () \u5E76\u4E0D\u4F1A\u4EE5\u64CD\u4F5C\u7CFB\u7EDF\u5C42\u9762\u56DE\u6536\u5185\u5B58\uFF0C\u56E0\u4E3A Buf \u7684\u662F\u5426\u56DE\u6536\uFF0C\u662F\u5426\u88AB\u91CD\u7F6E\u7B49\u9700\u8981\u4F9D\u8D56 BufPool \u5185\u5B58\u6C60\u6765\u7BA1\u7406\uFF0C\u5C06\u5728\u4E0B\u4E00\u5C0F\u7ED3\u4ECB\u7ECD\u5185\u5B58\u6C60\u7BA1\u7406 Buf \u7684\u60C5\u51B5\u3002\u4E3A\u4E86\u964D\u4F4E\u7CFB\u7EDF\u5185\u5B58\u7684\u5F00\u8F9F\u548C\u56DE\u6536\uFF0CBuf \u53EF\u80FD\u957F\u671F\u5728\u5185\u5B58\u6C60\u4E2D\u5B58\u5728\u3002\u8C03\u7528\u65B9\u53EA\u9700\u8981\u6539\u53D8\u51E0\u4E2A\u5730\u5740\u7D22\u5F15\u503C\u5C31\u53EF\u4EE5\u8FBE\u5230\u5185\u5B58\u7684\u4F7F\u7528\u548C\u56DE\u6536\u3002Clear () \u65B9\u6CD5\u7684\u5B9E\u73B0\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf.go

//\u6E05\u7A7A\u6570\u636E
func (b *Buf) Clear() {
   b.length = 0
   b.head = 0
}
\u5176\u4ED6\u7684\u63D0\u4F9B\u7684\u8BBF\u95EEhead\u548Clength\u7684\u65B9\u6CD5\u5982\u4E0B\uFF1A
func (b *Buf) Head() int {
   return b.head
}

func (b *Buf) Length() int {
   return b.length
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u73B0\u5728 Buf \u7684\u57FA\u672C\u529F\u80FD\u5DF2\u7ECF\u5B9E\u73B0\u5B8C\u6210\u4E86\uFF0C\u63A5\u4E0B\u6765\u5B9E\u73B0\u5BF9 Buf \u7684\u7BA1\u7406\u5185\u5B58\u6C60\u6A21\u5757\u3002</p><h3 id="_4-3-\u5185\u5B58\u6C60\u8BBE\u8BA1\u4E0E\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_4-3-\u5185\u5B58\u6C60\u8BBE\u8BA1\u4E0E\u5B9E\u73B0" aria-hidden="true">#</a> 4.3 \u5185\u5B58\u6C60\u8BBE\u8BA1\u4E0E\u5B9E\u73B0<a href="#d3dbb6">#</a></h3><p>\u4E00\u4E2A Buf \u53EA\u662F\u4E00\u6B21\u5185\u5B58\u4F7F\u7528\u6240\u9700\u8981\u5B58\u653E\u6570\u636E\u7684\u7F13\u51B2\u7A7A\u95F4\uFF0C\u4E3A\u4E86\u65B9\u4FBF\u591A\u4E2A Buf \u76F4\u63A5\u7684\u7533\u8BF7\u4E0E\u7BA1\u7406\uFF0C\u5219\u9700\u8981\u8BBE\u8BA1\u4E00\u4E2A\u5185\u5B58\u6C60\u6765\u7EDF\u4E00\u8FDB\u884C Buf \u7684\u8C03\u914D\u3002</p><p>\u5185\u5B58\u6C60\u7684\u8BBE\u8BA1\u662F\u9884\u5F00\u8F9F\u5185\u5B58\uFF0C\u5C31\u662F\u5728\u9996\u6B21\u7533\u8BF7\u521B\u5EFA\u5185\u5B58\u6C60\u7684\u65F6\u5019\uFF0C\u5C31\u5C06\u6C60\u5B50\u91CC\u5168\u90E8\u53EF\u4EE5\u88AB\u4F7F\u7528\u7684 Buf \u5185\u5B58\u7A7A\u95F4\u96C6\u5408\u4E00\u5E76\u7533\u8BF7\u5F00\u8F9F\u51FA\u6765\u3002\u8C03\u7528\u65B9\u5728\u7533\u8BF7\u5185\u5B58\u7684\u65F6\u5019\uFF0C\u662F\u901A\u8FC7\u5185\u5B58\u6C60\u6765\u7533\u8BF7\uFF0C\u5185\u5B58\u6C60\u4ECE Buf \u96C6\u5408\u4E2D\u9009\u62E9\u672A\u88AB\u4F7F\u7528\u6216\u5360\u7528\u7684 Buf \u8FD4\u56DE\u7ED9\u8C03\u7528\u65B9\u3002\u8C03\u7528\u65B9\u5728\u4F7F\u7528\u5B8C Buf</p><p>\u4E4B\u540E\uFF0C\u4E5F\u662F\u5C06 Buf \u9000\u8FD8\u7ED9\u5185\u5B58\u6C60\u3002\u8FD9\u6837\u8C03\u7528\u65B9\u5373\u4F7F\u9891\u7E41\u7684\u7533\u8BF7\u548C\u56DE\u6536\u5C0F\u7A7A\u95F4\u7684\u5185\u5B58\u4E5F\u4E0D\u4F1A\u51FA\u73B0\u9891\u7E41\u7684\u7CFB\u7EDF\u8C03\u7528\u7533\u8BF7\u7269\u7406\u5185\u5B58\u7A7A\u95F4\uFF0C\u964D\u4F4E\u4E86\u5185\u5B58\u52A8\u6001\u5F00\u8F9F\u7684\u5F00\u9500\u6210\u672C\uFF0C\u4E1A\u52A1\u65B9\u7684\u5185\u5B58\u8BBF\u95EE\u901F\u5EA6\u4E5F\u4F1A\u6709\u5F88\u5927\u7684\u63D0\u5347\u3002</p><p>\u4E0B\u9762\u6765\u5B9E\u73B0\u5185\u5B58\u6C60 BufPool\uFF0C\u9996\u5148\u5728 zmem/mem/ \u76EE\u5F55\u4E0B\u521B\u5EFA buf_pool.go \u6587\u4EF6\uFF0C\u5728\u5F53\u524D\u6587\u4EF6\u6765\u5B9E\u73B0 BufPool \u5185\u5B58\u6C60\u7684\u529F\u80FD\uFF0CBufPool \u7684\u6570\u636E\u7ED3\u6784\uFF0C\u4EE3\u7801\u5982\u4E0B\u6240\u793A\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf_pool.go
package mem

import (
   &quot;sync&quot;
)

//\u5185\u5B58\u7BA1\u7406\u6C60\u7C7B\u578B
type Pool map[int] *Buf

//Buf\u5185\u5B58\u6C60
type BufPool struct {
   //\u6240\u6709buffer\u7684\u4E00\u4E2Amap\u96C6\u5408\u53E5\u67C4
   Pool Pool
   PoolLock sync.RWMutex

   //\u603Bbuffer\u6C60\u7684\u5185\u5B58\u5927\u5C0F\u5355\u4F4D\u4E3AKB
   TotalMem uint64
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9996\u5148\u5B9A\u4E49 Pool \u6570\u636E\u7C7B\u578B\uFF0C\u8BE5\u7C7B\u578B\u8868\u793A\u7BA1\u7406\u5168\u90E8 Buf \u7684 Map \u96C6\u5408\uFF0C\u5176\u4E2D Key \u8868\u793A\u5F53\u524D</p><p>\u4E00\u7EC4 Buf \u7684 Capacity \u5BB9\u91CF\uFF0CValue \u5219\u662F\u4E00\u4E2A Buf \u94FE\u8868\u3002\u6BCF\u4E2A Key \u4E0B\u9762\u6302\u8F7D\u7740\u76F8\u540C Capacity \u7684 Buf \u96C6\u5408\u94FE\u8868\uFF0C\u5176\u5B9E\u662F BufPool \u7684\u6210\u5458\u5C5E\u6027\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><p>\uFF081\uFF09Pool\uFF0C\u5F53\u524D\u5185\u5B58\u6C60\u5168\u90E8\u7684 Buf \u7F13\u51B2\u5BF9\u8C61\u96C6\u5408\uFF0C\u662F\u4E00\u4E2A Map \u6570\u636E\u7ED3\u6784\u3002</p><p>\uFF082\uFF09PoolLock\uFF0C\u5BF9 Map \u8BFB\u5199\u5E76\u53D1\u5B89\u5168\u7684\u8BFB\u5199\u9501\u3002</p><p>\uFF083\uFF09TotalMem\uFF0C\u5F53\u524D BufPool \u6240\u5F00\u8F9F\u5185\u5B58\u6C60\u7533\u8BF7\u865A\u62DF\u5185\u5B58\u7684\u603B\u5BB9\u91CF\u3002</p><p>\u63A5\u4E0B\u6765\u63D0\u4F9B BufPoll \u7684\u521D\u59CB\u5316\u6784\u9020\u51FD\u6570\u65B9\u6CD5\uFF0CBufPool \u4F5C\u4E3A\u5185\u5B58\u6C60\uFF0C\u5168\u5C40\u5E94\u8BE5\u8BBE\u8BA1\u6210\u552F\u4E00\uFF0C\u6240\u4EE5\u91C7\u7528\u5355\u4F8B\u6A21\u5F0F\u8BBE\u8BA1\uFF0C\u4E0B\u9762\u5B9A\u4E49\u516C\u5171\u65B9\u6CD5 MemPool ()\uFF0C\u7528\u6765\u521D\u59CB\u5316\u5E76\u4E14\u83B7\u53D6 BufPoll \u5355\u4F8B\u5BF9\u8C61\uFF0C\u5177\u4F53\u7684\u5B9E\u73B0\u65B9\u5F0F\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf_pool.go

//\u5355\u4F8B\u5BF9\u8C61
var bufPoolInstance *BufPool
var once sync.Once

//\u83B7\u53D6BufPool\u5BF9\u8C61\uFF08\u5355\u4F8B\u6A21\u5F0F\uFF09
func MemPool() *BufPool{
   once.Do(func() {
      bufPoolInstance = new(BufPool)
      bufPoolInstance.Pool = make(map[int]*Buf)
      bufPoolInstance.TotalMem = 0
      bufPoolInstance.prev = nil
      bufPoolInstance.initPool()
   })

   return bufPoolInstance
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5168\u5C40\u904D\u5386\u6307\u9488 bufPoolInstance \u4F5C\u4E3A\u6307\u5411 BufPool \u5355\u4F8B\u5B9E\u4F8B\u7684\u552F\u4E00\u6307\u9488\uFF0C\u901A\u8FC7 Golang \u6807\u51C6\u5E93\u63D0\u4F9B sync.Once \u6765\u505A\u53EA\u6267\u884C\u4F9D\u6B21\u7684 Do () \u65B9\u6CD5\uFF0C\u6765\u521D\u59CB\u5316 BufPool\u3002\u5728\u5C06 BufPool \u6210\u5458\u5747\u8D4B\u503C\u5B8C\u4E4B\u540E\uFF0C\u6700\u540E\u901A\u8FC7 initPool () \u65B9\u6CD5\u6765\u521D\u59CB\u5316\u5185\u5B58\u6C60\u7684\u5185\u5B58\u7533\u8BF7\u5E03\u5C40\u3002</p><p>\u5185\u5B58\u7533\u8BF7 initPool () \u4F1A\u5C06\u5185\u5B58\u7684\u5206\u914D\u7ED3\u6784\u5982\u56FE 17 \u6240\u793A\u3002BufPool \u4F1A\u9884\u5148\u5C06\u6240\u6709\u8981\u7BA1\u7406\u7684 Buf \u6309\u7167\u5185\u5B58\u523B\u5EA6\u5927\u5C0F\u8FDB\u884C\u5206\u7EC4\uFF0C\u5982 4KB \u7684\u4E00\u7EC4\uFF0C16KB \u7684\u4E00\u7EC4\u7B49\u5F85\u3002\u5BB9\u91CF\u8D8A\u5C0F\u7684 Buf\uFF0C\u6240\u7BA1\u7406\u7684 Buf \u94FE\u8868\u7684\u6570\u91CF\u8D8A\u591A\uFF0C\u5BB9\u91CF\u8D8A\u5927\u7684 Buf \u6570\u91CF\u5219\u8D8A\u5C11\u3002\u5168\u90E8\u7684 Buf \u5173\u7CFB\u901A\u8FC7 Map \u6570\u636E\u7ED3\u6784\u6765\u7BA1\u7406\uFF0C\u7531\u4E8E Buf \u672C\u8EAB\u662F\u94FE\u8868\u6570\u636E\u7ED3\u6784\uFF0C\u6240\u4EE5\u6BCF\u4E2A Key \u6240\u5BF9\u5E94\u7684 Value \u53EA\u9700\u8981\u4FDD\u5B58\u5934\u7ED3\u70B9 Buf \u4FE1\u606F\u5373\u53EF\uFF0C\u4E4B\u540E\u7684 Buf \u53EF\u4EE5\u901A\u8FC7 Buf \u7684 Next \u6307\u9488\u627E\u5230\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/wzJf7M0K3b.png!large" alt="awsef"></p><h3 id="\u56FE-17-bufpool-\u5185\u5B58\u6C60\u7684\u5185\u5B58\u7BA1\u7406\u5E03\u5C40" tabindex="-1"><a class="header-anchor" href="#\u56FE-17-bufpool-\u5185\u5B58\u6C60\u7684\u5185\u5B58\u7BA1\u7406\u5E03\u5C40" aria-hidden="true">#</a> \u56FE 17 BufPool \u5185\u5B58\u6C60\u7684\u5185\u5B58\u7BA1\u7406\u5E03\u5C40<a href="#282190">#</a></h3><p>BufPool \u7684 initPool () \u521D\u59CB\u5316\u5185\u5B58\u65B9\u6CD5\u7684\u5177\u4F53\u5B9E\u73B0\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf_pool.go

const (
   m4K int = 4096
   m16K int = 16384
   m64K int = 655535
   m256K int = 262144
   m1M int = 1048576
   m4M int = 4194304
   m8M int = 8388608
)

/*
     \u521D\u59CB\u5316\u5185\u5B58\u6C60\u4E3B\u8981\u662F\u9884\u5148\u5F00\u8F9F\u4E00\u5B9A\u91CF\u7684\u7A7A\u95F4
  \u8FD9\u91CCBufPool\u662F\u4E00\u4E2Ahash\uFF0C\u6BCF\u4E2Akey\u90FD\u662F\u4E0D\u540C\u7A7A\u95F4\u5BB9\u91CF
  \u5BF9\u5E94\u7684value\u662F\u4E00\u4E2ABuf\u96C6\u5408\u7684\u94FE\u8868

BufPool --&gt; [m4K]  -- Buf-Buf-Buf-Buf...(BufList)
              [m16K] -- Buf-Buf-Buf-Buf...(BufList)
              [m64K] -- Buf-Buf-Buf-Buf...(BufList)
              [m256K]-- Buf-Buf-Buf-Buf...(BufList)
              [m1M] -- Buf-Buf-Buf-Buf...(BufList)
              [m4M] -- Buf-Buf-Buf-Buf...(BufList)
              [m8M] -- Buf-Buf-Buf-Buf...(BufList)
 */
func (bp *BufPool) initPool() {
   //----&gt; \u5F00\u8F9F4K buf \u5185\u5B58\u6C60
   // 4K\u7684Buf \u9884\u5148\u5F00\u8F9F5000\u4E2A\uFF0C\u7EA620MB\u4F9B\u5F00\u53D1\u8005\u4F7F\u7528
   bp.makeBufList(m4K, 5000)

   //----&gt; \u5F00\u8F9F16K buf \u5185\u5B58\u6C60
   //16K\u7684Buf \u9884\u5148\u5F00\u8F9F1000\u4E2A\uFF0C\u7EA616MB\u4F9B\u5F00\u53D1\u8005\u4F7F\u7528
   bp.makeBufList(m16K, 1000)

   //----&gt; \u5F00\u8F9F64K buf \u5185\u5B58\u6C60
   //64K\u7684Buf \u9884\u5148\u5F00\u8F9F500\u4E2A\uFF0C\u7EA632MB\u4F9B\u5F00\u53D1\u8005\u4F7F\u7528
   bp.makeBufList(m64K, 500)

   //----&gt; \u5F00\u8F9F256K buf \u5185\u5B58\u6C60
   //256K\u7684Buf \u9884\u5148\u5F00\u8F9F200\u4E2A\uFF0C\u7EA650MB\u4F9B\u5F00\u53D1\u8005\u4F7F\u7528
   bp.makeBufList(m256K, 200)

   //----&gt; \u5F00\u8F9F1M buf \u5185\u5B58\u6C60
   //1M\u7684Buf \u9884\u5148\u5F00\u8F9F50\u4E2A\uFF0C\u7EA650MB\u4F9B\u5F00\u53D1\u8005\u4F7F\u7528
   bp.makeBufList(m1M, 50)

   //----&gt; \u5F00\u8F9F4M buf \u5185\u5B58\u6C60
   //4M\u7684Buf \u9884\u5148\u5F00\u8F9F20\u4E2A\uFF0C\u7EA680MB\u4F9B\u5F00\u53D1\u8005\u4F7F\u7528
   bp.makeBufList(m4M, 20)

   //----&gt; \u5F00\u8F9F8M buf \u5185\u5B58\u6C60
   //8M\u7684io_buf \u9884\u5148\u5F00\u8F9F10\u4E2A\uFF0C\u7EA680MB\u4F9B\u5F00\u53D1\u8005\u4F7F\u7528
   bp.makeBufList(m8M, 10)
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D makeBufList () \u4E3A\u6BCF\u6B21\u521D\u59CB\u5316\u4E00\u79CD\u523B\u5EA6\u5BB9\u91CF\u7684 Buf \u94FE\u8868\uFF0C\u4EE3\u7801\u5B9E\u73B0\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf_pool.go

func (bp *BufPool) makeBufList(cap int, num int) {
   bp.Pool[cap] = NewBuf(cap)

   var prev *Buf
   prev = bp.Pool[cap]
   for i := 1; i &lt; num; i ++ {
      prev.Next = NewBuf(cap)
      prev = prev.Next
   }
   bp.TotalMem += (uint64(cap)/1024) * uint64(num)
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6BCF\u6B21\u521B\u5EFA\u4E00\u884C BufList \u4E4B\u540E\uFF0CBubPool \u5185\u5B58\u6C60\u7684 TotalMem \u5C31\u5BF9\u5E94\u589E\u52A0\u54CD\u5E94\u7533\u8BF7\u5185\u5B58\u7684\u5BB9\u91CF\uFF0C\u8FD9\u4E2A\u5C5E\u6027\u5C31\u4F5C\u4E3A\u5F53\u524D\u5185\u5B58\u6C60\u5DF2\u7ECF\u4ECE\u64CD\u4F5C\u7CFB\u7EDF\u83B7\u53D6\u7684\u5185\u5B58\u603B\u5BB9\u91CF\u4E3A\u591A\u5C11\u3002</p><p>\u73B0\u5728 BufPool \u5DF2\u7ECF\u5177\u5907\u4E86\u7533\u8BF7\u9996\u6B21\u521D\u59CB\u5316\u5185\u5B58\u6C60\u7684\u80FD\u529B\uFF0C\u8FD8\u5E94\u8BE5\u63D0\u4F9B\u4ECE BufPool \u83B7\u53D6\u4E00\u4E2A Buf \u5185\u5B58\u7684\u63A5\u53E3\uFF0C\u4E5F\u540C\u65F6\u9700\u8981\u5F53\u8C03\u7528\u65B9\u4F7F\u7528\u5B8C\u540E\uFF0C\u518D\u5C06\u5185\u5B58\u9000\u8FD8\u7ED9 BufPool \u7684\u63A5\u53E3\u3002</p><h4 id="_1-\u83B7\u53D6-buf" tabindex="-1"><a class="header-anchor" href="#_1-\u83B7\u53D6-buf" aria-hidden="true">#</a> 1. \u83B7\u53D6 Buf<a href="#b6ac54">#</a></h4><p>\u4E0B\u9762\u5B9A\u4E49 Alloc () \u65B9\u6CD5\u6765\u6807\u8BC6\u4ECE BufPool \u4E2D\u7533\u8BF7\u4E00\u4E2A\u53EF\u7528\u7684 Buf \u5BF9\u8C61\uFF0C\u5177\u4F53\u7684\u4EE3\u7801\u5B9E\u73B0\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf_pool.go

package mem

import (
   &quot;errors&quot;
   &quot;fmt&quot;
   &quot;sync&quot;
)

const (
   //\u603B\u5185\u5B58\u6C60\u6700\u5927\u9650\u5236\u5355\u4F4D\u662FKb \u6240\u4EE5\u76EE\u524D\u9650\u5236\u662F 5GB
   EXTRA_MEM_LIMIT int = 5 * 1024 * 1024
)

/*
   \u5F00\u8F9F\u4E00\u4E2ABuf
*/
func (bp *BufPool) Alloc(N int) (*Buf, error) {
   //1 \u627E\u5230N\u6700\u63A5\u8FD1\u54EAhash \u7EC4
   var index int
   if N &lt;= m4K {
      index = m4K
   } else if (N &lt;= m16K) {
      index = m16K
   } else if (N &lt;= m64K) {
      index = m64K
   } else if (N &lt;= m256K) {
      index = m256K
   } else if (N &lt;= m1M) {
      index = m1M
   } else if (N &lt;= m4M) {
      index = m4M
   } else if (N &lt;= m8M) {
      index = m8M
   } else {
      return nil, errors.New(&quot;Alloc size Too Large!&quot;);
   }

   //2 \u5982\u679C\u8BE5\u7EC4\u5DF2\u7ECF\u6CA1\u6709\uFF0C\u9700\u8981\u989D\u5916\u7533\u8BF7\uFF0C\u90A3\u4E48\u9700\u8981\u52A0\u9501\u4FDD\u62A4
   bp.PoolLock.Lock()
   if bp.Pool[index] == nil {
      if (bp.TotalMem + uint64(index/1024)) &gt;= uint64(EXTRA_MEM_LIMIT) {
         errStr := fmt.Sprintf(&quot;already use too many memory!\\n&quot;)
         return nil, errors.New(errStr)
      }

      newBuf := NewBuf(index)
      bp.TotalMem += uint64(index/1024)
      bp.PoolLock.Unlock()
      fmt.Printf(&quot;Alloc Mem Size: %d KB\\n&quot;, newBuf.Capacity/1024)
      return newBuf, nil
   }

   //3 \u5982\u679C\u6709\u8BE5\u7EC4\u6709Buf\u5185\u5B58\u5B58\u5728\uFF0C\u90A3\u4E48\u5F97\u5230\u4E00\u4E2ABuf\u5E76\u8FD4\u56DE\uFF0C\u5E76\u4E14\u4ECEpool\u4E2D\u6458\u9664\u8BE5\u5185\u5B58\u5757
   targetBuf := bp.Pool[index]
   bp.Pool[index] = targetBuf.Next
   bp.TotalMem -= uint64(index/1024)
   bp.PoolLock.Unlock()
   targetBuf.Next = nil
   fmt.Printf(&quot;Alloc Mem Size: %d KB\\n&quot;, targetBuf.Capacity/1024)
   return targetBuf, nil
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Alloc () \u51FD\u6570\u6709\u4E09\u4E2A\u5173\u952E\u6B65\u9AA4\uFF1A</p><p>\uFF081\uFF09\u5982\u679C\u4E0A\u5C42\u9700\u8981 N \u4E2A\u5B57\u8282\u7684\u5927\u5C0F\u7684\u7A7A\u95F4\uFF0C\u627E\u5230\u4E0E N \u6700\u63A5\u8FD1\u7684 Buf \u94FE\u8868\u96C6\u5408\uFF0C\u4ECE\u5F53\u524D Buf \u96C6\u5408\u53D6\u51FA\u3002</p><p>\uFF082\uFF09\u5982\u679C\u8BE5\u7EC4\u5DF2\u7ECF\u6CA1\u6709\u8282\u70B9\u4F7F\u7528\uFF0C\u53EF\u4EE5\u989D\u5916\u7533\u8BF7\u603B\u7533\u8BF7\u957F\u5EA6\u4E0D\u80FD\u591F\u8D85\u8FC7\u6700\u5927\u7684\u9650\u5236\u5927\u5C0F EXTRA_MEM_LIMIT\u3002</p><p>\uFF083\uFF09\u5982\u679C\u6709\u8BE5\u8282\u70B9\u9700\u8981\u7684\u5185\u5B58\u5757\uFF0C\u76F4\u63A5\u53D6\u51FA\uFF0C\u5E76\u4E14\u5C06\u8BE5\u5185\u5B58\u5757\u4ECE BufPool \u6458\u9664\u3002</p><h4 id="_2-\u9000\u8FD8-buf" tabindex="-1"><a class="header-anchor" href="#_2-\u9000\u8FD8-buf" aria-hidden="true">#</a> 2. \u9000\u8FD8 Buf<a href="#277159">#</a></h4><p>\u5B9A\u4E49 Revert () \u65B9\u6CD5\u4E3A\u4E3A\u9000\u8FD8\u4F7F\u7528\u540E\u7684 Buf \u7ED9 BufPool \u5185\u5B58\u6C60\uFF0C\u5177\u4F53\u7684\u4EE3\u7801\u5B9E\u73B0\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//\u5F53Alloc\u4E4B\u540E\uFF0C\u5F53\u524DBuf\u88AB\u4F7F\u7528\u5B8C\uFF0C\u9700\u8981\u91CD\u7F6E\u8FD9\u4E2ABuf,\u9700\u8981\u5C06\u8BE5buf\u653E\u56DEpool\u4E2D
func (bp *BufPool) Revert(buf *Buf) error {
   //\u6BCF\u4E2Abuf\u7684\u5BB9\u91CF\u90FD\u662F\u56FA\u5B9A\u7684\u5728hash\u7684key\u4E2D\u53D6\u503C
   index := buf.Capacity
   //\u91CD\u7F6Ebuf\u4E2D\u7684\u5185\u7F6E\u4F4D\u7F6E\u6307\u9488
   buf.Clear()

   bp.PoolLock.Lock()
   //\u627E\u5230\u5BF9\u5E94\u7684hash\u7EC4 buf\u9996\u5C4A\u70B9\u5730\u5740
   if _, ok := bp.Pool[index]; !ok {
      errStr := fmt.Sprintf(&quot;Index %d not in BufPoll!\\n&quot;, index)
      return errors.New(errStr)
   }

   //\u5C06buffer\u63D2\u56DE\u94FE\u8868\u5934\u90E8
   buf.Next = bp.Pool[index]
   bp.Pool[index] = buf
   bp.TotalMem += uint64(index/1024)
   bp.PoolLock.Unlock()
   fmt.Printf(&quot;Revert Mem Size: %d KB\\n&quot;,index/1024)

   return nil
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Revert () \u4F1A\u6839\u636E\u5F53\u524D Buf \u7684 Capacity \u627E\u5230\u5BF9\u5E94\u7684 Hash \u523B\u5EA6\uFF0C\u7136\u540E\u5C06 Buf \u63D2\u5165\u5230\u94FE\u8868\u7684\u5934\u90E8\uFF0C\u5728\u63D2\u5165\u4E4B\u524D\u901A\u8FC7 Buf \u7684 Clear () \u5C06 Buf \u7684\u5168\u90E8\u6709\u6548\u6570\u636E\u6E05\u7A7A\u3002</p><h3 id="_4-4-\u5185\u5B58\u6C60\u7684\u529F\u80FD\u5355\u5143\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_4-4-\u5185\u5B58\u6C60\u7684\u529F\u80FD\u5355\u5143\u6D4B\u8BD5" aria-hidden="true">#</a> 4.4 \u5185\u5B58\u6C60\u7684\u529F\u80FD\u5355\u5143\u6D4B\u8BD5<a href="#794861">#</a></h3><p>\u63A5\u4E0B\u6765\u5BF9\u4E0A\u8FF0\u63A5\u53E3\u505A\u4E00\u4E9B\u5355\u5143\u6D4B\u8BD5\uFF0C\u5728 zmem/mem/ \u76EE\u5F55\u4E0B\u521B\u5EFA buf_test.go \u6587\u4EF6\u3002</p><h4 id="_1-testbufpoolsetget" tabindex="-1"><a class="header-anchor" href="#_1-testbufpoolsetget" aria-hidden="true">#</a> 1.TestBufPoolSetGet<a href="#b442f3">#</a></h4><p>\u9996\u5148\u6D4B\u8BD5\u57FA\u672C\u7684 SetBytes () \u548C GetBytes () \u65B9\u6CD5\uFF0C\u5355\u6D4B\u4EE3\u7801\u7F16\u5199\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf_test.go

package mem_test

import (
   &quot;zmem/mem&quot;
   &quot;fmt&quot;
   &quot;testing&quot;
)

func TestBufPoolSetGet(t *testing.T) {
   pool := mem.MemPool()

   buffer, err := pool.Alloc(1)
   if err != nil {
      fmt.Println(&quot;pool Alloc Error &quot;, err)
      return
   }

   buffer.SetBytes([awsef]byte(&quot;Aceld12345&quot;))
   fmt.Printf(&quot;GetBytes = %+v, ToString = %s\\n&quot;, buffer.GetBytes(), string(buffer.GetBytes()))
   buffer.Pop(4)
   fmt.Printf(&quot;GetBytes = %+v, ToString = %s\\n&quot;, buffer.GetBytes(), string(buffer.GetBytes()))
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5355\u6D4B\u7528\u4F8B\u662F\u9996\u5148\u7533\u8BF7\u4E00\u4E2A\u5185\u5B58 buffer\uFF0C\u7136\u540E\u8BBE\u7F6E \u201CAceld12345\u201D \u5185\u5BB9\uFF0C\u7136\u540E\u8F93\u51FA\u65E5\u5FD7\uFF0C\u63A5\u4E0B\u6765\u5F39\u51FA\u6709\u6548\u6570\u636E 4 \u4E2A\u5B57\u8282\uFF0C\u518D\u6253\u5370 buffer \u53EF\u4EE5\u8BBF\u95EE\u7684\u5408\u6CD5\u6570\u636E\uFF0C\u6267\u884C\u5355\u5143\u6D4B\u8BD5\u4EE3\u7801\uFF0C\u901A\u8FC7\u5982\u4E0B\u6307\u4EE4\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ go test -run TestBufPoolSetGet
Alloc Mem Size: 4 KB
GetBytes = [65 99 101 108 100 49 50 51 52 53], ToString = Aceld12345
GetBytes = [100 49 50 51 52 53], ToString = d12345
PASS
ok      zmem/mem        0.010s

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u901A\u8FC7\u4E0A\u8FF0\u7ED3\u679C\u53EF\u5F97\u51FA\u901A\u8FC7 Pop (4) \u4E4B\u540E\uFF0C\u5DF2\u7ECF\u5F39\u51FA\u4E86 \u201CAcel\u201D \u524D 4 \u4E2A\u5B57\u8282\u6570\u636E\u3002</p><h4 id="_2-testbufpoolcopy" tabindex="-1"><a class="header-anchor" href="#_2-testbufpoolcopy" aria-hidden="true">#</a> 2.TestBufPoolCopy<a href="#3dd246">#</a></h4><p>\u63A5\u4E0B\u6765\u6D4B\u8BD5 Buf \u7684 Copy () \u8D4B\u503C\u65B9\u6CD5\uFF0C\u5177\u4F53\u7684\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf_test.go

package mem_test

import (
   &quot;zmem/mem&quot;
   &quot;fmt&quot;
   &quot;testing&quot;
)

func TestBufPoolCopy(t *testing.T) {
   pool := mem.MemPool()

   buffer, err := pool.Alloc(1)
   if err != nil {
      fmt.Println(&quot;pool Alloc Error &quot;, err)
      return
   }

   buffer.SetBytes([awsef]byte(&quot;Aceld12345&quot;))
   fmt.Printf(&quot;Buffer GetBytes = %+v\\n&quot;, string(buffer.GetBytes()))

   buffer2, err := pool.Alloc(1)
   if err != nil {
      fmt.Println(&quot;pool Alloc Error &quot;, err)
      return
   }
   buffer2.Copy(buffer)
   fmt.Printf(&quot;Buffer2 GetBytes = %+v\\n&quot;, string(buffer2.GetBytes()))
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5C06 buffer \u62F7\u8D1D\u7684 buffer2 \u4E2D\uFF0C\u770B buffer \u5B58\u653E\u7684\u6570\u636E\u5185\u5BB9\uFF0C\u6267\u884C\u5355\u5143\u6D4B\u8BD5\u6307\u4EE4\u548C\u6240\u5F97\u5230\u7684\u7ED3\u679C\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ go test -run TestBufPoolCopy
Alloc Mem Size: 4 KB
Buffer GetBytes = Aceld12345
Alloc Mem Size: 4 KB
Buffer2 GetBytes = Aceld12345
PASS
ok      zmem/mem        0.008s

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-testbufpooladjust" tabindex="-1"><a class="header-anchor" href="#_3-testbufpooladjust" aria-hidden="true">#</a> 3.TestBufPoolAdjust<a href="#c6e7ed">#</a></h4><p>\u4E4B\u540E\u6765\u9488\u5BF9 Buf \u7684 Adjust () \u65B9\u6CD5\u8FDB\u884C\u5355\u5143\u6D4B\u8BD5\uFF0C\u76F8\u5173\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/buf_test.go

package mem_test

import (
   &quot;zmem/mem&quot;
   &quot;fmt&quot;
   &quot;testing&quot;
)

func TestBufPoolAdjust(t *testing.T) {
   pool := mem.MemPool()

   buffer, err := pool.Alloc(4096)
   if err != nil {
      fmt.Println(&quot;pool Alloc Error &quot;, err)
      return
   }

   buffer.SetBytes([awsef]byte(&quot;Aceld12345&quot;))
   fmt.Printf(&quot;GetBytes = %+v, Head = %d, Length = %d\\n&quot;, buffer.GetBytes(), buffer.Head(), buffer.Length())
   buffer.Pop(4)
   fmt.Printf(&quot;GetBytes = %+v, Head = %d, Length = %d\\n&quot;, buffer.GetBytes(), buffer.Head(), buffer.Length())
   buffer.Adjust()
   fmt.Printf(&quot;GetBytes = %+v, Head = %d, Length = %d\\n&quot;, buffer.GetBytes(), buffer.Head(), buffer.Length())
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9996\u5148 buffer \u88AB\u586B\u5145 \u201CAceld12345\u201D\uFF0C\u7136\u540E\u6253\u5370 Head \u7D22\u5F15\u548C Length \u957F\u5EA6\uFF0C\u7136\u540E\u901A\u8FC7 Pop \u5F39\u51FA\u6709\u6548\u6570\u636E 4 \u4E2A\u5B57\u8282\uFF0C\u7EE7\u7EED\u6253\u5370\u65E5\u5FD7\uFF0C\u7136\u540E\u901A\u8FC7 Adjust () \u91CD\u7F6E Head\uFF0C\u518D\u8F93\u51FA buffer \u4FE1\u606F\uFF0C\u901A\u8FC7\u4E0B\u8FF0\u6307\u4EE4\u6267\u884C\u5355\u5143\u6D4B\u8BD5\u548C\u5F97\u5230\u7684\u7ED3\u679C\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ go test -run TestBufPoolAdjust
Alloc Mem Size: 4 KB
GetBytes = [65 99 101 108 100 49 50 51 52 53], Head = 0, Length = 10
GetBytes = [100 49 50 51 52 53], Head = 4, Length = 6
GetBytes = [100 49 50 51 52 53], Head = 0, Length = 6
PASS
ok      zmem/mem        0.009s

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u51FA\u7B2C\u4E09\u6B21\u8F93\u51FA\u7684\u65E5\u5FD7 Head \u5DF2\u7ECF\u91CD\u7F6E\u4E3A 0\uFF0C\u4E14 GetBytes () \u5F97\u5230\u7684\u6709\u6548\u6570\u636E\u6CA1\u6709\u6539\u53D8\u3002</p><h3 id="_4-5-\u5185\u5B58\u7BA1\u7406\u5E94\u7528\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_4-5-\u5185\u5B58\u7BA1\u7406\u5E94\u7528\u63A5\u53E3" aria-hidden="true">#</a> 4.5 \u5185\u5B58\u7BA1\u7406\u5E94\u7528\u63A5\u53E3<a href="#dc4357">#</a></h3><p>\u524D\u9762\u5C0F\u7ED3\u5DF2\u7ECF\u57FA\u672C\u5B9E\u73B0\u4E86\u4E00\u4E2A\u7B80\u5355\u7684\u5185\u5B58\u6C60\u7BA1\u7406\uFF0C\u4F46\u5982\u679C\u5E0C\u671B\u66F4\u65B9\u4FBF\u7684\u4F7F\u7528\uFF0C\u5219\u9700\u8981\u5BF9 Buf \u548C BufPool \u518D\u505A\u4E00\u5C42\u5C01\u88C5\uFF0C\u8FD9\u91CC\u5B9A\u4E49\u65B0\u6570\u636E\u7ED3\u6784 Zbuf\uFF0C\u5BF9 Buf \u7684\u57FA\u672C\u64CD\u4F5C\u505A\u5DF2\u7ECF\u5C01\u88C5\uFF0C\u4F7F\u5185\u5B58\u7BA1\u7406\u7684\u63A5\u53E3\u66F4\u52A0\u53CB\u597D\uFF0C\u5728 zmem/mem/ \u76EE\u5F55\u4E0B\u521B\u5EFA zbuf.go \u6587\u4EF6\uFF0C\u5207\u5B9A\u4E49\u6570\u636E\u7C7B\u578B Zbuf\uFF0C\u5177\u4F53\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/zbuf.go

package mem

//\u5E94\u7528\u5C42\u7684buffer\u6570\u636E
type ZBuf struct {
   b *Buf
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\u5B9A\u4E49 Zbuf \u5BF9\u5916\u63D0\u4F9B\u7684\u4E00\u4E9B\u4F7F\u7528\u65B9\u6CD5\u3002</p><h4 id="_1-clear-\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_1-clear-\u65B9\u6CD5" aria-hidden="true">#</a> 1.Clear () \u65B9\u6CD5<a href="#4a5c01">#</a></h4><p>Zbuf \u7684 Clear () \u65B9\u6CD5\u5B9E\u5219\u662F\u5C06 ZBuf \u4E2D\u7684 Buf \u9000\u8FD8\u7ED9 BufPool\uFF0C\u5177\u4F53\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/zbuf.go

//\u6E05\u7A7A\u5F53\u524D\u7684ZBuf
func (zb *ZBuf) Clear() {
   if zb.b != nil {
      //\u5C06Buf\u91CD\u65B0\u653E\u56DE\u5230buf_pool\u4E2D
      MemPool().Revert(zb.b)
      zb.b = nil
   }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 Buf \u7684 Clear () \u4E2D\u8C03\u7528\u4E86 MemPool () \u7684 Revert () \u65B9\u6CD5\uFF0C\u56DE\u6536\u4E86\u5F53\u524D Zbuf \u4E2D\u7684 Buf \u5BF9\u8C61\u3002</p><h4 id="_2-pop-\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_2-pop-\u65B9\u6CD5" aria-hidden="true">#</a> 2.Pop () \u65B9\u6CD5<a href="#858518">#</a></h4><p>Zbuf \u7684 Pop () \u65B9\u6CD5\u5BF9\u4E4B\u524D\u7684 Pop \u8FDB\u884C\u4E86\u4E00\u4E9B\u5B89\u5168\u6027\u8D8A\u754C\u6821\u9A8C\uFF0C\u5177\u4F53\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/zbuf.go

//\u5F39\u51FA\u5DF2\u4F7F\u7528\u7684\u6709\u6548\u957F\u5EA6
func (zb *ZBuf) Pop(len int) {
   if zb.b == nil || len &gt; zb.b.Length() {
      return
   }

   zb.b.Pop(len)

   //\u5F53\u6B64\u65F6Buf\u7684\u53EF\u7528\u957F\u5EA6\u5DF2\u7ECF\u4E3A0\u65F6,\u5C06Buf\u91CD\u65B0\u653E\u56DEBufPool\u4E2D
   if zb.b.Length() == 0 {
      MemPool().Revert(zb.b)
      zb.b = nil
   }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u679C Buf \u5728 Pop () \u4E4B\u540E\u7684\u6709\u6548\u6570\u636E\u957F\u5EA6\u4E3A 0\uFF0C\u90A3\u4E48\u5C31\u5C06\u5F53\u524D Buf \u9000\u8FD8\u7ED9 BufPool\u3002</p><h4 id="_3-data-\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_3-data-\u65B9\u6CD5" aria-hidden="true">#</a> 3.Data () \u65B9\u6CD5<a href="#0a302c">#</a></h4><p>Zbuf \u7684 Data () \u65B9\u6CD5\u5C31\u662F\u8FD4\u56DE Buf \u7684\u6570\u636E\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/zbuf.go

//\u83B7\u53D6Buf\u4E2D\u7684\u6570\u636E
func (zb *ZBuf) Data() [awsef]byte {
   if zb.b == nil {
      return nil
   }
   return zb.b.GetBytes()
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-adjust-\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_4-adjust-\u65B9\u6CD5" aria-hidden="true">#</a> 4.Adjust () \u65B9\u6CD5<a href="#295873">#</a></h4><p>Zbuf \u7684 Adjust () \u65B9\u6CD5\u7684\u5C01\u88C5\u4E5F\u6CA1\u6709\u4EFB\u4F55\u6539\u53D8\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/zbuf.go

//\u91CD\u7F6E\u7F13\u51B2\u533A
func (zb *ZBuf) Adjust() {
   if zb.b != nil {
      zb.b.Adjust()
   }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-read-\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_5-read-\u65B9\u6CD5" aria-hidden="true">#</a> 5.Read () \u65B9\u6CD5<a href="#c57d4e">#</a></h4><p>Zbuf \u7684 Read () \u65B9\u6CD5\u662F\u5C06\u6570\u636E\u586B\u5145\u5230 Zbuf \u7684 Buf \u4E2D\u3002Read () \u65B9\u6CD5\u662F\u5C06\u88AB\u586B\u5145\u7684\u6570\u636E\u4F5C\u4E3A\u5F62\u53C2 [awsef] byte \u4F20\u9012\u8FDB\u6765\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/zbuf.go

//\u8BFB\u53D6\u6570\u636E\u5230Buf\u4E2D
func (zb *ZBuf) Read(src [awsef]byte) (err error){
   if zb.b == nil {
      zb.b, err = MemPool().Alloc(len(src))
      if err != nil {
         fmt.Println(&quot;pool Alloc Error &quot;, err)
      }
   } else {
      if zb.b.Head() != 0 {
         return nil
      }
      if zb.b.Capacity - zb.b.Length() &lt; len(src) {
         //\u4E0D\u591F\u5B58\uFF0C\u91CD\u65B0\u4ECE\u5185\u5B58\u6C60\u7533\u8BF7
         newBuf, err := MemPool().Alloc(len(src)+zb.b.Length())
         if err != nil {
            return nil
         }
         //\u5C06\u4E4B\u524D\u7684Buf\u62F7\u8D1D\u5230\u65B0\u7533\u8BF7\u7684Buf\u4E2D\u53BB
         newBuf.Copy(zb.b)
         //\u5C06\u4E4B\u524D\u7684Buf\u56DE\u6536\u5230\u5185\u5B58\u6C60\u4E2D
         MemPool().Revert(zb.b)
         //\u65B0\u7533\u8BF7\u7684Buf\u6210\u4E3A\u5F53\u524D\u7684ZBuf
         zb.b = newBuf
      }
   }

   //\u5C06\u5185\u5BB9\u5199\u8FDBZBuf\u7F13\u51B2\u4E2D
   zb.b.SetBytes(src)

   return nil
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u679C\u5F53\u524D Zbuf \u7684 Buf \u4E3A\u7A7A\u5219\u4F1A\u5411 BufPool \u4E2D\u7533\u8BF7\u5185\u5B58\u3002\u5982\u679C\u4F20\u9012\u7684\u6E90\u6570\u636E\u8D85\u8FC7\u7684\u5F53\u524D Buf \u6240\u80FD\u627F\u8F7D\u7684\u5BB9\u91CF\uFF0C\u90A3\u4E48 Zbuf \u4F1A\u7533\u8BF7\u4E00\u4E2A\u66F4\u5927\u7684 Buf\uFF0C\u5C06\u4E4B\u524D\u7684\u5DF2\u6709\u7684\u6570\u636E\u901A\u8FC7 Copy () \u5230\u65B0\u7533\u8BF7\u7684 Buf \u4E2D\uFF0C\u4E4B\u540E\u5C06\u4E4B\u524D\u7684 Buf \u9000\u8FD8\u7ED9 BufPool \u4E2D\u3002</p><h4 id="_6-\u5176\u4ED6\u53EF\u62D3\u5C55\u65B9\u6CD5\u7B49" tabindex="-1"><a class="header-anchor" href="#_6-\u5176\u4ED6\u53EF\u62D3\u5C55\u65B9\u6CD5\u7B49" aria-hidden="true">#</a> 6. \u5176\u4ED6\u53EF\u62D3\u5C55\u65B9\u6CD5\u7B49<a href="#6074ee">#</a></h4><p>\u4E0A\u8FF0\u7684 Read () \u65B9\u6CD5\u4EE3\u8868 Zbuf \u4ECE\u53C2\u6570\u83B7\u53D6\u6E90\u6570\u636E\uFF0C\u5982\u679C\u4E3A\u4E86\u66F4\u65B9\u4FBF\u7684\u586B\u5145 Zbuf\uFF0C\u53EF\u4EE5\u5C01\u88C5\u7C7B\u4F3C\u63A5\u53E3\uFF0C\u5982 Fd \u6587\u4EF6\u63CF\u8FF0\u7B26\u4E2D\u8BFB\u53D6\u6570\u636E\u5230 Zbuf \u4E2D\u3001\u4ECE\u6587\u4EF6\u8BFB\u53D6\u6570\u636E\u5230 Zbuf \u4E2D\u3001\u4ECE\u7F51\u7EDC\u5957\u63A5\u5B57\u8BFB\u53D6\u6570\u636E\u5230 Zbuf \u4E2D\u7B49\u7B49\uFF0C\u76F8\u5173\u51FD\u6570\u539F\u578B\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//zmem/mem/zbuf.go

//\u8BFB\u53D6\u6570\u636E\u4ECEFd\u6587\u4EF6\u63CF\u8FF0\u7B26\u4E2D
func (zb *ZBuf) ReadFromFd(fd int) error {
   //...
   return nil
}

//\u5C06\u6570\u636E\u5199\u5165Fd\u6587\u4EF6\u63CF\u8FF0\u7B26\u4E2D
func (zb *ZBuf) WriteToFd(fd int) error {
   //...
   return nil
}

//\u8BFB\u53D6\u6570\u636E\u4ECE\u6587\u4EF6\u4E2D
func (zb *ZBuf) ReadFromFile(path string) error {
   //...
   return nil
}

func (zb *ZBuf) WriteToFile(path string) error {
   //...
   return nil
}

//\u8BFB\u53D6\u6570\u636E\u4ECE\u7F51\u7EDC\u8FDE\u63A5\u4E2D
func (zb *ZBuf) ReadFromConn(conn net.Conn) error {
   //...
   return nil
}

func (zb *ZBuf) WriteToConn(conn net.Conn) error {
   //...
   return nil
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u5C31\u4E0D\u4E00\u4E00\u5C55\u5F00\u7684\uFF0C\u5177\u4F53\u5B9E\u73B0\u65B9\u5F0F\u548C Read () \u65B9\u6CD5\u7C7B\u4F3C\u3002\u8FD9\u6837 Zbuf \u5C31\u53EF\u4EE5\u901A\u8FC7\u4E0D\u540C\u7684\u5A92\u4ECB\u6765\u586B\u5145 Buf \u5E76\u4E14\u6765\u4F7F\u7528\uFF0C\u4E1A\u52A1\u5C42\u53EA\u9700\u8981\u9762\u5411 Zbuf \u5C31\u53EF\u4EE5\u83B7\u53D6\u6570\u636E\uFF0C\u65E0\u9700\u5173\u5FC3\u5177\u4F53\u7684 IO \u5C42\u903B\u8F91\u3002</p><h2 id="_5-golang-\u5185\u5B58\u7BA1\u7406\u4E4B\u9B42-tcmalloc" tabindex="-1"><a class="header-anchor" href="#_5-golang-\u5185\u5B58\u7BA1\u7406\u4E4B\u9B42-tcmalloc" aria-hidden="true">#</a> 5 Golang \u5185\u5B58\u7BA1\u7406\u4E4B\u9B42 TCMalloc<a href="#8666ff">#</a></h2><p>\u5728\u4E86\u89E3 Golang \u7684\u5185\u5B58\u7BA1\u7406\u4E4B\u524D\uFF0C\u4E00\u5B9A\u8981\u4E86\u89E3\u7684\u57FA\u672C\u7533\u8BF7\u5185\u5B58\u6A21\u5F0F\uFF0C\u5373 TCMalloc\uFF08Thread Cache Malloc\uFF09\u3002Golang \u7684\u5185\u5B58\u7BA1\u7406\u5C31\u662F\u57FA\u4E8E TCMalloc \u7684\u6838\u5FC3\u601D\u60F3\u6765\u6784\u5EFA\u7684\u3002\u672C\u8282\u5C06\u4ECB\u7ECD TCMalloc \u7684\u57FA\u7840\u7406\u5FF5\u548C\u7ED3\u6784\u3002</p><h3 id="_5-1-tcmalloc" tabindex="-1"><a class="header-anchor" href="#_5-1-tcmalloc" aria-hidden="true">#</a> 5.1 TCMalloc<a href="#f5c42a">#</a></h3><p>TCMalloc \u6700\u5927\u4F18\u52BF\u5C31\u662F\u6BCF\u4E2A\u7EBF\u7A0B\u90FD\u4F1A\u72EC\u7ACB\u7EF4\u62A4\u81EA\u5DF1\u7684\u5185\u5B58\u6C60\u3002\u5728\u4E4B\u524D\u7AE0\u8282\u4ECB\u7ECD\u7684\u81EA\u5B9A\u4E49\u5B9E\u73B0\u7684 Golang \u5185\u5B58\u6C60\u7248 BufPool \u5B9E\u5219\u662F\u6240\u6709 Goroutine \u6216\u8005\u6240\u6709\u7EBF\u7A0B\u5171\u4EAB\u7684\u5185\u5B58\u6C60\uFF0C\u5176\u5173\u7CFB\u5982\u56FE 18 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/RhCSKk0Jl2.png!large" alt="awsef"></p><h3 id="\u56FE-18-bufpool-\u5185\u5B58\u6C60\u4E0E\u7EBF\u7A0B-thread-\u7684\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#\u56FE-18-bufpool-\u5185\u5B58\u6C60\u4E0E\u7EBF\u7A0B-thread-\u7684\u5173\u7CFB" aria-hidden="true">#</a> \u56FE 18 BufPool \u5185\u5B58\u6C60\u4E0E\u7EBF\u7A0B Thread \u7684\u5173\u7CFB<a href="#a618fa">#</a></h3><p>\u8FD9\u79CD\u5185\u5B58\u6C60\u7684\u8BBE\u8BA1\u7F3A\u70B9\u663E\u800C\u6613\u89C1\uFF0C\u5E94\u7528\u65B9\u5168\u90E8\u7684\u5185\u5B58\u7533\u8BF7\u5747\u9700\u8981\u548C\u5168\u5C40\u7684 BufPool \u4EA4\u4E92\uFF0C\u4E3A\u4E86\u7EBF\u7A0B\u7684\u5E76\u53D1\u5B89\u5168\uFF0C\u90A3\u4E48\u9891\u7E41\u7684 BufPool \u7684\u5185\u5B58\u7533\u8BF7\u548C\u9000\u8FD8\u9700\u8981\u52A0\u4E92\u65A5\u548C\u540C\u6B65\u673A\u5236\uFF0C\u5F71\u54CD\u4E86\u5185\u5B58\u7684\u4F7F\u7528\u7684\u6027\u80FD\u3002</p><p>TCMalloc \u5219\u662F\u4E3A\u6BCF\u4E2A Thread \u9884\u5206\u914D\u4E00\u5757\u7F13\u5B58\uFF0C\u6BCF\u4E2A Thread \u5728\u7533\u8BF7\u5185\u5B58\u65F6\u9996\u5148\u4F1A\u5148\u4ECE\u8FD9\u4E2A\u7F13\u5B58\u533A ThreadCache \u7533\u8BF7\uFF0C\u4E14\u6240\u6709 ThreadCache \u7F13\u5B58\u533A\u8FD8\u5171\u4EAB\u4E00\u4E2A\u53EB CentralCache \u7684\u4E2D\u5FC3\u7F13\u5B58\u3002\u8FD9\u91CC\u5047\u8BBE\u76EE\u524D Golang \u7684\u5185\u5B58\u7BA1\u7406\u7528\u7684\u662F\u539F\u751F TCMalloc \u6A21\u5F0F\uFF0C\u90A3\u4E48\u7EBF\u7A0B\u4E0E\u5185\u5B58\u7684\u5173\u7CFB\u5C06\u5982\u56FE 19 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/DWdNm4x8Ig.png!large" alt="awsef"></p><h3 id="\u56FE-19-tcmalloc-\u5185\u5B58\u6C60\u4E0E\u7EBF\u7A0B-thread-\u7684\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#\u56FE-19-tcmalloc-\u5185\u5B58\u6C60\u4E0E\u7EBF\u7A0B-thread-\u7684\u5173\u7CFB" aria-hidden="true">#</a> \u56FE 19 TCMalloc \u5185\u5B58\u6C60\u4E0E\u7EBF\u7A0B Thread \u7684\u5173\u7CFB<a href="#dbef1e">#</a></h3><p>\u8FD9\u6837\u505A\u7684\u597D\u5904\u5176\u4E00\u662F ThreadCache \u505A\u4E3A\u6BCF\u4E2A\u7EBF\u7A0B\u72EC\u7ACB\u7684\u7F13\u5B58\uFF0C\u80FD\u591F\u660E\u663E\u7684\u63D0\u9AD8 Thread \u83B7\u53D6\u9AD8\u547D\u4E2D\u7684\u6570\u636E\uFF0C\u5176\u4E8C\u662F ThreadCache \u4E5F\u662F\u4ECE\u5806\u7A7A\u95F4\u4E00\u6B21\u6027\u7533\u8BF7\uFF0C\u5373\u53EA\u89E6\u53D1\u4E00\u6B21\u7CFB\u7EDF\u8C03\u7528\u5373\u53EF\u3002\u6BCF\u4E2A ThreadCache \u8FD8\u4F1A\u5171\u540C\u8BBF\u95EE CentralCache\uFF0C\u8FD9\u4E2A\u4E0E BufPool \u7684\u7C7B\u4F3C\uFF0C\u4F46\u662F\u8BBE\u8BA1\u66F4\u4E3A\u7CBE\u7EC6\u4E00\u4E9B\u3002CentralCache \u662F\u6240\u6709\u7EBF\u7A0B\u5171\u4EAB\u7684\u7F13\u5B58\uFF0C\u5F53 ThreadCache \u7684\u7F13\u5B58\u4E0D\u8DB3\u65F6\uFF0C\u5C31\u4F1A\u4ECE CentralCache \u83B7\u53D6\uFF0C\u5F53 ThreadCache \u7684\u7F13\u5B58\u5145\u8DB3\u6216\u8005\u8FC7\u591A\u65F6\uFF0C\u5219\u4F1A\u5C06\u5185\u5B58\u9000\u8FD8\u7ED9 CentralCache\u3002\u4F46\u662F CentralCache \u7531\u4E8E\u5171\u4EAB\uFF0C\u90A3\u4E48\u8BBF\u95EE\u4E00\u5B9A\u662F\u9700\u8981\u52A0\u9501\u7684\u3002ThreadCache \u4F5C\u4E3A\u7EBF\u7A0B\u72EC\u7ACB\u7684\u7B2C\u4E00\u4EA4\u4E92\u5185\u5B58\uFF0C\u8BBF\u95EE\u65E0\u9700\u52A0\u9501\uFF0CCentralCache \u5219\u4F5C\u4E3A ThreadCache \u4E34\u65F6\u8865\u5145\u7F13\u5B58\u3002</p><p>TCMalloc \u7684\u6784\u9020\u4E0D\u4EC5\u4E8E\u6B64\uFF0C\u63D0\u4F9B\u4E86 ThreadCache \u548C CentralCache \u53EF\u4EE5\u89E3\u51B3\u5C0F\u5BF9\u8C61\u5185\u5B58\u5757\u7684\u7533\u8BF7\uFF0C\u4F46\u662F\u5BF9\u4E8E\u5927\u5757\u5185\u5B58 Cache \u663E\u7136\u662F\u4E0D\u9002\u5408\u7684\u3002 TCMalloc \u5C06\u5185\u5B58\u5206\u4E3A\u4E09\u7C7B\uFF0C\u5982\u8868 4 \u6240\u793A\u3002</p><h3 id="\u8868-4-tcmalloc-\u7684\u5185\u5B58\u5206\u79BB" tabindex="-1"><a class="header-anchor" href="#\u8868-4-tcmalloc-\u7684\u5185\u5B58\u5206\u79BB" aria-hidden="true">#</a> \u8868 4 TCMalloc \u7684\u5185\u5B58\u5206\u79BB<a href="#da2f57">#</a></h3><table><thead><tr><th><strong>\u5BF9\u8C61</strong></th><th><strong>\u5BB9\u91CF</strong></th></tr></thead><tbody><tr><td>\u5C0F\u5BF9\u8C61</td><td>(0,256KB]</td></tr><tr><td>\u4E2D\u5BF9\u8C61</td><td>(256KB, 1MB]</td></tr><tr><td>\u5927\u5BF9\u8C61</td><td>(1MB, +\u221E)</td></tr></tbody></table><p>\u6240\u4EE5\u4E3A\u4E86\u89E3\u51B3\u4E2D\u5BF9\u8C61\u548C\u5927\u5BF9\u8C61\u7684\u5185\u5B58\u7533\u8BF7\uFF0CTCMalloc \u4F9D\u7136\u6709\u4E00\u4E2A\u5168\u5C40\u5171\u4EAB\u5185\u5B58\u5806 PageHeap\uFF0C\u5982\u56FE 20 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/eWrHJLTEdA.png!large" alt="awsef"></p><h3 id="\u56FE-20-tcmalloc-\u4E2D\u7684-pageheap" tabindex="-1"><a class="header-anchor" href="#\u56FE-20-tcmalloc-\u4E2D\u7684-pageheap" aria-hidden="true">#</a> \u56FE 20 TCMalloc \u4E2D\u7684 PageHeap<a href="#386c1e">#</a></h3><p>PageHeap \u4E5F\u662F\u4E00\u6B21\u7CFB\u7EDF\u8C03\u7528\u4ECE\u865A\u62DF\u5185\u5B58\u4E2D\u7533\u8BF7\u7684\uFF0CPageHeap \u5F88\u660E\u663E\u662F\u5168\u5C40\u7684\uFF0C\u6240\u4EE5\u8BBF\u95EE\u4E00\u5B9A\u662F\u8981\u52A0\u9501\u3002\u5176\u4F5C\u7528\u662F\u5F53 CentralCache \u6CA1\u6709\u8DB3\u591F\u5185\u5B58\u65F6\u4F1A\u4ECE PageHeap \u53D6\uFF0C\u5F53 CentralCache \u5185\u5B58\u8FC7\u591A\u6216\u8005\u5145\u8DB3\uFF0C\u5219\u5C06\u4F4E\u547D\u4E2D\u5185\u5B58\u5757\u9000\u8FD8 PageHeap\u3002\u5982\u679C Thread \u9700\u8981\u5927\u5BF9\u8C61\u7533\u8BF7\u8D85\u8FC7\u7684 Cache \u5BB9\u7EB3\u7684\u5185\u5B58\u5757\u5355\u5143\u5927\u5C0F\uFF0C\u4E5F\u4F1A\u76F4\u63A5\u4ECE PageHeap \u83B7\u53D6\u3002</p><h3 id="_5-2-tcmalloc-\u6A21\u578B\u76F8\u5173\u57FA\u7840\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#_5-2-tcmalloc-\u6A21\u578B\u76F8\u5173\u57FA\u7840\u7ED3\u6784" aria-hidden="true">#</a> 5.2 TCMalloc \u6A21\u578B\u76F8\u5173\u57FA\u7840\u7ED3\u6784<a href="#56fa92">#</a></h3><p>\u5728\u4E86\u89E3 TCMalloc \u7684\u4E00\u4E9B\u5185\u90E8\u8BBE\u8BA1\u7ED3\u6784\u65F6\uFF0C\u9996\u8981\u4E86\u89E3\u7684\u662F\u4E00\u4E9B TCMalloc \u5B9A\u4E49\u7684\u57FA\u672C\u540D\u8BCD Page\u3001Span \u548C Size Class\u3002</p><h4 id="_1-page" tabindex="-1"><a class="header-anchor" href="#_1-page" aria-hidden="true">#</a> 1.Page<a href="#09ea37">#</a></h4><p>TCMalloc \u4E2D\u7684 Page \u4E0E\u4E4B\u524D\u7AE0\u8282\u4ECB\u7ECD\u64CD\u4F5C\u7CFB\u7EDF\u5BF9\u865A\u62DF\u5185\u5B58\u7BA1\u7406\u7684 MMU \u5B9A\u4E49\u7684\u7269\u7406\u9875\u6709\u76F8\u4F3C\u7684\u5B9A\u4E49\uFF0CTCMalloc \u5C06\u865A\u62DF\u5185\u5B58\u7A7A\u95F4\u5212\u5206\u4E3A\u591A\u4EFD\u540C\u7B49\u5927\u5C0F\u7684 Page\uFF0C\u6BCF\u4E2A Page \u9ED8\u8BA4\u662F 8KB\u3002</p><p>\u5BF9\u4E8E TCMalloc \u6765\u8BF4\uFF0C\u865A\u62DF\u5185\u5B58\u7A7A\u95F4\u7684\u5168\u90E8\u5185\u5B58\u90FD\u6309\u7167 Page \u7684\u5BB9\u91CF\u5206\u6210\u5747\u7B49\u4EFD\uFF0C\u5E76\u4E14\u7ED9\u6BCF\u4EFD Page \u6807\u8BB0\u4E86 ID \u7F16\u53F7\uFF0C\u5982\u56FE 21 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/3rqWEnJnzb.png!large" alt="awsef"></p><h3 id="\u56FE-21-tcmalloc-\u5C06\u865A\u62DF\u5185\u5B58\u5E73\u5747\u5206\u5C42-n-\u4EFD-page" tabindex="-1"><a class="header-anchor" href="#\u56FE-21-tcmalloc-\u5C06\u865A\u62DF\u5185\u5B58\u5E73\u5747\u5206\u5C42-n-\u4EFD-page" aria-hidden="true">#</a> \u56FE 21 TCMalloc \u5C06\u865A\u62DF\u5185\u5B58\u5E73\u5747\u5206\u5C42 N \u4EFD Page<a href="#5f4cc5">#</a></h3><p>\u5C06 Page \u8FDB\u884C\u7F16\u53F7\u7684\u597D\u5904\u662F\uFF0C\u53EF\u4EE5\u6839\u636E\u4EFB\u610F\u5185\u5B58\u7684\u5730\u5740\u6307\u9488\uFF0C\u8FDB\u884C\u56FA\u5B9A\u7B97\u6CD5\u504F\u79FB\u8BA1\u7B97\u6765\u7B97\u51FA\u6240\u5728\u7684 Page\u3002</p><h4 id="_2-span" tabindex="-1"><a class="header-anchor" href="#_2-span" aria-hidden="true">#</a> 2.Span<a href="#ed01dc">#</a></h4><p>\u591A\u4E2A\u8FDE\u7EED\u7684 Page \u79F0\u4E4B\u4E3A\u662F\u4E00\u4E2A Span\uFF0C\u5176\u5B9A\u4E49\u542B\u4E49\u6709\u64CD\u4F5C\u7CFB\u7EDF\u7684\u7BA1\u7406\u7684\u9875\u8868\u76F8\u4F3C\uFF0CPage \u548C Span \u7684\u5173\u7CFB\u5982\u56FE 22 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/nN1qHH89RQ.png!large" alt="awsef"></p><h3 id="\u56FE-22-tcmalloc-\u4E2D-page-\u4E0E-span-\u7684\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#\u56FE-22-tcmalloc-\u4E2D-page-\u4E0E-span-\u7684\u5173\u7CFB" aria-hidden="true">#</a> \u56FE 22 TCMalloc \u4E2D Page \u4E0E Span \u7684\u5173\u7CFB<a href="#31eb93">#</a></h3><p>TCMalloc \u662F\u4EE5 Span \u4E3A\u5355\u4F4D\u5411\u64CD\u4F5C\u7CFB\u7EDF\u7533\u8BF7\u5185\u5B58\u7684\u3002\u6BCF\u4E2A Span \u8BB0\u5F55\u4E86\u7B2C\u4E00\u4E2A\u8D77\u59CB Page \u7684\u7F16\u53F7 Start\uFF0C\u548C\u4E00\u5171\u6709\u591A\u5C11\u4E2A\u8FDE\u7EED Page \u7684\u6570\u91CF Length\u3002</p><p>\u4E3A\u4E86\u65B9\u4FBF Span \u548C Span \u4E4B\u95F4\u7684\u7BA1\u7406\uFF0CSpan \u96C6\u5408\u662F\u4EE5\u53CC\u5411\u94FE\u8868\u7684\u5F62\u5F0F\u6784\u5EFA\uFF0C\u5982\u56FE 23 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/ivmjaMfAeU.png!large" alt="awsef"></p><h3 id="\u56FE-23-tcmalloc-\u4E2D-span-\u5B58\u50A8\u5F62\u5F0F" tabindex="-1"><a class="header-anchor" href="#\u56FE-23-tcmalloc-\u4E2D-span-\u5B58\u50A8\u5F62\u5F0F" aria-hidden="true">#</a> \u56FE 23 TCMalloc \u4E2D Span \u5B58\u50A8\u5F62\u5F0F<a href="#9508dd">#</a></h3><h4 id="_3-size-class" tabindex="-1"><a class="header-anchor" href="#_3-size-class" aria-hidden="true">#</a> 3.Size Class<a href="#afde87">#</a></h4><p>\u53C2\u8003\u8868 3-3 \u6240\u793A\uFF0C\u5728 256KB \u4EE5\u5185\u7684\u5C0F\u5BF9\u8C61\uFF0CTCMalloc \u4F1A\u5C06\u8FD9\u4E9B\u5C0F\u5BF9\u8C61\u96C6\u5408\u5212\u5206\u6210\u591A\u4E2A\u5185\u5B58\u523B\u5EA6 <a href="#_ftn6">[6]</a>\uFF0C\u540C\u5C5E\u4E8E\u4E00\u4E2A\u523B\u5EA6\u7C7B\u522B\u4E0B\u7684\u5185\u5B58\u96C6\u5408\u79F0\u4E4B\u4E3A\u5C5E\u4E8E\u4E00\u4E2A Size Class\u3002\u8FD9\u4E0E\u4E4B\u524D\u7AE0\u8282\u81EA\u5B9A\u4E49\u5B9E\u73B0\u7684\u5185\u5B58\u6C60\uFF0C\u5C06 Buf \u5212\u5206\u591A\u4E2A\u523B\u5EA6\u7684 BufList \u7C7B\u4F3C\u3002</p><p>\u6BCF\u4E2A Size Class \u90FD\u5BF9\u5E94\u4E00\u4E2A\u5927\u5C0F\u6BD4\u5982 8 \u5B57\u8282\u300116 \u5B57\u8282\u300132 \u5B57\u8282\u7B49\u3002\u5728\u7533\u8BF7\u5C0F\u5BF9\u8C61\u5185\u5B58\u7684\u65F6\u5019\uFF0CTCMalloc \u4F1A\u6839\u636E\u4F7F\u7528\u65B9\u7533\u8BF7\u7684\u7A7A\u95F4\u5927\u5C0F\u5C31\u8FD1\u5411\u4E0A\u53D6\u6700\u63A5\u8FD1\u7684\u4E00\u4E2A Size Class \u7684 Span\uFF08\u7531\u591A\u4E2A\u7B49\u7A7A\u95F4\u7684 Page \u7EC4\u6210\uFF09\u5185\u5B58\u5757\u8FD4\u56DE\u7ED9\u4F7F\u7528\u65B9\u3002</p><p>\u5982\u679C\u5C06 Size Class\u3001Span\u3001Page \u7528\u4E00\u5F20\u56FE\u6765\u8868\u793A\uFF0C\u5219\u5177\u4F53\u7684\u62BD\u8C61\u5173\u7CFB\u5982\u56FE 24 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/TxIGJR26fZ.png!large" alt="awsef"></p><h3 id="\u56FE-24-tcmalloc-\u4E2D-size-class\u3001page\u3001span-\u7684\u7ED3\u6784\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#\u56FE-24-tcmalloc-\u4E2D-size-class\u3001page\u3001span-\u7684\u7ED3\u6784\u5173\u7CFB" aria-hidden="true">#</a> \u56FE 24 TCMalloc \u4E2D Size Class\u3001Page\u3001Span \u7684\u7ED3\u6784\u5173\u7CFB<a href="#92d255">#</a></h3><p>\u63A5\u4E0B\u6765\u5256\u6790\u4E00\u4E0B ThreadCache\u3001CentralCache\u3001PageHeap \u7684\u5185\u5B58\u7BA1\u7406\u7ED3\u6784\u3002</p><h3 id="_5-3-threadcache" tabindex="-1"><a class="header-anchor" href="#_5-3-threadcache" aria-hidden="true">#</a> 5.3 ThreadCache<a href="#9a33c6">#</a></h3><p>\u5728 TCMalloc \u4E2D\u6BCF\u4E2A\u7EBF\u7A0B\u90FD\u4F1A\u6709\u4E00\u4EFD\u5355\u72EC\u7684\u7F13\u5B58\uFF0C\u5C31\u662F ThreadCache\u3002ThreadCache \u4E2D\u5BF9\u4E8E\u6BCF\u4E2A Size Class \u90FD\u4F1A\u6709\u4E00\u4E2A\u5BF9\u5E94\u7684 FreeList\uFF0CFreeList \u8868\u793A\u5F53\u524D\u7F13\u5B58\u4E2D\u8FD8\u6709\u591A\u5C11\u4E2A\u7A7A\u95F2\u7684\u5185\u5B58\u53EF\u7528\uFF0C\u5177\u4F53\u7684\u7ED3\u6784\u5E03\u5C40\u5982\u56FE 25 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/V85EFusAJ5.png!large" alt="awsef"></p><h3 id="\u56FE-25-tcmalloc-\u4E2D-threadcache" tabindex="-1"><a class="header-anchor" href="#\u56FE-25-tcmalloc-\u4E2D-threadcache" aria-hidden="true">#</a> \u56FE 25 TCMalloc \u4E2D ThreadCache<a href="#d7e4ec">#</a></h3><p>\u4F7F\u7528\u65B9\u5BF9\u4E8E\u4ECE TCMalloc \u7533\u8BF7\u7684\u5C0F\u5BF9\u8C61\uFF0C\u4F1A\u76F4\u63A5\u4ECE TreadCache \u83B7\u53D6\uFF0C\u5B9E\u5219\u662F\u4ECE FreeList \u4E2D\u8FD4\u56DE\u4E00\u4E2A\u7A7A\u95F2\u7684\u5BF9\u8C61\uFF0C\u5982\u679C\u5BF9\u5E94\u7684 Size Class \u523B\u5EA6\u4E0B\u5DF2\u7ECF\u6CA1\u6709\u7A7A\u95F2\u7684 Span \u53EF\u4EE5\u88AB\u83B7\u53D6\u4E86\uFF0C\u5219 ThreadCache \u4F1A\u4ECE CentralCache \u4E2D\u83B7\u53D6\u3002\u5F53\u4F7F\u7528\u65B9\u4F7F\u7528\u5B8C\u5185\u5B58\u4E4B\u540E\uFF0C\u5F52\u8FD8\u4E5F\u662F\u76F4\u63A5\u5F52\u8FD8\u7ED9\u5F53\u524D\u7684 ThreadCache \u4E2D\u5BF9\u5E94\u523B\u5EA6\u4E0B\u7684\u7684 FreeList \u4E2D\u3002</p><p>\u6574\u6761\u7533\u8BF7\u548C\u5F52\u8FD8\u7684\u6D41\u7A0B\u662F\u4E0D\u9700\u8981\u52A0\u9501\u7684\uFF0C\u56E0\u4E3A ThreadCache \u4E3A\u5F53\u524D\u7EBF\u7A0B\u72EC\u4EAB\uFF0C\u4F46\u5982\u679C ThreadCache \u4E0D\u591F\u7528\uFF0C\u9700\u8981\u4ECE CentralCache \u7533\u8BF7\u5185\u5B58\u65F6\uFF0C\u8FD9\u4E2A\u52A8\u4F5C\u662F\u9700\u8981\u52A0\u9501\u7684\u3002\u4E0D\u540C Thread \u4E4B\u95F4\u7684 ThreadCache \u662F\u4EE5\u53CC\u5411\u94FE\u8868\u7684\u7ED3\u6784\u8FDB\u884C\u5173\u8054\uFF0C\u662F\u4E3A\u4E86\u65B9\u4FBF TCMalloc \u7EDF\u8BA1\u548C\u7BA1\u7406\u3002</p><h3 id="_5-4-centralcache" tabindex="-1"><a class="header-anchor" href="#_5-4-centralcache" aria-hidden="true">#</a> 5.4 CentralCache<a href="#357cb2">#</a></h3><p>CentralCache \u662F\u5404\u4E2A\u7EBF\u7A0B\u5171\u7528\u7684\uFF0C\u6240\u4EE5\u4E0E CentralCache \u83B7\u53D6\u5185\u5B58\u4EA4\u4E92\u662F\u9700\u8981\u52A0\u9501\u7684\u3002CentralCache \u7F13\u5B58\u7684 Size Class \u548C ThreadCache \u7684\u4E00\u6837\uFF0C\u8FD9\u4E9B\u7F13\u5B58\u90FD\u88AB\u653E\u5728 CentralFreeList \u4E2D\uFF0C\u5F53 ThreadCache \u4E2D\u7684\u67D0\u4E2A Size Class \u523B\u5EA6\u4E0B\u7684\u7F13\u5B58\u5C0F\u5BF9\u8C61\u4E0D\u591F\u7528\uFF0C\u5C31\u4F1A\u5411 CentralCache \u5BF9\u5E94\u7684 Size Class \u523B\u5EA6\u7684 CentralFreeList \u83B7\u53D6\uFF0C\u540C\u6837\u7684\u5982\u679C ThreadCache \u6709\u591A\u4F59\u7684\u7F13\u5B58\u5BF9\u8C61\u4E5F\u4F1A\u9000\u8FD8\u7ED9\u54CD\u5E94\u7684 CentralFreeList\uFF0C\u6D41\u7A0B\u548C\u5173\u7CFB\u5982\u56FE 26 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/1dkEKE2ak9.png!large" alt="awsef"></p><h3 id="\u56FE-26-tcmalloc-\u4E2D-centralcache" tabindex="-1"><a class="header-anchor" href="#\u56FE-26-tcmalloc-\u4E2D-centralcache" aria-hidden="true">#</a> \u56FE 26 TCMalloc \u4E2D CentralCache<a href="#066461">#</a></h3><p>CentralCache \u4E0E PageHeap \u7684\u89D2\u8272\u5173\u7CFB\u4E0E ThreadCache \u4E0E CentralCache \u7684\u89D2\u8272\u5173\u7CFB\u76F8\u4F3C\uFF0C\u5F53 CentralCache \u51FA\u73B0 Span \u4E0D\u8DB3\u65F6\uFF0C\u4F1A\u4ECE PageHeap \u7533\u8BF7 Span\uFF0C\u4EE5\u53CA\u5C06\u4E0D\u518D\u4F7F\u7528\u7684 Span \u9000\u8FD8\u7ED9 PageHeap\u3002</p><h3 id="_5-5-pageheap" tabindex="-1"><a class="header-anchor" href="#_5-5-pageheap" aria-hidden="true">#</a> 5.5 PageHeap<a href="#cddb52">#</a></h3><p>PageHeap \u662F\u63D0\u4F9B CentralCache \u7684\u5185\u5B58\u6765\u6E90\u3002PageHead \u4E0E CentralCache \u4E0D\u540C\u7684\u662F CentralCache \u662F\u4E0E ThreadCache \u5E03\u5C40\u4E00\u6A21\u4E00\u6837\u7684\u7F13\u5B58\uFF0C\u4E3B\u8981\u662F\u8D77\u5230\u9488\u5BF9 ThreadCache \u7684\u4E00\u5C42\u4E8C\u7EA7\u7F13\u5B58\u4F5C\u7528\uFF0C\u4E14\u53EA\u652F\u6301\u5C0F\u5BF9\u8C61\u5185\u5B58\u5206\u914D\u3002\u800C PageHeap \u5219\u662F\u9488\u5BF9 CentralCache \u7684\u4E09\u7EA7\u7F13\u5B58\u3002\u5F25\u8865\u5BF9\u4E8E\u4E2D\u5BF9\u8C61\u5185\u5B58\u548C\u5927\u5BF9\u8C61\u5185\u5B58\u7684\u5206\u914D\uFF0CPageHeap \u4E5F\u662F\u76F4\u63A5\u548C\u64CD\u4F5C\u7CFB\u7EDF\u865A\u62DF\u5185\u5B58\u8854\u63A5\u7684\u4E00\u5C42\u7F13\u5B58\uFF0C\u5F53\u627E\u4E0D\u5230 ThreadCache\u3001CentralCache\u3001PageHeap \u90FD\u627E\u4E0D\u5230\u5408\u9002\u7684 Span\uFF0CPageHeap \u5219\u4F1A\u8C03\u7528\u64CD\u4F5C\u7CFB\u7EDF\u5185\u5B58\u7533\u8BF7\u7CFB\u7EDF\u8C03\u7528\u51FD\u6570\u6765\u4ECE\u865A\u62DF\u5185\u5B58\u7684\u5806\u533A\u4E2D\u53D6\u51FA\u5185\u5B58\u586B\u5145\u5230 PageHeap \u5F53\u4E2D\uFF0C\u5177\u4F53\u7684\u7ED3\u6784\u5982\u56FE 27 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/H6WUHzoNme.png!large" alt="awsef"></p><h3 id="\u56FE-27-tcmalloc-\u4E2D-pageheap" tabindex="-1"><a class="header-anchor" href="#\u56FE-27-tcmalloc-\u4E2D-pageheap" aria-hidden="true">#</a> \u56FE 27 TCMalloc \u4E2D PageHeap<a href="#c70d8a">#</a></h3><p>PageHeap \u5185\u90E8\u7684 Span \u7BA1\u7406\uFF0C\u91C7\u7528\u4E24\u79CD\u4E0D\u540C\u7684\u65B9\u5F0F\uFF0C\u5BF9\u4E8E 128 \u4E2A Page \u4EE5\u5185\u7684 Span \u7533\u8BF7\uFF0C\u6BCF\u4E2A Page \u523B\u5EA6\u90FD\u4F1A\u7528\u4E00\u4E2A\u94FE\u8868\u5F62\u5F0F\u7684\u7F13\u5B58\u6765\u5B58\u50A8\u3002\u5BF9\u4E8E 128 \u4E2A Page \u4EE5\u4E0A\u5185\u5B58\u7533\u8BF7\uFF0CPageHeap \u662F\u4EE5\u6709\u5E8F\u96C6\u5408\uFF08C++ \u6807\u51C6\u5E93 STL \u4E2D\u7684 Std::Set \u5BB9\u5668\uFF09\u6765\u5B58\u653E\u3002</p><h3 id="_5-6-tcmalloc-\u7684\u5C0F\u5BF9\u8C61\u5206\u914D" tabindex="-1"><a class="header-anchor" href="#_5-6-tcmalloc-\u7684\u5C0F\u5BF9\u8C61\u5206\u914D" aria-hidden="true">#</a> 5.6 TCMalloc \u7684\u5C0F\u5BF9\u8C61\u5206\u914D<a href="#f0d639">#</a></h3><p>\u4E0A\u8FF0\u5DF2\u7ECF\u5C06 TCMalloc \u7684\u51E0\u79CD\u57FA\u7840\u7ED3\u6784\u4ECB\u7ECD\u4E86\uFF0C\u63A5\u4E0B\u6765\u603B\u7ED3\u4E00\u4E0B TCMalloc \u9488\u5BF9\u5C0F\u5BF9\u8C61\u3001\u4E2D\u5BF9\u8C61\u548C\u5927\u5BF9\u8C61\u7684\u5206\u914D\u6D41\u7A0B\u3002\u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B\u5982\u56FE 28 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/sFSOXbjSsK.png!large" alt="awsef"></p><h3 id="\u56FE-28-tcmalloc-\u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u56FE-28-tcmalloc-\u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" aria-hidden="true">#</a> \u56FE 28 TCMalloc \u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B<a href="#198bde">#</a></h3><p>\u5C0F\u5BF9\u8C61\u4E3A\u5360\u7528\u5185\u5B58\u5C0F\u4E8E\u7B49\u4E8E 256KB \u7684\u5185\u5B58\uFF0C\u53C2\u8003\u56FE\u4E2D\u7684\u6D41\u7A0B\uFF0C\u4E0B\u9762\u5C06\u4ECB\u7ECD\u8BE6\u7EC6\u6D41\u7A0B\u6B65\u9AA4\uFF1A</p><p>\uFF081\uFF09Thread \u7528\u6237\u7EBF\u7A0B\u5E94\u7528\u903B\u8F91\u7533\u8BF7\u5185\u5B58\uFF0C\u5F53\u524D Thread \u8BBF\u95EE\u5BF9\u5E94\u7684 ThreadCache \u83B7\u53D6\u5185\u5B58\uFF0C\u6B64\u8FC7\u7A0B\u4E0D\u9700\u8981\u52A0\u9501\u3002</p><p>\uFF082\uFF09ThreadCache \u7684\u5F97\u5230\u7533\u8BF7\u5185\u5B58\u7684 SizeClass\uFF08\u4E00\u822C\u5411\u4E0A\u53D6\u6574\uFF0C\u5927\u4E8E\u7B49\u4E8E\u7533\u8BF7\u7684\u5185\u5B58\u5927\u5C0F\uFF09\uFF0C\u901A\u8FC7 SizeClass \u7D22\u5F15\u53BB\u8BF7\u6C42\u81EA\u8EAB\u5BF9\u5E94\u7684 FreeList\u3002</p><p>\uFF083\uFF09\u5224\u65AD\u5F97\u5230\u7684 FreeList \u662F\u5426\u4E3A\u975E\u7A7A\u3002</p><p>\uFF084\uFF09\u5982\u679C FreeList \u975E\u7A7A\uFF0C\u5219\u8868\u793A\u76EE\u524D\u6709\u5BF9\u5E94\u5185\u5B58\u7A7A\u95F4\u4F9B Thread \u4F7F\u7528\uFF0C\u5F97\u5230 FreeList \u7B2C\u4E00\u4E2A\u7A7A\u95F2 Span \u8FD4\u56DE\u7ED9 Thread \u7528\u6237\u903B\u8F91\uFF0C\u6D41\u7A0B\u7ED3\u675F\u3002</p><p>\uFF085\uFF09\u5982\u679C FreeList \u4E3A\u7A7A\uFF0C\u5219\u8868\u793A\u76EE\u524D\u6CA1\u6709\u5BF9\u5E94 SizeClass \u7684\u7A7A\u95F2 Span \u53EF\u4F7F\u7528\uFF0C\u8BF7\u6C42 CentralCache \u5E76\u544A\u77E5 CentralCache \u5177\u4F53\u7684 SizeClass\u3002</p><p>\uFF086\uFF09CentralCache \u6536\u5230\u8BF7\u6C42\u540E\uFF0C\u52A0\u9501\u8BBF\u95EE CentralFreeList\uFF0C\u6839\u636E SizeClass \u8FDB\u884C\u7D22\u5F15\u627E\u5230\u5BF9\u5E94\u7684 CentralFreeList\u3002</p><p>\uFF087\uFF09\u5224\u65AD\u5F97\u5230\u7684 CentralFreeList \u662F\u5426\u4E3A\u975E\u7A7A\u3002</p><p>\uFF088\uFF09\u5982\u679C CentralFreeList \u975E\u7A7A\uFF0C\u5219\u8868\u793A\u76EE\u524D\u6709\u7A7A\u95F2\u7684 Span \u53EF\u4F7F\u7528\u3002\u8FD4\u56DE\u591A\u4E2A Span\uFF0C\u5C06\u8FD9\u4E9B Span\uFF08\u9664\u4E86\u7B2C\u4E00\u4E2A Span\uFF09\u653E\u7F6E ThreadCache \u7684 FreeList \u4E2D\uFF0C\u5E76\u4E14\u5C06\u7B2C\u4E00\u4E2A Span \u8FD4\u56DE\u7ED9 Thread \u7528\u6237\u903B\u8F91\uFF0C\u6D41\u7A0B\u7ED3\u675F\u3002</p><p>\uFF089\uFF09\u5982\u679C CentralFreeList \u4E3A\u7A7A\uFF0C\u5219\u8868\u793A\u76EE\u524D\u6CA1\u6709\u53EF\u7528\u662F Span \u53EF\u4F7F\u7528\uFF0C\u5411 PageHeap \u7533\u8BF7\u5BF9\u5E94\u5927\u5C0F\u7684 Span\u3002</p><p>\uFF0810\uFF09PageHeap \u5F97\u5230 CentralCache \u7684\u7533\u8BF7\uFF0C\u52A0\u9501\u8BF7\u6C42\u5BF9\u5E94\u7684 Page \u523B\u5EA6\u7684 Span \u94FE\u8868\u3002</p><p>\uFF0811\uFF09PageHeap \u5C06\u5F97\u5230\u7684 Span \u6839\u636E\u672C\u6B21\u6D41\u7A0B\u8BF7\u6C42\u7684 SizeClass \u5927\u5C0F\u4E3A\u523B\u5EA6\u8FDB\u884C\u62C6\u5206\uFF0C\u5206\u6210 N \u4EFD SizeClass \u5927\u5C0F\u7684 Span \u8FD4\u56DE\u7ED9 CentralCache\uFF0C\u5982\u679C\u6709\u591A\u4F59\u7684 Span \u5219\u653E\u56DE PageHeap \u5BF9\u5E94 Page \u7684 Span \u94FE\u8868\u4E2D\u3002</p><p>\uFF0812\uFF09CentralCache \u5F97\u5230\u5BF9\u5E94\u7684 N \u4E2A Span\uFF0C\u6DFB\u52A0\u81F3 CentralFreeList \u4E2D\uFF0C\u8DF3\u8F6C\u81F3\u7B2C\uFF088\uFF09\u6B65\u3002</p><p>\u7EFC\u4E0A\u662F TCMalloc \u4E00\u6B21\u7533\u8BF7\u5C0F\u5BF9\u8C61\u7684\u5168\u90E8\u8BE6\u7EC6\u6D41\u7A0B\uFF0C\u63A5\u4E0B\u6765\u5206\u6790\u4E2D\u5BF9\u8C61\u7684\u5206\u914D\u6D41\u7A0B\u3002</p><h3 id="_5-7-tcmalloc-\u7684\u4E2D\u5BF9\u8C61\u5206\u914D" tabindex="-1"><a class="header-anchor" href="#_5-7-tcmalloc-\u7684\u4E2D\u5BF9\u8C61\u5206\u914D" aria-hidden="true">#</a> 5.7 TCMalloc \u7684\u4E2D\u5BF9\u8C61\u5206\u914D<a href="#9acd4b">#</a></h3><p>\u4E2D\u5BF9\u8C61\u4E3A\u5927\u4E8E 256KB \u4E14\u5C0F\u4E8E\u7B49\u4E8E 1MB \u7684\u5185\u5B58\u3002\u5BF9\u4E8E\u4E2D\u5BF9\u8C61\u7533\u8BF7\u5206\u914D\u7684\u6D41\u7A0B TCMalloc \u4E0E\u5904\u7406\u5C0F\u5BF9\u8C61\u5206\u914D\u6709\u4E00\u5B9A\u7684\u533A\u522B\u3002\u5BF9\u4E8E\u4E2D\u5BF9\u8C61\u5206\u914D\uFF0CThread \u4E0D\u518D\u6309\u7167\u5C0F\u5BF9\u8C61\u7684\u6D41\u7A0B\u8DEF\u5F84\u5411 ThreadCache \u83B7\u53D6\uFF0C\u800C\u662F\u76F4\u63A5\u4ECE PageHeap \u83B7\u53D6\uFF0C\u5177\u4F53\u7684\u6D41\u7A0B\u5982\u56FE 29 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/gIEVG5Pnof.png!large" alt="awsef"></p><h3 id="\u56FE-29-tcmalloc-\u4E2D\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u56FE-29-tcmalloc-\u4E2D\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" aria-hidden="true">#</a> \u56FE 29 TCMalloc \u4E2D\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B<a href="#b4c551">#</a></h3><p>PageHeap \u5C06 128 \u4E2A Page \u4EE5\u5185\u5927\u5C0F\u7684 Span \u5B9A\u4E49\u4E3A\u5C0F Span\uFF0C\u5C06 128 \u4E2A Page \u4EE5\u4E0A\u5927\u5C0F\u7684 Span \u5B9A\u4E49\u4E3A\u5927 Span\u3002\u7531\u4E8E\u4E00\u4E2A Page \u4E3A 8KB\uFF0C\u90A3\u4E48 128 \u4E2A Page \u5373\u4E3A 1MB\uFF0C\u6240\u4EE5\u5BF9\u4E8E\u4E2D\u5BF9\u8C61\u7684\u7533\u8BF7\uFF0CPageHeap \u5747\u662F\u6309\u7167\u5C0F Span \u7684\u7533\u8BF7\u6D41\u7A0B\uFF0C\u5177\u4F53\u5982\u4E0B\uFF1A</p><p>\uFF081\uFF09Thread \u7528\u6237\u903B\u8F91\u5C42\u63D0\u4EA4\u5185\u5B58\u7533\u8BF7\u5904\u7406\uFF0C\u5982\u679C\u672C\u6B21\u7533\u8BF7\u5185\u5B58\u8D85\u8FC7 256KB \u4F46\u4E0D\u8D85\u8FC7 1MB \u5219\u5C5E\u4E8E\u4E2D\u5BF9\u8C61\u7533\u8BF7\u3002TCMalloc \u5C06\u76F4\u63A5\u5411 PageHeap \u53D1\u8D77\u7533\u8BF7 Span \u8BF7\u6C42\u3002</p><p>\uFF082\uFF09PageHeap \u63A5\u6536\u5230\u7533\u8BF7\u540E\u9700\u8981\u5224\u65AD\u672C\u6B21\u7533\u8BF7\u662F\u5426\u5C5E\u4E8E\u5C0F Span\uFF08128 \u4E2A Page \u4EE5\u5185\uFF09\uFF0C\u5982\u679C\u662F\uFF0C\u5219\u8D70\u5C0F Span\uFF0C\u5373\u4E2D\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\uFF0C\u5982\u679C\u4E0D\u662F\uFF0C\u5219\u8FDB\u5165\u5927\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\uFF0C\u4E0B\u4E00\u8282\u4ECB\u7ECD\u3002</p><p>\uFF083\uFF09PageHeap \u6839\u636E\u7533\u8BF7\u7684 Span \u5728\u5C0F Span \u7684\u94FE\u8868\u4E2D\u5411\u4E0A\u53D6\u6574\uFF0C\u5F97\u5230\u6700\u9002\u5E94\u7684\u7B2C K \u4E2A Page \u523B\u5EA6\u7684 Span \u94FE\u8868\u3002</p><p>\uFF084\uFF09\u5F97\u5230\u7B2C K \u4E2A Page \u94FE\u8868\u523B\u5EA6\u540E\uFF0C\u5C06 K \u4F5C\u4E3A\u8D77\u59CB\u70B9\uFF0C\u5411\u4E0B\u904D\u5386\u627E\u5230\u7B2C\u4E00\u4E2A\u975E\u7A7A\u94FE\u8868\uFF0C\u76F4\u81F3 128 \u4E2A Page \u523B\u5EA6\u4F4D\u7F6E\uFF0C\u627E\u5230\u5219\u505C\u6B62\uFF0C\u5C06\u505C\u6B62\u5904\u7684\u975E\u7A7A Span \u94FE\u8868\u4F5C\u4E3A\u63D0\u4F9B\u6B64\u6B21\u8FD4\u56DE\u7684\u5185\u5B58 Span\uFF0C\u5C06\u94FE\u8868\u4E2D\u7684\u7B2C\u4E00\u4E2A Span \u53D6\u51FA\u3002\u5982\u679C\u627E\u4E0D\u5230\u975E\u7A7A\u94FE\u8868\uFF0C\u5219\u5F53\u9519\u672C\u6B21\u7533\u8BF7\u4E3A\u5927 Span \u7533\u8BF7\uFF0C\u5219\u8FDB\u5165\u5927\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\u3002</p><p>\uFF085\uFF09\u5047\u8BBE\u672C\u6B21\u83B7\u53D6\u5230\u7684 Span \u7531 N \u4E2A Page \u7EC4\u6210\u3002PageHeap \u5C06 N \u4E2A Page \u7684 Span \u62C6\u5206\u6210\u4E24\u4E2A Span\uFF0C\u5176\u4E2D\u4E00\u4E2A\u4E3A K \u4E2A Page \u7EC4\u6210\u7684 Span\uFF0C\u4F5C\u4E3A\u672C\u6B21\u5185\u5B58\u7533\u8BF7\u7684\u8FD4\u56DE\uFF0C\u7ED9\u5230 Thread\uFF0C\u53E6\u4E00\u4E2A\u4E3A N-K \u4E2A Page \u7EC4\u6210\u7684 Span\uFF0C\u91CD\u65B0\u63D2\u5165\u5230 N-K \u4E2A Page \u5BF9\u5E94\u7684 Span \u94FE\u8868\u4E2D\u3002</p><p>\u7EFC\u4E0A\u662F TCMalloc \u5BF9\u4E8E\u4E2D\u5BF9\u8C61\u5206\u914D\u7684\u8BE6\u7EC6\u6D41\u7A0B\u3002</p><h3 id="_5-8-tcmalloc-\u7684\u5927\u5BF9\u8C61\u5206\u914D" tabindex="-1"><a class="header-anchor" href="#_5-8-tcmalloc-\u7684\u5927\u5BF9\u8C61\u5206\u914D" aria-hidden="true">#</a> 5.8 TCMalloc \u7684\u5927\u5BF9\u8C61\u5206\u914D<a href="#7b0304">#</a></h3><p>\u5BF9\u4E8E\u8D85\u8FC7 128 \u4E2A Page\uFF08\u5373 1MB\uFF09\u7684\u5185\u5B58\u5206\u914D\u5219\u4E3A\u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B\u3002\u5927\u5BF9\u8C61\u5206\u914D\u4E0E\u4E2D\u5BF9\u8C61\u5206\u914D\u60C5\u51B5\u7C7B\u4F3C\uFF0CThread \u7ED5\u8FC7 ThreadCache \u548C CentralCache\uFF0C\u76F4\u63A5\u5411 PageHeap \u83B7\u53D6\u3002\u8BE6\u7EC6\u7684\u5206\u914D\u6D41\u7A0B\u5982\u56FE 30 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/X4ZvnfDz7e.png!large" alt="awsef"></p><h3 id="\u56FE-30-tcmalloc-\u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u56FE-30-tcmalloc-\u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" aria-hidden="true">#</a> \u56FE 30 TCMalloc \u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B<a href="#747c4e">#</a></h3><p>\u8FDB\u5165\u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B\u9664\u4E86\u7533\u8BF7\u7684 Span \u5927\u4E8E 128 \u4E2A Page \u4E4B\u5916\uFF0C\u5BF9\u4E8E\u4E2D\u5BF9\u8C61\u5206\u914D\u5982\u679C\u627E\u4E0D\u5230\u975E\u7A7A\u94FE\u8868\u4E5F\u4F1A\u8FDB\u5165\u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B\uFF0C\u5927\u5BF9\u8C61\u5206\u914D\u7684\u5177\u4F53\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><p>\uFF081\uFF09Thread \u7528\u6237\u903B\u8F91\u5C42\u63D0\u4EA4\u5185\u5B58\u7533\u8BF7\u5904\u7406\uFF0C\u5982\u679C\u672C\u6B21\u7533\u8BF7\u5185\u5B58\u8D85\u8FC7 1MB \u5219\u5C5E\u4E8E\u5927\u5BF9\u8C61\u7533\u8BF7\u3002TCMalloc \u5C06\u76F4\u63A5\u5411 PageHeap \u53D1\u8D77\u7533\u8BF7 Span \u3002</p><p>\uFF082\uFF09PageHeap \u63A5\u6536\u5230\u7533\u8BF7\u540E\u9700\u8981\u5224\u65AD\u672C\u6B21\u7533\u8BF7\u662F\u5426\u5C5E\u4E8E\u5C0F Span\uFF08128 \u4E2A Page \u4EE5\u5185\uFF09\uFF0C\u5982\u679C\u662F\uFF0C\u5219\u8D70\u5C0F Span \u4E2D\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\uFF08\u4E0A\u4E00\u8282\u5DF2\u4ECB\u7ECD\uFF09\uFF0C\u5982\u679C\u4E0D\u662F\uFF0C\u5219\u8FDB\u5165\u5927\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\u3002</p><p>\uFF083\uFF09PageHeap \u6839\u636E Span \u7684\u5927\u5C0F\u6309\u7167 Page \u5355\u5143\u8FDB\u884C\u9664\u6CD5\u8FD0\u7B97\uFF0C\u5411\u4E0A\u53D6\u6574\uFF0C\u5F97\u5230\u6700\u63A5\u8FD1 Span \u7684\u4E14\u5927\u4E8E Span \u7684 Page \u500D\u6570 K\uFF0C\u6B64\u65F6\u7684 K \u5E94\u8BE5\u662F\u5927\u4E8E 128\u3002\u5982\u679C\u662F\u4ECE\u4E2D\u5BF9\u8C61\u6D41\u7A0B\u5206\u8FC7\u6765\u7684\uFF08\u4E2D\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\u53EF\u80FD\u6CA1\u6709\u975E\u7A7A\u94FE\u8868\u63D0\u4F9B Span\uFF09\uFF0C\u5219 K \u503C\u5E94\u8BE5\u5C0F\u4E8E 128\u3002</p><p>\uFF084\uFF09\u641C\u7D22 Large Span Set \u96C6\u5408\uFF0C\u627E\u5230\u4E0D\u5C0F\u4E8E K \u4E2A Page \u7684\u6700\u5C0F Span\uFF08N \u4E2A Page\uFF09\u3002\u5982\u679C\u6CA1\u6709\u627E\u5230\u5408\u9002\u7684 Span\uFF0C\u5219\u8BF4\u660E PageHeap \u5DF2\u7ECF\u65E0\u6CD5\u6EE1\u8DB3\u9700\u6C42\uFF0C\u5219\u5411\u64CD\u4F5C\u7CFB\u7EDF\u865A\u62DF\u5185\u5B58\u7684\u5806\u7A7A\u95F4\u7533\u8BF7\u4E00\u5806\u5185\u5B58\uFF0C\u5C06\u7533\u8BF7\u5230\u7684\u5185\u5B58\u5B89\u7F6E\u5728 PageHeap \u7684\u5185\u5B58\u7ED3\u6784\u4E2D\uFF0C\u91CD\u65B0\u6267\u884C\uFF083\uFF09\u6B65\u9AA4\u3002</p><p>\uFF085\uFF09\u5C06\u4ECE Large Span Set \u96C6\u5408\u5F97\u5230\u7684 N \u4E2A Page \u7EC4\u6210\u7684 Span \u62C6\u5206\u6210\u4E24\u4E2A Span\uFF0CK \u4E2A Page \u7684 Span \u76F4\u63A5\u8FD4\u56DE\u7ED9 Thread \u7528\u6237\u903B\u8F91\uFF0CN-K \u4E2A Span \u9000\u8FD8\u7ED9 PageHeap\u3002\u5176\u4E2D\u5982\u679C N-K \u5927\u4E8E 128 \u5219\u9000\u8FD8\u5230 Large Span Set \u96C6\u5408\u4E2D\uFF0C\u5982\u679C N-K \u5C0F\u4E8E 128\uFF0C\u5219\u9000\u8FD8\u5230 Page \u94FE\u8868\u4E2D\u3002</p><p>\u7EFC\u4E0A\u662F TCMalloc \u5BF9\u4E8E\u5927\u5BF9\u8C61\u5206\u914D\u7684\u8BE6\u7EC6\u6D41\u7A0B\u3002</p><h2 id="_6-golang-\u5806\u5185\u5B58\u7BA1\u7406" tabindex="-1"><a class="header-anchor" href="#_6-golang-\u5806\u5185\u5B58\u7BA1\u7406" aria-hidden="true">#</a> 6 Golang \u5806\u5185\u5B58\u7BA1\u7406<a href="#3d2c5c">#</a></h2><p>\u672C\u7AE0\u8282\u5C06\u4ECB\u7ECD Golang \u7684\u5185\u5B58\u7BA1\u7406\u6A21\u578B\uFF0C\u770B\u672C\u7AE0\u8282\u4E4B\u524D\u5F3A\u70C8\u5EFA\u8BAE\u8BFB\u8005\u5C06\u4E0A\u8FF0\u7AE0\u8282\u5747\u9605\u8BFB\u7406\u89E3\u5B8C\u6210\uFF0C\u66F4\u6709\u52A9\u4E8E\u7406\u89E3 Golang \u7684\u5185\u5B58\u7BA1\u7406\u673A\u5236\u3002</p><h3 id="_6-1-golang-\u5185\u5B58\u6A21\u578B\u5C42\u7EA7\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#_6-1-golang-\u5185\u5B58\u6A21\u578B\u5C42\u7EA7\u7ED3\u6784" aria-hidden="true">#</a> 6.1 Golang \u5185\u5B58\u6A21\u578B\u5C42\u7EA7\u7ED3\u6784<a href="#2a1f70">#</a></h3><p>Golang \u5185\u5B58\u7BA1\u7406\u6A21\u578B\u7684\u903B\u8F91\u5C42\u6B21\u5168\u666F\u56FE\uFF0C\u5982\u56FE 31 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/uDZB3Hy50v.png!large" alt="awsef"></p><h3 id="\u56FE-31-golang-\u5185\u5B58\u7BA1\u7406\u6A21\u5757\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#\u56FE-31-golang-\u5185\u5B58\u7BA1\u7406\u6A21\u5757\u5173\u7CFB" aria-hidden="true">#</a> \u56FE 31 Golang \u5185\u5B58\u7BA1\u7406\u6A21\u5757\u5173\u7CFB<a href="#f6387d">#</a></h3><p>Golang \u5185\u5B58\u7BA1\u7406\u6A21\u578B\u4E0E TCMalloc \u7684\u8BBE\u8BA1\u6781\u5176\u76F8\u4F3C\u3002\u57FA\u672C\u8F6E\u5ED3\u548C\u6982\u5FF5\u4E5F\u51E0\u4E4E\u76F8\u540C\uFF0C\u53EA\u662F\u4E00\u4E9B\u89C4\u5219\u548C\u6D41\u7A0B\u5B58\u5728\u5DEE\u5F02\uFF0C\u63A5\u4E0B\u6765\u5206\u6790\u4E00\u4E0B Golang \u5185\u5B58\u7BA1\u7406\u6A21\u578B\u7684\u57FA\u672C\u5C42\u7EA7\u6A21\u5757\u7EC4\u6210\u6982\u5FF5\u3002</p><h3 id="_6-2-golang-\u5185\u5B58\u7BA1\u7406\u5355\u5143\u76F8\u5173\u6982\u5FF5" tabindex="-1"><a class="header-anchor" href="#_6-2-golang-\u5185\u5B58\u7BA1\u7406\u5355\u5143\u76F8\u5173\u6982\u5FF5" aria-hidden="true">#</a> 6.2 Golang \u5185\u5B58\u7BA1\u7406\u5355\u5143\u76F8\u5173\u6982\u5FF5<a href="#174ec7">#</a></h3><p>Golang \u5185\u5B58\u7BA1\u7406\u4E2D\u4F9D\u7136\u4FDD\u7559 TCMalloc \u4E2D\u7684 Page\u3001Span\u3001Size Class \u7B49\u6982\u5FF5\u3002</p><h4 id="_1-page-1" tabindex="-1"><a class="header-anchor" href="#_1-page-1" aria-hidden="true">#</a> 1.Page<a href="#09ea37">#</a></h4><p>\u4E0E TCMalloc \u7684 Page \u4E00\u81F4\u3002Golang \u5185\u5B58\u7BA1\u7406\u6A21\u578B\u5EF6\u7EED\u4E86 TCMalloc \u7684\u6982\u5FF5\uFF0C\u4E00\u4E2A Page \u7684\u5927\u5C0F\u4F9D\u7136\u662F 8KB\u3002Page \u8868\u793A Golang \u5185\u5B58\u7BA1\u7406\u4E0E\u865A\u62DF\u5185\u5B58\u4EA4\u4E92\u5185\u5B58\u7684\u6700\u5C0F\u5355\u5143\u3002\u64CD\u4F5C\u7CFB\u7EDF\u865A\u62DF\u5185\u5B58\u5BF9\u4E8E Golang \u6765\u8BF4\uFF0C\u4F9D\u7136\u662F\u5212\u5206\u6210\u7B49\u5206\u7684 N \u4E2A Page \u7EC4\u6210\u7684\u4E00\u5757\u5927\u5185\u5B58\u516C\u5171\u6C60\uFF0C\u5982\u56FE 3.21 \u6240\u793A\u3002</p><h4 id="_2-mspan" tabindex="-1"><a class="header-anchor" href="#_2-mspan" aria-hidden="true">#</a> 2.mSpan<a href="#c26313">#</a></h4><p>\u4E0E TCMalloc \u4E2D\u7684 Span \u4E00\u81F4\u3002mSpan \u6982\u5FF5\u4F9D\u7136\u5EF6\u7EED TCMalloc \u4E2D\u7684 Span \u6982\u5FF5\uFF0C\u5728 Golang \u4E2D\u5C06 Span \u7684\u540D\u79F0\u6539\u4E3A mSpan\uFF0C\u4F9D\u7136\u8868\u793A\u4E00\u7EC4\u8FDE\u7EED\u7684 Page\u3002</p><h4 id="_3-size-class-\u76F8\u5173" tabindex="-1"><a class="header-anchor" href="#_3-size-class-\u76F8\u5173" aria-hidden="true">#</a> 3.Size Class \u76F8\u5173<a href="#006890">#</a></h4><p>Golang \u5185\u5B58\u7BA1\u7406\u9488\u5BF9 Size Class \u5BF9\u8861\u91CF\u5185\u5B58\u7684\u7684\u6982\u5FF5\u53C8\u66F4\u52A0\u8BE6\u7EC6\u4E86\u5F88\u591A\uFF0C\u8FD9\u91CC\u9762\u4ECB\u7ECD\u4E00\u4E9B\u57FA\u7840\u7684\u6709\u5173\u5185\u5B58\u5927\u5C0F\u7684\u540D\u8BCD\u53CA\u7B97\u6CD5\u3002</p><p>\uFF081\uFF09Object Size\uFF0C\u662F\u53EA\u534F\u7A0B\u5E94\u7528\u903B\u8F91\u4E00\u6B21\u5411 Golang \u5185\u5B58\u7533\u8BF7\u7684\u5BF9\u8C61 Object \u5927\u5C0F\u3002Object \u662F Golang \u5185\u5B58\u7BA1\u7406\u6A21\u5757\u9488\u5BF9\u5185\u5B58\u7BA1\u7406\u66F4\u52A0\u7EC6\u5316\u7684\u5185\u5B58\u7BA1\u7406\u5355\u5143\u3002\u4E00\u4E2A Span \u5728\u521D\u59CB\u5316\u65F6\u4F1A\u88AB\u5206\u6210\u591A\u4E2A Object\u3002\u6BD4\u5982 Object Size \u662F 8B\uFF088 \u5B57\u8282\uFF09\u5927\u5C0F\u7684 Object\uFF0C\u6240\u5C5E\u7684 Span \u5927\u5C0F\u662F 8KB\uFF088192 \u5B57\u8282\uFF09\uFF0C\u90A3\u4E48\u8FD9\u4E2A Span \u5C31\u4F1A\u88AB\u5E73\u5747\u5206\u5272\u6210 1024\uFF088192/8=1024\uFF09\u4E2A Object\u3002\u903B\u8F91\u5C42\u5411 Golang \u5185\u5B58\u6A21\u578B\u53D6\u5185\u5B58\uFF0C\u5B9E\u5219\u662F\u5206\u914D\u4E00\u4E2A Object \u51FA\u53BB\u3002\u4E3A\u4E86\u66F4\u597D\u7684\u8BA9\u8BFB\u8005\u7406\u89E3\uFF0C\u8FD9\u91CC\u5047\u8BBE\u4E86\u51E0\u4E2A\u6570\u636E\u6765\u6807\u8BC6 Object Size \u548C Span \u7684\u5173\u7CFB\uFF0C\u5982\u56FE 32 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/2fxXkOn6an.png!large" alt="awsef"></p><h3 id="\u56FE-32-object-size-\u4E0E-span-\u7684\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#\u56FE-32-object-size-\u4E0E-span-\u7684\u5173\u7CFB" aria-hidden="true">#</a> \u56FE 32 Object Size \u4E0E Span \u7684\u5173\u7CFB<a href="#b1a219">#</a></h3><p>\u4E0A\u56FE\u4E2D\u7684 Num Of Object \u8868\u793A\u5F53\u524D Span \u4E2D\u4E00\u5171\u5B58\u5728\u591A\u5C11\u4E2A Object\u3002</p><p>\u6CE8\u610F Page \u662F Golang \u5185\u5B58\u7BA1\u7406\u4E0E\u64CD\u4F5C\u7CFB\u7EDF\u4EA4\u4E92\u8861\u91CF\u5185\u5B58\u5BB9\u91CF\u7684\u57FA\u672C\u5355\u5143\uFF0CGolang \u5185\u5B58\u7BA1\u7406\u5185\u90E8\u672C\u8EAB\u7528\u6765\u7ED9\u5BF9\u8C61\u5B58\u50A8\u5185\u5B58\u7684\u57FA\u672C\u5355\u5143\u662F Object\u3002</p><p>\uFF082\uFF09Size Class\uFF0CGolang \u5185\u5B58\u7BA1\u7406\u4E2D\u7684 Size Class \u4E0E TCMalloc \u6240\u8868\u793A\u7684\u8BBE\u8BA1\u542B\u4E49\u662F\u4E00\u81F4\u7684\uFF0C\u90FD\u8868\u793A\u4E00\u5757\u5185\u5B58\u7684\u6240\u5C5E\u89C4\u683C\u6216\u8005\u523B\u5EA6\u3002Golang \u5185\u5B58\u7BA1\u7406\u4E2D\u7684 Size Class \u662F\u9488\u5BF9 Object Size \u6765\u5212\u5206\u5185\u5B58\u7684\u3002\u4E5F\u662F\u5212\u5206 Object \u5927\u5C0F\u7684\u7EA7\u522B\u3002\u6BD4\u5982 Object Size \u5728 1Byte~8Byte \u4E4B\u95F4\u7684 Object \u5C5E\u4E8E Size Class 1 \u7EA7\u522B\uFF0CObject Size \u5728 8B~16Byte \u4E4B\u95F4\u7684\u5C5E\u4E8E Size Class 2 \u7EA7\u522B\u3002</p><p>\uFF083\uFF09Span Class\uFF0C\u8FD9\u4E2A\u662F Golang \u5185\u5B58\u7BA1\u7406\u989D\u5916\u5B9A\u4E49\u7684\u89C4\u683C\u5C5E\u6027\uFF0C\u662F\u9488\u5BF9 Span \u6765\u8FDB\u884C\u5212\u5206\u7684\uFF0C\u662F Span \u5927\u5C0F\u7684\u7EA7\u522B\u3002\u4E00\u4E2A Size Class \u4F1A\u5BF9\u5E94\u4E24\u4E2A Span Class\uFF0C\u5176\u4E2D\u4E00\u4E2A Span \u4E3A\u5B58\u653E\u9700\u8981 GC \u626B\u63CF\u7684\u5BF9\u8C61\uFF08\u5305\u542B\u6307\u9488\u7684\u5BF9\u8C61\uFF09\uFF0C\u53E6\u4E00\u4E2A Span \u4E3A\u5B58\u653E\u4E0D\u9700\u8981 GC \u626B\u63CF\u7684\u5BF9\u8C61\uFF08\u4E0D\u5305\u542B\u6307\u9488\u7684\u5BF9\u8C61\uFF09\uFF0C\u5177\u4F53 Span Class \u4E0E Size Class \u7684\u903B\u8F91\u7ED3\u6784\u5173\u7CFB\u5982\u56FE 33 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/CDvFCKTFqv.png!large" alt="awsef"></p><h3 id="\u56FE-33-span-class-\u4E0E-size-class-\u7684\u903B\u8F91\u7ED3\u6784\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#\u56FE-33-span-class-\u4E0E-size-class-\u7684\u903B\u8F91\u7ED3\u6784\u5173\u7CFB" aria-hidden="true">#</a> \u56FE 33 Span Class \u4E0E Size Class \u7684\u903B\u8F91\u7ED3\u6784\u5173\u7CFB<a href="#70c010">#</a></h3><p>\u5176\u4E2D Size Class \u548C Span Class \u7684\u5BF9\u5E94\u5173\u7CFB\u8BA1\u7B97\u65B9\u5F0F\u53EF\u4EE5\u53C2\u8003 Golang \u6E90\u4EE3\u7801\uFF0C\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//usr/local/go/src/runtime/mheap.go

type spanClass uint8 

//\u2026\u2026(\u7701\u7565\u90E8\u5206\u4EE3\u7801)

func makeSpanClass(sizeclass uint8, noscan bool) spanClass {
return spanClass(sizeclass&lt;&lt;1) | spanClass(bool2int(noscan))
}

//\u2026\u2026(\u7701\u7565\u90E8\u5206\u4EE3\u7801)

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC makeSpanClass () \u51FD\u6570\u4E3A\u901A\u8FC7 Size Class \u6765\u5F97\u5230\u5BF9\u5E94\u7684 Span Class\uFF0C\u5176\u4E2D\u7B2C\u4E8C\u4E2A\u5F62\u53C2 noscan \u8868\u793A\u5F53\u524D\u5BF9\u8C61\u662F\u5426\u9700\u8981 GC \u626B\u63CF\uFF0C\u4E0D\u96BE\u770B\u51FA\u6765 Span Class \u548C Size Class \u7684\u5BF9\u5E94\u5173\u7CFB\u516C\u5F0F\u5982\u8868 3-5 \u6240\u793A\u3002</p><h3 id="\u8868-5-tcmalloc-\u7684\u5185\u5B58\u5206\u79BB" tabindex="-1"><a class="header-anchor" href="#\u8868-5-tcmalloc-\u7684\u5185\u5B58\u5206\u79BB" aria-hidden="true">#</a> \u8868 5 TCMalloc \u7684\u5185\u5B58\u5206\u79BB<a href="#798f83">#</a></h3><table><thead><tr><th><strong>\u5BF9\u8C61</strong></th><th><strong>Size Class **</strong> \u4E0E <strong>** Span Class**</strong> \u5BF9\u5E94\u516C\u5F0F **</th></tr></thead><tbody><tr><td>\u9700\u8981 GC \u626B\u63CF</td><td>Span Class = Size Class * 2 + 0</td></tr><tr><td>\u4E0D\u9700\u8981 GC \u626B\u63CF</td><td>Span Class = Size Class * 2 + 1</td></tr></tbody></table><h4 id="_4-size-class-\u660E\u7EC6" tabindex="-1"><a class="header-anchor" href="#_4-size-class-\u660E\u7EC6" aria-hidden="true">#</a> 4.Size Class \u660E\u7EC6<a href="#5a9565">#</a></h4><p>\u5982\u679C\u518D\u5177\u4F53\u4E00\u4E9B\uFF0C\u5219\u901A\u8FC7 Golang \u7684\u6E90\u7801\u53EF\u4EE5\u770B\u5230\uFF0CGolang \u7ED9\u5185\u5B58\u6C60\u4E2D\u56FA\u5B9A\u5212\u5206\u4E86 66<a href="#_ftn7">[7]</a> \u4E2A Size Class\uFF0C\u8FD9\u91CC\u9762\u5217\u4E3E\u4E86\u8BE6\u7EC6\u7684 Size Class \u548C Object \u5927\u5C0F\u3001\u5B58\u653E Object \u6570\u91CF\uFF0C\u4EE5\u53CA\u6BCF\u4E2A Size Class \u5BF9\u5E94\u7684 Span \u5185\u5B58\u5927\u5C0F\u5173\u7CFB\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//usr/local/go/src/runtime/sizeclasses.go

package runtime

// \u6807\u9898Title\u89E3\u91CA\uFF1A
// [class]: Size Class
// [bytes/obj]: Object Size\uFF0C\u4E00\u6B21\u5BF9\u5916\u63D0\u4F9B\u5185\u5B58Object\u7684\u5927\u5C0F
// [bytes/span]: \u5F53\u524DObject\u6240\u5BF9\u5E94Span\u7684\u5185\u5B58\u5927\u5C0F
// [objects]: \u5F53\u524DSpan\u4E00\u5171\u6709\u591A\u5C11\u4E2AObject
// [tail wastre]: \u4E3A\u5F53\u524DSpan\u5E73\u5747\u5206\u5C42N\u4EFDObject\uFF0C\u4F1A\u6709\u591A\u5C11\u5185\u5B58\u6D6A\u8D39
// [max waste]: \u5F53\u524DSize Class\u6700\u5927\u53EF\u80FD\u6D6A\u8D39\u7684\u7A7A\u95F4\u6240\u5360\u767E\u5206\u6BD4

// class  bytes/obj  bytes/span  objects  tail waste  max waste
//     1          8        8192     1024           0        87.50%
//     2         16        8192      512           0        43.75%
//     3         32        8192      256           0        46.88%
//     4         48        8192      170          32        31.52%
//     5         64        8192      128           0        23.44%
//     6         80        8192      102          32        19.07%
//     7         96        8192       85          32        15.95%
//     8        112        8192       73          16        13.56%
//     9        128        8192       64           0        11.72%
//    10        144        8192       56         128        11.82%
//    11        160        8192       51          32        9.73%
//    12        176        8192       46          96        9.59%
//    13        192        8192       42         128        9.25%
//    14        208        8192       39          80        8.12%
//    15        224        8192       36         128        8.15%
//    16        240        8192       34          32        6.62%
//    17        256        8192       32           0        5.86%
//    18        288        8192       28         128        12.16%
//    19        320        8192       25         192        11.80%
//    20        352        8192       23          96        9.88%
//    21        384        8192       21         128        9.51%
//    22        416        8192       19         288        10.71%
//    23        448        8192       18         128        8.37%
//    24        480        8192       17          32        6.82%
//    25        512        8192       16           0        6.05%
//    26        576        8192       14         128        12.33%
//    27        640        8192       12         512        15.48%
//    28        704        8192       11         448        13.93%
//    29        768        8192       10         512        13.94%
//    30        896        8192        9         128        15.52%
//    31       1024        8192        8           0        12.40%
//    32       1152        8192        7         128        12.41%
//    33       1280        8192        6         512        15.55%
//    34       1408       16384       11         896        14.00%
//    35       1536        8192        5         512        14.00%
//    36       1792       16384        9         256        15.57%
//    37       2048        8192        4           0        12.45%
//    38       2304       16384        7         256       12.46%
//    39       2688        8192        3         128        15.59%
//    40       3072       24576        8           0        12.47%
//    41       3200       16384        5         384        6.22%
//    42       3456       24576        7         384        8.83%
//    43       4096        8192        2           0        15.60%
//    44       4864       24576        5         256        16.65%
//    45       5376       16384        3         256        10.92%
//    46       6144       24576        4           0        12.48%
//    47       6528       32768        5         128        6.23%
//    48       6784       40960        6         256        4.36%
//    49       6912       49152        7         768        3.37%
//    50       8192        8192        1           0        15.61%
//    51       9472       57344        6         512        14.28%
//    52       9728       49152        5         512        3.64%
//    53      10240       40960        4           0        4.99%
//    54      10880       32768        3         128        6.24%
//    55      12288       24576        2           0        11.45%
//    56      13568       40960        3         256        9.99%
//    57      14336       57344        4           0        5.35%
//    58      16384       16384        1           0        12.49%
//    59      18432       73728        4           0        11.11%
//    60      19072       57344        3         128        3.57%
//    61      20480       40960        2           0        6.87%
//    62      21760       65536        3         256        6.25%
//    63      24576       24576        1           0        11.45%
//    64      27264       81920        3         128        10.00%
//    65      28672       57344        2           0        4.91%
//    66      32768       32768        1           0        12.50%

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0B\u9762\u5206\u522B\u89E3\u91CA\u4E00\u4E0B\u6BCF\u4E00\u5217\u7684\u542B\u4E49\uFF1A</p><p>\uFF081\uFF09Class \u5217\u4E3A Size Class \u89C4\u683C\u7EA7\u522B\u3002</p><p>\uFF082\uFF09bytes/obj \u5217\u4E3A Object Size\uFF0C\u5373\u4E00\u6B21\u5BF9\u5916\u63D0\u4F9B\u5185\u5B58 Object \u7684\u5927\u5C0F\uFF08\u5355\u4F4D\u4E3A Byte\uFF09\uFF0C\u53EF\u80FD\u6709\u4E00\u5B9A\u7684\u6D6A\u8D39\uFF0C\u6BD4\u5982\u4E1A\u52A1\u903B\u8F91\u5C42\u9700\u8981 2B \u7684\u6570\u636E\uFF0C\u5B9E\u5219\u4F1A\u5B9A\u4F4D\u5230 Size Class \u4E3A 1\uFF0C\u8FD4\u56DE\u4E00\u4E2A Object \u5373 8B \u7684\u5185\u5B58\u7A7A\u95F4\u3002</p><p>\uFF083\uFF09bytes/span \u5217\u4E3A\u5F53\u524D Object \u6240\u5BF9\u5E94 Span \u7684\u5185\u5B58\u5927\u5C0F\uFF08\u5355\u4F4D\u4E3A Byte\uFF09\u3002</p><p>\uFF084\uFF09objects \u5217\u4E3A\u5F53\u524D Span \u4E00\u5171\u6709\u591A\u5C11\u4E2A Object\uFF0C\u8BE5\u5B57\u6BB5\u662F\u901A\u8FC7 bytes/span \u548C bytes/obj \u76F8\u9664\u8BA1\u7B97\u800C\u6765\u3002</p><p>\uFF085\uFF09tail waste \u5217\u4E3A\u5F53\u524D Span \u5E73\u5747\u5206\u5C42 N \u4EFD Object\uFF0C\u4F1A\u6709\u591A\u5C11\u5185\u5B58\u6D6A\u8D39\uFF0C\u8FD9\u4E2A\u503C\u662F\u901A\u8FC7 bytes/span \u5BF9 bytes/obj \u6C42\u4F59\u5F97\u51FA\uFF0C\u5373 span% obj\u3002</p><p>\uFF086\uFF09max waste \u5217\u5F53\u524D Size Class \u6700\u5927\u53EF\u80FD\u6D6A\u8D39\u7684\u7A7A\u95F4\u6240\u5360\u767E\u5206\u6BD4\u3002\u8FD9\u91CC\u9762\u6700\u5927\u7684\u60C5\u51B5\u5C31\u662F\u4E00\u4E2A Object \u4FDD\u5B58\u7684\u5B9E\u9645\u6570\u636E\u521A\u597D\u662F\u4E0A\u4E00\u7EA7 Size Class \u7684 Object \u5927\u5C0F\u52A0\u4E0A 1B\u3002\u5F53\u524D Size Class \u7684 Object \u6240\u4FDD\u5B58\u7684\u771F\u5B9E\u6570\u636E\u5BF9\u8C61\u90FD\u662F\u8FD9\u4E00\u79CD\u60C5\u51B5\uFF0C\u8FD9\u4E9B\u5168\u90E8\u7A7A\u95F4\u7684\u6D6A\u8D39\u518D\u52A0\u4E0A\u6700\u540E\u7684 tail waste \u5C31\u662F max waste \u6700\u5927\u6D6A\u8D39\u7684\u5185\u5B58\u767E\u5206\u6BD4\uFF0C\u5177\u4F53\u5982\u56FE 34 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/z1KuvVWFyd.png!large" alt="awsef"></p><h3 id="\u56FE-34-max-waste-\u6700\u5927\u6D6A\u8D39\u7A7A\u95F4\u8BA1\u7B97\u516C\u5F0F" tabindex="-1"><a class="header-anchor" href="#\u56FE-34-max-waste-\u6700\u5927\u6D6A\u8D39\u7A7A\u95F4\u8BA1\u7B97\u516C\u5F0F" aria-hidden="true">#</a> \u56FE 34 Max Waste \u6700\u5927\u6D6A\u8D39\u7A7A\u95F4\u8BA1\u7B97\u516C\u5F0F<a href="#d6e708">#</a></h3><p>\u56FE\u4E2D\u4EE5 Size Class \u4E3A 7 \u7684 Span \u4E3A\u4F8B\uFF0C\u901A\u8FC7\u6E90\u4EE3\u7801 runtime/sizeclasses.go \u7684\u8BE6\u7EC6 Size Class \u6570\u636E\u53EF\u4EE5\u5F97\u77E5\u5177\u4F53 Span \u7EC6\u8282\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// class  bytes/obj  bytes/span  objects  tail waste  max waste

// \u2026 \u2026
//     6         80        8192      102          32        19.07%
//     7         96        8192       85          32        15.95%
// \u2026 \u2026

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE\u56FE 3.34 \u53EF\u4EE5\u770B\u51FA\uFF0CSize Class \u4E3A 7 \u7684 Span \u5982\u679C\u6BCF\u4E2A Object \u5747\u8D85\u8FC7 Size Class \u4E3A 7 \u4E2D\u7684 Object \u4E00\u4E2A\u5B57\u8282\u3002\u90A3\u4E48\u5C31\u4F1A\u5BFC\u81F4 Size Class \u4E3A 7 \u7684 Span \u51FA\u73B0\u6700\u5927\u7A7A\u95F4\u6D6A\u8D39\u60C5\u51B5\u3002\u7EFC\u4E0A\u53EF\u4EE5\u5F97\u51FA\u8BA1\u7B97\u6700\u5927\u6D6A\u8D39\u7A7A\u95F4\u6BD4\u4F8B\u7684\u7B97\u6CD5\u516C\u5F0F\u5982\u4E0B\uFF1A</p><blockquote><p>(\u672C\u7EA7 Object Size \u2013 (\u4E0A\u7EA7 Object Size + 1)* \u672C\u7EA7 Object \u6570\u91CF) / \u672C\u7EA7 Span Size</p></blockquote><h3 id="_6-3-mcache" tabindex="-1"><a class="header-anchor" href="#_6-3-mcache" aria-hidden="true">#</a> 6.3 MCache<a href="#aeb07c">#</a></h3><p>\u4ECE\u6982\u5FF5\u6765\u8BB2 MCache \u4E0E TCMalloc \u7684 ThreadCache \u5341\u5206\u76F8\u4F3C\uFF0C\u8BBF\u95EE mcache \u4F9D\u7136\u4E0D\u9700\u8981\u52A0\u9501\u800C\u662F\u76F4\u63A5\u8BBF\u95EE\uFF0C\u4E14 MCache \u4E2D\u4F9D\u7136\u4FDD\u5B58\u5404\u79CD\u5927\u5C0F\u7684 Span\u3002</p><p>\u867D\u7136 MCache \u4E0E ThreadCache \u6982\u5FF5\u76F8\u4F3C\uFF0C\u4E8C\u8005\u8FD8\u662F\u5B58\u5728\u4E00\u5B9A\u7684\u533A\u522B\u7684\uFF0CMCache \u662F\u4E0E Golang \u534F\u7A0B\u8C03\u5EA6\u6A21\u578B GPM \u4E2D\u7684 P \u6240\u7ED1\u5B9A\uFF0C\u800C\u4E0D\u662F\u548C\u7EBF\u7A0B\u7ED1\u5B9A\u3002\u56E0\u4E3A Golang \u8C03\u5EA6\u7684 GPM \u6A21\u578B\uFF0C\u771F\u6B63\u53EF\u8FD0\u884C\u7684\u7EBF\u7A0B M \u7684\u6570\u91CF\u4E0E P \u7684\u6570\u91CF\u4E00\u81F4\uFF0C\u5373 GOMAXPROCS \u4E2A\uFF0C\u6240\u4EE5 MCache \u4E0E P \u8FDB\u884C\u7ED1\u5B9A\u66F4\u80FD\u8282\u7701\u5185\u5B58\u7A7A\u95F4\u4F7F\u7528\uFF0C\u53EF\u4EE5\u4FDD\u8BC1\u6BCF\u4E2A G \u4F7F\u7528 MCache \u65F6\u4E0D\u9700\u8981\u52A0\u9501\u5C31\u53EF\u4EE5\u83B7\u53D6\u5230\u5185\u5B58\u3002\u800C TCMalloc \u4E2D\u7684 ThreadCache \u968F\u7740 Thread \u7684\u589E\u591A\uFF0CThreadCache \u7684\u6570\u91CF\u4E5F\u5C31\u76F8\u5BF9\u6210\u6B63\u6BD4\u589E\u591A\uFF0C\u4E8C\u8005\u7ED1\u5B9A\u5173\u7CFB\u7684\u533A\u522B\u5982\u56FE 35 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/Eoa2O9XiiT.png!large" alt="awsef"></p><h3 id="\u56FE-35-threadcache-\u4E0E-mcache-\u7684\u7ED1\u5B9A\u5173\u7CFB\u533A\u522B" tabindex="-1"><a class="header-anchor" href="#\u56FE-35-threadcache-\u4E0E-mcache-\u7684\u7ED1\u5B9A\u5173\u7CFB\u533A\u522B" aria-hidden="true">#</a> \u56FE 35 ThreadCache \u4E0E mcache \u7684\u7ED1\u5B9A\u5173\u7CFB\u533A\u522B<a href="#164589">#</a></h3><p>\u5982\u679C\u5C06\u56FE 35 \u7684 mcache \u5C55\u5F00\uFF0C\u6765\u770B mcache \u7684\u5185\u90E8\u6784\u9020\uFF0C\u5219\u5177\u4F53\u7684\u7ED3\u6784\u5F62\u5F0F\u5982\u56FE 36 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/kbkO9zhs1K.png!large" alt="awsef"></p><h3 id="\u56FE-36-mcache-\u5185\u90E8\u6784\u9020" tabindex="-1"><a class="header-anchor" href="#\u56FE-36-mcache-\u5185\u90E8\u6784\u9020" aria-hidden="true">#</a> \u56FE 36 MCache \u5185\u90E8\u6784\u9020<a href="#cffe4d">#</a></h3><p>\u534F\u7A0B\u903B\u8F91\u5C42\u4ECE mcache \u4E0A\u83B7\u53D6\u5185\u5B58\u662F\u4E0D\u9700\u8981\u52A0\u9501\u7684\uFF0C\u56E0\u4E3A\u4E00\u4E2A P \u53EA\u6709\u4E00\u4E2A M \u5728\u5176\u4E0A\u8FD0\u884C\uFF0C\u4E0D\u53EF\u80FD\u51FA\u73B0\u7ADE\u4E89\uFF0C\u7531\u4E8E\u6CA1\u6709\u9501\u9650\u5236\uFF0Cmcache \u5219\u5176\u5230\u4E86\u52A0\u901F\u5185\u5B58\u5206\u914D\u3002</p><p>MCache \u4E2D\u6BCF\u4E2A Span Class \u90FD\u4F1A\u5BF9\u5E94\u4E00\u4E2A MSpan\uFF0C\u4E0D\u540C Span Class \u7684 MSpan \u7684\u603B\u4F53\u957F\u5EA6\u4E0D\u540C\uFF0C\u53C2\u8003 runtime/sizeclasses.go \u7684\u6807\u51C6\u89C4\u5B9A\u5212\u5206\u3002\u6BD4\u5982\u5BF9\u4E8E Span Class \u4E3A 4 \u7684 MSpan \u6765\u8BF4\uFF0C\u5B58\u653E\u5185\u5B58\u5927\u5C0F\u4E3A 1Page\uFF0C\u5373 8KB\u3002\u6BCF\u4E2A\u5BF9\u5916\u63D0\u4F9B\u7684 Object \u5927\u5C0F\u4E3A 16B\uFF0C\u5171\u5B58\u653E 512 \u4E2A Object\u3002\u5176\u4ED6 Span Class \u7684\u5B58\u653E\u65B9\u5F0F\u7C7B\u4F3C\u3002\u5F53\u5176\u4E2D\u67D0\u4E2A Span Class \u7684 MSpan \u5DF2\u7ECF\u6CA1\u6709\u53EF\u63D0\u4F9B\u7684 Object \u65F6\uFF0CMCache \u5219\u4F1A\u5411 MCentral \u7533\u8BF7\u4E00\u4E2A\u5BF9\u5E94\u7684 MSpan\u3002</p><p>\u5728\u56FE 3.36 \u4E2D\u5E94\u8BE5\u4F1A\u53D1\u73B0\uFF0C\u5BF9\u4E8E Span Class \u4E3A 0 \u548C 1 \u7684\uFF0C\u4E5F\u5C31\u662F\u5BF9\u5E94 Size Class \u4E3A 0 \u7684\u89C4\u683C\u523B\u5EA6\u5185\u5B58\uFF0Cmcache \u5B9E\u9645\u4E0A\u662F\u6CA1\u6709\u5206\u914D\u4EFB\u4F55\u5185\u5B58\u7684\u3002\u56E0\u4E3A Golang \u5185\u5B58\u7BA1\u7406\u5BF9\u5185\u5B58\u4E3A 0 \u7684\u6570\u636E\u7533\u8BF7\u505A\u4E86\u7279\u6B8A\u5904\u7406\uFF0C\u5982\u679C\u7533\u8BF7\u7684\u6570\u636E\u5927\u5C0F\u4E3A 0 \u5C06\u76F4\u63A5\u8FD4\u56DE\u4E00\u4E2A\u56FA\u5B9A\u5185\u5B58\u5730\u5740\uFF0C\u4E0D\u4F1A\u8D70 Golang \u5185\u5B58\u7BA1\u7406\u7684\u6B63\u5E38\u903B\u8F91\uFF0C\u76F8\u5173 Golang \u6E90\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//usr/local/go/src/runtime/malloc.go

// Al Allocate an object of size bytes.                                     
// Sm Small objects are allocated from the per-P cache&#39;s free lists.        
// La Large objects (&gt; 32 kB) are allocated straight from the heap.         
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {                        
// \u2026\u2026\uFF08\u7701\u7565\u90E8\u5206\u4EE3\u7801\uFF09

if size == 0 {
return unsafe.Pointer(&amp;zerobase)
}

//\u2026\u2026\uFF08\u7701\u7565\u90E8\u5206\u4EE3\u7801\uFF09
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u53EF\u4EE5\u770B\u89C1\uFF0C\u5982\u679C\u7533\u8BF7\u7684 size \u4E3A 0\uFF0C\u5219\u76F4\u63A5 return \u4E00\u4E2A\u56FA\u5B9A\u5730\u5740 zerobase\u3002\u4E0B\u9762\u6765\u6D4B\u8BD5\u4E00\u4E0B\u6709\u5173 0 \u7A7A\u95F4\u7533\u8BF7\u7684\u60C5\u51B5\uFF0C\u5728 Golang \u4E2D\u5982 [0] int\u3001 struct {} \u6240\u9700\u8981\u5927\u5C0F\u5747\u662F 0\uFF0C\u8FD9\u4E5F\u662F\u4E3A\u4EC0\u4E48\u5F88\u591A\u5F00\u53D1\u8005\u5728\u901A\u8FC7 Channel \u505A\u540C\u6B65\u65F6\uFF0C\u53D1\u9001\u4E00\u4E2A struct {} \u6570\u636E\uFF0C\u56E0\u4E3A\u4E0D\u4F1A\u7533\u8BF7\u4EFB\u4F55\u5185\u5B58\uFF0C\u80FD\u591F\u9002\u5F53\u8282\u7701\u4E00\u90E8\u5206\u5185\u5B58\u7A7A\u95F4\uFF0C\u6D4B\u8BD5\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//\u7B2C\u4E00\u7BC7/chapter3/MyGolang/zeroBase.go
package main

import (
&quot;fmt&quot;
)

func main() {
var (
//0\u5185\u5B58\u5BF9\u8C61
a struct{}
b [0]int

//100\u4E2A0\u5185\u5B58struct{}
c [100]struct{}

//100\u4E2A0\u5185\u5B58struct{},make\u7533\u8BF7\u5F62\u5F0F
d = make([awsef]struct{}, 100)
)

fmt.Printf(&quot;%p\\n&quot;, &amp;a)
fmt.Printf(&quot;%p\\n&quot;, &amp;b)
fmt.Printf(&quot;%p\\n&quot;, &amp;c[50])    //\u53D6\u4EFB\u610F\u5143\u7D20
fmt.Printf(&quot;%p\\n&quot;, &amp;(d[50]))  //\u53D6\u4EFB\u610F\u5143\u7D20
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD0\u884C\u7ED3\u679C\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ go run zeroBase.go 
0x11aac78
0x11aac78
0x11aac78
0x11aac78

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE\u7ED3\u679C\u53EF\u4EE5\u770B\u51FA\uFF0C\u5168\u90E8\u7684 0 \u5185\u5B58\u5BF9\u8C61\u5206\u914D\uFF0C\u8FD4\u56DE\u7684\u90FD\u662F\u4E00\u4E2A\u56FA\u5B9A\u7684\u5730\u5740\u3002</p><h3 id="_6-4-mcentral" tabindex="-1"><a class="header-anchor" href="#_6-4-mcentral" aria-hidden="true">#</a> 6.4 MCentral<a href="#fa0bbd">#</a></h3><p>MCentral \u4E0E TCMalloc \u4E2D\u7684 Central \u6982\u5FF5\u4F9D\u7136\u76F8\u4F3C\u3002\u5411 MCentral \u7533\u8BF7 Span \u662F\u540C\u6837\u662F\u9700\u8981\u52A0\u9501\u7684\u3002\u5F53 MCache \u4E2D\u67D0\u4E2A Size Class \u5BF9\u5E94\u7684 Span \u88AB\u4E00\u6B21\u6B21 Object \u88AB\u4E0A\u5C42\u53D6\u8D70\u540E\uFF0C\u5982\u679C\u51FA\u73B0\u5F53\u524D Size Class \u7684 Span \u7A7A\u7F3A\u60C5\u51B5\uFF0CMCache \u5219\u4F1A\u5411 MCentral \u7533\u8BF7\u5BF9\u5E94\u7684 Span\u3002Goroutine\u3001MCache\u3001MCentral\u3001MHeap \u4E92\u76F8\u4EA4\u6362\u7684\u5185\u5B58\u5355\u4F4D\u662F\u4E0D\u540C\uFF0C\u5177\u4F53\u5982\u56FE 37 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/qK281tfKAX.png!large" alt="awsef"></p><h3 id="\u56FE-37-golang-\u5185\u5B58\u7BA1\u7406\u5404\u5C42\u7EA7\u5185\u5B58\u4EA4\u6362\u5355\u4F4D" tabindex="-1"><a class="header-anchor" href="#\u56FE-37-golang-\u5185\u5B58\u7BA1\u7406\u5404\u5C42\u7EA7\u5185\u5B58\u4EA4\u6362\u5355\u4F4D" aria-hidden="true">#</a> \u56FE 37 Golang \u5185\u5B58\u7BA1\u7406\u5404\u5C42\u7EA7\u5185\u5B58\u4EA4\u6362\u5355\u4F4D<a href="#cd06d7">#</a></h3><p>\u5176\u4E2D\u534F\u7A0B\u903B\u8F91\u5C42\u4E0E MCache \u7684\u5185\u5B58\u4EA4\u6362\u5355\u4F4D\u662F Object\uFF0CMCache \u4E0E MCentral \u7684\u5185\u5B58\u4EA4\u6362\u5355\u4F4D\u662F Span\uFF0C\u800C MCentral \u4E0E MHeap \u7684\u5185\u5B58\u4EA4\u6362\u5355\u4F4D\u662F Page\u3002</p><p>MCentral \u4E0E TCMalloc \u4E2D\u7684 Central \u4E0D\u540C\u7684\u662F MCentral \u9488\u5BF9\u6BCF\u4E2A Span Class \u7EA7\u522B\u6709\u4E24\u4E2A Span \u94FE\u8868\uFF0C\u800C TCMalloc \u4E2D\u7684 Central \u53EA\u6709\u4E00\u4E2A\u3002MCentral \u7684\u5185\u90E8\u6784\u9020\u5982\u56FE 38 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/6NQvk0q25r.png!large" alt="awsef"></p><h3 id="\u56FE-38-mcentral-\u7684\u5185\u90E8\u6784\u9020" tabindex="-1"><a class="header-anchor" href="#\u56FE-38-mcentral-\u7684\u5185\u90E8\u6784\u9020" aria-hidden="true">#</a> \u56FE 38 MCentral \u7684\u5185\u90E8\u6784\u9020<a href="#673623">#</a></h3><p>MCentral \u4E0E MCCache \u4E0D\u540C\u7684\u662F\uFF0C\u6BCF\u4E2A\u7EA7\u522B\u4FDD\u5B58\u7684\u4E0D\u662F\u4E00\u4E2A Span\uFF0C\u800C\u662F\u4E00\u4E2A Span List \u94FE\u8868\u3002\u4E0E TCMalloc \u4E2D\u7684 Central \u4E0D\u540C\u7684\u662F\uFF0CMCentral \u6BCF\u4E2A\u7EA7\u522B\u90FD\u4FDD\u5B58\u4E86\u4E24\u4E2A Span List\u3002</p><p><strong>\u6CE8\u610F \u56FE 38 \u4E2D MCentral \u662F\u8868\u793A\u4E00\u5C42\u62BD\u8C61\u7684\u6982\u5FF5\uFF0C\u5B9E\u9645\u4E0A\u6BCF\u4E2A Span Class \u5BF9\u5E94\u7684\u5185\u5B58\u6570\u636E\u7ED3\u6784\u662F\u4E00\u4E2A mcentral\uFF0C\u5373\u5728 MCentral \u8FD9\u5C42\u6570\u636E\u7BA1\u7406\u4E2D\uFF0C\u5B9E\u9645\u4E0A\u6709 Span Class \u4E2A mcentral \u5C0F\u5185\u5B58\u7BA1\u7406\u5355\u5143\u3002</strong></p><p><strong>1\uFF09NonEmpty Span List</strong></p><p>\u8868\u793A\u8FD8\u6709\u53EF\u7528\u7A7A\u95F4\u7684 Span \u94FE\u8868\u3002\u94FE\u8868\u4E2D\u7684\u6240\u6709 Span \u90FD\u81F3\u5C11\u6709 1 \u4E2A\u7A7A\u95F2\u7684 Object \u7A7A\u95F4\u3002\u5982\u679C MCentral \u4E0A\u6E38 MCache \u9000\u8FD8 Span\uFF0C\u4F1A\u5C06\u9000\u8FD8\u7684 Span \u52A0\u5165\u5230 NonEmpty Span List \u94FE\u8868\u4E2D\u3002</p><p><strong>2\uFF09Empty Span List</strong></p><p>\u8868\u793A\u6CA1\u6709\u53EF\u7528\u7A7A\u95F4\u7684 Span \u94FE\u8868\u3002\u8BE5\u94FE\u8868\u4E0A\u7684 Span \u90FD\u4E0D\u786E\u5B9A\u5426\u8FD8\u6709\u6709\u7A7A\u95F2\u7684 Object \u7A7A\u95F4\u3002\u5982\u679C MCentral \u63D0\u4F9B\u7ED9\u4E00\u4E2A Span \u7ED9\u5230\u4E0A\u6E38 MCache\uFF0C\u90A3\u4E48\u88AB\u63D0\u4F9B\u7684 Span \u5C31\u4F1A\u52A0\u5165\u5230 Empty List \u94FE\u8868\u4E2D\u3002</p><p><strong>\u6CE8\u610F \u5728 Golang 1.16 \u7248\u672C\u4E4B\u540E\uFF0CMCentral \u4E2D\u7684 NonEmpty Span List \u548C Empty Span List</strong></p><p><strong>\u5747\u7531\u94FE\u8868\u7BA1\u7406\u6539\u6210\u96C6\u5408\u7BA1\u7406\uFF0C\u5206\u522B\u5BF9\u5E94 Partial Span Set \u548C Full Span Set\u3002\u867D\u7136\u5B58\u50A8\u7684\u6570\u636E\u7ED3\u6784\u6709\u53D8\u5316\uFF0C\u4F46\u662F\u57FA\u672C\u7684\u4F5C\u7528\u548C\u804C\u8D23\u6CA1\u6709\u533A\u522B\u3002</strong></p><p>\u4E0B\u9762\u662F MCentral \u5C42\u7EA7\u4E2D\u5176\u4E2D\u4E00\u4E2A Size Class \u7EA7\u522B\u7684 MCentral \u7684\u5B9A\u4E49 Golang \u6E90\u4EE3\u7801\uFF08V1.14 \u7248\u672C\uFF09\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//usr/local/go/src/runtime/mcentral.go  , Go V1.14

// Central list of free objects of a given size.
// go:notinheap
type mcentral struct {
lock      mutex      //\u7533\u8BF7MCentral\u5185\u5B58\u5206\u914D\u65F6\u9700\u8981\u52A0\u7684\u9501

spanclass spanClass //\u5F53\u524D\u54EA\u4E2ASize Class\u7EA7\u522B\u7684

// list of spans with a free object, ie a nonempty free list
// \u8FD8\u6709\u53EF\u7528\u7A7A\u95F4\u7684Span \u94FE\u8868
nonempty  mSpanList 

// list of spans with no free objects (or cached in an mcache)
// \u6CA1\u6709\u53EF\u7528\u7A7A\u95F4\u7684Span\u94FE\u8868\uFF0C\u6216\u8005\u5F53\u524D\u94FE\u8868\u91CC\u7684Span\u5DF2\u7ECF\u4EA4\u7ED9mcache
empty     mSpanList 

// nmalloc is the cumulative count of objects allocated from
// this mcentral, assuming all spans in mcaches are
// fully-allocated. Written atomically, read under STW.
// nmalloc\u662F\u4ECE\u8BE5mcentral\u5206\u914D\u7684\u5BF9\u8C61\u7684\u7D2F\u79EF\u8BA1\u6570
// \u5047\u8BBEmcaches\u4E2D\u7684\u6240\u6709\u8DE8\u5EA6\u90FD\u5DF2\u5B8C\u5168\u5206\u914D\u3002
// \u4EE5\u539F\u5B50\u65B9\u5F0F\u4E66\u5199\uFF0C\u5728STW\u4E0B\u9605\u8BFB\u3002
nmalloc uint64
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 GolangV1.16 \u53CA\u4E4B\u540E\u7248\u672C\uFF08\u622A\u6B62\u672C\u4E66\u7F16\u5199\u6700\u65B0\u65F6\u95F4\uFF09\u7684\u76F8\u5173 MCentral \u7ED3\u6784\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//usr/local/go/src/runtime/mcentral.go  , Go V1.16+

//\u2026

type mcentral struct {
// mcentral\u5BF9\u5E94\u7684spanClass
spanclass spanClass

partial  [2]spanSet // \u7EF4\u62A4\u5168\u90E8\u7A7A\u95F2\u7684Span\u96C6\u5408
full     [2]spanSet // \u7EF4\u62A4\u5B58\u5728\u975E\u7A7A\u95F2\u7684Span\u96C6\u5408
}

//\u2026

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u65B0\u7248\u672C\u7684\u6539\u8FDB\u662F\u5C06 List \u53D8\u6210\u4E86\u4E24\u4E2A Set \u96C6\u5408\uFF0CPartial \u96C6\u5408\u4E0E NonEmpty Span List \u8D23\u4EFB\u7C7B\u4F3C\uFF0CFull \u96C6\u5408\u4E0E Empty Span List \u8D23\u4EFB\u7C7B\u4F3C\u3002\u53EF\u4EE5\u770B\u89C1 Partial \u548C Full \u90FD\u662F\u4E00\u4E2A [2] spanSet \u7C7B\u578B\uFF0C\u4E5F\u5C31\u6BCF\u4E2A Partial \u548C Full \u90FD\u5404\u6709\u4E24\u4E2A spanSet \u96C6\u5408\uFF0C\u8FD9\u662F\u4E3A\u4E86\u7ED9 GC \u5783\u573E\u56DE\u6536\u6765\u4F7F\u7528\u7684\uFF0C\u5176\u4E2D\u4E00\u4E2A\u96C6\u5408\u662F\u5DF2\u626B\u63CF\u7684\uFF0C\u53E6\u4E00\u4E2A\u96C6\u5408\u662F\u672A\u626B\u63CF\u7684\u3002</p><h3 id="_6-5-mheap" tabindex="-1"><a class="header-anchor" href="#_6-5-mheap" aria-hidden="true">#</a> 6.5 MHeap<a href="#577c48">#</a></h3><p>Golang \u5185\u5B58\u7BA1\u7406\u7684 MHeap \u4F9D\u7136\u662F\u7EE7\u627F TCMalloc \u7684 PageHeap \u8BBE\u8BA1\u3002MHeap \u7684\u4E0A\u6E38\u662F MCentral\uFF0CMCentral \u4E2D\u7684 Span \u4E0D\u591F\u65F6\u4F1A\u5411 MHeap \u7533\u8BF7\u3002MHeap \u7684\u4E0B\u6E38\u662F\u64CD\u4F5C\u7CFB\u7EDF\uFF0CMHeap \u7684\u5185\u5B58\u4E0D\u591F\u65F6\u4F1A\u5411\u64CD\u4F5C\u7CFB\u7EDF\u7684\u865A\u62DF\u5185\u5B58\u7A7A\u95F4\u7533\u8BF7\u3002\u8BBF\u95EE MHeap \u83B7\u53D6\u5185\u5B58\u4F9D\u7136\u662F\u9700\u8981\u52A0\u9501\u7684\u3002</p><p>MHeap \u662F\u5BF9\u5185\u5B58\u5757\u7684\u7BA1\u7406\u5BF9\u8C61\uFF0C\u662F\u901A\u8FC7 Page \u4E3A\u5185\u5B58\u5355\u5143\u8FDB\u884C\u7BA1\u7406\u3002\u90A3\u4E48\u7528\u6765\u8BE6\u7EC6\u7BA1\u7406\u6BCF\u4E00\u7CFB\u5217 Page \u7684\u7ED3\u6784\u79F0\u4E4B\u4E3A\u4E00\u4E2A HeapArena\uFF0C\u5B83\u4EEC\u7684\u903B\u8F91\u5C42\u7EA7\u5173\u7CFB\u5982\u56FE 39 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/rrio7zjjY4.png!large" alt="awsef"></p><h3 id="\u56FE-39-mheap-\u5185\u90E8\u903B\u8F91\u5C42\u7EA7\u6784\u9020" tabindex="-1"><a class="header-anchor" href="#\u56FE-39-mheap-\u5185\u90E8\u903B\u8F91\u5C42\u7EA7\u6784\u9020" aria-hidden="true">#</a> \u56FE 39 MHeap \u5185\u90E8\u903B\u8F91\u5C42\u7EA7\u6784\u9020<a href="#48d946">#</a></h3><p>\u4E00\u4E2A HeapArena \u5360\u7528\u5185\u5B58 64MB<a href="#_ftn8">[8]</a>\uFF0C\u5176\u4E2D\u91CC\u9762\u7684\u5185\u5B58\u7684\u662F\u4E00\u4E2A\u4E00\u4E2A\u7684 mspan\uFF0C\u5F53\u7136\u6700\u5C0F\u5355\u5143\u4F9D\u7136\u662F Page\uFF0C\u56FE\u4E2D\u6CA1\u6709\u8868\u793A\u51FA mspan\uFF0C\u56E0\u4E3A\u591A\u4E2A\u8FDE\u7EED\u7684 page \u5C31\u662F\u4E00\u4E2A mspan\u3002\u6240\u6709\u7684 HeapArena \u7EC4\u6210\u7684\u96C6\u5408\u662F\u4E00\u4E2A Arenas\uFF0C\u4E5F\u5C31\u662F MHeap \u9488\u5BF9\u5806\u5185\u5B58\u7684\u7BA1\u7406\u3002MHeap \u662F Golang \u8FDB\u7A0B\u5168\u5C40\u552F\u4E00\u7684\u6240\u4EE5\u8BBF\u95EE\u4F9D\u7136\u52A0\u9501\u3002\u56FE\u4E2D\u53C8\u51FA\u73B0\u4E86 MCentral\uFF0C\u56E0\u4E3A MCentral \u672C\u4E5F\u5C5E\u4E8E MHeap \u4E2D\u7684\u4E00\u90E8\u5206\u3002\u53EA\u4E0D\u8FC7\u4F1A\u4F18\u5148\u4ECE MCentral \u83B7\u53D6\u5185\u5B58\uFF0C\u5982\u679C\u6CA1\u6709 MCentral \u4F1A\u4ECE Arenas \u4E2D\u7684\u67D0\u4E2A HeapArena \u83B7\u53D6 Page\u3002</p><p>\u5982\u679C\u518D\u8BE6\u7EC6\u5256\u6790 MHeap \u91CC\u9762\u76F8\u5173\u7684\u6570\u636E\u7ED3\u6784\u548C\u6307\u9488\u4F9D\u8D56\u5173\u7CFB\uFF0C\u53EF\u4EE5\u53C2\u8003\u56FE 40\uFF0C\u8FD9\u91CC\u4E0D\u505A\u8FC7\u591A\u89E3\u91CA\uFF0C\u5982\u679C\u66F4\u50CF\u8BE6\u7EC6\u7406\u89E3 MHeap \u5EFA\u8BAE\u7814\u8BFB\u6E90\u4EE3\u7801 /usr/local/go/src/runtime/mheap.go \u6587\u4EF6\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/VmLPHYEJAb.png!large" alt="awsef"></p><h3 id="\u56FE-40-mheap-\u6570\u636E\u7ED3\u6784\u5F15\u7528\u4F9D\u8D56" tabindex="-1"><a class="header-anchor" href="#\u56FE-40-mheap-\u6570\u636E\u7ED3\u6784\u5F15\u7528\u4F9D\u8D56" aria-hidden="true">#</a> \u56FE 40 MHeap \u6570\u636E\u7ED3\u6784\u5F15\u7528\u4F9D\u8D56<a href="#110ffe">#</a></h3><p>MHeap \u4E2D HeapArena \u5360\u7528\u4E86\u7EDD\u5927\u90E8\u5206\u7684\u7A7A\u95F4\uFF0C\u5176\u4E2D\u6BCF\u4E2A HeapArean \u5305\u542B\u4E00\u4E2A bitmap\uFF0C\u5176\u4F5C\u7528\u662F\u7528\u4E8E\u6807\u8BB0\u5F53\u524D\u8FD9\u4E2A HeapArena \u7684\u5185\u5B58\u4F7F\u7528\u60C5\u51B5\u3002\u5176\u4E3B\u8981\u662F\u670D\u52A1\u4E8E GC \u5783\u573E\u56DE\u6536\u6A21\u5757\uFF0Cbitmap \u5171\u6709\u4E24\u79CD\u6807\u8BB0\uFF0C\u4E00\u4E2A\u662F\u6807\u8BB0\u5BF9\u5E94\u5730\u5740\u4E2D\u662F\u5426\u5B58\u5728\u5BF9\u8C61\uFF0C\u4E00\u4E2A\u662F\u6807\u8BB0\u6B64\u5BF9\u8C61\u662F\u5426\u88AB GC \u6A21\u5757\u6807\u8BB0\u8FC7\uFF0C\u6240\u4EE5\u5F53\u524D HeapArena \u4E2D\u7684\u6240\u6709 Page \u5747\u4F1A\u88AB bitmap \u6240\u6807\u8BB0\u3002</p><p>ArenaHint \u4E3A\u5BFB\u5740 HeapArena \u7684\u7ED3\u6784\uFF0C\u5176\u6709\u4E09\u4E2A\u6210\u5458\uFF1A</p><p>\uFF081\uFF09addr\uFF0C\u4E3A\u6307\u5411\u7684\u5BF9\u5E94 HeapArena \u9996\u5730\u5740\u3002</p><p>\uFF082\uFF09down\uFF0C\u4E3A\u5F53\u524D\u7684 HeapArena \u662F\u5426\u53EF\u4EE5\u6269\u5BB9\u3002</p><p>\uFF083\uFF09next\uFF0C\u6307\u5411\u4E0B\u4E00\u4E2A HeapArena \u6240\u5BF9\u5E94\u7684 ArenaHint \u9996\u5730\u5740\u3002</p><p>\u4ECE\u56FE 3.40 \u4E2D\u53EF\u4EE5\u770B\u51FA\uFF0CMCentral \u5B9E\u9645\u4E0A\u5C31\u662F\u96B6\u5C5E\u4E8E MHeap \u7684\u4E00\u90E8\u5206\uFF0C\u4ECE\u6570\u636E\u7ED3\u6784\u6765\u770B\uFF0C\u6BCF\u4E2A Span Class \u5BF9\u5E94\u4E00\u4E2A MCentral\uFF0C\u800C\u4E4B\u524D\u5728\u5206\u6790 Golang \u5185\u5B58\u7BA1\u7406\u4E2D\u7684\u903B\u8F91\u5206\u5C42\u4E2D\uFF0C\u662F\u5C06\u8FD9\u4E9B MCentral \u96C6\u5408\u7EDF\u4E00\u5F52\u7C7B\u4E3A MCentral \u5C42\u3002</p><h3 id="_6-6-tiny-\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_6-6-tiny-\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" aria-hidden="true">#</a> 6.6 Tiny \u5BF9\u8C61\u5206\u914D\u6D41\u7A0B<a href="#29cd9c">#</a></h3><p>\u5728\u4E4B\u524D\u7AE0\u8282\u7684\u8868 3-4 \u4E2D\u53EF\u4EE5\u5F97\u5230 TCMalloc \u5C06\u5BF9\u8C61\u5206\u4E3A\u4E86\u5C0F\u5BF9\u8C61\u3001\u4E2D\u5BF9\u8C61\u3001\u548C\u5927\u5BF9\u8C61\uFF0C\u800C Golang \u5185\u5B58\u7BA1\u7406\u5C06\u5BF9\u8C61\u7684\u5206\u7C7B\u8FDB\u884C\u4E86\u66F4\u7EC6\u7684\u4E00\u4E9B\u5212\u5206\uFF0C\u5177\u4F53\u7684\u5212\u5206\u533A\u522B\u5BF9\u6BD4\u5982\u8868 6 \u6240\u793A\u3002</p><h3 id="\u8868-6-golang-\u5185\u5B58\u4E0E-tcmalloc-\u5BF9\u5185\u5B58\u7684\u5206\u7C7B\u5BF9\u6BD4" tabindex="-1"><a class="header-anchor" href="#\u8868-6-golang-\u5185\u5B58\u4E0E-tcmalloc-\u5BF9\u5185\u5B58\u7684\u5206\u7C7B\u5BF9\u6BD4" aria-hidden="true">#</a> \u8868 6 Golang \u5185\u5B58\u4E0E TCMalloc \u5BF9\u5185\u5B58\u7684\u5206\u7C7B\u5BF9\u6BD4<a href="#4caa71">#</a></h3><table><thead><tr><th><strong>TCMalloc</strong></th><th><strong>Golang</strong></th></tr></thead><tbody><tr><td>\u5C0F\u5BF9\u8C61</td><td>Tiny \u5BF9\u8C61</td></tr><tr><td>\u4E2D\u5BF9\u8C61</td><td>\u5C0F\u5BF9\u8C61</td></tr><tr><td>\u5927\u5BF9\u8C61</td><td>\u5927\u5BF9\u8C61</td></tr></tbody></table><p>\u9488\u5BF9 Tiny \u5FAE\u5C0F\u5BF9\u8C61\u7684\u5206\u914D\uFF0C\u5B9E\u9645\u4E0A Golang \u505A\u4E86\u6BD4\u8F83\u7279\u6B8A\u7684\u5904\u7406\uFF0C\u4E4B\u524D\u5728\u4ECB\u7ECD MCache \u7684\u65F6\u5019\u5E76\u6CA1\u6709\u63D0\u53CA\u6709\u5173 Tiny \u7684\u5B58\u50A8\u548C\u5206\u914D\u95EE\u9898\uFF0CMCache \u4E2D\u4E0D\u4EC5\u4FDD\u5B58\u7740\u5404\u4E2A Span Class \u7EA7\u522B\u7684\u5185\u5B58\u5757\u7A7A\u95F4\uFF0C\u8FD8\u6709\u4E00\u4E2A\u6BD4\u8F83\u7279\u6B8A\u7684 Tiny \u5B58\u50A8\u7A7A\u95F4\uFF0C\u5982\u56FE 41 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/uGkWn9hFmu.png!large" alt="awsef"></p><h3 id="\u56FE-41-mcache-\u4E2D\u7684-tiny-\u7A7A\u95F4" tabindex="-1"><a class="header-anchor" href="#\u56FE-41-mcache-\u4E2D\u7684-tiny-\u7A7A\u95F4" aria-hidden="true">#</a> \u56FE 41 MCache \u4E2D\u7684 Tiny \u7A7A\u95F4<a href="#0232e6">#</a></h3><p>Tiny \u7A7A\u95F4\u662F\u4ECE Size Class = 2\uFF08\u5BF9\u5E94 Span Class = 4 \u6216 5\uFF09\u4E2D\u83B7\u53D6\u4E00\u4E2A 16B \u7684 Object\uFF0C\u4F5C\u4E3A Tiny \u5BF9\u8C61\u7684\u5206\u914D\u7A7A\u95F4\u3002\u5BF9\u4E8E Golang \u5185\u5B58\u7BA1\u7406\u4E3A\u4EC0\u4E48\u9700\u8981\u4E00\u4E2A Tiny \u8FD9\u6837\u7684 16B \u7A7A\u95F4\uFF0C\u539F\u56E0\u662F\u56E0\u4E3A\u5982\u679C\u534F\u7A0B\u903B\u8F91\u5C42\u7533\u8BF7\u7684\u5185\u5B58\u7A7A\u95F4\u5C0F\u4E8E\u7B49\u4E8E 8B\uFF0C\u90A3\u4E48\u6839\u636E\u6B63\u5E38\u7684 Size Class \u5339\u914D\u4F1A\u5339\u914D\u5230 Size Class = 1\uFF08\u5BF9\u5E94 Span Class = 2 \u6216 3\uFF09\uFF0C\u6240\u4EE5\u50CF int32\u3001 byte\u3001 bool \u4EE5\u53CA\u5C0F\u5B57\u7B26\u4E32\u7B49\u7ECF\u5E38\u4F7F\u7528\u7684 Tiny \u5FAE\u5C0F\u5BF9\u8C61\uFF0C\u4E5F\u90FD\u4F1A\u4F7F\u7528\u4ECE Size Class = 1 \u7533\u8BF7\u7684\u8FD9 8B \u7684\u7A7A\u95F4\u3002\u4F46\u662F\u7C7B\u4F3C bool \u6216\u8005 1 \u4E2A\u5B57\u8282\u7684 byte\uFF0C\u4E5F\u90FD\u4F1A\u5404\u81EA\u72EC\u4EAB\u8FD9 8B \u7684\u7A7A\u95F4\uFF0C\u8FDB\u800C\u5BFC\u81F4\u6709\u4E00\u5B9A\u7684\u5185\u5B58\u7A7A\u95F4\u6D6A\u8D39\uFF0C\u5982\u56FE 42 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/MMIyWhR3Bi.png!large" alt="awsef"></p><h3 id="\u56FE-42-\u5982\u679C\u5FAE\u5C0F\u5BF9\u8C61\u4E0D\u5B58\u5728-tiny-\u7A7A\u95F4\u4E2D" tabindex="-1"><a class="header-anchor" href="#\u56FE-42-\u5982\u679C\u5FAE\u5C0F\u5BF9\u8C61\u4E0D\u5B58\u5728-tiny-\u7A7A\u95F4\u4E2D" aria-hidden="true">#</a> \u56FE 42 \u5982\u679C\u5FAE\u5C0F\u5BF9\u8C61\u4E0D\u5B58\u5728 Tiny \u7A7A\u95F4\u4E2D<a href="#fa8240">#</a></h3><p>\u53EF\u4EE5\u770B\u51FA\u6765\u8FD9\u6837\u5F53\u5927\u91CF\u7684\u4F7F\u7528\u5FAE\u5C0F\u5BF9\u8C61\u53EF\u80FD\u4F1A\u5BF9 Size Class = 1 \u7684 Span \u9020\u6210\u5927\u91CF\u7684\u6D6A\u8D39\u3002\u6240\u4EE5 Golang \u5185\u5B58\u7BA1\u7406\u51B3\u5B9A\u5C3D\u91CF\u4E0D\u4F7F\u7528 Size Class = 1 \u7684 Span\uFF0C\u800C\u662F\u5C06\u7533\u8BF7\u7684 Object \u5C0F\u4E8E 16B \u7684\u7533\u8BF7\u7EDF\u4E00\u5F52\u7C7B\u4E3A Tiny \u5BF9\u8C61\u7533\u8BF7\u3002\u5177\u4F53\u7684\u7533\u8BF7\u6D41\u7A0B\u5982\u56FE 43 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/tGQtrTmWNl.png!large" alt="awsef"></p><h3 id="\u56FE-43-mcache-\u4E2D-tiny-\u5FAE\u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u56FE-43-mcache-\u4E2D-tiny-\u5FAE\u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" aria-hidden="true">#</a> \u56FE 43 MCache \u4E2D Tiny \u5FAE\u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B<a href="#a29912">#</a></h3><p>MCache \u4E2D\u5BF9\u4E8E Tiny \u5FAE\u5C0F\u5BF9\u8C61\u7684\u7533\u8BF7\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><p>\uFF081\uFF09P \u5411 MCache \u7533\u8BF7\u5FAE\u5C0F\u5BF9\u8C61\u5982\u4E00\u4E2A Bool \u53D8\u91CF\u3002\u5982\u679C\u7533\u8BF7\u7684 Object \u5728 Tiny \u5BF9\u8C61\u7684\u5927\u5C0F\u8303\u56F4\u5219\u8FDB\u5165 Tiny \u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\uFF0C\u5426\u5219\u8FDB\u5165\u5C0F\u5BF9\u8C61\u6216\u5927\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\u3002</p><p>\uFF082\uFF09\u5224\u65AD\u7533\u8BF7\u7684 Tiny \u5BF9\u8C61\u662F\u5426\u5305\u542B\u6307\u9488\uFF0C\u5982\u679C\u5305\u542B\u5219\u8FDB\u5165\u5C0F\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\uFF08\u4E0D\u4F1A\u653E\u5728 Tiny \u7F13\u51B2\u533A\uFF0C\u56E0\u4E3A\u9700\u8981 GC \u8D70\u626B\u63CF\u7B49\u6D41\u7A0B\uFF09\u3002</p><p>\uFF083\uFF09\u5982\u679C Tiny \u7A7A\u95F4\u7684 16B \u6CA1\u6709\u591A\u4F59\u7684\u5B58\u50A8\u5BB9\u91CF\uFF0C\u5219\u4ECE Size Class = 2\uFF08\u5373 Span Class = 4 \u6216 5\uFF09\u7684 Span \u4E2D\u83B7\u53D6\u4E00\u4E2A 16B \u7684 Object \u653E\u7F6E Tiny \u7F13\u51B2\u533A\u3002</p><p>\uFF084\uFF09\u5C06 1B \u7684 Bool \u7C7B\u578B\u653E\u7F6E\u5728 16B \u7684 Tiny \u7A7A\u95F4\u4E2D\uFF0C\u4EE5\u5B57\u8282\u5BF9\u9F50\u7684\u65B9\u5F0F\u3002</p><p>Tiny \u5BF9\u8C61\u7684\u7533\u8BF7\u4E5F\u662F\u8FBE\u4E0D\u5230\u5185\u5B58\u5229\u7528\u7387 100% \u7684\uFF0C\u5C31\u4E0A\u8FF0\u56FE 43 \u4E3A\u4F8B\uFF0C\u5F53\u524D Tiny \u7F13\u51B2 16B \u7684\u5185\u5B58\u5229\u7528\u7387\u4E3A\uFF0C\u800C\u5982\u679C\u4E0D\u7528 Tiny \u5FAE\u5C0F\u5BF9\u8C61\u7684\u65B9\u5F0F\u6765\u5B58\u50A8\uFF0C\u90A3\u4E48\u5185\u5B58\u7684\u5E03\u5C40\u5C06\u5982\u56FE 44 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/Wul3ss2Vdd.png!large" alt="awsef"></p><h3 id="\u56FE-44-\u4E0D\u7528-tiny-\u7F13\u51B2\u5B58\u50A8\u60C5\u51B5" tabindex="-1"><a class="header-anchor" href="#\u56FE-44-\u4E0D\u7528-tiny-\u7F13\u51B2\u5B58\u50A8\u60C5\u51B5" aria-hidden="true">#</a> \u56FE 44 \u4E0D\u7528 Tiny \u7F13\u51B2\u5B58\u50A8\u60C5\u51B5<a href="#5b7e70">#</a></h3><p>\u53EF\u4EE5\u7B97\u51FA\u5229\u7528\u7387\u4E3A\u3002Golang \u5185\u5B58\u7BA1\u7406\u901A\u8FC7 Tiny \u5BF9\u8C61\u7684\u5904\u7406\uFF0C\u53EF\u4EE5\u5E73\u5747\u8282\u7701 20% \u5DE6\u53F3\u7684\u5185\u5B58\u3002</p><h3 id="_6-7-\u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_6-7-\u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" aria-hidden="true">#</a> 6.7 \u5C0F\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B<a href="#934f71">#</a></h3><p>\u4E0A\u8282\u5DF2\u7ECF\u4ECB\u7ECD\u4E86\u5206\u914D\u5728 1B \u81F3 16B \u7684 Tiny \u5BF9\u8C61\u7684\u5206\u914D\u6D41\u7A0B\uFF0C\u90A3\u4E48\u5BF9\u4E8E\u5BF9\u8C61\u5728 16B \u81F3 32B \u7684\u5185\u5B58\u5206\u914D\uFF0CGolang \u4F1A\u91C7\u7528\u5C0F\u5BF9\u8C61\u7684\u5206\u914D\u6D41\u7A0B\u3002</p><p>\u5206\u914D\u5C0F\u5BF9\u8C61\u7684\u6807\u51C6\u6D41\u7A0B\u662F\u6309\u7167 Span Class \u89C4\u683C\u5339\u914D\u7684\u3002\u5728\u4E4B\u524D\u4ECB\u7ECD MCache \u7684\u5185\u90E8\u6784\u9020\u5DF2\u7ECF\u4ECB\u7ECD\u4E86\uFF0CMCache \u4E00\u5171\u6709 67 \u4EFD Size Class \u5176\u4E2D Size Class \u4E3A 0 \u7684\u505A\u4E86\u7279\u6B8A\u7684\u5904\u7406\u76F4\u63A5\u8FD4\u56DE\u4E00\u4E2A\u56FA\u5B9A\u7684\u5730\u5740\u3002Span Class \u4E3A Size Class \u7684\u4E8C\u500D\uFF0C\u4E5F\u5C31\u662F\u4ECE 0 \u81F3 133 \u5171 134 \u4E2A Span Class\u3002</p><p>\u5F53\u534F\u7A0B\u903B\u8F91\u5C42 P \u4E3B\u52A8\u7533\u8BF7\u4E00\u4E2A\u5C0F\u5BF9\u8C61\u7684\u65F6\u5019\uFF0CGolang \u5185\u5B58\u7BA1\u7406\u7684\u5185\u5B58\u7533\u8BF7\u6D41\u7A0B\u5982\u56FE 45 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/v0iUFYrCxc.png!large" alt="awsef"></p><h3 id="\u56FE-45-golang-\u5C0F\u5BF9\u8C61\u5185\u5B58\u5206\u914D\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u56FE-45-golang-\u5C0F\u5BF9\u8C61\u5185\u5B58\u5206\u914D\u6D41\u7A0B" aria-hidden="true">#</a> \u56FE 45 Golang \u5C0F\u5BF9\u8C61\u5185\u5B58\u5206\u914D\u6D41\u7A0B<a href="#a7c16d">#</a></h3><p>\u4E0B\u9762\u6765\u5206\u6790\u4E00\u4E0B\u5177\u4F53\u7684\u6D41\u7A0B\u8FC7\u7A0B\uFF1A</p><p>\uFF081\uFF09\u9996\u5148\u534F\u7A0B\u903B\u8F91\u5C42 P \u5411 Golang \u5185\u5B58\u7BA1\u7406\u7533\u8BF7\u4E00\u4E2A\u5BF9\u8C61\u6240\u9700\u7684\u5185\u5B58\u7A7A\u95F4\u3002</p><p>\uFF082\uFF09MCache \u5728\u63A5\u6536\u5230\u8BF7\u6C42\u540E\uFF0C\u4F1A\u6839\u636E\u5BF9\u8C61\u6240\u9700\u7684\u5185\u5B58\u7A7A\u95F4\u8BA1\u7B97\u51FA\u5177\u4F53\u7684\u5927\u5C0F Size\u3002</p><p>\uFF083\uFF09\u5224\u65AD Size \u662F\u5426\u5C0F\u4E8E 16B\uFF0C\u5982\u679C\u5C0F\u4E8E 16B \u5219\u8FDB\u5165 Tiny \u5FAE\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\uFF0C\u5426\u5219\u8FDB\u5165\u5C0F\u5BF9\u8C61\u7533\u8BF7\u6D41\u7A0B\u3002</p><p>\uFF084\uFF09\u6839\u636E Size \u5339\u914D\u5BF9\u5E94\u7684 Size Class \u5185\u5B58\u89C4\u683C\uFF0C\u518D\u6839\u636E Size Class \u548C\u8BE5\u5BF9\u8C61\u662F\u5426\u5305\u542B\u6307\u9488\uFF0C\u6765\u5B9A\u4F4D\u662F\u4ECE noscan Span Class \u8FD8\u662F scan Span Class \u83B7\u53D6\u7A7A\u95F4\uFF0C\u6CA1\u6709\u6307\u9488\u5219\u9501\u5B9A noscan\u3002</p><p>\uFF085\uFF09\u5728\u5B9A\u4F4D\u7684 Span Class \u4E2D\u7684 Span \u53D6\u51FA\u4E00\u4E2A Object \u8FD4\u56DE\u7ED9\u534F\u7A0B\u903B\u8F91\u5C42 P\uFF0CP \u5F97\u5230\u5185\u5B58\u7A7A\u95F4\uFF0C\u6D41\u7A0B\u7ED3\u675F\u3002</p><p>\uFF086\uFF09\u5982\u679C\u5B9A\u4F4D\u7684 Span Class \u4E2D\u7684 Span \u6240\u6709\u7684\u5185\u5B58\u5757 Object \u90FD\u88AB\u5360\u7528\uFF0C\u5219 MCache \u4F1A\u5411 MCentral \u7533\u8BF7\u4E00\u4E2A Span\u3002</p><p>\uFF087\uFF09MCentral \u6536\u5230\u5185\u5B58\u7533\u8BF7\u540E\uFF0C\u4F18\u5148\u4ECE\u76F8\u5BF9\u5E94\u7684 Span Class \u4E2D\u7684 NonEmpty Span List\uFF08\u6216 Partial Set\uFF0CGolang V1.16+\uFF09\u91CC\u53D6\u51FA Span\uFF08\u591A\u4E2A Object \u7EC4\u6210\uFF09\uFF0CNonEmpty Span List \u6CA1\u6709\u5219\u4ECE Empty List\uFF08\u6216 Full Set Golang V1.16+\uFF09\u4E2D\u53D6\uFF0C\u8FD4\u56DE\u7ED9 MCache\u3002</p><p>\uFF088\uFF09MCache \u5F97\u5230 MCentral \u8FD4\u56DE\u7684 Span\uFF0C\u8865\u5145\u5230\u5BF9\u5E94\u7684 Span Class \u4E2D\uFF0C\u4E4B\u540E\u518D\u6B21\u6267\u884C\u7B2C\uFF085\uFF09\u6B65\u6D41\u7A0B\u3002</p><p>\uFF089\uFF09\u5982\u679C Empty Span List\uFF08\u6216 Full Set\uFF09\u4E2D\u6CA1\u6709\u7B26\u5408\u6761\u4EF6\u7684 Span\uFF0C\u5219 MCentral \u4F1A\u5411 MHeap \u7533\u8BF7\u5185\u5B58\u3002</p><p>\uFF0810\uFF09MHeap \u6536\u5230\u5185\u5B58\u8BF7\u6C42\u4ECE\u5176\u4E2D\u4E00\u4E2A HeapArena \u4ECE\u53D6\u51FA\u4E00\u90E8\u5206 Pages \u8FD4\u56DE\u7ED9 MCentral\uFF0C\u5F53 MHeap \u6CA1\u6709\u8DB3\u591F\u7684\u5185\u5B58\u65F6\uFF0CMHeap \u4F1A\u5411\u64CD\u4F5C\u7CFB\u7EDF\u7533\u8BF7\u5185\u5B58\uFF0C\u5C06\u7533\u8BF7\u7684\u5185\u5B58\u4E5F\u4FDD\u5B58\u5230 HeapArena \u4E2D\u7684 mspan \u4E2D\u3002MCentral \u5C06\u4ECE MHeap \u83B7\u53D6\u7684\u7531 Pages \u7EC4\u6210\u7684 Span \u6DFB\u52A0\u5230\u5BF9\u5E94\u7684 Span Class \u94FE\u8868\u6216\u96C6\u5408\u4E2D\uFF0C\u4F5C\u4E3A\u65B0\u7684\u8865\u5145\uFF0C\u4E4B\u540E\u518D\u6B21\u6267\u884C\u7B2C\uFF087\uFF09\u6B65\u3002</p><p>\uFF0811\uFF09\u6700\u540E\u534F\u7A0B\u4E1A\u52A1\u903B\u8F91\u5C42\u5F97\u5230\u8BE5\u5BF9\u8C61\u7533\u8BF7\u5230\u7684\u5185\u5B58\uFF0C\u6D41\u7A0B\u7ED3\u675F\u3002</p><h3 id="_6-8-\u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_6-8-\u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B" aria-hidden="true">#</a> 6.8 \u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B<a href="#9589ee">#</a></h3><p>\u5C0F\u5BF9\u8C61\u662F\u5728 MCache \u4E2D\u5206\u914D\u7684\uFF0C\u800C\u5927\u5BF9\u8C61\u662F\u76F4\u63A5\u4ECE MHeap \u4E2D\u5206\u914D\u3002\u5BF9\u4E8E\u4E0D\u6EE1\u8DB3 MCache \u5206\u914D\u8303\u56F4\u7684\u5BF9\u8C61\uFF0C\u5747\u662F\u6309\u7167\u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B\u5904\u7406\u3002</p><p>\u5927\u5BF9\u8C61\u5206\u914D\u6D41\u7A0B\u662F\u534F\u7A0B\u903B\u8F91\u5C42\u76F4\u63A5\u5411 MHeap \u7533\u8BF7\u5BF9\u8C61\u6240\u9700\u8981\u7684\u9002\u5F53 Pages\uFF0C\u4ECE\u800C\u7ED5\u8FC7\u4ECE MCaceh \u5230 MCentral \u7684\u7E41\u7410\u7533\u8BF7\u5185\u5B58\u6D41\u7A0B\uFF0C\u5927\u5BF9\u8C61\u7684\u5185\u5B58\u5206\u914D\u6D41\u7A0B\u76F8\u5BF9\u6BD4\u8F83\u7B80\u5355\uFF0C\u5177\u4F53\u7684\u6D41\u7A0B\u5982\u56FE 46 \u6240\u793A\u3002</p><p><img src="https://cdn.learnku.com/uploads/images/202205/23/58489/uW9ClvLmCi.png!large" alt="sad"></p><h3 id="\u56FE-46-golang-\u5927\u5BF9\u8C61\u5185\u5B58\u5206\u914D\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u56FE-46-golang-\u5927\u5BF9\u8C61\u5185\u5B58\u5206\u914D\u6D41\u7A0B" aria-hidden="true">#</a> \u56FE 46 Golang \u5927\u5BF9\u8C61\u5185\u5B58\u5206\u914D\u6D41\u7A0B<a href="#be8a6d">#</a></h3><p>\u4E0B\u9762\u6765\u5206\u6790\u4E00\u4E0B\u5177\u4F53\u7684\u5927\u5BF9\u8C61\u5185\u5B58\u5206\u914D\u6D41\u7A0B\uFF1A</p><p>\uFF081\uFF09\u534F\u7A0B\u903B\u8F91\u5C42\u7533\u8BF7\u5927\u5BF9\u8C61\u6240\u9700\u7684\u5185\u5B58\u7A7A\u95F4\uFF0C\u5982\u679C\u8D85\u8FC7 32KB\uFF0C\u5219\u76F4\u63A5\u7ED5\u8FC7 MCache \u548C MCentral \u76F4\u63A5\u5411 MHeap \u7533\u8BF7\u3002</p><p>\uFF082\uFF09MHeap \u6839\u636E\u5BF9\u8C61\u6240\u9700\u7684\u7A7A\u95F4\u8BA1\u7B97\u5F97\u5230\u9700\u8981\u591A\u5C11\u4E2A Page\u3002</p><p>\uFF083\uFF09MHeap \u5411 Arenas \u4E2D\u7684 HeapArena \u7533\u8BF7\u76F8\u5BF9\u5E94\u7684 Pages\u3002</p><p>\uFF084\uFF09\u5982\u679C Arenas \u4E2D\u6CA1\u6709 HeapA \u53EF\u63D0\u4F9B\u5408\u9002\u7684 Pages \u5185\u5B58\uFF0C\u5219\u5411\u64CD\u4F5C\u7CFB\u7EDF\u7684\u865A\u62DF\u5185\u5B58\u7533\u8BF7\uFF0C\u4E14\u586B\u5145\u81F3 Arenas \u4E2D\u3002</p><p>\uFF085\uFF09MHeap \u8FD4\u56DE\u5927\u5BF9\u8C61\u7684\u5185\u5B58\u7A7A\u95F4\u3002</p><p>\uFF086\uFF09\u534F\u7A0B\u903B\u8F91\u5C42 P \u5F97\u5230\u5185\u5B58\uFF0C\u6D41\u7A0B\u7ED3\u675F\u3002</p><h2 id="_7-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_7-\u5C0F\u7ED3" aria-hidden="true">#</a> 7 \u5C0F\u7ED3<a href="#c55eda">#</a></h2><p>\u672C\u7AE0\u4ECE\u64CD\u4F5C\u7CFB\u7EDF\u7684\u865A\u62DF\u5185\u5B58\u7533\u8BF7\u5230 Golang \u5185\u5B58\u6A21\u578B\u8FDB\u884C\u7684\u7406\u8BBA\u7684\u63A8\u8FDB\u548C\u9010\u5C42\u5256\u6790\u3002\u901A\u8FC7\u672C\u7AE0\u7684\u5185\u5B58\uFF0C\u53EF\u4EE5\u4E86\u89E3\u5230\u65E0\u8BBA\u662F\u64CD\u4F5C\u7CFB\u7EDF\u865A\u62DF\u5185\u5B58\u7BA1\u7406\uFF0C\u8FD8\u662F C++ \u7684 TCMalloc\u3001Golang \u5185\u5B58\u6A21\u578B\uFF0C\u5747\u6709\u4E00\u4E2A\u5171\u540C\u7279\u70B9\uFF0C\u5C31\u662F\u5206\u5C42\u7684\u7F13\u5B58\u673A\u5236\u3002\u9488\u5BF9\u4E0D\u540C\u7684\u5185\u5B58\u573A\u666F\u91C7\u7528\u4E0D\u540C\u7684\u72EC\u7279\u89E3\u51B3\u65B9\u5F0F\uFF0C\u63D0\u9AD8\u5C40\u90E8\u6027\u903B\u8F91\u548C\u7EC6\u5FAE\u7C92\u5EA6\u5185\u5B58\u7684\u590D\u7528\u7387\u3002\u8FD9\u4E5F\u662F\u7A0B\u5E8F\u8BBE\u8BA1\u7684\u81F3\u9AD8\u7406\u5FF5\u3002</p><p><a href="#_ftnref1">[1]</a> PTE \u662F Page Table Entry \u7684\u7F29\u5199\uFF0C\u8868\u793A\u9875\u8868\u6761\u76EE\u3002PTE \u662F\u7531\u4E00\u4E2A\u6709\u6548\u4F4D\u548C N \u4F4D\u5730\u5740\u5B57\u6BB5\u6784\u6210\uFF0C\u80FD\u591F\u6709\u6548\u6807\u8BC6\u8FD9\u4E2A\u865A\u62DF\u5185\u5B58\u5730\u5740\u662F\u5426\u5206\u914D\u4E86\u7269\u7406\u5185\u5B58\u3002</p>`,545),K=e("a",{href:"#_ftnref2"},"[2]",-1),O=n("CPU \u6BCF\u6B21\u8BBF\u95EE\u865A\u62DF\u5185\u5B58\uFF0C\u865A\u62DF\u5730\u5740\u90FD\u5FC5\u987B\u8F6C\u6362\u4E3A\u5BF9\u5E94\u7684\u7269\u7406\u5730\u5740\u3002\u4ECE\u6982\u5FF5\u4E0A\u8BF4\uFF0C\u8FD9\u4E2A\u8F6C\u6362\u9700\u8981\u904D\u5386\u9875\u8868\uFF0C\u9875\u8868\u662F\u4E09\u7EA7\u9875\u8868\uFF0C\u5C31\u9700\u8981 3 \u6B21\u5185\u5B58\u8BBF\u95EE\u3002\u5C31\u662F\u8BF4\uFF0C\u6BCF\u6B21\u865A\u62DF\u5185\u5B58\u8BBF\u95EE\u90FD\u4F1A\u5BFC\u81F4 4 \u6B21\u7269\u7406\u5185\u5B58\u8BBF\u95EE\u3002\u7B80\u5355\u70B9\u8BF4\uFF0C\u5982\u679C\u4E00\u6B21\u865A\u62DF\u5185\u5B58\u8BBF\u95EE\u5BF9\u5E94\u4E86 4 \u6B21\u7269\u7406\u5185\u5B58\u8BBF\u95EE\uFF0C\u80AF\u5B9A\u6BD4 1 \u6B21\u7269\u7406\u8BBF\u95EE\u6162\uFF0C\u8FD9\u6837\u865A\u62DF\u5185\u5B58\u80AF\u5B9A\u4E0D\u4F1A\u53D1\u5C55\u8D77\u6765\u3002\u5E78\u8FD0\u7684\u662F\uFF0C\u6709\u4E00\u4E2A\u806A\u660E\u7684\u505A\u6CD5\u89E3\u51B3\u4E86\u5927\u90E8\u5206\u95EE\u9898\uFF1A\u73B0\u4EE3 CPU \u4F7F\u7528\u4E00\u5C0F\u5757\u5173\u8054\u5185\u5B58\uFF0C\u7528\u6765\u7F13\u5B58\u6700\u8FD1\u8BBF\u95EE\u7684\u865A\u62DF\u9875\u7684 PTE\u3002\u8FD9\u5757\u5185\u5B58\u79F0\u4E3A "),E=e("em",null,"translation lookaside buffer",-1),F=n("(TLB)\uFF0C\u53C2\u8003\u300A"),U={href:"https://www.informit.com/store/ia-64-linux-kernel-design-and-implementation-9780130610140?w_ptgrevartcl=Virtual+Memory+in+the+IA-64+Linux+Kernel_29961",target:"_blank",rel:"noopener noreferrer"},R=n("IA-64 Linux Kernel: Design and Implementation"),Z=n("\u300B"),V=e("p",null,[e("a",{href:"#_ftnref3"},"[3]"),n(" \u4E00\u4E2A\u865A\u62DF\u5730\u5740 VA\uFF08Virtual Address\uFF09= \u865A\u62DF\u9875\u53F7 VPN + \u865A\u62DF\u9875\u504F\u79FB\u91CF VPO\u3002")],-1),I=e("p",null,[e("a",{href:"#_ftnref4"},"[4]"),n(" \u4E00\u4E2A\u7269\u7406\u5730\u5740 PA\uFF08Physical Address\uFF09= \u7269\u7406\u9875\u53F7 PPN * \u9875\u957F\u5EA6 PageSize+ \u7269\u7406\u9875\u53F7\u504F\u79FB PPO\uFF08Physical Page Offset\uFF09")],-1),D=e("p",null,[e("a",{href:"#_ftnref5"},"[5]"),n(" Man \u624B\u518C\u9875\uFF08Manua pages\uFF0C\u7F29\u5199 man page\uFF09\u662F\u5728 Linux \u64CD\u4F5C\u7CFB\u7EDF\u5728\u7EBF\u8F6F\u4EF6\u6587\u6863\u7684\u4E00\u79CD\u666E\u904D\u5F62\u5F0F\u3002\u5185\u5BB9\u5305\u62EC\u8BA1\u7B97\u673A\u7A0B\u5E8F\u5E93\u548C\u7CFB\u7EDF\u8C03\u7528\u7B49\u547D\u4EE4\u7684\u5E2E\u52A9\u624B\u518C\u3002")],-1),W=e("a",{href:"#_ftnref6"},"[6]",-1),J=n(" TCMalloc \u5B98\u65B9\u6587\u6863\u79F0\u4E00\u5171\u5212\u5206 88 \u4E2A size-classes\uFF0C\u201CEach small object size maps to one of approximately 88 allocatable size-classes\u201D\uFF0C\u53C2\u8003\u300ATCMalloc : Thread-Caching Malloc\u300B"),X={href:"https://gperftools.github.io/gperftools/tcmalloc.html",target:"_blank",rel:"noopener noreferrer"},Q=n("gperftools.github.io/gperftools/tc..."),Y=e("p",null,[e("a",{href:"#_ftnref7"},"[7]"),n(" \u53C2\u8003 Golang 1.14 \u7248\u672C\uFF0C\u5176\u4E2D\u8FD8\u6709\u6269\u5C55\u5230 128 \u4E2A size class \u7684\u5BF9\u5E94\u5173\u7CFB\uFF0C\u672C\u4E66\u4E0D\u8BE6\u7EC6\u4ECB\u7ECD\uFF0C\u5177\u4F53\u7EC6\u8282\u53C2\u8003 Golang \u6E90\u7801 /usr/local/go/src/runtime/sizeclasses.go \u6587\u4EF6\u3002")],-1),$=e("p",null,[e("a",{href:"#_ftnref8"},"[8]"),n(" \u5728 Linux64 \u4F4D\u64CD\u4F5C\u7CFB\u7EDF\u4E0A\u3002")],-1),ee=e("h2",{id:"end-\u94FE\u63A5",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#end-\u94FE\u63A5","aria-hidden":"true"},"#"),n(" END \u94FE\u63A5")],-1),ne=n("\u56DE\u5230\u76EE\u5F55"),ae=n("\u4E0A\u4E00\u8282"),ie=n("\u4E0B\u4E00\u8282"),se=e("hr",null,null,-1),le={href:"https://github.com/cubxxw/awesome-cs-cloudnative-blockchain/blob/master/Git/git-contributor.md",target:"_blank",rel:"noopener noreferrer"},de=n("\u53C2\u4E0E\u8D21\u732E\u2764\uFE0F\u{1F495}\u{1F495}");function re(ce,te){const i=d("ExternalLinkIcon"),s=d("RouterLink");return c(),t("div",null,[e("ul",null,[e("li",null,[e("a",m,[o,a(i)])])]),p,e("ul",null,[e("li",null,[a(s,{to:"/go-advancend/"},{default:l(()=>[b]),_:1})]),e("li",null,[a(s,{to:"/go-advancend/markdown/39.html"},{default:l(()=>[h]),_:1})])]),e("blockquote",null,[e("p",null,[f,e("a",g,[C,a(i)])])]),e("h3",B,[S,x,e("strong",null,[e("a",P,[M,a(i)])])]),e("h3",_,[y,T,e("strong",null,[e("a",z,[G,a(i)])])]),k,L,w,e("blockquote",null,[e("p",null,[q,e("a",H,[j,a(i)]),A])]),N,e("p",null,[K,O,E,F,e("a",U,[R,a(i)]),Z]),V,I,D,e("p",null,[W,J,e("a",X,[Q,a(i)])]),Y,$,ee,e("ul",null,[e("li",null,[a(s,{to:"/go-advancend/"},{default:l(()=>[ne]),_:1})]),e("li",null,[a(s,{to:"/go-advancend/markdown/39.html"},{default:l(()=>[ae]),_:1})]),e("li",null,[a(s,{to:"/go-advancend/markdown/41.html"},{default:l(()=>[ie]),_:1})])]),se,e("ul",null,[e("li",null,[e("a",le,[de,a(i)])])])])}const ve=r(v,[["render",re],["__file","40.html.vue"]]);export{ve as default};
