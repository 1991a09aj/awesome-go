<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/img/1.jpg"><title>第21节 控制流（下）：iam-apiserver服务核心功能实现讲解 | 你好</title><meta name="description" content="链学社致力于打造出区块链去中心化的学习平台">
    <link rel="modulepreload" href="/assets/app.7c0cd728.js"><link rel="modulepreload" href="/assets/21.html.61d251ce.js"><link rel="modulepreload" href="/assets/21.html.e0077841.js"><link rel="prefetch" href="/assets/index.html.7a7dfc60.js"><link rel="prefetch" href="/assets/go_route.html.c8fe622e.js"><link rel="prefetch" href="/assets/index.html.ebe30265.js"><link rel="prefetch" href="/assets/bitwise.html.0875bf7a.js"><link rel="prefetch" href="/assets/catalogue.html.d45d2ea3.js"><link rel="prefetch" href="/assets/go-air.html.50ef7c1a.js"><link rel="prefetch" href="/assets/go-version.html.f82697a0.js"><link rel="prefetch" href="/assets/go_file.html.e6caea41.js"><link rel="prefetch" href="/assets/go_mod.html.2b3ea260.js"><link rel="prefetch" href="/assets/mod.html.bac87341.js"><link rel="prefetch" href="/assets/name.html.bcc8fde0.js"><link rel="prefetch" href="/assets/index.html.37f33959.js"><link rel="prefetch" href="/assets/zhenze.html.28cf92c0.js"><link rel="prefetch" href="/assets/1.html.36144ee3.js"><link rel="prefetch" href="/assets/10.html.da722ebe.js"><link rel="prefetch" href="/assets/11.html.31e40108.js"><link rel="prefetch" href="/assets/12.html.0898ecc7.js"><link rel="prefetch" href="/assets/13.html.0a65d5eb.js"><link rel="prefetch" href="/assets/14.html.be4956cc.js"><link rel="prefetch" href="/assets/15.html.a8adeffa.js"><link rel="prefetch" href="/assets/16.html.f18704c3.js"><link rel="prefetch" href="/assets/17.html.783339a3.js"><link rel="prefetch" href="/assets/18.html.923df3cc.js"><link rel="prefetch" href="/assets/19.html.9a6796eb.js"><link rel="prefetch" href="/assets/2.html.ace4d0cd.js"><link rel="prefetch" href="/assets/20.html.f7001dd2.js"><link rel="prefetch" href="/assets/21.html.8748d4cc.js"><link rel="prefetch" href="/assets/22.html.bf197532.js"><link rel="prefetch" href="/assets/23.html.e46aa786.js"><link rel="prefetch" href="/assets/24.html.1bc12ccb.js"><link rel="prefetch" href="/assets/25.html.9da66186.js"><link rel="prefetch" href="/assets/26.html.536b3d1b.js"><link rel="prefetch" href="/assets/27.html.4c596bfd.js"><link rel="prefetch" href="/assets/28.html.5c0110cc.js"><link rel="prefetch" href="/assets/29.html.25de6c78.js"><link rel="prefetch" href="/assets/3.html.d9dde611.js"><link rel="prefetch" href="/assets/30.html.a61a9f96.js"><link rel="prefetch" href="/assets/4.html.e2a114cd.js"><link rel="prefetch" href="/assets/5.html.8de69897.js"><link rel="prefetch" href="/assets/6.html.075b7fd1.js"><link rel="prefetch" href="/assets/7.html.259b8049.js"><link rel="prefetch" href="/assets/8.html.5038041b.js"><link rel="prefetch" href="/assets/9.html.ab5a6ab3.js"><link rel="prefetch" href="/assets/chan底层分析.html.aa95a27f.js"><link rel="prefetch" href="/assets/eth.html.752bbd67.js"><link rel="prefetch" href="/assets/file.html.5fbdaf59.js"><link rel="prefetch" href="/assets/gofloat.html.b2f73e3e.js"><link rel="prefetch" href="/assets/Go汇编.html.2eee7fc6.js"><link rel="prefetch" href="/assets/九型人格.html.81266ddb.js"><link rel="prefetch" href="/assets/反射.html.1fd002bd.js"><link rel="prefetch" href="/assets/并发.html.7135a824.js"><link rel="prefetch" href="/assets/index.html.b2a5a271.js"><link rel="prefetch" href="/assets/index.html.0f5169d3.js"><link rel="prefetch" href="/assets/字节青训营进阶面试准备.html.54660659.js"><link rel="prefetch" href="/assets/接口设计稿.html.145ed7d2.js"><link rel="prefetch" href="/assets/码上掘金主题创作活动.html.59816292.js"><link rel="prefetch" href="/assets/青训营题库.html.2024f8c3.js"><link rel="prefetch" href="/assets/1.html.235cc506.js"><link rel="prefetch" href="/assets/10.html.5c312915.js"><link rel="prefetch" href="/assets/11.html.55699fcd.js"><link rel="prefetch" href="/assets/12.html.a382bc79.js"><link rel="prefetch" href="/assets/13.html.aa855ae8.js"><link rel="prefetch" href="/assets/14.html.08ef65bd.js"><link rel="prefetch" href="/assets/15.html.01d21e16.js"><link rel="prefetch" href="/assets/16.html.70b426a8.js"><link rel="prefetch" href="/assets/17.html.f1499142.js"><link rel="prefetch" href="/assets/18.html.d8d3da03.js"><link rel="prefetch" href="/assets/19.html.015fd28a.js"><link rel="prefetch" href="/assets/2.html.769b639f.js"><link rel="prefetch" href="/assets/20.html.f9c50793.js"><link rel="prefetch" href="/assets/21.html.e90aecab.js"><link rel="prefetch" href="/assets/22.html.b8dd466e.js"><link rel="prefetch" href="/assets/23.html.adc860f9.js"><link rel="prefetch" href="/assets/24.html.d252c2b7.js"><link rel="prefetch" href="/assets/25.html.bee06ed0.js"><link rel="prefetch" href="/assets/26.html.b9dec8d9.js"><link rel="prefetch" href="/assets/27.html.4db64b27.js"><link rel="prefetch" href="/assets/28.html.22e1efc5.js"><link rel="prefetch" href="/assets/29.html.48a9f807.js"><link rel="prefetch" href="/assets/3.html.6776d83a.js"><link rel="prefetch" href="/assets/30.html.b6adc27b.js"><link rel="prefetch" href="/assets/31.html.58cd209d.js"><link rel="prefetch" href="/assets/32.html.dd04e440.js"><link rel="prefetch" href="/assets/33.html.10090b2d.js"><link rel="prefetch" href="/assets/34.html.3636fe56.js"><link rel="prefetch" href="/assets/35.html.d4c55782.js"><link rel="prefetch" href="/assets/36.html.2866b6e8.js"><link rel="prefetch" href="/assets/37.html.a165ac3b.js"><link rel="prefetch" href="/assets/38.html.7970a5ca.js"><link rel="prefetch" href="/assets/39.html.25a2a187.js"><link rel="prefetch" href="/assets/4.html.3296e70a.js"><link rel="prefetch" href="/assets/40.html.9c879ac6.js"><link rel="prefetch" href="/assets/41.html.bf6a470e.js"><link rel="prefetch" href="/assets/42.html.7dd22ad5.js"><link rel="prefetch" href="/assets/43.html.68ab423b.js"><link rel="prefetch" href="/assets/44.html.78d0b9cb.js"><link rel="prefetch" href="/assets/45.html.6c351189.js"><link rel="prefetch" href="/assets/46.html.ede9ae29.js"><link rel="prefetch" href="/assets/47.html.0af69310.js"><link rel="prefetch" href="/assets/48.html.0a007480.js"><link rel="prefetch" href="/assets/49.html.ff9fd03c.js"><link rel="prefetch" href="/assets/5.html.58f5b1b7.js"><link rel="prefetch" href="/assets/50.html.c9b82bd5.js"><link rel="prefetch" href="/assets/51.html.26521767.js"><link rel="prefetch" href="/assets/52.html.c7e1e0b4.js"><link rel="prefetch" href="/assets/53.html.b26e3e4d.js"><link rel="prefetch" href="/assets/54.html.0f43b492.js"><link rel="prefetch" href="/assets/55.html.4e499377.js"><link rel="prefetch" href="/assets/56.html.6717ae50.js"><link rel="prefetch" href="/assets/57.html.e0493603.js"><link rel="prefetch" href="/assets/58.html.7b43713c.js"><link rel="prefetch" href="/assets/59.html.2240bf2a.js"><link rel="prefetch" href="/assets/6.html.c77757ad.js"><link rel="prefetch" href="/assets/60.html.04a1b1a2.js"><link rel="prefetch" href="/assets/61.html.0180164d.js"><link rel="prefetch" href="/assets/62.html.5aa383df.js"><link rel="prefetch" href="/assets/63.html.4eafb66f.js"><link rel="prefetch" href="/assets/64.html.7d2e947e.js"><link rel="prefetch" href="/assets/65.html.f91d4ee9.js"><link rel="prefetch" href="/assets/66.html.4b576058.js"><link rel="prefetch" href="/assets/67.html.2dd3fcab.js"><link rel="prefetch" href="/assets/68.html.aa224bc8.js"><link rel="prefetch" href="/assets/69.html.dcdfe4e4.js"><link rel="prefetch" href="/assets/7.html.d22b99dc.js"><link rel="prefetch" href="/assets/70.html.88ad98ba.js"><link rel="prefetch" href="/assets/71.html.35cc51da.js"><link rel="prefetch" href="/assets/72.html.e0c43705.js"><link rel="prefetch" href="/assets/73.html.f359483a.js"><link rel="prefetch" href="/assets/74.html.bec94dd1.js"><link rel="prefetch" href="/assets/75.html.9fff4689.js"><link rel="prefetch" href="/assets/76.html.6c07ed9d.js"><link rel="prefetch" href="/assets/77.html.0912a5b9.js"><link rel="prefetch" href="/assets/78.html.7a3c2e6a.js"><link rel="prefetch" href="/assets/79.html.8abf884d.js"><link rel="prefetch" href="/assets/8.html.12a6b159.js"><link rel="prefetch" href="/assets/80.html.6030053a.js"><link rel="prefetch" href="/assets/81.html.17419a40.js"><link rel="prefetch" href="/assets/82.html.9b77dbf0.js"><link rel="prefetch" href="/assets/83.html.73c332e8.js"><link rel="prefetch" href="/assets/84.html.ce5609ce.js"><link rel="prefetch" href="/assets/85.html.beb25b29.js"><link rel="prefetch" href="/assets/86.html.817c788b.js"><link rel="prefetch" href="/assets/87.html.9380d03b.js"><link rel="prefetch" href="/assets/88.html.3eb0a65b.js"><link rel="prefetch" href="/assets/89.html.cc3a0d82.js"><link rel="prefetch" href="/assets/9.html.c6efbd9d.js"><link rel="prefetch" href="/assets/90.html.3535f0b3.js"><link rel="prefetch" href="/assets/91.html.7c473580.js"><link rel="prefetch" href="/assets/92.html.a4919e55.js"><link rel="prefetch" href="/assets/93.html.c4746f39.js"><link rel="prefetch" href="/assets/94.html.eead2a63.js"><link rel="prefetch" href="/assets/95.html.d4e5fabd.js"><link rel="prefetch" href="/assets/96.html.97af7ef2.js"><link rel="prefetch" href="/assets/97.html.0ace7f77.js"><link rel="prefetch" href="/assets/98.html.3045492d.js"><link rel="prefetch" href="/assets/99.html.e1b6ca02.js"><link rel="prefetch" href="/assets/1.html.0e306242.js"><link rel="prefetch" href="/assets/10.html.16e21422.js"><link rel="prefetch" href="/assets/11.html.8f7df031.js"><link rel="prefetch" href="/assets/12.html.2047a9a4.js"><link rel="prefetch" href="/assets/13.html.0feabf60.js"><link rel="prefetch" href="/assets/14.html.5d2145ca.js"><link rel="prefetch" href="/assets/15.html.2a6d842a.js"><link rel="prefetch" href="/assets/16.html.15f61a51.js"><link rel="prefetch" href="/assets/17.html.99c0af78.js"><link rel="prefetch" href="/assets/18.html.c116a903.js"><link rel="prefetch" href="/assets/19.html.64c34358.js"><link rel="prefetch" href="/assets/2.html.404c4df8.js"><link rel="prefetch" href="/assets/20.html.e51c49a9.js"><link rel="prefetch" href="/assets/21.html.72850f1c.js"><link rel="prefetch" href="/assets/22.html.8a2421e1.js"><link rel="prefetch" href="/assets/23.html.a8068a1d.js"><link rel="prefetch" href="/assets/24.html.ed4ef892.js"><link rel="prefetch" href="/assets/25.html.85244a6e.js"><link rel="prefetch" href="/assets/26.html.a530ece1.js"><link rel="prefetch" href="/assets/27.html.2b58dc38.js"><link rel="prefetch" href="/assets/28.html.b85561da.js"><link rel="prefetch" href="/assets/29.html.baf58f32.js"><link rel="prefetch" href="/assets/3.html.58b79ab7.js"><link rel="prefetch" href="/assets/30.html.29d3065d.js"><link rel="prefetch" href="/assets/31.html.5a5774a9.js"><link rel="prefetch" href="/assets/32.html.3e68319a.js"><link rel="prefetch" href="/assets/33.html.1d697f01.js"><link rel="prefetch" href="/assets/34.html.1374c8a4.js"><link rel="prefetch" href="/assets/35.html.b7a4ef4f.js"><link rel="prefetch" href="/assets/36.html.d3e59054.js"><link rel="prefetch" href="/assets/37.html.126d176f.js"><link rel="prefetch" href="/assets/38.html.c354b41f.js"><link rel="prefetch" href="/assets/39.html.6f90be52.js"><link rel="prefetch" href="/assets/4.html.4c070bae.js"><link rel="prefetch" href="/assets/40.html.d7912b7a.js"><link rel="prefetch" href="/assets/41.html.25767891.js"><link rel="prefetch" href="/assets/42.html.87a96b3c.js"><link rel="prefetch" href="/assets/43.html.6e1125b1.js"><link rel="prefetch" href="/assets/44.html.baffa155.js"><link rel="prefetch" href="/assets/45.html.1cd195b7.js"><link rel="prefetch" href="/assets/46.html.19985086.js"><link rel="prefetch" href="/assets/47.html.4780b7a6.js"><link rel="prefetch" href="/assets/48.html.fe514bf3.js"><link rel="prefetch" href="/assets/49.html.cdf9db74.js"><link rel="prefetch" href="/assets/5.html.2ac6f4f2.js"><link rel="prefetch" href="/assets/50.html.6eef00b3.js"><link rel="prefetch" href="/assets/6.html.67971fc9.js"><link rel="prefetch" href="/assets/7.html.f49614f2.js"><link rel="prefetch" href="/assets/8.html.3535abc2.js"><link rel="prefetch" href="/assets/9.html.68ac8e3b.js"><link rel="prefetch" href="/assets/1.html.a3dc020c.js"><link rel="prefetch" href="/assets/10.html.bd14a3fb.js"><link rel="prefetch" href="/assets/100.html.f3db826f.js"><link rel="prefetch" href="/assets/11.html.66433e47.js"><link rel="prefetch" href="/assets/12.html.002d260c.js"><link rel="prefetch" href="/assets/13.html.59e20d79.js"><link rel="prefetch" href="/assets/14.html.73cfcd2c.js"><link rel="prefetch" href="/assets/15.html.99d15b40.js"><link rel="prefetch" href="/assets/16.html.c62c1434.js"><link rel="prefetch" href="/assets/17.html.0075c852.js"><link rel="prefetch" href="/assets/18.html.9538db0b.js"><link rel="prefetch" href="/assets/19.html.96e7efa0.js"><link rel="prefetch" href="/assets/2.html.a4c595c8.js"><link rel="prefetch" href="/assets/20.html.626333f9.js"><link rel="prefetch" href="/assets/21.html.6c94316b.js"><link rel="prefetch" href="/assets/22.html.9d4a851c.js"><link rel="prefetch" href="/assets/23.html.d8b33e76.js"><link rel="prefetch" href="/assets/24.html.7c1a964f.js"><link rel="prefetch" href="/assets/25.html.36d57c56.js"><link rel="prefetch" href="/assets/26.html.a4ccf683.js"><link rel="prefetch" href="/assets/27.html.1fc8c78b.js"><link rel="prefetch" href="/assets/28.html.230f24f9.js"><link rel="prefetch" href="/assets/29.html.cfb655b4.js"><link rel="prefetch" href="/assets/3.html.90f216e6.js"><link rel="prefetch" href="/assets/30.html.e8eb780c.js"><link rel="prefetch" href="/assets/31.html.f16d7bdd.js"><link rel="prefetch" href="/assets/32.html.969db2c6.js"><link rel="prefetch" href="/assets/33.html.2fd1e893.js"><link rel="prefetch" href="/assets/34.html.80f95318.js"><link rel="prefetch" href="/assets/35.html.93bd1a64.js"><link rel="prefetch" href="/assets/36.html.b0d70eb7.js"><link rel="prefetch" href="/assets/37.html.a8634caf.js"><link rel="prefetch" href="/assets/38.html.6d7ee270.js"><link rel="prefetch" href="/assets/39.html.4efa7896.js"><link rel="prefetch" href="/assets/4.html.d361cc4b.js"><link rel="prefetch" href="/assets/40.html.4ee391b3.js"><link rel="prefetch" href="/assets/41.html.2053a7e0.js"><link rel="prefetch" href="/assets/42.html.cc4b36a7.js"><link rel="prefetch" href="/assets/43.html.0f7beb77.js"><link rel="prefetch" href="/assets/44.html.113f35e8.js"><link rel="prefetch" href="/assets/45.html.2fcc7089.js"><link rel="prefetch" href="/assets/46.html.9a29d782.js"><link rel="prefetch" href="/assets/47.html.7fb14238.js"><link rel="prefetch" href="/assets/48.html.62bc0e52.js"><link rel="prefetch" href="/assets/49.html.3975bb80.js"><link rel="prefetch" href="/assets/5.html.6604ccf7.js"><link rel="prefetch" href="/assets/50.html.4077aa53.js"><link rel="prefetch" href="/assets/51.html.f7a84853.js"><link rel="prefetch" href="/assets/52.html.b86a43ba.js"><link rel="prefetch" href="/assets/53.html.769b0acd.js"><link rel="prefetch" href="/assets/54.html.efb643ec.js"><link rel="prefetch" href="/assets/55.html.be95d2bb.js"><link rel="prefetch" href="/assets/56.html.ca415217.js"><link rel="prefetch" href="/assets/57.html.6348bd02.js"><link rel="prefetch" href="/assets/58.html.93afeaf2.js"><link rel="prefetch" href="/assets/59.html.b52e6cc8.js"><link rel="prefetch" href="/assets/6.html.26081d20.js"><link rel="prefetch" href="/assets/60.html.246214a5.js"><link rel="prefetch" href="/assets/61.html.25657f9a.js"><link rel="prefetch" href="/assets/62.html.5b1f07f4.js"><link rel="prefetch" href="/assets/63.html.2dbbd4ac.js"><link rel="prefetch" href="/assets/64.html.0f7da8a1.js"><link rel="prefetch" href="/assets/65.html.1b86b0ed.js"><link rel="prefetch" href="/assets/66.html.d6a1a532.js"><link rel="prefetch" href="/assets/67.html.f777f920.js"><link rel="prefetch" href="/assets/68.html.2f2b75c8.js"><link rel="prefetch" href="/assets/69.html.618650ce.js"><link rel="prefetch" href="/assets/7.html.213eaadf.js"><link rel="prefetch" href="/assets/70.html.9d717256.js"><link rel="prefetch" href="/assets/71.html.7e7f16b0.js"><link rel="prefetch" href="/assets/72.html.ac9918d0.js"><link rel="prefetch" href="/assets/73.html.c5ca0eb4.js"><link rel="prefetch" href="/assets/74.html.3d949922.js"><link rel="prefetch" href="/assets/75.html.c3f02bd5.js"><link rel="prefetch" href="/assets/76.html.6091d630.js"><link rel="prefetch" href="/assets/77.html.718dbec3.js"><link rel="prefetch" href="/assets/78.html.e8ce2655.js"><link rel="prefetch" href="/assets/79.html.0461e3a6.js"><link rel="prefetch" href="/assets/8.html.abe9fed5.js"><link rel="prefetch" href="/assets/80.html.ca5a646d.js"><link rel="prefetch" href="/assets/81.html.2e23060c.js"><link rel="prefetch" href="/assets/82.html.8983ed47.js"><link rel="prefetch" href="/assets/83.html.9e9ba7dc.js"><link rel="prefetch" href="/assets/84.html.0503fff0.js"><link rel="prefetch" href="/assets/85.html.1e2fbf66.js"><link rel="prefetch" href="/assets/86.html.953395ac.js"><link rel="prefetch" href="/assets/87.html.aef2bb24.js"><link rel="prefetch" href="/assets/88.html.0ec29698.js"><link rel="prefetch" href="/assets/89.html.40a390be.js"><link rel="prefetch" href="/assets/9.html.9ae22ce4.js"><link rel="prefetch" href="/assets/90.html.4af85622.js"><link rel="prefetch" href="/assets/91.html.6d4cf67e.js"><link rel="prefetch" href="/assets/92.html.3bfa6320.js"><link rel="prefetch" href="/assets/93.html.67f8b61d.js"><link rel="prefetch" href="/assets/94.html.675e5734.js"><link rel="prefetch" href="/assets/95.html.55b1dd85.js"><link rel="prefetch" href="/assets/96.html.88289f6a.js"><link rel="prefetch" href="/assets/97.html.013ae5df.js"><link rel="prefetch" href="/assets/98.html.82596b4a.js"><link rel="prefetch" href="/assets/99.html.d6666293.js"><link rel="prefetch" href="/assets/1.html.8a4563a7.js"><link rel="prefetch" href="/assets/10.html.ad3ee00b.js"><link rel="prefetch" href="/assets/11.html.2755b813.js"><link rel="prefetch" href="/assets/12.html.623368f6.js"><link rel="prefetch" href="/assets/13.html.3f3fe897.js"><link rel="prefetch" href="/assets/14.html.872ad030.js"><link rel="prefetch" href="/assets/15.html.3bb3e15f.js"><link rel="prefetch" href="/assets/16.html.238bd494.js"><link rel="prefetch" href="/assets/17.html.2f689b1b.js"><link rel="prefetch" href="/assets/18.html.defd96a2.js"><link rel="prefetch" href="/assets/19.html.cb27157b.js"><link rel="prefetch" href="/assets/2.html.e705d67a.js"><link rel="prefetch" href="/assets/20.html.d6b702a1.js"><link rel="prefetch" href="/assets/21.html.81ebf320.js"><link rel="prefetch" href="/assets/22.html.3d560814.js"><link rel="prefetch" href="/assets/23.html.1755c245.js"><link rel="prefetch" href="/assets/24.html.ea315686.js"><link rel="prefetch" href="/assets/25.html.39a12d99.js"><link rel="prefetch" href="/assets/26.html.305a68bc.js"><link rel="prefetch" href="/assets/27.html.f08b7220.js"><link rel="prefetch" href="/assets/28.html.58c64f29.js"><link rel="prefetch" href="/assets/29.html.f342fa6a.js"><link rel="prefetch" href="/assets/3.html.6b94edd9.js"><link rel="prefetch" href="/assets/30.html.e119308b.js"><link rel="prefetch" href="/assets/31.html.26612d8c.js"><link rel="prefetch" href="/assets/32.html.096bcc84.js"><link rel="prefetch" href="/assets/33.html.bf171d3b.js"><link rel="prefetch" href="/assets/34.html.36168f64.js"><link rel="prefetch" href="/assets/35.html.1422c1b6.js"><link rel="prefetch" href="/assets/36.html.0aa7f0a2.js"><link rel="prefetch" href="/assets/37.html.f6a229f8.js"><link rel="prefetch" href="/assets/38.html.617c2a41.js"><link rel="prefetch" href="/assets/39.html.ceff315d.js"><link rel="prefetch" href="/assets/4.html.d28e66e5.js"><link rel="prefetch" href="/assets/40.html.f65d98c3.js"><link rel="prefetch" href="/assets/41.html.60450e0e.js"><link rel="prefetch" href="/assets/42.html.2d9280ae.js"><link rel="prefetch" href="/assets/43.html.f696f4d5.js"><link rel="prefetch" href="/assets/44.html.23b37290.js"><link rel="prefetch" href="/assets/45.html.066b87c8.js"><link rel="prefetch" href="/assets/46.html.dd5a20a1.js"><link rel="prefetch" href="/assets/47.html.3740a19b.js"><link rel="prefetch" href="/assets/48.html.a48ac8f8.js"><link rel="prefetch" href="/assets/49.html.3f1adbed.js"><link rel="prefetch" href="/assets/5.html.f163e78b.js"><link rel="prefetch" href="/assets/6.html.7e27aacf.js"><link rel="prefetch" href="/assets/7.html.5ef812a8.js"><link rel="prefetch" href="/assets/8.html.3a4a891b.js"><link rel="prefetch" href="/assets/9.html.ca89a28d.js"><link rel="prefetch" href="/assets/1.html.fb190c3b.js"><link rel="prefetch" href="/assets/10.html.37d1f8bd.js"><link rel="prefetch" href="/assets/11.html.2fa808b6.js"><link rel="prefetch" href="/assets/12.html.783cccc3.js"><link rel="prefetch" href="/assets/13.html.cecfd060.js"><link rel="prefetch" href="/assets/14.html.624e1a7f.js"><link rel="prefetch" href="/assets/15.html.c5c9b66b.js"><link rel="prefetch" href="/assets/16.html.64f9fd80.js"><link rel="prefetch" href="/assets/17.html.e6f6ad52.js"><link rel="prefetch" href="/assets/18.html.413f9e53.js"><link rel="prefetch" href="/assets/19.html.f63b08f0.js"><link rel="prefetch" href="/assets/2.html.b6e07cbc.js"><link rel="prefetch" href="/assets/20.html.ffc23ff4.js"><link rel="prefetch" href="/assets/22.html.87940274.js"><link rel="prefetch" href="/assets/23.html.a910f76c.js"><link rel="prefetch" href="/assets/24.html.86c09f3c.js"><link rel="prefetch" href="/assets/25.html.245f45cb.js"><link rel="prefetch" href="/assets/26.html.3738b18f.js"><link rel="prefetch" href="/assets/27.html.c6a15cc6.js"><link rel="prefetch" href="/assets/28.html.30b7014e.js"><link rel="prefetch" href="/assets/29.html.07648fd0.js"><link rel="prefetch" href="/assets/3.html.f1182881.js"><link rel="prefetch" href="/assets/30.html.44fe9c72.js"><link rel="prefetch" href="/assets/31.html.3a33d570.js"><link rel="prefetch" href="/assets/32.html.67b19357.js"><link rel="prefetch" href="/assets/33.html.645535dc.js"><link rel="prefetch" href="/assets/34.html.76cb04ab.js"><link rel="prefetch" href="/assets/35.html.2809ea05.js"><link rel="prefetch" href="/assets/36.html.622073b7.js"><link rel="prefetch" href="/assets/37.html.89cb279f.js"><link rel="prefetch" href="/assets/38.html.41763e8a.js"><link rel="prefetch" href="/assets/39.html.f86d6fee.js"><link rel="prefetch" href="/assets/4.html.02ffb4a1.js"><link rel="prefetch" href="/assets/40.html.b70affdb.js"><link rel="prefetch" href="/assets/41.html.9d80c47f.js"><link rel="prefetch" href="/assets/42.html.1ebee671.js"><link rel="prefetch" href="/assets/43.html.56eaa8c0.js"><link rel="prefetch" href="/assets/44.html.d3b898bc.js"><link rel="prefetch" href="/assets/45.html.712878f7.js"><link rel="prefetch" href="/assets/46.html.3fd772d2.js"><link rel="prefetch" href="/assets/47.html.36796bbf.js"><link rel="prefetch" href="/assets/48.html.6ebdc580.js"><link rel="prefetch" href="/assets/49.html.39f53e13.js"><link rel="prefetch" href="/assets/5.html.7c2b8fe0.js"><link rel="prefetch" href="/assets/50.html.99e4d0bf.js"><link rel="prefetch" href="/assets/51.html.1c3158fd.js"><link rel="prefetch" href="/assets/52.html.ae92bae9.js"><link rel="prefetch" href="/assets/53.html.ff8624c1.js"><link rel="prefetch" href="/assets/54.html.7266cd22.js"><link rel="prefetch" href="/assets/55.html.f5ef6e19.js"><link rel="prefetch" href="/assets/56.html.234fcfea.js"><link rel="prefetch" href="/assets/57.html.8157c6d4.js"><link rel="prefetch" href="/assets/58.html.d932b01b.js"><link rel="prefetch" href="/assets/59.html.37ef38d6.js"><link rel="prefetch" href="/assets/6.html.dd1f39d7.js"><link rel="prefetch" href="/assets/60.html.3a12f8fc.js"><link rel="prefetch" href="/assets/61.html.58e03455.js"><link rel="prefetch" href="/assets/62.html.d90f7c4b.js"><link rel="prefetch" href="/assets/63.html.d5fa0bc3.js"><link rel="prefetch" href="/assets/64.html.9350f6de.js"><link rel="prefetch" href="/assets/65.html.5e29014b.js"><link rel="prefetch" href="/assets/66.html.b3a6cc86.js"><link rel="prefetch" href="/assets/67.html.14de0fd5.js"><link rel="prefetch" href="/assets/68.html.983fc2e8.js"><link rel="prefetch" href="/assets/69.html.6e0f2252.js"><link rel="prefetch" href="/assets/7.html.18cd2242.js"><link rel="prefetch" href="/assets/70.html.d6f46382.js"><link rel="prefetch" href="/assets/71.html.8ce3e0c9.js"><link rel="prefetch" href="/assets/72.html.8ad4fa1d.js"><link rel="prefetch" href="/assets/73.html.9f3f36c6.js"><link rel="prefetch" href="/assets/74.html.9c74950c.js"><link rel="prefetch" href="/assets/75.html.b16f6304.js"><link rel="prefetch" href="/assets/76.html.0abe795c.js"><link rel="prefetch" href="/assets/77.html.f3880998.js"><link rel="prefetch" href="/assets/78.html.b203ab61.js"><link rel="prefetch" href="/assets/79.html.3dfeacc8.js"><link rel="prefetch" href="/assets/8.html.f35196e1.js"><link rel="prefetch" href="/assets/80.html.419994bc.js"><link rel="prefetch" href="/assets/81.html.d819cedb.js"><link rel="prefetch" href="/assets/82.html.02c1ffd7.js"><link rel="prefetch" href="/assets/83.html.58effd31.js"><link rel="prefetch" href="/assets/84.html.a55178d9.js"><link rel="prefetch" href="/assets/85.html.e83fb3cb.js"><link rel="prefetch" href="/assets/86.html.673deeae.js"><link rel="prefetch" href="/assets/87.html.feaaeca4.js"><link rel="prefetch" href="/assets/88.html.3f9bbaf5.js"><link rel="prefetch" href="/assets/89.html.02f317dc.js"><link rel="prefetch" href="/assets/9.html.d56adf76.js"><link rel="prefetch" href="/assets/90.html.094dae18.js"><link rel="prefetch" href="/assets/91.html.efb356fe.js"><link rel="prefetch" href="/assets/92.html.35281ad8.js"><link rel="prefetch" href="/assets/93.html.72e22018.js"><link rel="prefetch" href="/assets/94.html.42010db1.js"><link rel="prefetch" href="/assets/95.html.5f1d3253.js"><link rel="prefetch" href="/assets/96.html.a42caadf.js"><link rel="prefetch" href="/assets/97.html.8cb4f9b9.js"><link rel="prefetch" href="/assets/98.html.da67854e.js"><link rel="prefetch" href="/assets/99.html.8aa227bf.js"><link rel="prefetch" href="/assets/404.html.c3e557d0.js"><link rel="prefetch" href="/assets/index.html.4fc4f83e.js"><link rel="prefetch" href="/assets/go_route.html.cc5e9678.js"><link rel="prefetch" href="/assets/index.html.15021ca6.js"><link rel="prefetch" href="/assets/bitwise.html.22bba635.js"><link rel="prefetch" href="/assets/catalogue.html.8d830aeb.js"><link rel="prefetch" href="/assets/go-air.html.5c0b8867.js"><link rel="prefetch" href="/assets/go-version.html.6bc9fa2d.js"><link rel="prefetch" href="/assets/go_file.html.c4847245.js"><link rel="prefetch" href="/assets/go_mod.html.a0c0411e.js"><link rel="prefetch" href="/assets/mod.html.0887dfd9.js"><link rel="prefetch" href="/assets/name.html.ff2d7a52.js"><link rel="prefetch" href="/assets/index.html.48de80ea.js"><link rel="prefetch" href="/assets/zhenze.html.42c1f255.js"><link rel="prefetch" href="/assets/1.html.da9327f2.js"><link rel="prefetch" href="/assets/10.html.f079fcba.js"><link rel="prefetch" href="/assets/11.html.b6731830.js"><link rel="prefetch" href="/assets/12.html.c3899bcc.js"><link rel="prefetch" href="/assets/13.html.b5ac7d0c.js"><link rel="prefetch" href="/assets/14.html.f42d826c.js"><link rel="prefetch" href="/assets/15.html.129ca06e.js"><link rel="prefetch" href="/assets/16.html.c6b12559.js"><link rel="prefetch" href="/assets/17.html.271648a0.js"><link rel="prefetch" href="/assets/18.html.b751374a.js"><link rel="prefetch" href="/assets/19.html.d836eb6b.js"><link rel="prefetch" href="/assets/2.html.2e97f123.js"><link rel="prefetch" href="/assets/20.html.c5851a81.js"><link rel="prefetch" href="/assets/21.html.7e037094.js"><link rel="prefetch" href="/assets/22.html.83aa297b.js"><link rel="prefetch" href="/assets/23.html.ebc8f269.js"><link rel="prefetch" href="/assets/24.html.5522f4fc.js"><link rel="prefetch" href="/assets/25.html.3461cc91.js"><link rel="prefetch" href="/assets/26.html.63561d6a.js"><link rel="prefetch" href="/assets/27.html.80f4b961.js"><link rel="prefetch" href="/assets/28.html.8b7fde99.js"><link rel="prefetch" href="/assets/29.html.9ef2a1f0.js"><link rel="prefetch" href="/assets/3.html.41ff557d.js"><link rel="prefetch" href="/assets/30.html.74d0f923.js"><link rel="prefetch" href="/assets/4.html.3d2fffdc.js"><link rel="prefetch" href="/assets/5.html.fc392eda.js"><link rel="prefetch" href="/assets/6.html.32426110.js"><link rel="prefetch" href="/assets/7.html.ea1c3f97.js"><link rel="prefetch" href="/assets/8.html.1ea3fe8a.js"><link rel="prefetch" href="/assets/9.html.32fd4a4e.js"><link rel="prefetch" href="/assets/chan底层分析.html.21949e51.js"><link rel="prefetch" href="/assets/eth.html.f1d2bf82.js"><link rel="prefetch" href="/assets/file.html.afa7d909.js"><link rel="prefetch" href="/assets/gofloat.html.8d367dd2.js"><link rel="prefetch" href="/assets/Go汇编.html.cc76268d.js"><link rel="prefetch" href="/assets/九型人格.html.ce0421e4.js"><link rel="prefetch" href="/assets/反射.html.3a66dddb.js"><link rel="prefetch" href="/assets/并发.html.f951f860.js"><link rel="prefetch" href="/assets/index.html.e3bdc756.js"><link rel="prefetch" href="/assets/index.html.eacbf63c.js"><link rel="prefetch" href="/assets/字节青训营进阶面试准备.html.4e7d09e6.js"><link rel="prefetch" href="/assets/接口设计稿.html.0f22d226.js"><link rel="prefetch" href="/assets/码上掘金主题创作活动.html.663a2bd1.js"><link rel="prefetch" href="/assets/青训营题库.html.d1824c47.js"><link rel="prefetch" href="/assets/1.html.347438d8.js"><link rel="prefetch" href="/assets/10.html.eaa2ac7d.js"><link rel="prefetch" href="/assets/11.html.aac66b8c.js"><link rel="prefetch" href="/assets/12.html.16880db0.js"><link rel="prefetch" href="/assets/13.html.eea3d541.js"><link rel="prefetch" href="/assets/14.html.cdf72480.js"><link rel="prefetch" href="/assets/15.html.5364b59e.js"><link rel="prefetch" href="/assets/16.html.b9578d08.js"><link rel="prefetch" href="/assets/17.html.76aa7bbe.js"><link rel="prefetch" href="/assets/18.html.034a38f7.js"><link rel="prefetch" href="/assets/19.html.adc84eb3.js"><link rel="prefetch" href="/assets/2.html.752d4c12.js"><link rel="prefetch" href="/assets/20.html.0ab52f0b.js"><link rel="prefetch" href="/assets/21.html.b771f44b.js"><link rel="prefetch" href="/assets/22.html.e236924a.js"><link rel="prefetch" href="/assets/23.html.02fe68d6.js"><link rel="prefetch" href="/assets/24.html.7b7a56f1.js"><link rel="prefetch" href="/assets/25.html.8b4973dd.js"><link rel="prefetch" href="/assets/26.html.6ae8bfb2.js"><link rel="prefetch" href="/assets/27.html.186a8b35.js"><link rel="prefetch" href="/assets/28.html.308e76e8.js"><link rel="prefetch" href="/assets/29.html.44b4c7e0.js"><link rel="prefetch" href="/assets/3.html.7d415325.js"><link rel="prefetch" href="/assets/30.html.4de7b6eb.js"><link rel="prefetch" href="/assets/31.html.f7911ffa.js"><link rel="prefetch" href="/assets/32.html.50be0b7f.js"><link rel="prefetch" href="/assets/33.html.dcf0bbe4.js"><link rel="prefetch" href="/assets/34.html.46db9cfb.js"><link rel="prefetch" href="/assets/35.html.194ce6a1.js"><link rel="prefetch" href="/assets/36.html.1baec9d0.js"><link rel="prefetch" href="/assets/37.html.56ec0b95.js"><link rel="prefetch" href="/assets/38.html.3664b9d2.js"><link rel="prefetch" href="/assets/39.html.a77e9f54.js"><link rel="prefetch" href="/assets/4.html.eac1da6e.js"><link rel="prefetch" href="/assets/40.html.037edd87.js"><link rel="prefetch" href="/assets/41.html.c0e53bfe.js"><link rel="prefetch" href="/assets/42.html.c6615079.js"><link rel="prefetch" href="/assets/43.html.ce469fc1.js"><link rel="prefetch" href="/assets/44.html.e812f561.js"><link rel="prefetch" href="/assets/45.html.2c88849f.js"><link rel="prefetch" href="/assets/46.html.b306c809.js"><link rel="prefetch" href="/assets/47.html.56da4b30.js"><link rel="prefetch" href="/assets/48.html.08c3a2ad.js"><link rel="prefetch" href="/assets/49.html.db90d181.js"><link rel="prefetch" href="/assets/5.html.2c7d0a4c.js"><link rel="prefetch" href="/assets/50.html.2d1cea49.js"><link rel="prefetch" href="/assets/51.html.b7fef7a1.js"><link rel="prefetch" href="/assets/52.html.eaf46bf5.js"><link rel="prefetch" href="/assets/53.html.3ef8d78f.js"><link rel="prefetch" href="/assets/54.html.2cf85d1d.js"><link rel="prefetch" href="/assets/55.html.0050ed54.js"><link rel="prefetch" href="/assets/56.html.9540e712.js"><link rel="prefetch" href="/assets/57.html.e7be4c70.js"><link rel="prefetch" href="/assets/58.html.9cc158ad.js"><link rel="prefetch" href="/assets/59.html.a6f876ce.js"><link rel="prefetch" href="/assets/6.html.1739fcaf.js"><link rel="prefetch" href="/assets/60.html.5d777a13.js"><link rel="prefetch" href="/assets/61.html.9e23c825.js"><link rel="prefetch" href="/assets/62.html.b458a962.js"><link rel="prefetch" href="/assets/63.html.2b19c7be.js"><link rel="prefetch" href="/assets/64.html.5afe1a48.js"><link rel="prefetch" href="/assets/65.html.17db3af9.js"><link rel="prefetch" href="/assets/66.html.b7496a35.js"><link rel="prefetch" href="/assets/67.html.91e29bd7.js"><link rel="prefetch" href="/assets/68.html.7129c35e.js"><link rel="prefetch" href="/assets/69.html.804d7434.js"><link rel="prefetch" href="/assets/7.html.5359fe94.js"><link rel="prefetch" href="/assets/70.html.31168145.js"><link rel="prefetch" href="/assets/71.html.95c0b4ed.js"><link rel="prefetch" href="/assets/72.html.64a92e03.js"><link rel="prefetch" href="/assets/73.html.23aa82c4.js"><link rel="prefetch" href="/assets/74.html.4d4f671a.js"><link rel="prefetch" href="/assets/75.html.4601715a.js"><link rel="prefetch" href="/assets/76.html.fbab5b5e.js"><link rel="prefetch" href="/assets/77.html.d25664fe.js"><link rel="prefetch" href="/assets/78.html.1f5dc3c4.js"><link rel="prefetch" href="/assets/79.html.b88a93ce.js"><link rel="prefetch" href="/assets/8.html.73931ea5.js"><link rel="prefetch" href="/assets/80.html.683f423a.js"><link rel="prefetch" href="/assets/81.html.7c6d253e.js"><link rel="prefetch" href="/assets/82.html.04dd8381.js"><link rel="prefetch" href="/assets/83.html.360b9d8f.js"><link rel="prefetch" href="/assets/84.html.bba3cfe8.js"><link rel="prefetch" href="/assets/85.html.df284478.js"><link rel="prefetch" href="/assets/86.html.dc6ddd4c.js"><link rel="prefetch" href="/assets/87.html.f22e2f44.js"><link rel="prefetch" href="/assets/88.html.103063ac.js"><link rel="prefetch" href="/assets/89.html.147d1c75.js"><link rel="prefetch" href="/assets/9.html.ce4e2892.js"><link rel="prefetch" href="/assets/90.html.4d2d9b88.js"><link rel="prefetch" href="/assets/91.html.b5d55412.js"><link rel="prefetch" href="/assets/92.html.c499b8b3.js"><link rel="prefetch" href="/assets/93.html.9a9d9951.js"><link rel="prefetch" href="/assets/94.html.72ca0d4c.js"><link rel="prefetch" href="/assets/95.html.28036564.js"><link rel="prefetch" href="/assets/96.html.1f6d6981.js"><link rel="prefetch" href="/assets/97.html.cb79144c.js"><link rel="prefetch" href="/assets/98.html.aa9ce6be.js"><link rel="prefetch" href="/assets/99.html.03bf0fc2.js"><link rel="prefetch" href="/assets/1.html.b97b7af9.js"><link rel="prefetch" href="/assets/10.html.beaa97a6.js"><link rel="prefetch" href="/assets/11.html.29d7f01a.js"><link rel="prefetch" href="/assets/12.html.1f21cdad.js"><link rel="prefetch" href="/assets/13.html.49271361.js"><link rel="prefetch" href="/assets/14.html.2b346dd1.js"><link rel="prefetch" href="/assets/15.html.f1e578e7.js"><link rel="prefetch" href="/assets/16.html.2ca06fe8.js"><link rel="prefetch" href="/assets/17.html.011da877.js"><link rel="prefetch" href="/assets/18.html.b51691da.js"><link rel="prefetch" href="/assets/19.html.8a0152eb.js"><link rel="prefetch" href="/assets/2.html.cd27b37f.js"><link rel="prefetch" href="/assets/20.html.27806296.js"><link rel="prefetch" href="/assets/21.html.4d7c60a9.js"><link rel="prefetch" href="/assets/22.html.27144d46.js"><link rel="prefetch" href="/assets/23.html.4ffece1b.js"><link rel="prefetch" href="/assets/24.html.7ca2457a.js"><link rel="prefetch" href="/assets/25.html.adc6de4d.js"><link rel="prefetch" href="/assets/26.html.ed30f898.js"><link rel="prefetch" href="/assets/27.html.927775d4.js"><link rel="prefetch" href="/assets/28.html.288f551e.js"><link rel="prefetch" href="/assets/29.html.f4ea90f3.js"><link rel="prefetch" href="/assets/3.html.379a5e41.js"><link rel="prefetch" href="/assets/30.html.b7a5224c.js"><link rel="prefetch" href="/assets/31.html.e290457c.js"><link rel="prefetch" href="/assets/32.html.b81d837e.js"><link rel="prefetch" href="/assets/33.html.734771df.js"><link rel="prefetch" href="/assets/34.html.d54b06d6.js"><link rel="prefetch" href="/assets/35.html.3d7cb509.js"><link rel="prefetch" href="/assets/36.html.4cf0946d.js"><link rel="prefetch" href="/assets/37.html.29641381.js"><link rel="prefetch" href="/assets/38.html.f5e792ff.js"><link rel="prefetch" href="/assets/39.html.1e7a2166.js"><link rel="prefetch" href="/assets/4.html.17a256e9.js"><link rel="prefetch" href="/assets/40.html.216b8a32.js"><link rel="prefetch" href="/assets/41.html.e2f092f4.js"><link rel="prefetch" href="/assets/42.html.6f0eded5.js"><link rel="prefetch" href="/assets/43.html.45395aac.js"><link rel="prefetch" href="/assets/44.html.81edda31.js"><link rel="prefetch" href="/assets/45.html.a8dfc5bf.js"><link rel="prefetch" href="/assets/46.html.bbd23090.js"><link rel="prefetch" href="/assets/47.html.968d43f9.js"><link rel="prefetch" href="/assets/48.html.d514729f.js"><link rel="prefetch" href="/assets/49.html.e25c027e.js"><link rel="prefetch" href="/assets/5.html.60951a89.js"><link rel="prefetch" href="/assets/50.html.0b3b10f6.js"><link rel="prefetch" href="/assets/6.html.ca83e5c3.js"><link rel="prefetch" href="/assets/7.html.638f6148.js"><link rel="prefetch" href="/assets/8.html.f60d64dd.js"><link rel="prefetch" href="/assets/9.html.72a8d8be.js"><link rel="prefetch" href="/assets/1.html.7da34ac1.js"><link rel="prefetch" href="/assets/10.html.10c34ba3.js"><link rel="prefetch" href="/assets/100.html.2cf80d17.js"><link rel="prefetch" href="/assets/11.html.75208f7c.js"><link rel="prefetch" href="/assets/12.html.f6be6af7.js"><link rel="prefetch" href="/assets/13.html.e4b4d9d4.js"><link rel="prefetch" href="/assets/14.html.8cc161c0.js"><link rel="prefetch" href="/assets/15.html.c049eb14.js"><link rel="prefetch" href="/assets/16.html.0d7413d2.js"><link rel="prefetch" href="/assets/17.html.763937c8.js"><link rel="prefetch" href="/assets/18.html.694df482.js"><link rel="prefetch" href="/assets/19.html.5e417ace.js"><link rel="prefetch" href="/assets/2.html.000b05cd.js"><link rel="prefetch" href="/assets/20.html.00996838.js"><link rel="prefetch" href="/assets/21.html.560b2fcb.js"><link rel="prefetch" href="/assets/22.html.91a7527c.js"><link rel="prefetch" href="/assets/23.html.05e7d387.js"><link rel="prefetch" href="/assets/24.html.9853ecb4.js"><link rel="prefetch" href="/assets/25.html.ee4b4271.js"><link rel="prefetch" href="/assets/26.html.987583ed.js"><link rel="prefetch" href="/assets/27.html.291aab45.js"><link rel="prefetch" href="/assets/28.html.c5df427f.js"><link rel="prefetch" href="/assets/29.html.b5414101.js"><link rel="prefetch" href="/assets/3.html.9e63d39d.js"><link rel="prefetch" href="/assets/30.html.e67e73c2.js"><link rel="prefetch" href="/assets/31.html.cfa883f7.js"><link rel="prefetch" href="/assets/32.html.28de8319.js"><link rel="prefetch" href="/assets/33.html.c7fb523e.js"><link rel="prefetch" href="/assets/34.html.17c2231c.js"><link rel="prefetch" href="/assets/35.html.af2e11ac.js"><link rel="prefetch" href="/assets/36.html.71b5c907.js"><link rel="prefetch" href="/assets/37.html.d707fe69.js"><link rel="prefetch" href="/assets/38.html.9968a328.js"><link rel="prefetch" href="/assets/39.html.3e137ab3.js"><link rel="prefetch" href="/assets/4.html.cb3dd4a6.js"><link rel="prefetch" href="/assets/40.html.e1b3dff8.js"><link rel="prefetch" href="/assets/41.html.8580f616.js"><link rel="prefetch" href="/assets/42.html.7477fe41.js"><link rel="prefetch" href="/assets/43.html.bab158ef.js"><link rel="prefetch" href="/assets/44.html.d368f5d0.js"><link rel="prefetch" href="/assets/45.html.a68cf7ce.js"><link rel="prefetch" href="/assets/46.html.228fbc99.js"><link rel="prefetch" href="/assets/47.html.a55ecffe.js"><link rel="prefetch" href="/assets/48.html.1aca972f.js"><link rel="prefetch" href="/assets/49.html.9494c4d0.js"><link rel="prefetch" href="/assets/5.html.707a5dfb.js"><link rel="prefetch" href="/assets/50.html.52918c10.js"><link rel="prefetch" href="/assets/51.html.7c70657d.js"><link rel="prefetch" href="/assets/52.html.4c800432.js"><link rel="prefetch" href="/assets/53.html.3c563ae9.js"><link rel="prefetch" href="/assets/54.html.7cf18da8.js"><link rel="prefetch" href="/assets/55.html.d7df7037.js"><link rel="prefetch" href="/assets/56.html.ab2b96ba.js"><link rel="prefetch" href="/assets/57.html.0e17bff8.js"><link rel="prefetch" href="/assets/58.html.789ab265.js"><link rel="prefetch" href="/assets/59.html.0cf039de.js"><link rel="prefetch" href="/assets/6.html.9e409a44.js"><link rel="prefetch" href="/assets/60.html.f2c969a9.js"><link rel="prefetch" href="/assets/61.html.7dc4eb89.js"><link rel="prefetch" href="/assets/62.html.f8b4b0ed.js"><link rel="prefetch" href="/assets/63.html.331b7c31.js"><link rel="prefetch" href="/assets/64.html.268b38ef.js"><link rel="prefetch" href="/assets/65.html.ccc09697.js"><link rel="prefetch" href="/assets/66.html.5729399a.js"><link rel="prefetch" href="/assets/67.html.b3df9099.js"><link rel="prefetch" href="/assets/68.html.546c0a4d.js"><link rel="prefetch" href="/assets/69.html.b0aeb5d1.js"><link rel="prefetch" href="/assets/7.html.dd73ff0c.js"><link rel="prefetch" href="/assets/70.html.ad3341f4.js"><link rel="prefetch" href="/assets/71.html.c4734e3b.js"><link rel="prefetch" href="/assets/72.html.4955059e.js"><link rel="prefetch" href="/assets/73.html.9ccec10c.js"><link rel="prefetch" href="/assets/74.html.97850041.js"><link rel="prefetch" href="/assets/75.html.e612380c.js"><link rel="prefetch" href="/assets/76.html.07a4a539.js"><link rel="prefetch" href="/assets/77.html.22b5806e.js"><link rel="prefetch" href="/assets/78.html.245c825e.js"><link rel="prefetch" href="/assets/79.html.56b0e00d.js"><link rel="prefetch" href="/assets/8.html.8abf8e63.js"><link rel="prefetch" href="/assets/80.html.3175c1c0.js"><link rel="prefetch" href="/assets/81.html.9d8b9f98.js"><link rel="prefetch" href="/assets/82.html.28f7743d.js"><link rel="prefetch" href="/assets/83.html.89809382.js"><link rel="prefetch" href="/assets/84.html.ebda0ca6.js"><link rel="prefetch" href="/assets/85.html.e1e77359.js"><link rel="prefetch" href="/assets/86.html.d905b98c.js"><link rel="prefetch" href="/assets/87.html.394286b4.js"><link rel="prefetch" href="/assets/88.html.9d249254.js"><link rel="prefetch" href="/assets/89.html.b83cb600.js"><link rel="prefetch" href="/assets/9.html.fa56dffb.js"><link rel="prefetch" href="/assets/90.html.6d827fdd.js"><link rel="prefetch" href="/assets/91.html.2c6d5193.js"><link rel="prefetch" href="/assets/92.html.6d0bdef4.js"><link rel="prefetch" href="/assets/93.html.7969a3d7.js"><link rel="prefetch" href="/assets/94.html.fdf41305.js"><link rel="prefetch" href="/assets/95.html.2d67352f.js"><link rel="prefetch" href="/assets/96.html.3df848f7.js"><link rel="prefetch" href="/assets/97.html.52cfb043.js"><link rel="prefetch" href="/assets/98.html.2e75f276.js"><link rel="prefetch" href="/assets/99.html.bfdb3c1e.js"><link rel="prefetch" href="/assets/1.html.c4404e66.js"><link rel="prefetch" href="/assets/10.html.1fe6bc64.js"><link rel="prefetch" href="/assets/11.html.a2b96a79.js"><link rel="prefetch" href="/assets/12.html.8414a47e.js"><link rel="prefetch" href="/assets/13.html.fee6b1fc.js"><link rel="prefetch" href="/assets/14.html.870e7e57.js"><link rel="prefetch" href="/assets/15.html.cb69c380.js"><link rel="prefetch" href="/assets/16.html.4dfed9a5.js"><link rel="prefetch" href="/assets/17.html.3af63fca.js"><link rel="prefetch" href="/assets/18.html.2fb28748.js"><link rel="prefetch" href="/assets/19.html.3a7d48c9.js"><link rel="prefetch" href="/assets/2.html.4367f7f6.js"><link rel="prefetch" href="/assets/20.html.d6356f72.js"><link rel="prefetch" href="/assets/21.html.036a19d8.js"><link rel="prefetch" href="/assets/22.html.086dd284.js"><link rel="prefetch" href="/assets/23.html.0c9034e3.js"><link rel="prefetch" href="/assets/24.html.70a6a605.js"><link rel="prefetch" href="/assets/25.html.a83c4ad3.js"><link rel="prefetch" href="/assets/26.html.e72a0c95.js"><link rel="prefetch" href="/assets/27.html.be9a43f7.js"><link rel="prefetch" href="/assets/28.html.b04895c1.js"><link rel="prefetch" href="/assets/29.html.32af3e3a.js"><link rel="prefetch" href="/assets/3.html.3fbafc4e.js"><link rel="prefetch" href="/assets/30.html.fa4cc381.js"><link rel="prefetch" href="/assets/31.html.cd52afef.js"><link rel="prefetch" href="/assets/32.html.4be8b4a0.js"><link rel="prefetch" href="/assets/33.html.1efe810a.js"><link rel="prefetch" href="/assets/34.html.b552bb57.js"><link rel="prefetch" href="/assets/35.html.2bacf940.js"><link rel="prefetch" href="/assets/36.html.b31706d5.js"><link rel="prefetch" href="/assets/37.html.f8404f61.js"><link rel="prefetch" href="/assets/38.html.359d8f8c.js"><link rel="prefetch" href="/assets/39.html.31202919.js"><link rel="prefetch" href="/assets/4.html.503cfc13.js"><link rel="prefetch" href="/assets/40.html.cac6d193.js"><link rel="prefetch" href="/assets/41.html.4e688ebc.js"><link rel="prefetch" href="/assets/42.html.04bc9324.js"><link rel="prefetch" href="/assets/43.html.d00f1fcc.js"><link rel="prefetch" href="/assets/44.html.27ef8dc0.js"><link rel="prefetch" href="/assets/45.html.e9822111.js"><link rel="prefetch" href="/assets/46.html.c633ba8d.js"><link rel="prefetch" href="/assets/47.html.c61e8feb.js"><link rel="prefetch" href="/assets/48.html.563b5180.js"><link rel="prefetch" href="/assets/49.html.a858357a.js"><link rel="prefetch" href="/assets/5.html.31d250f5.js"><link rel="prefetch" href="/assets/6.html.24bd017f.js"><link rel="prefetch" href="/assets/7.html.49e71609.js"><link rel="prefetch" href="/assets/8.html.55e2aafc.js"><link rel="prefetch" href="/assets/9.html.523cec6e.js"><link rel="prefetch" href="/assets/1.html.e4a9403c.js"><link rel="prefetch" href="/assets/10.html.0647bc17.js"><link rel="prefetch" href="/assets/11.html.864534fb.js"><link rel="prefetch" href="/assets/12.html.7da9e141.js"><link rel="prefetch" href="/assets/13.html.e5c230eb.js"><link rel="prefetch" href="/assets/14.html.df51d590.js"><link rel="prefetch" href="/assets/15.html.e38817c1.js"><link rel="prefetch" href="/assets/16.html.6d914183.js"><link rel="prefetch" href="/assets/17.html.1649ccb9.js"><link rel="prefetch" href="/assets/18.html.489abcd6.js"><link rel="prefetch" href="/assets/19.html.4b33a26a.js"><link rel="prefetch" href="/assets/2.html.836757a0.js"><link rel="prefetch" href="/assets/20.html.e7d4ccbf.js"><link rel="prefetch" href="/assets/22.html.d46520fa.js"><link rel="prefetch" href="/assets/23.html.3acc65f5.js"><link rel="prefetch" href="/assets/24.html.ec840bdf.js"><link rel="prefetch" href="/assets/25.html.b2862663.js"><link rel="prefetch" href="/assets/26.html.4c894b74.js"><link rel="prefetch" href="/assets/27.html.36ed97cc.js"><link rel="prefetch" href="/assets/28.html.3ee471fe.js"><link rel="prefetch" href="/assets/29.html.06580289.js"><link rel="prefetch" href="/assets/3.html.5b4a0b1e.js"><link rel="prefetch" href="/assets/30.html.7d133a3c.js"><link rel="prefetch" href="/assets/31.html.c2d861f4.js"><link rel="prefetch" href="/assets/32.html.2426ec1b.js"><link rel="prefetch" href="/assets/33.html.47611387.js"><link rel="prefetch" href="/assets/34.html.dc503a52.js"><link rel="prefetch" href="/assets/35.html.adb5486c.js"><link rel="prefetch" href="/assets/36.html.620a9b1c.js"><link rel="prefetch" href="/assets/37.html.57143890.js"><link rel="prefetch" href="/assets/38.html.b3900d73.js"><link rel="prefetch" href="/assets/39.html.b152b7c7.js"><link rel="prefetch" href="/assets/4.html.e9289c0b.js"><link rel="prefetch" href="/assets/40.html.9be993b6.js"><link rel="prefetch" href="/assets/41.html.e1f0aeb7.js"><link rel="prefetch" href="/assets/42.html.66276ccf.js"><link rel="prefetch" href="/assets/43.html.3bda490c.js"><link rel="prefetch" href="/assets/44.html.b38e6166.js"><link rel="prefetch" href="/assets/45.html.997a6eb5.js"><link rel="prefetch" href="/assets/46.html.9d36fba1.js"><link rel="prefetch" href="/assets/47.html.326af551.js"><link rel="prefetch" href="/assets/48.html.9e1eb664.js"><link rel="prefetch" href="/assets/49.html.d3a5e7b3.js"><link rel="prefetch" href="/assets/5.html.7baefce6.js"><link rel="prefetch" href="/assets/50.html.3137e12b.js"><link rel="prefetch" href="/assets/51.html.c1057168.js"><link rel="prefetch" href="/assets/52.html.e8b1a19c.js"><link rel="prefetch" href="/assets/53.html.259b7acf.js"><link rel="prefetch" href="/assets/54.html.5bc76c1c.js"><link rel="prefetch" href="/assets/55.html.36ddd170.js"><link rel="prefetch" href="/assets/56.html.579f6f3c.js"><link rel="prefetch" href="/assets/57.html.58d3ed36.js"><link rel="prefetch" href="/assets/58.html.f65f378b.js"><link rel="prefetch" href="/assets/59.html.72e2f2bb.js"><link rel="prefetch" href="/assets/6.html.53cca7c5.js"><link rel="prefetch" href="/assets/60.html.c2d80863.js"><link rel="prefetch" href="/assets/61.html.fbe85b06.js"><link rel="prefetch" href="/assets/62.html.00a9b0e9.js"><link rel="prefetch" href="/assets/63.html.aedc5b42.js"><link rel="prefetch" href="/assets/64.html.4690efe2.js"><link rel="prefetch" href="/assets/65.html.af7e1796.js"><link rel="prefetch" href="/assets/66.html.f0c3253f.js"><link rel="prefetch" href="/assets/67.html.d384e7eb.js"><link rel="prefetch" href="/assets/68.html.75c2c181.js"><link rel="prefetch" href="/assets/69.html.795748dd.js"><link rel="prefetch" href="/assets/7.html.f2c636ac.js"><link rel="prefetch" href="/assets/70.html.ccb41aab.js"><link rel="prefetch" href="/assets/71.html.373d8d06.js"><link rel="prefetch" href="/assets/72.html.03439d30.js"><link rel="prefetch" href="/assets/73.html.2df68614.js"><link rel="prefetch" href="/assets/74.html.4a89cda6.js"><link rel="prefetch" href="/assets/75.html.1392600c.js"><link rel="prefetch" href="/assets/76.html.8e087f71.js"><link rel="prefetch" href="/assets/77.html.cb4906b7.js"><link rel="prefetch" href="/assets/78.html.6d1cdb99.js"><link rel="prefetch" href="/assets/79.html.9340ce39.js"><link rel="prefetch" href="/assets/8.html.23e22fc3.js"><link rel="prefetch" href="/assets/80.html.e8f5d2d1.js"><link rel="prefetch" href="/assets/81.html.51827a8f.js"><link rel="prefetch" href="/assets/82.html.e9a57821.js"><link rel="prefetch" href="/assets/83.html.1d498126.js"><link rel="prefetch" href="/assets/84.html.fa5a2676.js"><link rel="prefetch" href="/assets/85.html.cbe9d1c3.js"><link rel="prefetch" href="/assets/86.html.254c391a.js"><link rel="prefetch" href="/assets/87.html.4b96a065.js"><link rel="prefetch" href="/assets/88.html.77eed936.js"><link rel="prefetch" href="/assets/89.html.613e7c1e.js"><link rel="prefetch" href="/assets/9.html.919b43bb.js"><link rel="prefetch" href="/assets/90.html.2f4bc404.js"><link rel="prefetch" href="/assets/91.html.e9936fec.js"><link rel="prefetch" href="/assets/92.html.2f8671ea.js"><link rel="prefetch" href="/assets/93.html.194b838b.js"><link rel="prefetch" href="/assets/94.html.eb9d1561.js"><link rel="prefetch" href="/assets/95.html.c808044e.js"><link rel="prefetch" href="/assets/96.html.64475e63.js"><link rel="prefetch" href="/assets/97.html.312e65bc.js"><link rel="prefetch" href="/assets/98.html.933ff9de.js"><link rel="prefetch" href="/assets/99.html.c0e234bf.js"><link rel="prefetch" href="/assets/404.html.472fdf67.js">
    <link rel="stylesheet" href="/assets/style.03848e77.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">你好</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/cubxxw/awesome-cs-cloudnative-blockchain" rel="noopener noreferrer" target="_blank" aria-label="Github仓库"><!--[--><!--]--> Github仓库 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="http://nsddd.top" rel="noopener noreferrer" target="_blank" aria-label="我的博客"><!--[--><!--]--> 我的博客 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://www.zhihu.com/people/3293172751" rel="noopener noreferrer" target="_blank" aria-label="知乎"><!--[--><!--]--> 知乎 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/kubecub/" rel="noopener noreferrer" target="_blank" aria-label="⛓️链学社组织"><!--[--><!--]--> ⛓️链学社组织 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/" class="" aria-label="🏠首页"><!--[--><!--]--> 🏠首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://docker.nsddd.top/" rel="noopener noreferrer" target="_blank" aria-label="🐋docker文档"><!--[--><!--]--> 🐋docker文档 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/markdown/1.md/" class="" aria-label="🔥 Go语言基础篇"><!--[--><!--]--> 🔥 Go语言基础篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Gomd_super/" class="" aria-label="🔥 Go语言进阶篇"><!--[--><!--]--> 🔥 Go语言进阶篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/go-advancend/" class="" aria-label="🔥 Go语言高级篇"><!--[--><!--]--> 🔥 Go语言高级篇 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/3293172751/awesome-go" rel="noopener noreferrer" target="_blank" aria-label="查看源码"><!--[--><!--]--> 查看源码 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="切换颜色模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/cubxxw/awesome-cs-cloudnative-blockchain" rel="noopener noreferrer" target="_blank" aria-label="Github仓库"><!--[--><!--]--> Github仓库 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="http://nsddd.top" rel="noopener noreferrer" target="_blank" aria-label="我的博客"><!--[--><!--]--> 我的博客 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://www.zhihu.com/people/3293172751" rel="noopener noreferrer" target="_blank" aria-label="知乎"><!--[--><!--]--> 知乎 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/kubecub/" rel="noopener noreferrer" target="_blank" aria-label="⛓️链学社组织"><!--[--><!--]--> ⛓️链学社组织 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/" class="" aria-label="🏠首页"><!--[--><!--]--> 🏠首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://docker.nsddd.top/" rel="noopener noreferrer" target="_blank" aria-label="🐋docker文档"><!--[--><!--]--> 🐋docker文档 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/markdown/1.md/" class="" aria-label="🔥 Go语言基础篇"><!--[--><!--]--> 🔥 Go语言基础篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Gomd_super/" class="" aria-label="🔥 Go语言进阶篇"><!--[--><!--]--> 🔥 Go语言进阶篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/go-advancend/" class="" aria-label="🔥 Go语言高级篇"><!--[--><!--]--> 🔥 Go语言高级篇 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/3293172751/awesome-go" rel="noopener noreferrer" target="_blank" aria-label="查看源码"><!--[--><!--]--> 查看源码 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/Gomd_super/" class="sidebar-item sidebar-heading" aria-label="/Gomd_super/"><!--[--><!--]--> /Gomd_super/ <!--[--><!--]--></a><!----></li><li><a href="/Gomd_super/go-air.html" class="sidebar-item sidebar-heading" aria-label="go-air实现热加载"><!--[--><!--]--> go-air实现热加载 <!--[--><!--]--></a><!----></li><li><a href="/Gomd_super/name.html" class="sidebar-item sidebar-heading" aria-label="Go语言命名规范"><!--[--><!--]--> Go语言命名规范 <!--[--><!--]--></a><!----></li><li><a href="/Gomd_super/mod.html" class="sidebar-item sidebar-heading" aria-label="Go mod包"><!--[--><!--]--> Go mod包 <!--[--><!--]--></a><!----></li><li><a href="/Gomd_super/zhenze.html" class="sidebar-item sidebar-heading" aria-label="正则表达式语法速查表"><!--[--><!--]--> 正则表达式语法速查表 <!--[--><!--]--></a><!----></li><li><a href="/Gomd_super/go_file.html" class="sidebar-item sidebar-heading" aria-label="Go语言文本编码处理"><!--[--><!--]--> Go语言文本编码处理 <!--[--><!--]--></a><!----></li><li><a href="/Gomd_super/catalogue.html" class="sidebar-item sidebar-heading" aria-label="目录结构"><!--[--><!--]--> 目录结构 <!--[--><!--]--></a><!----></li><li><a href="/Gomd_super/bitwise.html" class="sidebar-item sidebar-heading" aria-label="位运算以及补码重点"><!--[--><!--]--> 位运算以及补码重点 <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><ul><li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">🔥 开源地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h1 id="第21节-控制流-下-iam-apiserver服务核心功能实现讲解" tabindex="-1"><a class="header-anchor" href="#第21节-控制流-下-iam-apiserver服务核心功能实现讲解" aria-hidden="true">#</a> 第21节 控制流（下）：iam-apiserver服务核心功能实现讲解</h1><br><div><a href="20.md" style="float:left;">⬆️上一节🔗 </a><a href="22.md" style="float:right;"> ⬇️下一节🔗</a></div><br><blockquote><p>❤️💕💕During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><hr><nav class="table-of-contents"><ul><li><a aria-current="page" href="/projects/projects/21.html#开始" class="router-link-active router-link-exact-active">开始</a></li><li><a aria-current="page" href="/projects/projects/21.html#应用框架相关的特性" class="router-link-active router-link-exact-active">应用框架相关的特性</a><ul><li><a aria-current="page" href="/projects/projects/21.html#优雅关停" class="router-link-active router-link-exact-active">优雅关停</a></li><li><a aria-current="page" href="/projects/projects/21.html#健康检查" class="router-link-active router-link-exact-active">健康检查</a></li><li><a aria-current="page" href="/projects/projects/21.html#插件化加载中间件" class="router-link-active router-link-exact-active">插件化加载中间件</a></li></ul></li><li><a aria-current="page" href="/projects/projects/21.html#编程规范相关的特性" class="router-link-active router-link-exact-active">编程规范相关的特性</a><ul><li><a aria-current="page" href="/projects/projects/21.html#api-版本" class="router-link-active router-link-exact-active">API 版本</a></li><li><a aria-current="page" href="/projects/projects/21.html#统一的资源元数据" class="router-link-active router-link-exact-active">统一的资源元数据</a></li><li><a aria-current="page" href="/projects/projects/21.html#统一的返回" class="router-link-active router-link-exact-active">统一的返回</a></li><li><a aria-current="page" href="/projects/projects/21.html#并发处理模板" class="router-link-active router-link-exact-active">并发处理模板</a></li></ul></li><li><a aria-current="page" href="/projects/projects/21.html#其他特性" class="router-link-active router-link-exact-active">其他特性</a><ul><li><a aria-current="page" href="/projects/projects/21.html#插件化选择-json-库" class="router-link-active router-link-exact-active">插件化选择 JSON 库</a></li><li><a aria-current="page" href="/projects/projects/21.html#调用链实现" class="router-link-active router-link-exact-active">调用链实现</a></li><li><a aria-current="page" href="/projects/projects/21.html#数据一致性" class="router-link-active router-link-exact-active">数据一致性</a></li></ul></li><li><a aria-current="page" href="/projects/projects/21.html#总结" class="router-link-active router-link-exact-active">总结</a></li><li><a aria-current="page" href="/projects/projects/21.html#end-链接" class="router-link-active router-link-exact-active">END 链接</a></li></ul></nav><p>[TOC]</p><h2 id="开始" tabindex="-1"><a class="header-anchor" href="#开始" aria-hidden="true">#</a> 开始</h2><p>iam-apiserver 中包含了很多优秀的设计思想和实现，这些点可能比较零碎，但我觉得很值得分享给你。我将这些关键代码设计分为 3 类，分别是应用框架相关的特性、编程规范相关的特性和其他特性。接下来，我们就来详细看看这些设计点，以及它们背后的设计思想。</p><h2 id="应用框架相关的特性" tabindex="-1"><a class="header-anchor" href="#应用框架相关的特性" aria-hidden="true">#</a> 应用框架相关的特性</h2><p>应用框架相关的特性包括三个，分别是 <strong>优雅关停、健康检查和插件化加载中间件</strong>。</p><h3 id="优雅关停" tabindex="-1"><a class="header-anchor" href="#优雅关停" aria-hidden="true">#</a> 优雅关停</h3><p>在讲优雅关停之前，先来看看不优雅的停止服务方式是什么样的。</p><p>当我们需要重启服务时，首先需要停止服务，这时可以通过两种方式来停止我们的服务：</p><ul><li>在 Linux 终端键入 Ctrl + C（其实是发送 SIGINT 信号）。</li><li>发送 SIGTERM 信号，例如 <code>kill</code> 或者 <code>systemctl stop</code> 等。</li></ul><p>当我们使用以上两种方式停止服务时，都会产生下面两个问题：</p><ul><li>有些请求正在处理，如果服务端直接退出，会造成客户端连接中断，请求失败。</li><li>我们的程序可能需要做一些清理工作，比如等待进程内任务队列的任务执行完成，或者拒绝接受新的消息等。</li></ul><p>这些问题都会对业务造成影响，所以我们需要一种优雅的方式来关停我们的应用。在 Go 开发中，通常通过拦截 <code>SIGINT</code> 和 <code>SIGTERM</code> 信号，来实现优雅关停。当收到这两个信号时，应用进程会做一些清理工作，然后结束阻塞状态，继续执行余下的代码，最后自然退出进程。</p><p><strong>先来看一个简单的优雅关停的示例代码：</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;context&quot;</span>
    <span class="token string">&quot;log&quot;</span>
    <span class="token string">&quot;net/http&quot;</span>
    <span class="token string">&quot;os&quot;</span>
    <span class="token string">&quot;os/signal&quot;</span>
    <span class="token string">&quot;time&quot;</span>

    <span class="token string">&quot;github.com/gin-gonic/gin&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">&quot;Welcome Gin Server&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    srv <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
        Addr<span class="token punctuation">:</span>    <span class="token string">&quot;:8080&quot;</span><span class="token punctuation">,</span>
        Handler<span class="token punctuation">:</span> router<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将服务在 goroutine 中启动</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> http<span class="token punctuation">.</span>ErrServerClosed <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;listen: %s\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
    signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Interrupt<span class="token punctuation">)</span>
    <span class="token operator">&lt;-</span>quit <span class="token comment">// 阻塞等待接收 channel 数据</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Shutdown Server ...&quot;</span><span class="token punctuation">)</span>

    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">// 5s 缓冲时间处理已有请求</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 调用 net/http 包提供的优雅关闭函数：Shutdown</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;Server Shutdown:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Server exiting&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>上面的代码实现优雅关停的思路如下：</strong></p><ol><li>将 HTTP 服务放在 goroutine 中运行，程序不阻塞，继续执行。</li><li>创建一个无缓冲的 channel <code>quit</code>，调用 <code>signal.Notify(quit, os.Interrupt)</code>。通过 signal.Notify 函数调用，可以将进程收到的 os.Interrupt（SIGINT）信号，发送给 channel <code>quit</code>。</li><li><code>&lt;-quit</code> 阻塞当前 goroutine（也就是 main 函数所在的 goroutine），等待从 channel <code>quit</code> 接收关停信号。通过以上步骤，我们成功启动了 HTTP 服务，并且 main 函数阻塞，防止启动 HTTP 服务的 goroutine 退出。当我们键入 <code>Ctrl + C</code>时，进程会收到 SIGINT 信号，并将该信号发送到 channel <code>quit</code> 中，这时候<code>&lt;-quit</code>收到了 channel 另一端传来的数据，结束阻塞状态，程序继续执行。这里，<code>&lt;-quit</code>唯一目的是阻塞当前的 goroutine，所以对收到的数据直接丢弃。</li><li>打印退出消息，提示准备退出当前服务。</li><li>调用 <code>net/http</code> 包提供的 Shutdown 方法，Shutdown 方法会在指定的时间内处理完现有请求，并返回。</li><li>最后，程序执行完 <code>log.Println(&quot;Server exiting&quot;)</code> 代码后，退出 main 函数。</li></ol><p>**iam-apiserver 也实现了优雅关停，优雅关停思路跟上面的代码类似。**具体可以分为三个步骤，流程如下：</p><p><strong>第一步</strong>，创建 channel 用来接收 os.Interrupt（SIGINT）和 syscall.SIGTERM（SIGKILL）信号。</p><p>代码见 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/server/signal.go#L19" target="_blank" rel="noopener noreferrer">internal/pkg/server/signal.go<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">var</span> onlyOneSignalHandler <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> shutdownHandler <span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal

<span class="token keyword">func</span> <span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span>onlyOneSignalHandler<span class="token punctuation">)</span> <span class="token comment">// panics when called twice</span>

    shutdownHandler <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

    stop <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>shutdownHandler<span class="token punctuation">,</span> shutdownSignals<span class="token operator">...</span><span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">&lt;-</span>shutdownHandler
        <span class="token function">close</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span>
        <span class="token operator">&lt;-</span>shutdownHandler
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// second signal. Exit directly.</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> stop
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SetupSignalHandler 函数中，通过 <code>close(onlyOneSignalHandler)</code>来确保 iam-apiserver 组件的代码只调用一次 SetupSignalHandler 函数。否则，可能会因为信号传给了不同的 shutdownHandler，而造成信号丢失。</p><p>SetupSignalHandler 函数还实现了一个功能：收到一次 SIGINT/ SIGTERM 信号，程序优雅关闭。收到两次 SIGINT/ SIGTERM 信号，程序强制关闭。实现代码如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">&lt;-</span>shutdownHandler
    <span class="token function">close</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span>
    <span class="token operator">&lt;-</span>shutdownHandler
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// second signal. Exit directly.</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里要注意：<code>signal.Notify(c chan&lt;- os.Signal, sig ...os.Signal)</code>函数不会为了向 <code>c</code> 发送信息而阻塞。也就是说，如果发送时 <code>c</code> 阻塞了，signal 包会直接丢弃信号。为了不丢失信号，我们创建了有缓冲的 channel <code>shutdownHandler</code>。</p><p>最后，SetupSignalHandler 函数会返回 <code>stop</code>，后面的代码可以通过关闭 <code>stop</code> 来结束代码的阻塞状态。</p><p><strong>第二步</strong>，将 channel <code>stop</code> 传递给启动 HTTP（S）、gRPC 服务的函数，在函数中以 goroutine 的方式启动 HTTP（S）、gRPC 服务，然后执行 <code>&lt;-stop</code> 阻塞 goroutine。</p><p><strong>第三步</strong>，当 iam-apiserver 进程收到 SIGINT/SIGTERM 信号后，关闭 <code>stop</code> channel，继续执行 <code>&lt;-stop</code> 后的代码，在后面的代码中，我们可以执行一些清理逻辑，或者调用 <code>google.golang.org/grpc</code>和 <code>net/http</code>包提供的优雅关停函数 GracefulStop 和 Shutdown。例如下面这个代码（位于 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/grpc.go#L36" target="_blank" rel="noopener noreferrer">internal/apiserver/grpc.go<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 文件中）：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>grpcAPIServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listen<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to listen: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Start grpc server at %s&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>address<span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listen<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to start grpc server: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token operator">&lt;-</span>stopCh

    log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Grpc server on %s stopped&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span><span class="token function">GracefulStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了上面说的方法，iam-apiserver 还通过 <a href="https://github.com/marmotedu/iam/tree/v1.0.4/pkg/shutdown" target="_blank" rel="noopener noreferrer">github.com/marmotedu/iam/pkg/shutdown<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 包，实现了另外一种优雅关停方法，这个方法更加友好、更加灵活。实现代码见 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/server.go#L81" target="_blank" rel="noopener noreferrer">PrepareRun<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 函数。</p><p><code>github.com/marmotedu/iam/pkg/shutdown</code> 包的使用方法如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;fmt&quot;</span>
  <span class="token string">&quot;time&quot;</span>
  <span class="token string">&quot;github.com/marmotedu/iam/pkg/shutdown&quot;</span>
  <span class="token string">&quot;github.com/marmotedu/iam/pkg/shutdown/shutdownmanagers/posixsignal&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// initialize shutdown</span>
  gs <span class="token operator">:=</span> shutdown<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// add posix shutdown manager</span>
  gs<span class="token punctuation">.</span><span class="token function">AddShutdownManager</span><span class="token punctuation">(</span>posixsignal<span class="token punctuation">.</span><span class="token function">NewPosixSignalManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// add your tasks that implement ShutdownCallback</span>
  gs<span class="token punctuation">.</span><span class="token function">AddShutdownCallback</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">.</span><span class="token function">ShutdownFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Shutdown callback start&quot;</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Shutdown callback finished&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// start shutdown managers</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> gs<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Start:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// do other stuff</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码中，通过 <code>gs := shutdown.New()</code> 创建 shutdown 实例；通过 <code>AddShutdownManager</code> 方法添加监听的信号；通过 <code>AddShutdownCallback</code> 方法设置监听到指定信号时，需要执行的回调函数。这些回调函数可以执行一些清理工作。最后，通过 <code>Start</code> 方法启动 shutdown 实例。</p><h3 id="健康检查" tabindex="-1"><a class="header-anchor" href="#健康检查" aria-hidden="true">#</a> 健康检查</h3><p>通常，我们会根据进程是否存在来判定 iam-apiserver 是否健康，例如执行 <code>ps -ef|grep iam-apiserver</code>。在实际开发中，我发现有时候服务进程仍然存在，但是 HTTP 服务却不能接收和处理请求，所以更加靠谱的检查方法是，直接请求 iam-apiserver 的健康检查接口。</p><p>我们可以在启动 iam-apiserver 进程后，手动调用 iam-apiserver 健康检查接口进行检查。但还有更方便的方法：启动服务后自动调用健康检查接口。这个方法的具体实现，你可以查看 GenericAPIServer 提供的 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/server/genericapiserver.go#L219" target="_blank" rel="noopener noreferrer">ping<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 方法。在 ping 方法中，你需要注意函数中的如下代码：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>url <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s/healthz&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>InsecureServingInfo<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>
<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>InsecureServingInfo<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    url <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:%s/healthz&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>InsecureServingInfo<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当 HTTP 服务监听在所有网卡时，请求 IP 为 <code>127.0.0.1</code>；当 HTTP 服务监听在指定网卡时，我们需要请求该网卡的 IP 地址。</p><h3 id="插件化加载中间件" tabindex="-1"><a class="header-anchor" href="#插件化加载中间件" aria-hidden="true">#</a> 插件化加载中间件</h3><p>iam-apiserver 支持插件化地加载 Gin 中间件，通过这种插件机制，我们可以根据需要选择中间件。</p><p>那么，为什么要将中间件做成一种插件化的机制呢？一方面，每个中间件都完成某种功能，这些功能不是所有情况下都需要的；另一方面，中间件是追加在 HTTP 请求链路上的一个处理函数，会影响 API 接口的性能。为了保证 API 接口的性能，我们也需要选择性地加载中间件。</p><p>例如，在测试环境中为了方便 Debug，可以选择加载 dump 中间件。dump 中间件可以打印请求包和返回包信息，这些信息可以协助我们 Debug。但是在现网环境中，我们不需要 dump 中间件来协助 Debug，而且如果加载了 dump 中间件，请求时会打印大量的请求信息，严重影响 API 接口的性能。这时候，我们就期望中间件能够按需加载。</p><p>iam-apiserver 通过 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/server/genericapiserver.go#L94" target="_blank" rel="noopener noreferrer">InstallMiddlewares<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 函数来安装 Gin 中间件，函数代码如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>GenericAPIServer<span class="token punctuation">)</span> <span class="token function">InstallMiddlewares</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// necessary middlewares</span>
    s<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span><span class="token function">RequestID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// install custom middlewares</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>middlewares <span class="token punctuation">{</span>
        mw<span class="token punctuation">,</span> ok <span class="token operator">:=</span> middleware<span class="token punctuation">.</span>Middlewares<span class="token punctuation">[</span>m<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;can not find middleware: %s&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span>

            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;install middleware: %s&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>mw<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，安装中间件时，我们不仅安装了一些必备的中间件，还安装了一些可配置的中间件。</p><p>上述代码安装了两个默认的中间件： <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/requestid.go#L22" target="_blank" rel="noopener noreferrer">RequestID<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 和 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/context.go#L17" target="_blank" rel="noopener noreferrer">Context<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><p>RequestID 中间件，主要用来在 HTTP 请求头和返回头中设置 <code>X-Request-ID</code> Header。如果 HTTP 请求头中没有 <code>X-Request-ID</code> HTTP 头，则创建 64 位的 UUID，如果有就复用。UUID 是调用 <code>github.com/satori/go.uuid</code>包提供的 <code>NewV4().String()</code>方法来生成的：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>rid <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">NewV4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>另外，这里有个 Go 常量的设计规范需要你注意：常量要跟该常量相关的功能包放在一起，不要将一个项目的常量都集中放在 const 这类包中。例如， <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/requestid.go" target="_blank" rel="noopener noreferrer">requestid.go<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 文件中，我们定义了 <code>XRequestIDKey = &quot;X-Request-ID&quot;</code>常量，其他地方如果需要使用 <code>XRequestIDKey</code>，只需要引入 <code>XRequestIDKey</code>所在的包，并使用即可。</p><p>Context 中间件，用来在 gin.Context 中设置 <code>requestID</code>和 <code>username</code>键，在打印日志时，将 gin.Context 类型的变量传递给 <code>log.L()</code> 函数，<code>log.L()</code> 函数会在日志输出中输出 <code>requestID</code>和 <code>username</code>域：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">2021</span>-07-09 <span class="token number">13</span>:33:21.362 DEBUG   apiserver       v1/user.go:106  get <span class="token number">2</span> <span class="token function">users</span> from backend storage.       <span class="token punctuation">{</span><span class="token string">&quot;requestID&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;f8477cf5-4592-4e47-bdcf-82f7bde2e2d0&quot;</span>, <span class="token string">&quot;username&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>requestID</code>和 <code>username</code>字段可以方便我们后期过滤并查看日志。</p><p>除了默认的中间件，iam-apiserver 还支持一些可配置的中间件，我们可以通过配置 iam-apiserver 配置文件中的 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/configs/iam-apiserver.yaml#L11" target="_blank" rel="noopener noreferrer">server.middlewares<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 配置项，来配置这些这些中间件。</p><p>可配置以下中间件：</p><ul><li>recovery：捕获任何 panic，并恢复。</li><li>secure：添加一些安全和资源访问相关的 HTTP 头。</li><li>nocache：禁止客户端缓存 HTTP 请求的返回结果。</li><li>cors：HTTP 请求跨域中间件。</li><li>dump：打印出 HTTP 请求包和返回包的内容，方便 debug。注意，生产环境禁止加载该中间件。</li></ul><p>当然，你还可以根据需要，添加更多的中间件。方法很简单，只需要编写中间件，并将中间件添加到一个 <code>map[string]gin.HandlerFunc</code> 类型的变量中即可：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">defaultMiddlewares</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>      
    <span class="token keyword">return</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>gin<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">{</span>                          
        <span class="token string">&quot;recovery&quot;</span><span class="token punctuation">:</span>  gin<span class="token punctuation">.</span><span class="token function">Recovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                            
        <span class="token string">&quot;secure&quot;</span><span class="token punctuation">:</span>    Secure<span class="token punctuation">,</span>                                
        <span class="token string">&quot;options&quot;</span><span class="token punctuation">:</span>   Options<span class="token punctuation">,</span>             
        <span class="token string">&quot;nocache&quot;</span><span class="token punctuation">:</span>   NoCache<span class="token punctuation">,</span>             
        <span class="token string">&quot;cors&quot;</span><span class="token punctuation">:</span>      <span class="token function">Cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                        
        <span class="token string">&quot;requestid&quot;</span><span class="token punctuation">:</span> <span class="token function">RequestID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                       
        <span class="token string">&quot;logger&quot;</span><span class="token punctuation">:</span>    <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                                           
        <span class="token string">&quot;dump&quot;</span><span class="token punctuation">:</span>      gindump<span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                                               
    <span class="token punctuation">}</span>                                                                                              
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码位于 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/middleware.go#L56" target="_blank" rel="noopener noreferrer">internal/pkg/middleware/middleware.go<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 文件中。</p><h2 id="编程规范相关的特性" tabindex="-1"><a class="header-anchor" href="#编程规范相关的特性" aria-hidden="true">#</a> 编程规范相关的特性</h2><p>编程规范相关的特性有四个，分别是 API 版本、统一的资源元数据、统一的返回、并发处理模板。</p><h3 id="api-版本" tabindex="-1"><a class="header-anchor" href="#api-版本" aria-hidden="true">#</a> API 版本</h3><p>RESTful API 为了方便以后扩展，都需要支持 API 版本，iam-apiserver 选择了将 API 版本号放在 URL 中，例如<code>/v1/secrets</code>。放在 URL 中的好处是很直观，看 API 路径就知道版本号。另外，API 的路径也可以很好地跟控制层、业务层、模型层的代码路径相映射。例如，密钥资源相关的代码存放位置如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>internal/apiserver/controller/v1/secret/  <span class="token comment"># 控制几层代码存放位置</span>
internal/apiserver/service/v1/secret.go <span class="token comment"># 业务层代码存放位置</span>
github.com/marmotedu/api/apiserver/v1/secret.go <span class="token comment"># 模型层代码存放位置</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于代码存放路径，我还有一些地方想跟你分享。对于 Secret 资源，通常我们需要提供 CRUD 接口。</p><ul><li>C：Create（创建 Secret）。</li><li>R：Get（获取详情）、List（获取 Secret 资源列表）。</li><li>U：Update（更新 Secret）。</li><li>D：Delete（删除指定的 Secret）、DeleteCollection（批量删除 Secret）。</li></ul><p>每个接口相互独立，为了减少更新 A 接口代码时因为误操作影响到 B 接口代码的情况，这里建议 CRUD 接口每个接口一个文件，从物理上将不同接口的代码隔离开。这种接口还可以方便我们查找 A 接口的代码所在位置。例如，Secret 控制层相关代码的存放方式如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ls</span> internal/apiserver/controller/v1/secret/
create.go  delete_collection.go  delete.go  doc.go  get.go  list.go  secret.go  update.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>业务层和模型层的代码也可以这么组织。iam-apiserver 中，因为 Secret 的业务层和模型层代码比较少，所以我放在了 <code>internal/apiserver/service/v1/secret.go</code>和 <code>github.com/marmotedu/api/apiserver/v1/secret.go</code>文件中。如果后期 Secret 业务代码增多，我们也可以修改成下面这种方式：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code> $ <span class="token function">ls</span> internal/apiserver/service/v1/secret/
 create.go  delete_collection.go  delete.go  doc.go  get.go  list.go  secret.go  update.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这里再说个题外话：<code>/v1/secret/</code>和<code>/secret/v1/</code>这两种目录组织方式都可以，你选择一个自己喜欢的就行。</p><p>当我们需要升级 API 版本时，相关代码可以直接放在 <code>v2</code> 目录下，例如：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>internal/apiserver/controller/v2/secret/ <span class="token comment"># v2 版本控制几层代码存放位置</span>
internal/apiserver/service/v2/secret.go <span class="token comment"># v2 版本业务层代码存放位置</span>
github.com/marmotedu/api/apiserver/v2/secret.go <span class="token comment"># v2 版本模型层代码存放位置</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样既能够跟 v1 版本的代码物理隔离开，互不影响，又方便查找 v2 版本的代码。</p><h3 id="统一的资源元数据" tabindex="-1"><a class="header-anchor" href="#统一的资源元数据" aria-hidden="true">#</a> 统一的资源元数据</h3><p>iam-apiserver 设计的一大亮点是，<strong>像Kubernetes REST 资源一样，支持统一的资源元数据。</strong></p><p>iam-apiserver 中所有的资源都是 REST 资源，iam-apiserver 将 REST 资源的属性也进一步规范化了，这里的规范化是指所有的 REST 资源均支持两种属性：</p><ul><li>公共属性。</li><li>资源自有的属性。</li></ul><p>例如，Secret 资源的定义方式如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Secret <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// May add TypeMeta in the future.</span>
    <span class="token comment">// metav1.TypeMeta `json:&quot;,inline&quot;`</span>

    <span class="token comment">// Standard object&#39;s metadata.</span>
    metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">`       json:&quot;metadata,omitempty&quot;`</span>
    Username          <span class="token builtin">string</span> <span class="token string">`json:&quot;username&quot;           gorm:&quot;column:username&quot;  validate:&quot;omitempty&quot;`</span>
    SecretID          <span class="token builtin">string</span> <span class="token string">`json:&quot;secretID&quot;           gorm:&quot;column:secretID&quot;  validate:&quot;omitempty&quot;`</span>
    SecretKey         <span class="token builtin">string</span> <span class="token string">`json:&quot;secretKey&quot;          gorm:&quot;column:secretKey&quot; validate:&quot;omitempty&quot;`</span>

    <span class="token comment">// Required: true</span>
    Expires     <span class="token builtin">int64</span>  <span class="token string">`json:&quot;expires&quot;     gorm:&quot;column:expires&quot;     validate:&quot;omitempty&quot;`</span>
    Description <span class="token builtin">string</span> <span class="token string">`json:&quot;description&quot; gorm:&quot;column:description&quot; validate:&quot;description&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>资源自有的属性，会因资源不同而不同。这里，我们来重点看一下公共属性 <a href="https://github.com/marmotedu/component-base/blob/v1.0.1/pkg/meta/v1/types.go#L38" target="_blank" rel="noopener noreferrer">ObjectMeta<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ，它的定义如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> ObjectMeta <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID <span class="token builtin">uint64</span> <span class="token string">`json:&quot;id,omitempty&quot; gorm:&quot;primary_key;AUTO_INCREMENT;column:id&quot;`</span>
  InstanceID <span class="token builtin">string</span> <span class="token string">`json:&quot;instanceID,omitempty&quot; gorm:&quot;unique;column:instanceID;type:varchar(32);not null&quot;`</span>
  Name <span class="token builtin">string</span> <span class="token string">`json:&quot;name,omitempty&quot; gorm:&quot;column:name;type:varchar(64);not null&quot; validate:&quot;name&quot;`</span>
  Extend Extend <span class="token string">`json:&quot;extend,omitempty&quot; gorm:&quot;-&quot; validate:&quot;omitempty&quot;`</span>
  ExtendShadow <span class="token builtin">string</span> <span class="token string">`json:&quot;-&quot; gorm:&quot;column:extendShadow&quot; validate:&quot;omitempty&quot;`</span>
  CreatedAt time<span class="token punctuation">.</span>Time <span class="token string">`json:&quot;createdAt,omitempty&quot; gorm:&quot;column:createdAt&quot;`</span>
  UpdatedAt time<span class="token punctuation">.</span>Time <span class="token string">`json:&quot;updatedAt,omitempty&quot; gorm:&quot;column:updatedAt&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来，我来详细介绍公共属性中每个字段的含义及作用。</p><p><strong>ID</strong></p><p>这里的 ID，映射为 MariaDB 数据库中的 <code>id</code> 字段。<code>id</code> 字段在一些应用中，会作为资源的唯一标识。但 iam-apiserver 中没有使用 ID 作为资源的唯一标识，而是使用了 InstanceID。iam-apiserver 中 ID 唯一的作用是跟数据库 <code>id</code> 字段进行映射，代码中并没有使用到 <code>ID</code>。</p><p><strong>InstanceID</strong></p><p>InstanceID 是资源的唯一标识，格式为<code>&lt;resource identifier&gt;-xxxxxx</code>。其中，<code>&lt;resource identifier&gt;</code>是资源的英文标识符号，<code>xxxxxx</code>是随机字符串。字符集合为 <code>abcdefghijklmnopqrstuvwxyz1234567890</code>，长度&gt;=6，例如 <code>secret-yj8m30</code>、<code>user-j4lz3g</code>、<code>policy-3v18jq</code>。</p><p>腾讯云、阿里云、华为云也都是采用这种格式的字符串作为资源唯一标识的。</p><p>InstanceID 的生成和更新都是自动化的，通过 gorm 提供的 <code>AfterCreate</code> Hooks 在记录插入数据库之后，生成并更新到数据库的 <code>instanceID</code>字段：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Secret<span class="token punctuation">)</span> <span class="token function">AfterCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>InstanceID <span class="token operator">=</span> idutil<span class="token punctuation">.</span><span class="token function">GetInstanceID</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">&quot;secret-&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码，在 Secret 记录插入到 iam 数据库的 secret 表之后，调用 <code>idutil.GetInstanceID</code>生成 InstanceID，并通过 <code>tx.Save(s)</code>更新到数据库 secret 表的 <code>instanceID</code>字段。</p><p>因为通常情况下，应用中的 REST 资源只会保存到数据库中的一张表里，这样就能保证应用中每个资源的数据库 ID 是唯一的。所以 <code>GetInstanceID(uid uint64, prefix string) string</code>函数使用 <code>github.com/speps/go-hashids</code>包提供的方法，对这个数据库 ID 进行哈希，最终得到一个数据库级别的唯一的字符串（例如：<code>3v18jq</code>），并根据传入的 prefix，得到资源的 InstanceID。</p><p>使用这种方式生成资源的唯一标识，有下面这两个优点：</p><ul><li>数据库级别唯一。</li><li>InstanceID 是长度可控的字符串，长度最小是 6 个字符，但会根据表中的记录个数动态变长。根据我的测试，2176782336 条记录以内生成的 InstanceID 长度都在 6 个字符以内。长度可控的另外一个好处是方便记忆和传播。</li></ul><p>这里需要你注意：如果同一个资源分别存放在不同的表中，那在使用这种方式时，生成的 InstanceID 可能相同，不过概率很小，几乎为零。这时候，我们就需要使用分布式 ID 生成技术。这又是另外一个话题了，这里不再扩展讲解。</p><p>在实际的开发中，不少开发者会使用数据库数字段 ID（例如 <code>121</code>）和 36/64 位的 UUID（例如 <code>20cd59d4-08c6-4e86-a9d4-a0e51c420a04</code> ）来作为资源的唯一标识。相较于这两种资源标识方式，使用<code>&lt;resource identifier&gt;-xxxxxx</code>这种标识方式具有以下优点：</p><ul><li>看标识名就知道是什么类型的资源，例如：<code>secret-yj8m30</code>说明该资源是 secret 类型的资源。在实际的排障过程中，能够有效减少误操作。</li><li>长度可控，占用数据库空间小。iam-apiserver 的资源标识长度基本可以认为是 12 个字符（secret/policy 是 6 个字符，再加 6 位随机字符）。</li><li>如果使用 <code>121</code> 这类数值作为资源唯一标识，相当于间接向友商透漏系统的规模，是一定要禁止的。</li></ul><p>另外，还有一些系统如 Kubernetes 中，使用资源名作为资源唯一标识。这种方式有个弊端，就是当系统中同类资源太多时，创建资源很容易重名，你自己想要的名字往往填不了，所以 iam-apiserver 不采用这种设计方式。</p><p>我们使用 instanceID 来作为资源的唯一标识，在代码中，就经常需要根据 instanceID 来查询资源。所以，在数据库中要设置该字段为唯一索引，一方面可以防止 instanceID 不唯一，另一方面也能加快查询速度。</p><p><strong>Name:</strong></p><p>Name 即资源的名字，我们可以通过名字很容易地辨别一个资源。</p><p><strong>Extend、ExtendShadow：</strong></p><p>Extend 和 ExtendShadow 是 iam-apiserver 设计的又一大亮点。</p><p>在实际开发中，我们经常会遇到这个问题：随着业务发展，某个资源需要增加一些属性，这时，我们可能会选择在数据库中新增一个数据库字段。但是，随着业务系统的演进，数据库中的字段越来越多，我们的 Code 也要做适配，最后就会越来越难维护。</p><p>我们还可能遇到这种情况：我们将上面说的字段保存在数据库中叫 <code>meta</code>的字段中，数据库中 <code>meta</code>字段的数据格式是<code>{&quot;disable&quot;:true,&quot;tag&quot;:&quot;colin&quot;}</code>。但是，我们如果想在代码中使用这些字段，需要 Unmarshal 到一个结构体中，例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>metaData <span class="token operator">:=</span> <span class="token string">`{&quot;disable&quot;:true,&quot;tag&quot;:&quot;colin&quot;}`</span>
meta <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>metaData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>meta<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再存入数据中时，又要 Marshal 成 JSON 格式的字符串，例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>meta <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;disable&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;tag&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;colin&quot;</span><span class="token punctuation">}</span>
data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>meta<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可以看到，这种 Unmarshal 和 Marshal 操作有点繁琐。</p><p>因为每个资源都可能需要用到扩展字段，那么有没有一种通用的解决方案呢？iam-apiserver 就通过 Extend 和 ExtendShadow 解决了这个问题。</p><p>Extend 是 Extend 类型的字段，Extend 类型其实是 <code>map[string]interface{}</code>的类型别名。在程序中，我们可以很方便地引用 Extend 包含的属性，也就是 map 的 key。Extend 字段在保存到数据库中时，会自动 Marshal 成字符串，保存在 ExtendShadow 字段中。</p><p>ExtendShadow 是 Extend 在数据库中的影子。同样，当从数据库查询数据时，ExtendShadow 的值会自动 Unmarshal 到 Extend 类型的变量中，供程序使用。</p><p>具体实现方式如下：</p><ul><li>借助 gorm 提供的 <code>BeforeCreate</code>、<code>BeforeUpdate</code> Hooks，在插入记录、更新记录时，将 Extend 的值转换成字符串，保存在 ExtendShadow 字段中，并最终保存在数据库的 ExtendShadow 字段中。</li><li>借助 gorm 提供的 <code>AfterFind</code> Hooks，在查询数据后，将 ExtendShadow 的值 Unmarshal 到 Extend 字段中，之后程序就可以通过 Extend 字段来使用其中的属性。</li></ul><ol><li>CreatedAt</li></ol><p>资源的创建时间。每个资源在创建时，我们都应该记录资源的创建时间，可以帮助后期进行排障、分析等。</p><ol><li>UpdatedAt</li></ol><p>资源的更新时间。每个资源在更新时，我们都应该记录资源的更新时间。资源更新时，该字段由 gorm 自动更新。</p><p>可以看到，ObjectMeta 结构体包含了很多字段，每个字段都完成了很酷的功能。那么，如果把 ObjectMeta 作为所有资源的公共属性，这些资源就会自带这些能力。</p><p>当然，有些开发者可能会说，User 资源其实是不需要 <code>user-xxxxxx</code>这种资源标识的，所以 InstanceID 这个字段其实是无用的字段。但是在我看来，和功能冗余相比，功能规范化、不重复造轮子，以及 ObjectMeta 的其他功能更加重要。所以，也建议所有的 REST 资源都使用统一的资源元数据。</p><h3 id="统一的返回" tabindex="-1"><a class="header-anchor" href="#统一的返回" aria-hidden="true">#</a> 统一的返回</h3><p>在<a href="https://time.geekbang.org/column/article/391895" target="_blank" rel="noopener noreferrer">18 讲<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 中，我们介绍过 API 的接口返回格式应该是统一的。要想返回一个固定格式的消息，最好的方式就是使用同一个返回函数。因为 API 接口都是通过同一个函数来返回的，其返回格式自然是统一的。</p><p>IAM 项目通过 <a href="https://github.com/marmotedu/component-base/tree/master/pkg/core" target="_blank" rel="noopener noreferrer">github.com/marmotedu/component-base/pkg/core<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 包提供的 <a href="https://github.com/marmotedu/component-base/blob/master/pkg/core/core.go#L33" target="_blank" rel="noopener noreferrer">WriteResponse<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 函数来返回结果。WriteResponse 函数定义如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">WriteResponse</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">,</span> data <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%#+v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        coder <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">ParseCoder</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>coder<span class="token punctuation">.</span><span class="token function">HTTPStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ErrResponse<span class="token punctuation">{</span>
            Code<span class="token punctuation">:</span>      coder<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Message<span class="token punctuation">:</span>   coder<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Reference<span class="token punctuation">:</span> coder<span class="token punctuation">.</span><span class="token function">Reference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，WriteResponse 函数会判断 err 是否为 nil。如果不为 nil，则将 err 解析为 <code>github.com/marmotedu/errors</code>包中定义的 Coder 类型的错误，并调用 Coder 接口提供的 <code>Code()</code> 、<code>String()</code> 、<code>Reference()</code> 方法，获取该错误的业务码、对外展示的错误信息和排障文档。如果 err 为 nil，则调用 <code>c.JSON</code>返回 JSON 格式的数据。</p><h3 id="并发处理模板" tabindex="-1"><a class="header-anchor" href="#并发处理模板" aria-hidden="true">#</a> 并发处理模板</h3><p>在 Go 项目开发中，经常会遇到这样一种场景：查询列表接口时，查询出了多条记录，但是需要针对每一条记录做一些其他逻辑处理。因为是多条记录，比如 100 条，处理每条记录延时如果为 X 毫秒，串行处理完 100 条记录，整体延时就是 <code>100 * X 毫秒</code>。如果 X 比较大，那整体处理完的延时是非常高的，会严重影响 API 接口的性能。</p><p>这时候，我们自然就会想到利用 CPU 的多核能力，并发来处理这 100 条记录。这种场景我们在实际开发中经常遇到，有必要抽象成一个并发处理模板，这样以后在查询时，就可以使用这个模板了。</p><p>例如，iam-apiserver 中，查询用户列表接口 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/service/v1/user.go#L43" target="_blank" rel="noopener noreferrer">List<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ，还需要返回每个用户所拥有的策略个数。这就用到了并发处理。这里，我试着将其抽象成一个模板，模板如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>userService<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>UserList<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  users<span class="token punctuation">,</span> err <span class="token operator">:=</span> u<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">L</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;list users from storage failed: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrDatabase<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
  errChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  finished <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token keyword">var</span> m sync<span class="token punctuation">.</span>Map

  <span class="token comment">// Improve query efficiency in parallel</span>
  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>user <span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">// some cost time process</span>
      policies<span class="token punctuation">,</span> err <span class="token operator">:=</span> u<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Policies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        errChan <span class="token operator">&lt;-</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrDatabase<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>

      m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">{</span>
                <span class="token operator">...</span>
        Phone<span class="token punctuation">:</span>       user<span class="token punctuation">.</span>Phone<span class="token punctuation">,</span>
        TotalPolicy<span class="token punctuation">:</span> policies<span class="token punctuation">.</span>TotalCount<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">close</span><span class="token punctuation">(</span>finished<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">select</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token operator">&lt;-</span>finished<span class="token punctuation">:</span>
  <span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errChan<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>

  <span class="token comment">// infos := make([]*v1.User, 0)</span>
  infos <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>Items<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
    info<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
    infos <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>infos<span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  log<span class="token punctuation">.</span><span class="token function">L</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;get %d users from backend storage.&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>infos<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>UserList<span class="token punctuation">{</span>ListMeta<span class="token punctuation">:</span> users<span class="token punctuation">.</span>ListMeta<span class="token punctuation">,</span> Items<span class="token punctuation">:</span> infos<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的并发模板中，我实现了并发处理查询结果中的三个功能：</p><p>**第一个功能，goroutine 报错即返回。**goroutine 中代码段报错时，会将错误信息写入 <code>errChan</code>中。我们通过 List 函数中的 select 语句，实现只要有一个 goroutine 发生错误，即返回：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token operator">&lt;-</span>finished<span class="token punctuation">:</span>
<span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errChan<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**第二个功能，保持查询顺序。**我们从数据库查询出的列表是有顺序的，比如默认按数据库 ID 字段升序排列，或者我们指定的其他排序方法。在并发处理中，这些顺序会被打断。但为了确保最终返回的结果跟我们预期的排序效果一样，在并发模板中，我们还需要保证最终返回结果跟查询结果保持一致的排序。</p><p>上面的模板中，我们将处理后的记录保存在 map 中，map 的 key 为数据库 ID。并且，在最后按照查询的 ID 顺序，依次从 map 中取出 ID 的记录，例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> m sync<span class="token punctuation">.</span>Map
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
      <span class="token operator">...</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>user <span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>
    m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
  <span class="token operator">...</span>
infos <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>Items<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
  info<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
  infos <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>infos<span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过上面这种方式，可以确保最终返回的结果跟从数据库中查询的结果保持一致的排序。</p><p>**第三个功能，并发安全。**Go 语言中的 map 不是并发安全的，要想实现并发安全，需要自己实现（如加锁），或者使用 <code>sync.Map</code>。上面的模板使用了 <code>sync.Map</code>。</p><p>当然了，如果期望 List 接口能在期望时间内返回，还可以添加超时机制，例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>finished<span class="token punctuation">:</span>
    <span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errChan<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;list users timeout after 30 seconds&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>goroutine 虽然很轻量，但还是会消耗资源，如果我们需要处理几百上千的并发，就需要用协程池来复用协程，达到节省资源的目的。有很多优秀的协程包可供我们直接使用，比如 <a href="https://github.com/panjf2000/ants" target="_blank" rel="noopener noreferrer">ants<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 、 <a href="https://github.com/Jeffail/tunny" target="_blank" rel="noopener noreferrer">tunny<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 等。</p><h2 id="其他特性" tabindex="-1"><a class="header-anchor" href="#其他特性" aria-hidden="true">#</a> 其他特性</h2><p>除了上面那两大类，这里我还想给你介绍下关键代码设计中的其他特性，包括插件化选择 JSON 库、调用链实现、数据一致性。</p><h3 id="插件化选择-json-库" tabindex="-1"><a class="header-anchor" href="#插件化选择-json-库" aria-hidden="true">#</a> 插件化选择 JSON 库</h3><p>Golang 提供的标准 JSON 解析库 encoding/json，在开发高性能、高并发的网络服务时会产生性能问题。所以很多开发者在实际的开发中，往往会选用第三方的高性能 JSON 解析库，例如 <a href="https://github.com/json-iterator/go" target="_blank" rel="noopener noreferrer">jsoniter<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 、 <a href="https://github.com/mailru/easyjson" target="_blank" rel="noopener noreferrer">easyjson<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 、 <a href="https://github.com/buger/jsonparser" target="_blank" rel="noopener noreferrer">jsonparser<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 等。</p><p>我见过的很多开发者选择了 jsoniter，也有一些开发者使用了 easyjson。jsoniter 的性能略高于 encoding/json。但随着 go 版本的迭代，encoding/json 库的性能也越来越高，jsoniter 的性能优势也越来越有限。所以，IAM 项目使用了 jsoniter 库，并准备随时切回 encoding/json 库。</p><p>为了方便切换不同的 JSON 包，iam-apiserver 采用了一种插件化的机制来使用不同的 JSON 包。具体是通过使用 go 的标签编译选择运行的解析库来实现的。</p><p>标签编译就是在源代码里添加标注，通常称之为编译标签（build tag）。编译标签通过注释的方式在靠近源代码文件顶部的地方添加。go build 在构建一个包的时候，会读取这个包里的每个源文件并且分析编译便签，这些标签决定了这个源文件是否参与本次编译。例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// +build jsoniter</span>

<span class="token keyword">package</span> json

<span class="token keyword">import</span> jsoniter <span class="token string">&quot;github.com/json-iterator/go&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>+build jsoniter</code>就是编译标签。这里要注意，一个源文件可以有多个编译标签，多个编译标签之间是逻辑“与”的关系；一个编译标签可以包括由空格分割的多个标签，这些标签是逻辑“或”的关系。例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// +build linux darwin</span>
<span class="token comment">// +build 386</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这里要注意，编译标签和包的声明之间应该使用空行隔开，否则编译标签会被当作包声明的注释，而不是编译标签。</p><p>那具体来说，我们是如何实现插件化选择 JSON 库的呢？</p><p>首先，我自定义了一个 <a href="https://github.com/marmotedu/component-base/tree/master/pkg/json" target="_blank" rel="noopener noreferrer">github.com/marmotedu/component-base/pkg/json<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> json 包，来适配 encoding/json 和 json-iterator。<code>github.com/marmotedu/component-base/pkg/json</code> 包中有两个文件：</p><ul><li>**json.go：**映射了 encoding/json 包的 Marshal、Unmarshal、MarshalIndent、NewDecoder、NewEncoder 方法。</li><li>**jsoniter.go：**映射了 github.com/json-iterator/go 包的 Marshal、Unmarshal、MarshalIndent、NewDecoder、NewEncoder。</li></ul><p>json.go 和 jsoniter.go 通过编译标签，让 Go 编译器在构建代码时选择使用哪一个 json 文件。</p><p>接着，通过在执行 <code>go build</code>时指定 <a href="https://github.com/marmotedu/iam/blob/master/scripts/make-rules/golang.mk#L19" target="_blank" rel="noopener noreferrer">-tags<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 参数，来选择编译哪个 json 文件。</p><p><code>json/json.go</code>、<code>json/jsoniter.go</code> 这两个 Go 文件的顶部，都有一行注释：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// +build !jsoniter</span>

<span class="token comment">// +build jsoniter</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>// +build !jsoniter</code>表示，tags 不是 jsoniter 的时候编译这个 Go 文件。<code>// +build jsoniter</code>表示，tags 是 jsoniter 的时候编译这个 Go 文件。也就是说，这两种条件是互斥的，只有当 tags=jsoniter 的时候，才会使用 <code>json-iterator</code>，其他情况使用 <code>encoding/json</code>。</p><p>例如，如果我们想使用包，可以这么编译项目：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>$ <span class="token keyword">go</span> build <span class="token operator">-</span>tags<span class="token operator">=</span>jsoniter
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在实际开发中，**我们需要根据场景来选择合适的JSON 库。**这里我给你一些建议。</p><p>场景一：结构体序列化和反序列化场景</p><p>在这个场景中，我个人首推的是官方的 JSON 库。可能你会比较意外，那我就来说说我的理由：</p><p>首先，虽然 easyjson 的性能压倒了其他所有开源项目，但它有一个最大的缺陷，那就是需要额外使用工具来生成这段代码，而对额外工具的版本控制就增加了运维成本。当然，如果你的团队已经能够很好地处理 protobuf 了，也是可以用同样的思路来管理 easyjson 的。</p><p>其次，虽然 Go 1.8 之前，官方 JSON 库的性能总是被大家吐槽，但现在（1.16.3）官方 JSON 库的性能已不可同日而语。此外，作为使用最为广泛，而且没有之一的 JSON 库，官方库的 bug 是最少的，兼容性也是最好的</p><p>最后，jsoniter 的性能虽然依然优于官方，但没有达到逆天的程度。如果你追求的是极致的性能，那么你应该选择 easyjson 而不是 jsoniter。jsoniter 近年已经不活跃了，比如说，我前段时间提了一个 issue 没人回复，于是就上去看了下 issue 列表，发现居然还遗留着一些 2018 年的 issue。</p><p>场景二：非结构化数据的序列化和反序列化场景</p><p>这个场景下，我们要分高数据利用率和低数据利用率两种情况来看。你可能对数据利用率的高低没啥概念，那我举个例子：JSON 数据的正文中，如果说超过四分之一的数据都是业务需要关注和处理的，那就算是高数据利用率。</p><p>在高数据利用率的情况下，我推荐使用 jsonvalue。</p><p>至于低数据利用率的情况，还可以根据 **JSON 数据是否需要重新序列化，**分成两种情况。</p><p>如果无需重新序列化，这个时候选择 jsonparser 就行了，因为它的性能实在是耀眼。</p><p>如果需要重新序列化，这种情况下你有两种选择：如果对性能要求相对较低，可以使用 jsonvalue；如果对性能的要求高，并且只需要往二进制序列中插入一条数据，那么可以采用 jsoniter 的 Set 方法。</p><p>实际操作中，超大 JSON 数据量，并且同时需要重新序列化的情况非常少，往往是在代理服务器、网关、overlay 中继服务等，同时又需要往原数据中注入额外信息的时候。换句话说，jsoniter 的适用场景比较有限。</p><p>下面是从 10%到 60%数据覆盖率下，不同库的操作效率对比（纵坐标单位：μs/op）：</p><p><img src="https://static001.geekbang.org/resource/image/fc/a6/fcc79727a26a37345af705df1179c1a6.png?wh=1920x1266" alt="图片"></p><p>可以看到，当 jsoniter 的数据利用率达到 25% 时，和 jsonvalue、jsonparser 相比就已经没有任何优势；至于 jsonvalue，由于对数据做了一次性的全解析，因此解析后的数据存取耗时极少，因此在不同数据覆盖率下的耗时都很稳定。</p><h3 id="调用链实现" tabindex="-1"><a class="header-anchor" href="#调用链实现" aria-hidden="true">#</a> 调用链实现</h3><p>调用链对查日志、排障帮助非常大。所以，在 iam-apiserver 中也实现了调用链，通过 <code>requestID</code>来串联整个调用链。</p><p>具体是通过以下两步来实现的：</p><p>第一步，将 <code>ctx context.Context</code> 类型的变量作为函数的第一个参数，在函数调用时传递。</p><p>第二步，不同函数中，通过 <code>log.L(ctx context.Context)</code>来记录日志。</p><p>在请求到来时，请求会通过 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/context.go#L17" target="_blank" rel="noopener noreferrer">Context<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 中间件处理：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>KeyRequestID<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>XRequestIDKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>KeyUsername<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>UsernameKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 Context 中间件中，会在 gin.Context 类型的变量中设置 <code>log.KeyRequestID</code>键，其值为 36 位的 UUID。UUID 通过 <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/requestid.go#L22" target="_blank" rel="noopener noreferrer">RequestID<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 中间件来生成，并设置在 gin 请求的 Context 中。</p><p>RequestID 中间件在 Context 中间件之前被加载，所以在 Context 中间件被执行时，能够获取到 RequestID 生成的 UUID。</p><p><code>log.L(ctx context.Context)</code>函数在记录日志时，会从头 ctx 中获取到 <code>log.KeyRequestID</code>，并作为一个附加字段随日志打印。</p><p>通过以上方式，我们最终可以形成 iam-apiserver 的请求调用链，日志示例如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">2021</span>-07-19 <span class="token number">19</span>:41:33.472 INFO    apiserver       apiserver/auth.go:205   user <span class="token variable"><span class="token variable">`</span>admin<span class="token variable">`</span></span> is authenticated.  <span class="token punctuation">{</span><span class="token string">&quot;requestID&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;b6c56cd3-d095-4fd5-a928-291a2e33077f&quot;</span>, <span class="token string">&quot;username&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021</span>-07-19 <span class="token number">19</span>:41:33.472 INFO    apiserver       policy/create.go:22     create policy <span class="token keyword">function</span> called.  <span class="token punctuation">{</span><span class="token string">&quot;requestID&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;b6c56cd3-d095-4fd5-a928-291a2e33077f&quot;</span>, <span class="token string">&quot;username&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外，<code>ctx context.Context</code>作为函数/方法的第一个参数，还有一个好处是方便后期扩展。例如，如果我们有以下调用关系：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">B</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;name: %s, address: %s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> address<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">B</span><span class="token punctuation">(</span><span class="token string">&quot;colin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sz&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码最终调用 <code>B</code>函数打印出用户名及其地址。如果随着业务的发展，希望 A 调用 B 时，传入用户的电话，B 中打印出用户的电话号码。这时候，我们可能会考虑给 B 函数增加一个电话号参数，例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">B</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> address<span class="token punctuation">,</span> phone <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;name: %s, address: %s, phone: %s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> address<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果我们后面还要增加年龄、性别等属性呢？按这种方式不断增加 B 函数的参数，不仅麻烦，而且还要改动所有调用 B 的函数，工作量也很大。这时候，可以考虑通过 <code>ctx context.Context</code> 来传递这些扩展参数，实现如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;context&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">B</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;name: %s, address: %s, phone: %v&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> address<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1812884xxxx&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">B</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;colin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sz&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样，我们下次需要新增参数的话，只需要调用 context 的 WithValue 方法：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;male&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 B 函数中，通过 <code>context.Context</code> 类型的变量提供的 <code>Value</code> 方法，从 context 中获取 <code>sex</code> key 即可：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;name: %s, address: %s, phone: %v, sex: %v&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> address<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="数据一致性" tabindex="-1"><a class="header-anchor" href="#数据一致性" aria-hidden="true">#</a> 数据一致性</h3><p>为了提高 iam-authz-server 的响应性能，我将密钥和授权策略信息缓存在 iam-authz-server 部署机器的内存中。同时，为了实现高可用，我们需要保证 iam-authz-server 启动的实例个数至少为两个。这时候，我们会面临数据一致性的问题：所有 iam-authz-server 缓存的数据要一致，并且跟 iam-apiserver 数据库中保存的一致。iam-apiserver 通过如下方式来实现数据一致性：</p><p><img src="http://sm.nsddd.top/sm202302282227080.jpeg" alt="img"></p><p><strong>具体流程如下：</strong></p><p>第一步，iam-authz-server 启动时，会通过 grpc 调用 iam-apiserver 的 GetSecrets 和 GetPolicies 接口，获取所有的密钥和授权策略信息。</p><p>第二步，当我们通过控制台调用 iam-apiserver 密钥/授权策略的写接口（POST、PUT、DELETE）时，会向 Redis 的 <code>iam.cluster.notifications</code>通道发送 SecretChanged/PolicyChanged 消息。</p><p>第三步，iam-authz-server 会订阅 <code>iam.cluster.notifications</code>通道，当监听到有 SecretChanged/PolicyChanged 消息时，会请求 iam-apiserver 拉取所有的密钥/授权策略。</p><p>通过 Redis 的 Sub/Pub 机制，保证每个 iam-authz-server 节点的缓存数据跟 iam-apiserver 数据库中保存的数据一致。所有节点都调用 iam-apiserver 的同一个接口来拉取数据，通过这种方式保证所有 iam-authz-server 节点的数据是一致的。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>今天，我和你分享了 iam-apiserver 的一些关键功能实现，并介绍了我的设计思路。这里我再简要梳理下。</p><ul><li>为了保证进程关停时，HTTP 请求执行完后再断开连接，进程中的任务正常完成，iam-apiserver 实现了优雅关停功能。</li><li>为了避免进程存在，但服务没成功启动的异常场景，iam-apiserver 实现了健康检查机制。</li><li>Gin 中间件可通过配置文件配置，从而实现按需加载的特性。</li><li>为了能够直接辨别出 API 的版本，iam-apiserver 将 API 的版本标识放在 URL 路径中，例如 <code>/v1/secrets</code>。</li><li>为了能够最大化地共享功能代码，iam-apiserver 抽象出了统一的元数据，每个 REST 资源都具有这些元数据。</li><li>因为 API 接口都是通过同一个函数来返回的，其返回格式自然是统一的。</li><li>因为程序中经常需要处理并发逻辑，iam-apiserver 抽象出了一个通用的并发模板。</li><li>为了方便根据需要切换 JSON 库，我们实现了插件化选择 JSON 库的功能。</li><li>为了实现调用链功能，iam-apiserver 不同函数之间通过 <code>ctx context.Context</code> 来传递 RequestID。</li><li>iam-apiserver 通过 Redis 的 Sub/Pub 机制来保证数据一致性。</li></ul><h2 id="end-链接" tabindex="-1"><a class="header-anchor" href="#end-链接" aria-hidden="true">#</a> END 链接</h2><ul><li><div><a href="20.md" style="float:left;">⬆️上一节🔗 </a><a href="22.md" style="float:right;"> ️下一节🔗</a></div></li></ul><ul><li><p><a href="/projects/" class="">Ⓜ️回到目录🏠</a></p></li><li><p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>🫵参与贡献💞❤️‍🔥💖</strong><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</p></li><li><p>✴️版权声明 © ：本书所有内容遵循<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0协议（署名-相同方式共享）©<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ul></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/3293172751/awesome-go/edit/master/docs/projects/projects/21.md" rel="noopener noreferrer" target="_blank" aria-label="在GitHub上贡献此页面"><!--[--><!--]--> 在GitHub上贡献此页面 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 3293172751nss@gmail.com">Xinwei Xiong</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: 3293172751nss@gmail.com">xiongxinwei</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.7c0cd728.js" defer></script>
  </body>
</html>
